<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .line-path { fill: none; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body class="bg-slate-50">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, Component } = React;

class ErrorBoundary extends Component {
    state = { hasError: false };
    static getDerivedStateFromError() { return { hasError: true }; }
    render() {
        if (this.state.hasError) {
            return (<div className="min-h-screen flex items-center justify-center"><div className="bg-white p-8 rounded-2xl shadow-xl text-center">
                <div className="text-4xl mb-4">‚ö†Ô∏è</div><h1 className="text-xl font-bold mb-4">Something went wrong</h1>
                <button onClick={() => { localStorage.removeItem('expense_v9'); localStorage.removeItem('merchant_rules'); window.location.reload(); }} className="px-6 py-3 bg-red-500 text-white rounded-xl font-bold">Clear & Reload</button>
            </div></div>);
        }
        return this.props.children;
    }
}

// ============== CONFIGURATION ==============
const CATEGORIES = ['Groceries','Rent','Daycare','Household','Transportation','Entertainment','Health & Wellness','Shopping','Dining','Travel','Subscriptions','Stylecom','Venmo','Income','TaxIncome','Transfer','Other','Excluded'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const YEAR_COLORS = { 2021:'#94a3b8', 2022:'#f59e0b', 2023:'#3b82f6', 2024:'#ef4444', 2025:'#10b981', 2026:'#8b5cf6' };
const CAT_COLORS = { Groceries:'#22c55e', Rent:'#f59e0b', Daycare:'#a855f7', Household:'#3b82f6', Transportation:'#8b5cf6', Entertainment:'#ec4899', 'Health & Wellness':'#14b8a6', Shopping:'#f43f5e', Dining:'#f97316', Travel:'#06b6d4', Subscriptions:'#6366f1', Stylecom:'#db2777', Venmo:'#008CFF', Other:'#94a3b8', Uncategorized:'#fbbf24', Excluded:'#cbd5e1', Income:'#10b981', TaxIncome:'#059669', Transfer:'#64748b' };

// HIGH PRIORITY specific expense rules (checked FIRST in autoRuleMatch)
const PRIORITY_RULES = {
    Daycare: ['msh'],  // MSH = Daycare provider
    Rent: ['wells fargo card', 'wells fargo']  // Wells Fargo withdrawals = Rent
};

// Credit Card Payoff keywords (these become Transfer, excluded from expense totals)
const CC_PAYOFF_KEYWORDS = ['amex', 'chase card', 'capital one', 'citi card', 'discover card', 'cc payment', 'card ccpymt', 'card autopay', 'credit card auto pay', 'wf credit card'];

const AUTO_RULES = {
    // Excluded - only for truly unmatchable/ignorable transactions
    Excluded:[],
    Groceries:['walmart','kroger','safeway','trader joe','whole foods','aldi','costco','publix','grocery','supermarket','wegmans','heb','albertsons','sprouts'],
    Dining:['sweetgreen','mcdonald','starbucks','chipotle','subway','restaurant','cafe','coffee','doordash','uber eats','pizza','grubhub','seamless','postmates'],
    Transportation:['uber','lyft','taxi','shell','exxon','chevron','gas','fuel','parking','metro','transit','mobil','bp','sunoco'],
    Shopping:['amazon','ebay','best buy','apple store','ikea','nike','nordstrom','target','macys','tjmaxx','marshalls','kohls','gap','old navy','zara','h&m','uniqlo','sephora','ulta','bath body'],
    Entertainment:['netflix','hulu','disney','hbo','spotify','movie','cinema','xbox','steam','playstation','nintendo','amc'],
    // Household - utilities, home services, maintenance, cleaning, home supplies
    Household:['electric','power','water bill','comcast','xfinity','spectrum','internet','verizon','at&t','t-mobile','con ed','pge','national grid','cable','phone bill','trash','waste','sewer','gas bill','heating','cooling','hvac','plumber','plumbing','electrician','handyman','lawn','landscaping','pest control','cleaning','maid','housekeeping','home depot','lowes','ace hardware','menards','bed bath','container store','pottery barn','crate barrel','williams sonoma','wayfair','overstock','furniture','mattress','appliance','repair','maintenance','security','adt','ring','nest','thermostat'],
    // Health & Wellness - medical, pharmacy, fitness, mental health, personal care
    'Health & Wellness':['pharmacy','cvs','walgreens','doctor','hospital','medical','dentist','optum','cigna','aetna','united health','clinic','urgent care','emergency','lab','blood','xray','mri','therapy','therapist','counseling','psychiatrist','psychologist','mental health','gym','fitness','yoga','pilates','peloton','crossfit','equinox','planet fitness','orange theory','soulcycle','massage','spa','chiropractor','physical therapy','vision','eye','optical','glasses','contacts','lenscrafters','warby parker','vitamins','supplements','gnc','vitamin shoppe'],
    Travel:['airline','delta','united','southwest','flight','airbnb','hotel','marriott','hilton','hyatt','expedia','booking.com'],
    Subscriptions:['subscription','membership','adobe','dropbox','linkedin','patreon','github','notion'],
    // Venmo - special category, NOT excluded (allows netting)
    Venmo:['venmo'],
    // Income categories - will be auto-excluded from expense views
    Income:['payroll','salary','direct deposit','paycheck','dividend','interest income','wire in','employer','bonus','commission','stripe'],
    // Tax refunds/income - auto-excluded
    TaxIncome:['irs','treasury','tax refund','state tax','federal tax','tax credit'],
    // Transfer category - internal moves between accounts (for transfer matching)
    // Includes CC payments so they can be matched with checking withdrawals
    Transfer:['zelle to','zelle from','internal transfer','external transfer','online transfer to','online transfer from','ach payment to','transfer to sav','transfer from sav','transfer to chk','transfer from chk','autopay','auto pay','thank you','credit card payment','card payment','online payment','bill pay','paying','paid in full','minimum payment','statement balance','balance payment','ach payment','electronic payment','pymt','payment to chase','payment to amex','payment to citi','payment to capital one','payment to discover','amex transfer','chase transfer']
};

// INTERNAL TRANSFER SOURCES - these override income keywords
// If description contains these, it's money moving between your own accounts, NOT real income
const INTERNAL_TRANSFER_SOURCES = [
    'hsbc bank usa',
    'hsbc bank',
    'preauthorized deposit from hsbc',
    'preauthorized deposit from wells',
    'preauthorized deposit from chase',
    'preauthorized deposit from bank of america',
    'preauthorized deposit from citi',
    'from checking',
    'from savings',
    'from sav ',
    'from chk ',
    'internal xfer',
    'account transfer'
];

// Categories to exclude from expense calculations (Venmo is NOT excluded - it nets out)
const EXCLUDED_CATEGORIES = ['Income', 'Transfer', 'Excluded', 'TaxIncome'];

// Cost Type mappings for budget structure analysis
const COST_TYPE_RULES = {
    Fixed: ['Rent', 'Daycare'],
    'Semi-Fixed': ['Household', 'Groceries', 'Subscriptions'],
    Variable: [] // Catch-all for everything else
};
const COST_TYPE_COLORS = {
    Fixed: '#ef4444',      // Red - mandatory expenses
    'Semi-Fixed': '#f59e0b', // Amber - somewhat predictable
    Variable: '#3b82f6'     // Blue - discretionary
};

// Helper to get cost type from category
const getCostType = (category) => {
    const catLower = (category || '').toLowerCase();
    for (const [costType, categories] of Object.entries(COST_TYPE_RULES)) {
        if (costType === 'Variable') continue; // Skip catch-all
        if (categories.some(c => c.toLowerCase() === catLower)) {
            return costType;
        }
    }
    return 'Variable'; // Default catch-all
};

// ============== HELPERS ==============
const MIN_YEAR = 2024; // Only show data from 2024 onwards
const safe = v => (v == null || isNaN(v)) ? 0 : Number(v);
const pDate = d => { const x = new Date(d); return isNaN(x) ? new Date() : x; };
const getY = d => pDate(d).getFullYear();
const getM = d => pDate(d).getMonth();
const getDoY = d => { const x = pDate(d), s = new Date(x.getFullYear(),0,0); return Math.floor((x-s)/864e5); };
const isValidYear = d => getY(d) >= MIN_YEAR;

// Payment processor prefixes to strip from descriptions
// These prefixes obscure the actual merchant name
const PROCESSOR_PREFIXES = [
    // Apple Pay variations
    /^APLPAY\s*\*?\s*/i,
    /^APL\s*\*?\s*/i,
    /^APPLE PAY\s*\*?\s*/i,
    // Toast POS variations
    /^TST\s*\*?\s*/i,
    /^TOAST\s*\*?\s*/i,
    // Square variations
    /^SQ\s*\*?\s*/i,
    /^SQU\s*\*?\s*/i,
    /^SQUARE\s*\*?\s*/i,
    /^GOSQ\s*\*?\s*/i,
    // PayPal variations
    /^PAYPAL\s*\*?\s*/i,
    /^PP\s*\*?\s*/i,
    // Google Pay
    /^GOOGLEPAY\s*\*?\s*/i,
    /^GOOGLE\s*\*?\s*/i,
    // Stripe
    /^STRIPE\s*\*?\s*/i,
    // Clover
    /^CLOVER\s*\*?\s*/i,
    /^CLV\s*\*?\s*/i,
    // Generic POS prefixes
    /^POS\s*(PURCHASE\s*)?\*?\s*/i,
    /^DEBIT\s*(CARD\s*)?(PURCHASE\s*)?\*?\s*/i,
    /^CHECK\s*CARD\s*\*?\s*/i,
    // Recurring/subscription prefixes
    /^RECURRING\s*\*?\s*/i,
    /^RECUR\s*\*?\s*/i
];

// Clean description by stripping payment processor prefixes
// Returns the cleaned description for categorization
const cleanDescription = (rawDesc) => {
    if (!rawDesc) return '';
    let cleaned = rawDesc.trim();
    
    // Apply each prefix pattern
    for (const pattern of PROCESSOR_PREFIXES) {
        cleaned = cleaned.replace(pattern, '');
    }
    
    // Also strip any leading asterisks or spaces left over
    cleaned = cleaned.replace(/^\*+\s*/, '').trim();
    
    return cleaned;
};

// Clean merchant name for matching (uses cleanDescription internally)
const cleanMerchant = (desc) => {
    if (!desc) return 'Unknown';
    // First clean any processor prefixes
    let name = cleanDescription(desc);
    // Then apply merchant name extraction
    name = name.split(/\s{2,}|\t|\*|#|\d{10,}/)[0].trim();
    name = name.substring(0, 40).toUpperCase();
    return name || 'Unknown';
};

// Fuzzy match CSV category to our categories
const fuzzyMatchCSV = v => {
    if (!v) return 'Uncategorized';
    const l = v.toLowerCase();
    const e = CATEGORIES.find(c => c.toLowerCase() === l);
    if (e) return e;
    for (const p of l.split(/[-&,]/)) {
        const part = p.trim();
        if (!part) continue;
        const m = CATEGORIES.find(c => part.includes(c.toLowerCase()) || c.toLowerCase().includes(part));
        if (m) return m;
        if (part.includes('restaurant') || part.includes('food') || part.includes('dining')) return 'Dining';
        if (part.includes('taxi') || part.includes('transport') || part.includes('uber') || part.includes('lyft') || part.includes('parking')) return 'Transportation';
        if (part.includes('airline') || part.includes('travel') || part.includes('hotel') || part.includes('lodging') || part.includes('flight')) return 'Travel';
        if (part.includes('pharmac') || part.includes('medical') || part.includes('health') || part.includes('doctor') || part.includes('hospital')) return 'Healthcare';
        if (part.includes('grocer') || part.includes('supermarket') || part.includes('food store')) return 'Groceries';
        if (part.includes('gas') || part.includes('fuel') || part.includes('petrol')) return 'Transportation';
        if (part.includes('entertain') || part.includes('movie') || part.includes('theatre') || part.includes('theater')) return 'Entertainment';
        if (part.includes('merchan') || part.includes('retail') || part.includes('store') || part.includes('shop')) return 'Shopping';
        if (part.includes('util') || part.includes('electric') || part.includes('water') || part.includes('internet') || part.includes('phone')) return 'Utilities';
        if (part.includes('subscription') || part.includes('member')) return 'Subscriptions';
    }
    return 'Uncategorized';
};

// Auto-categorize by description keywords
const autoRuleMatch = (desc, transactionType = 'expense') => {
    if (!desc) return null;
    
    // Clean description first to strip payment processor prefixes
    const cleaned = cleanDescription(desc);
    const d = cleaned.toLowerCase();
    const rawLower = desc.toLowerCase(); // Keep raw for checking prefixes like withdrawal/deposit
    
    // ============ PRIORITY HIERARCHY ============
    
    // PRIORITY 0: Venmo transactions always go to Venmo category
    // This prevents Venmo from being caught by other rules
    if (rawLower.includes('venmo') || d.includes('venmo')) {
        return 'Venmo';
    }
    
    // PRIORITY 1: HARD EXCEPTIONS - Specific Expense Overrides (HIGHEST PRIORITY)
    // These rules run BEFORE CC payoff detection to prevent false positives
    // Example: "WELLS FARGO CARD CCPYMT" should be Rent, NOT Transfer
    for (const [cat, kws] of Object.entries(PRIORITY_RULES)) {
        if (kws.some(k => d.includes(k) || rawLower.includes(k))) {
            // Hard exception - return immediately, do NOT check CC payoff keywords
            return cat;
        }
    }
    
    // PRIORITY 2: Credit Card Payoffs ‚Üí Transfer (EXCLUDED)
    // Only runs if PRIORITY 1 didn't match
    // Check for CC payoff patterns - these are transfers, not expenses
    if (CC_PAYOFF_KEYWORDS.some(k => d.includes(k) || rawLower.includes(k))) {
        return 'Transfer';
    }
    
    // PRIORITY 2.5: Generic Withdrawals ‚Üí Transfer (EXCLUDED)
    // Catches ATM withdrawals, transfers to savings, unrecognized bill payments
    // This runs AFTER specific overrides (Venmo, Wells Fargo, CC payoffs)
    if (rawLower.includes('withdrawal') || d.includes('withdrawal')) {
        return 'Transfer';
    }
    
    // PRIORITY 2.75: If transaction type is transfer (set during import for HSBC etc)
    if (transactionType === 'transfer') {
        return 'Transfer';
    }
    
    // PRIORITY 3: If it's an income transaction type AND doesn't match above
    if (transactionType === 'income') {
        // PRIORITY 3a: Check for INTERNAL TRANSFERS first (overrides income keywords)
        // If money is coming from your own bank accounts, it's NOT real income
        if (INTERNAL_TRANSFER_SOURCES.some(src => rawLower.includes(src) || d.includes(src))) {
            return 'Transfer';
        }
        
        // PRIORITY 3b: Check for explicit transfer keywords in income transactions
        if (AUTO_RULES.Transfer.some(k => d.includes(k) || rawLower.includes(k))) {
            return 'Transfer';
        }
        
        // PRIORITY 3c: Now safe to check for real income
        // Check TaxIncome first (more specific)
        if (AUTO_RULES.TaxIncome.some(k => d.includes(k))) return 'TaxIncome';
        // Then general Income
        if (AUTO_RULES.Income.some(k => d.includes(k))) return 'Income';
        
        // Default income to Income category (positive amounts that aren't transfers)
        return 'Income';
    }
    
    // PRIORITY 4: Regular AUTO_RULES for expenses (use cleaned description)
    for (const [cat, kws] of Object.entries(AUTO_RULES)) {
        if (kws.some(k => d.includes(k))) return cat;
    }
    
    // PRIORITY 5: Default - return null (will become Uncategorized)
    return null;
};

// ============== DATA STORAGE ==============
const loadExpenses = () => {
    try {
        const s = localStorage.getItem('expense_v9');
        return s ? JSON.parse(s).filter(e => e && typeof e.amount === 'number') : [];
    } catch { return []; }
};

const loadMerchantRules = () => {
    try {
        const s = localStorage.getItem('merchant_rules_v2');
        if (s) return JSON.parse(s);
        
        // Migrate from old format (merchant_rules)
        const oldRules = localStorage.getItem('merchant_rules');
        if (oldRules) {
            const parsed = JSON.parse(oldRules);
            // Convert old format {merchant: category} to new {merchant: {category, scope: 'global'}}
            const migrated = {};
            Object.entries(parsed).forEach(([merchant, value]) => {
                if (typeof value === 'string') {
                    migrated[merchant] = { category: value, scope: 'global' };
                } else {
                    migrated[merchant] = value; // Already in new format
                }
            });
            return migrated;
        }
        return {};
    } catch { return {}; }
};

// Get the rule key for account-specific rules (now uses merchant only, accounts stored in rule)
const getAccountsRuleKey = (merchant) => `${merchant}|||accounts`;

// Get effective category for a transaction
const getEffectiveCategory = (expense, merchantRules) => {
    const merchant = cleanMerchant(expense.description);
    const account = expense.account || '';
    const transactionType = expense.transactionType || 'expense';
    
    // Priority 1: Multi-Account Rule (check if this account is in the rule's accounts list)
    const accountsKey = getAccountsRuleKey(merchant);
    if (merchantRules[accountsKey]) {
        const rule = merchantRules[accountsKey];
        // Check if transaction's account is in the rule's accounts array
        if (rule.accounts && Array.isArray(rule.accounts) && rule.accounts.includes(account)) {
            return { category: rule.category, source: 'rule-accounts', accounts: rule.accounts };
        }
    }
    
    // Priority 1b: Legacy single-account rule (for backward compatibility)
    const legacyAccountKey = `${merchant}|||${account}`;
    if (merchantRules[legacyAccountKey]) {
        const rule = merchantRules[legacyAccountKey];
        return { category: rule.category, source: 'rule-account', account: account };
    }
    
    // Priority 2: Global Merchant Rule
    if (merchantRules[merchant] && merchantRules[merchant].scope === 'global') {
        return { category: merchantRules[merchant].category, source: 'rule-global' };
    }
    
    // Priority 3: Manual Override (single transaction)
    if (expense.manualCategory) {
        return { category: expense.manualCategory, source: 'manual' };
    }
    
    // Priority 4: Auto-detected rule (with transaction type awareness)
    const autoCategory = autoRuleMatch(expense.description, transactionType);
    if (autoCategory) {
        return { category: autoCategory, source: 'auto' };
    }
    
    // Priority 5: CSV Category (fuzzy matched)
    if (expense.csvCategory && expense.csvCategory !== 'Uncategorized') {
        return { category: expense.csvCategory, source: 'csv' };
    }
    
    return { category: 'Uncategorized', source: 'none' };
};

const Empty = ({ msg }) => <div className="h-full flex items-center justify-center text-slate-400"><div className="text-center"><div className="text-3xl mb-2">üìä</div><p className="text-sm font-medium">{msg}</p></div></div>;

// ============== CHART COMPONENTS ==============
const SVGLine = ({ data, xLabels, h = 200, dots = true }) => {
    if (!data?.length) return <Empty msg="No data" />;
    const pad = { t:20, r:20, b:30, l:50 }, w = 400, cW = w - pad.l - pad.r, cH = h - pad.t - pad.b;
    const vals = data.flatMap(d => d.values.filter(v => v > 0));
    if (!vals.length) return <Empty msg="No data to display" />;
    const yMax = Math.max(...vals) * 1.1, xN = data[0].values.length;
    return (<svg viewBox={`0 0 ${w} ${h}`} className="w-full h-full">
        {[0,.25,.5,.75,1].map(r => <g key={r}><line x1={pad.l} x2={w-pad.r} y1={pad.t+cH*(1-r)} y2={pad.t+cH*(1-r)} stroke="#e2e8f0" strokeDasharray="4"/><text x={pad.l-8} y={pad.t+cH*(1-r)+4} fontSize="9" fill="#94a3b8" textAnchor="end">${(yMax*r/1000).toFixed(1)}k</text></g>)}
        {xLabels?.map((l,i) => <text key={i} x={pad.l+(i/(xN-1||1))*cW} y={h-8} fontSize="9" fill="#94a3b8" textAnchor="middle">{l}</text>)}
        {data.map((s,si) => {
            const pts = s.values.map((v,i) => v > 0 ? { x:pad.l+(i/(xN-1||1))*cW, y:pad.t+cH-(v/yMax)*cH, v } : null).filter(Boolean);
            if (pts.length < 2) return null;
            return (<g key={si}><path d={pts.map((p,i) => `${i?'L':'M'} ${p.x} ${p.y}`).join(' ')} className="line-path" stroke={s.color}/>{dots && pts.map((p,i) => <circle key={i} cx={p.x} cy={p.y} r="4" fill={s.color}><title>{s.label}: ${p.v.toLocaleString()}</title></circle>)}</g>);
        })}
    </svg>);
};

const Legend = ({ years }) => <div className="flex flex-wrap gap-3 justify-center pt-2 border-t border-slate-100">{years.map(y => <div key={y} className="flex items-center gap-1"><div className="w-3 h-3 rounded" style={{backgroundColor:YEAR_COLORS[y]||'#6366f1'}}/><span className="text-[10px] font-bold text-slate-500">{y}</span></div>)}</div>;

const SeasonalityChart = ({ expenses, merchantRules }) => {
    const { data, years } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const data = yrs.map(y => {
            const mt = Array(12).fill(0);
            sp.filter(e => getY(e.date) === y).forEach(e => mt[getM(e.date)] += safe(e.amount));
            return { label: String(y), color: YEAR_COLORS[y] || '#6366f1', values: mt };
        });
        return { data, years: yrs };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="Import data to see seasonality" />;
    return (<div className="h-full flex flex-col">
        <div className="flex-1 min-h-0 overflow-hidden"><SVGLine data={data} xLabels={MONTHS} h={220}/></div>
        <div className="flex-shrink-0"><Legend years={years}/></div>
    </div>);
};

const PaceChart = ({ expenses, merchantRules }) => {
    const { data, years } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const data = yrs.map(y => {
            const ye = sp.filter(e => getY(e.date) === y).sort((a,b) => pDate(a.date) - pDate(b.date));
            const dt = Array(366).fill(null);
            let cum = 0;
            ye.forEach(e => { cum += safe(e.amount); dt[getDoY(e.date)] = cum; });
            let last = 0;
            for (let i = 0; i < 366; i++) { if (dt[i] !== null) last = dt[i]; else if (last > 0) dt[i] = last; }
            const sam = []; for (let i = 0; i < 365; i += 30) sam.push(dt[i] || 0);
            return { label: String(y), color: YEAR_COLORS[y] || '#6366f1', values: sam };
        });
        return { data, years: yrs };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="Import data to see pace" />;
    return (<div className="h-full flex flex-col">
        <div className="flex-1 min-h-0 overflow-hidden"><SVGLine data={data} xLabels={MONTHS} h={220} dots={false}/></div>
        <div className="flex-shrink-0"><Legend years={years}/></div>
    </div>);
};

// Category Evolution - vertical year layout, two columns
const CategoryEvolution = ({ expenses, merchantRules }) => {
    const { data, years } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const year = getY(e.date);
            return !EXCLUDED_CATEGORIES.includes(cat) && cat !== 'Uncategorized' && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const cyt = {};
        sp.forEach(e => { 
            const y = getY(e.date); 
            if (!yrs.includes(y)) return; 
            const cat = getEffectiveCategory(e, merchantRules).category;
            if (!cyt[cat]) cyt[cat] = {}; 
            cyt[cat][y] = (cyt[cat][y]||0) + safe(e.amount); 
        });
        const cy = yrs[yrs.length-1];
        const data = Object.entries(cyt).map(([c,yt]) => ({ 
            category: c, 
            yearData: yrs.map(y => ({ year: y, value: yt[y] || 0 })),
            cur: yt[cy] || 0 
        })).sort((a,b) => b.cur - a.cur).slice(0, 10);
        return { data, years: yrs };
    }, [expenses, merchantRules]);
    
    if (!data.length) return <Empty msg="Import data to compare" />;
    const mx = Math.max(...data.flatMap(d => d.yearData.map(y => y.value)));
    
    // Split into two columns
    const midpoint = Math.ceil(data.length / 2);
    const leftColumn = data.slice(0, midpoint);
    const rightColumn = data.slice(midpoint);
    
    const CategoryBlock = ({ item }) => (
        <div className="bg-slate-50 rounded-lg p-2">
            <div className="text-[11px] font-bold text-slate-700 mb-2 truncate" title={item.category}>
                {item.category}
            </div>
            <div className="space-y-1.5">
                {item.yearData.map(({ year, value }) => (
                    <div key={year} className="flex items-center gap-2">
                        <div className="w-10 text-[9px] font-bold text-slate-400">{year}</div>
                        <div className="flex-1 h-5 bg-slate-200 rounded overflow-hidden relative">
                            <div 
                                className="h-full rounded transition-all" 
                                style={{
                                    width: `${mx > 0 ? Math.max((value / mx) * 100, 0) : 0}%`,
                                    backgroundColor: YEAR_COLORS[year] || '#6366f1'
                                }}
                            />
                        </div>
                        <div className="w-16 text-[10px] font-bold text-slate-600 text-right">
                            {value > 0 ? `$${(value / 1000).toFixed(1)}k` : '$0'}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 min-h-0 overflow-auto">
                <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-3">
                        {leftColumn.map(item => <CategoryBlock key={item.category} item={item} />)}
                    </div>
                    <div className="space-y-3">
                        {rightColumn.map(item => <CategoryBlock key={item.category} item={item} />)}
                    </div>
                </div>
            </div>
            <div className="flex-shrink-0"><Legend years={years}/></div>
        </div>
    );
};

const Heatmap = ({ expenses, merchantRules }) => {
    const { data, years, min, max } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const data = {};
        sp.forEach(e => { const y = getY(e.date), m = getM(e.date); if (!data[y]) data[y] = Array(12).fill(0); data[y][m] += safe(e.amount); });
        const all = Object.values(data).flatMap(a => a.filter(v => v > 0));
        return { data, years: yrs, min: all.length ? Math.min(...all) : 0, max: all.length ? Math.max(...all) : 1 };
    }, [expenses, merchantRules]);
    if (!years.length) return <Empty msg="Import data for heatmap" />;
    const getCol = v => { if (!v) return '#f8fafc'; const r = (v-min)/(max-min||1); return r<.5 ? `rgb(${34+r*2*216},${197+r*2*7},${94-r*2*94})` : `rgb(${250-(r-.5)*2*11},${204-(r-.5)*2*136},${(r-.5)*2*68})`; };
    return (<div className="h-full flex flex-col"><div className="flex-1 min-h-0 overflow-auto"><table className="w-full text-[10px]"><thead><tr><th className="p-1 text-slate-400 text-left">Year</th>{MONTHS.map(m=><th key={m} className="p-1 text-slate-400 text-center">{m}</th>)}<th className="p-1 text-slate-400 text-right">Total</th></tr></thead><tbody>
        {years.map(y => { const yd = data[y]||Array(12).fill(0), tot = yd.reduce((a,b)=>a+b,0); return (<tr key={y}><td className="p-1 font-bold text-slate-700">{y}</td>{yd.map((v,i)=><td key={i} className="p-0.5"><div className="rounded p-1 text-center font-bold" style={{backgroundColor:getCol(v),color:v>max*.6?'white':'#334155'}}>{v>0?`${(v/1000).toFixed(1)}k`:'-'}</div></td>)}<td className="p-1 font-black text-slate-900 text-right">${tot.toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>); })}
    </tbody></table></div><div className="flex-shrink-0 flex items-center justify-center gap-2 pt-2 border-t border-slate-100 mt-2"><span className="text-[10px] text-slate-400">Low</span><div className="flex h-3 rounded overflow-hidden">{[0,.25,.5,.75,1].map(r=><div key={r} className="w-6 h-full" style={{backgroundColor:getCol(min+r*(max-min))}}/>)}</div><span className="text-[10px] text-slate-400">High</span></div></div>);
};

const AccountTotalsChart = ({ expenses, merchantRules }) => {
    const { data, years, maxVal } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const byAccount = {};
        sp.forEach(e => { const acc = e.account || 'Unknown', year = getY(e.date); if (!byAccount[acc]) byAccount[acc] = {}; byAccount[acc][year] = (byAccount[acc][year] || 0) + safe(e.amount); });
        const yearsSet = new Set(sp.map(e => getY(e.date)));
        const years = [...yearsSet].sort();
        const data = Object.entries(byAccount).map(([account, yearTotals]) => ({ account, years: years.map(y => yearTotals[y] || 0), total: Object.values(yearTotals).reduce((s, v) => s + v, 0) })).sort((a, b) => b.total - a.total);
        const maxVal = Math.max(...data.flatMap(d => d.years));
        return { data, years, maxVal };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="Import data to see account totals" />;
    return (<div className="h-full flex flex-col">
        <div className="flex-1 min-h-0 overflow-auto space-y-2">
            {data.map(item => (<div key={item.account} className="space-y-1"><div className="text-[10px] font-bold text-slate-700 truncate">{item.account}</div><div className="flex gap-1">{item.years.map((val, yi) => (<div key={yi} className="flex-1 flex items-center gap-1"><div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden"><div className="h-full rounded" style={{width: `${maxVal > 0 ? (val / maxVal) * 100 : 0}%`, backgroundColor: YEAR_COLORS[years[yi]] || '#6366f1'}}/></div><span className="text-[9px] font-semibold text-slate-500 w-14 text-right">{val > 0 ? `$${(val/1000).toFixed(1)}k` : '-'}</span></div>))}</div></div>))}
        </div>
        <div className="flex-shrink-0"><Legend years={years}/></div>
    </div>);
};

// Cost Structure Chart - Dashboard version (2025 only)
const CostStructureChart = ({ expenses, merchantRules }) => {
    const data = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            return !EXCLUDED_CATEGORIES.includes(cat) && getY(e.date) === 2025;
        });
        
        // Group by month and cost type
        const byMonth = {};
        sp.forEach(e => {
            const month = getM(e.date);
            const cat = getEffectiveCategory(e, merchantRules).category;
            const costType = getCostType(cat);
            
            if (!byMonth[month]) byMonth[month] = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 };
            byMonth[month][costType] += safe(e.amount);
            byMonth[month].total += safe(e.amount);
        });
        
        // Convert to array format
        return MONTHS.map((name, i) => ({
            month: name,
            monthIndex: i,
            ...byMonth[i] || { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 }
        }));
    }, [expenses, merchantRules]);
    
    const maxTotal = Math.max(...data.map(d => d.total), 1);
    const hasData = data.some(d => d.total > 0);
    const chartHeight = 160; // Fixed pixel height for bars area
    
    if (!hasData) return <Empty msg="No 2025 data for cost structure" />;
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 flex items-end gap-1 pb-1">
                {data.map((d, i) => {
                    const barHeight = d.total > 0 ? (d.total / maxTotal) * chartHeight : 0;
                    const fixedH = d.total > 0 ? (d.Fixed / d.total) * barHeight : 0;
                    const semiH = d.total > 0 ? (d['Semi-Fixed'] / d.total) * barHeight : 0;
                    const varH = d.total > 0 ? (d.Variable / d.total) * barHeight : 0;
                    
                    return (
                        <div key={i} className="flex-1 flex flex-col items-center group">
                            <div className="relative w-full flex flex-col justify-end" style={{ height: chartHeight }}>
                                {/* Total label on hover */}
                                {d.total > 0 && (
                                    <div className="absolute -top-4 left-1/2 -translate-x-1/2 text-[8px] font-bold text-slate-600 opacity-0 group-hover:opacity-100 whitespace-nowrap z-10">
                                        ${(d.total/1000).toFixed(1)}k
                                    </div>
                                )}
                                {/* Stacked bars - Fixed at bottom, Variable at top */}
                                <div 
                                    className="w-full cursor-pointer"
                                    title={`${d.month}: $${d.total.toLocaleString()}\nFixed: $${d.Fixed.toLocaleString()}\nSemi-Fixed: $${d['Semi-Fixed'].toLocaleString()}\nVariable: $${d.Variable.toLocaleString()}`}
                                >
                                    {varH > 0 && <div style={{ height: varH, backgroundColor: COST_TYPE_COLORS.Variable }} className="w-full rounded-t" />}
                                    {semiH > 0 && <div style={{ height: semiH, backgroundColor: COST_TYPE_COLORS['Semi-Fixed'] }} className="w-full" />}
                                    {fixedH > 0 && <div style={{ height: fixedH, backgroundColor: COST_TYPE_COLORS.Fixed }} className="w-full rounded-b" />}
                                </div>
                            </div>
                            <div className="text-[9px] text-slate-400 mt-1 font-semibold">{d.month}</div>
                        </div>
                    );
                })}
            </div>
            {/* Legend */}
            <div className="flex-shrink-0 flex justify-center gap-4 pt-2 border-t border-slate-100">
                {['Fixed', 'Semi-Fixed', 'Variable'].map(type => (
                    <div key={type} className="flex items-center gap-1">
                        <div className="w-3 h-3 rounded" style={{ backgroundColor: COST_TYPE_COLORS[type] }} />
                        <span className="text-[10px] font-bold text-slate-500">{type}</span>
                    </div>
                ))}
            </div>
        </div>
    );
};

// Cost Structure Evolution - 2024 vs 2025 side by side
const CostStructureEvolution = ({ expenses, merchantRules }) => {
    const { data, maxTotal } = useMemo(() => {
        const years = [2024, 2025];
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const year = getY(e.date);
            return !EXCLUDED_CATEGORIES.includes(cat) && (year === 2024 || year === 2025);
        });
        
        // Group by year, month, and cost type
        const byYearMonth = {};
        years.forEach(y => { byYearMonth[y] = {}; });
        
        sp.forEach(e => {
            const year = getY(e.date);
            const month = getM(e.date);
            const cat = getEffectiveCategory(e, merchantRules).category;
            const costType = getCostType(cat);
            
            if (!byYearMonth[year][month]) {
                byYearMonth[year][month] = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 };
            }
            byYearMonth[year][month][costType] += safe(e.amount);
            byYearMonth[year][month].total += safe(e.amount);
        });
        
        // Build data array
        const data = MONTHS.map((name, i) => ({
            month: name,
            monthIndex: i,
            years: years.map(y => ({
                year: y,
                ...(byYearMonth[y][i] || { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 })
            }))
        }));
        
        const maxTotal = Math.max(...data.flatMap(d => d.years.map(y => y.total)), 1);
        
        return { data, maxTotal };
    }, [expenses, merchantRules]);
    
    const hasData = data.some(d => d.years.some(y => y.total > 0));
    const chartHeight = 160; // Fixed pixel height
    
    if (!hasData) return <Empty msg="No data for cost structure comparison" />;
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 flex items-end gap-1 pb-1">
                {data.map((d, i) => (
                    <div key={i} className="flex-1 flex flex-col items-center">
                        {/* Month bars - 2024 and 2025 side by side */}
                        <div className="flex gap-0.5 w-full justify-center" style={{ height: chartHeight }}>
                            {d.years.map((yearData, yi) => {
                                const barHeight = yearData.total > 0 ? (yearData.total / maxTotal) * chartHeight : 0;
                                const fixedH = yearData.total > 0 ? (yearData.Fixed / yearData.total) * barHeight : 0;
                                const semiH = yearData.total > 0 ? (yearData['Semi-Fixed'] / yearData.total) * barHeight : 0;
                                const varH = yearData.total > 0 ? (yearData.Variable / yearData.total) * barHeight : 0;
                                
                                return (
                                    <div 
                                        key={yi}
                                        className="flex-1 flex flex-col justify-end cursor-pointer"
                                        style={{ opacity: yi === 0 ? 0.6 : 1 }}
                                        title={`${d.month} ${yearData.year}: $${yearData.total.toLocaleString()}\nFixed: $${yearData.Fixed.toLocaleString()}\nSemi-Fixed: $${yearData['Semi-Fixed'].toLocaleString()}\nVariable: $${yearData.Variable.toLocaleString()}`}
                                    >
                                        {varH > 0 && <div style={{ height: varH, backgroundColor: COST_TYPE_COLORS.Variable }} className="w-full rounded-t" />}
                                        {semiH > 0 && <div style={{ height: semiH, backgroundColor: COST_TYPE_COLORS['Semi-Fixed'] }} className="w-full" />}
                                        {fixedH > 0 && <div style={{ height: fixedH, backgroundColor: COST_TYPE_COLORS.Fixed }} className="w-full rounded-b" />}
                                    </div>
                                );
                            })}
                        </div>
                        <div className="text-[8px] text-slate-400 text-center mt-1 font-semibold">{d.month}</div>
                    </div>
                ))}
            </div>
            {/* Combined Legend */}
            <div className="flex-shrink-0 border-t border-slate-100 pt-2">
                <div className="flex justify-center gap-4 mb-1">
                    {['Fixed', 'Semi-Fixed', 'Variable'].map(type => (
                        <div key={type} className="flex items-center gap-1">
                            <div className="w-2.5 h-2.5 rounded" style={{ backgroundColor: COST_TYPE_COLORS[type] }} />
                            <span className="text-[9px] font-bold text-slate-500">{type}</span>
                        </div>
                    ))}
                </div>
                <div className="flex justify-center gap-3">
                    <div className="flex items-center gap-1">
                        <div className="w-3 h-2 bg-slate-400 rounded opacity-60" />
                        <span className="text-[9px] text-slate-400">2024</span>
                    </div>
                    <div className="flex items-center gap-1">
                        <div className="w-3 h-2 bg-slate-600 rounded" />
                        <span className="text-[9px] text-slate-400">2025</span>
                    </div>
                </div>
            </div>
        </div>
    );
};

// Dashboard Charts (2025 filtered)
const Stats = ({ expenses, merchantRules }) => {
    const { tot, cnt, avg } = useMemo(() => {
        const sp = expenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const tot = sp.reduce((s,e) => s + safe(e.amount), 0);
        return { tot, cnt: sp.length, avg: sp.length ? tot/sp.length : 0 };
    }, [expenses, merchantRules]);
    return (<div className="grid grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Spent (2025)</h3><p className="text-2xl font-black text-slate-900 mt-1">${tot.toLocaleString(undefined,{maximumFractionDigits:0})}</p></div>
        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-[10px] font-bold text-slate-400 uppercase">Transactions (2025)</h3><p className="text-2xl font-black text-slate-900 mt-1">{cnt}</p></div>
        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-[10px] font-bold text-slate-400 uppercase">Avg Transaction</h3><p className="text-2xl font-black text-slate-900 mt-1">${avg.toFixed(0)}</p></div>
    </div>);
};

const Pareto = ({ expenses, merchantRules }) => {
    const { data, total } = useMemo(() => {
        const sp = expenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const bc = {}; sp.forEach(e => { const cat = getEffectiveCategory(e, merchantRules).category; bc[cat] = (bc[cat]||0) + safe(e.amount); });
        const sorted = Object.entries(bc).map(([n,v]) => ({name:n,value:v})).sort((a,b) => b.value - a.value);
        const tot = sorted.reduce((s,i) => s + i.value, 0);
        return { data: sorted.map(i => ({...i, pct: tot > 0 ? (i.value / tot) * 100 : 0 })), total: tot };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="No 2025 data" />;
    const mx = Math.max(...data.map(d => d.value));
    return (<div className="h-full flex flex-col">
        <div className="flex-1 overflow-auto space-y-1.5">
            {data.map(i => <div key={i.name} className="flex items-center gap-2">
                <div className="w-24 text-[10px] font-semibold text-slate-600 truncate text-right" title={i.name}>{i.name}</div>
                <div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden">
                    <div className="h-full rounded" style={{width:`${i.value/mx*100}%`,backgroundColor:CAT_COLORS[i.name]||'#6366f1'}}/>
                </div>
                <div className="w-16 text-[10px] font-bold text-slate-700 text-right">${(i.value/1000).toFixed(1)}k</div>
                <div className="w-10 text-[10px] font-bold text-slate-500 text-right">{i.pct.toFixed(0)}%</div>
            </div>)}
        </div>
        <div className="text-[10px] text-slate-400 text-center pt-2 border-t border-slate-100 mt-2">
            Total: <span className="font-bold text-slate-600">${total.toLocaleString(undefined,{maximumFractionDigits:0})}</span>
        </div>
    </div>);
};

const TopMerchants = ({ expenses, merchantRules }) => {
    const { data, total } = useMemo(() => {
        const sp = expenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const total = sp.reduce((s, e) => s + safe(e.amount), 0);
        const byMerchant = {};
        sp.forEach(e => { const name = cleanMerchant(e.description); byMerchant[name] = (byMerchant[name] || 0) + safe(e.amount); });
        const sorted = Object.entries(byMerchant).map(([name, value]) => ({ name, value, pct: total > 0 ? (value / total) * 100 : 0 })).sort((a, b) => b.value - a.value).slice(0, 20);
        return { data: sorted, total };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="No 2025 data" />;
    const mx = data[0]?.value || 1;
    return (<div className="h-full flex flex-col"><div className="flex-1 space-y-1 overflow-auto">
        {data.map((m, i) => (<div key={m.name} className="flex items-center gap-2"><div className="w-5 text-[10px] font-black text-slate-400">{i + 1}</div><div className="w-28 text-[10px] font-semibold text-slate-600 truncate" title={m.name}>{m.name}</div><div className="flex-1 h-4 bg-slate-100 rounded overflow-hidden"><div className="h-full rounded bg-gradient-to-r from-indigo-500 to-purple-500" style={{width:`${m.value/mx*100}%`}}/></div><div className="w-14 text-[9px] font-bold text-slate-700 text-right">${m.value.toLocaleString(undefined,{maximumFractionDigits:0})}</div><div className="w-10 text-[9px] font-semibold text-slate-400 text-right">{m.pct.toFixed(1)}%</div></div>))}
    </div><div className="text-[10px] text-slate-400 text-center pt-2 border-t border-slate-100 mt-2">Top 20 = ${data.reduce((s,m)=>s+m.value,0).toLocaleString(undefined,{maximumFractionDigits:0})}</div></div>);
};

const RecurringCosts = ({ expenses, merchantRules }) => {
    const { recurring, totalMonthly, totalYearly } = useMemo(() => {
        const sp2025 = expenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const byMerchant = {};
        sp2025.forEach(e => { const name = cleanMerchant(e.description); if (!byMerchant[name]) byMerchant[name] = { amounts: [], months: new Set(), total: 0 }; byMerchant[name].amounts.push(safe(e.amount)); byMerchant[name].months.add(getM(e.date)); byMerchant[name].total += safe(e.amount); });
        const recurring = [];
        Object.entries(byMerchant).forEach(([name, data]) => {
            if (data.months.size >= 2) {
                const amounts = data.amounts.sort((a,b) => a - b);
                const median = amounts[Math.floor(amounts.length / 2)];
                const consistent = amounts.filter(a => Math.abs(a - median) / median < 0.2).length;
                if (consistent >= data.months.size * 0.6) recurring.push({ name, monthlyAvg: data.total / data.months.size, totalYear: data.total, months: data.months.size });
            }
        });
        recurring.sort((a, b) => b.totalYear - a.totalYear);
        const totalYearly = recurring.reduce((s, r) => s + r.totalYear, 0);
        const totalMonthly = recurring.reduce((s, r) => s + r.monthlyAvg, 0);
        return { recurring: recurring.slice(0, 12), totalMonthly, totalYearly };
    }, [expenses, merchantRules]);
    if (!recurring.length) return <Empty msg="No recurring costs detected" />;
    return (<div className="h-full flex flex-col"><div className="flex-1 overflow-auto"><table className="w-full text-[10px]"><thead className="sticky top-0 bg-white"><tr className="text-slate-400 uppercase font-bold"><th className="text-left p-1.5">Merchant</th><th className="text-center p-1.5">Freq</th><th className="text-right p-1.5">Monthly</th><th className="text-right p-1.5">2025</th></tr></thead><tbody className="divide-y divide-slate-50">
        {recurring.map((r, i) => (<tr key={r.name} className="hover:bg-slate-50"><td className="p-1.5 font-semibold text-slate-700 truncate max-w-[120px]" title={r.name}><span className="inline-flex items-center gap-1"><span className="w-4 h-4 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center text-[8px] font-black">{i+1}</span>{r.name}</span></td><td className="p-1.5 text-center text-slate-500">{r.months}mo</td><td className="p-1.5 text-right font-bold text-slate-700">${r.monthlyAvg.toFixed(0)}</td><td className="p-1.5 text-right font-black text-indigo-600">${r.totalYear.toFixed(0)}</td></tr>))}
    </tbody></table></div><div className="pt-2 border-t border-slate-100 mt-2 flex justify-between items-center"><div className="text-[10px] text-slate-400">üîÑ {recurring.length} recurring</div><div className="text-right"><div className="text-[10px] font-bold text-slate-600">~${totalMonthly.toFixed(0)}/mo</div><div className="text-[11px] font-black text-indigo-600">${totalYearly.toLocaleString(undefined,{maximumFractionDigits:0})} YTD</div></div></div></div>);
};

// Subscriptions - exact same amount for 3+ consecutive months
const Subscriptions = ({ expenses, merchantRules }) => {
    const { subscriptions, totalMonthly, totalYearly } = useMemo(() => {
        const sp2025 = expenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const byMerchant = {};
        
        // Group by merchant and track amounts per month
        sp2025.forEach(e => {
            const name = cleanMerchant(e.description);
            const month = getM(e.date);
            const amount = safe(e.amount);
            
            if (!byMerchant[name]) byMerchant[name] = { monthlyAmounts: {}, total: 0 };
            
            // Store the amount for each month (use the first transaction of the month)
            if (!byMerchant[name].monthlyAmounts[month]) {
                byMerchant[name].monthlyAmounts[month] = amount;
            }
            byMerchant[name].total += amount;
        });
        
        const subscriptions = [];
        
        Object.entries(byMerchant).forEach(([name, data]) => {
            const months = Object.keys(data.monthlyAmounts).map(Number).sort((a, b) => a - b);
            if (months.length < 3) return; // Need at least 3 months
            
            // Find sequences of consecutive months with exact same amount
            let maxConsecutive = 1;
            let currentConsecutive = 1;
            let subscriptionAmount = null;
            let bestAmount = null;
            
            for (let i = 1; i < months.length; i++) {
                const prevMonth = months[i - 1];
                const currMonth = months[i];
                const prevAmount = data.monthlyAmounts[prevMonth];
                const currAmount = data.monthlyAmounts[currMonth];
                
                // Check if consecutive month AND exact same amount (within 1 cent tolerance)
                const isConsecutive = (currMonth === prevMonth + 1) || (prevMonth === 11 && currMonth === 0);
                const isSameAmount = Math.abs(prevAmount - currAmount) < 0.02;
                
                if (isConsecutive && isSameAmount) {
                    currentConsecutive++;
                    if (currentConsecutive > maxConsecutive) {
                        maxConsecutive = currentConsecutive;
                        bestAmount = currAmount;
                    }
                } else {
                    currentConsecutive = 1;
                }
            }
            
            // Only include if 3+ consecutive months with exact same amount
            if (maxConsecutive >= 3 && bestAmount !== null) {
                subscriptions.push({
                    name,
                    amount: bestAmount,
                    months: maxConsecutive,
                    totalYear: data.total
                });
            }
        });
        
        subscriptions.sort((a, b) => b.totalYear - a.totalYear);
        const totalYearly = subscriptions.reduce((s, r) => s + r.totalYear, 0);
        const totalMonthly = subscriptions.reduce((s, r) => s + r.amount, 0);
        
        return { subscriptions: subscriptions.slice(0, 12), totalMonthly, totalYearly };
    }, [expenses, merchantRules]);
    
    if (!subscriptions.length) return <Empty msg="No subscriptions detected (3+ months same amount)" />;
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 overflow-auto">
                <table className="w-full text-[10px]">
                    <thead className="sticky top-0 bg-white">
                        <tr className="text-slate-400 uppercase font-bold">
                            <th className="text-left p-1.5">Service</th>
                            <th className="text-center p-1.5">Streak</th>
                            <th className="text-right p-1.5">Amount</th>
                            <th className="text-right p-1.5">2025</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                        {subscriptions.map((s, i) => (
                            <tr key={s.name} className="hover:bg-emerald-50">
                                <td className="p-1.5 font-semibold text-slate-700 truncate max-w-[120px]" title={s.name}>
                                    <span className="inline-flex items-center gap-1">
                                        <span className="w-4 h-4 rounded bg-emerald-100 text-emerald-600 flex items-center justify-center text-[8px] font-black">{i+1}</span>
                                        {s.name}
                                    </span>
                                </td>
                                <td className="p-1.5 text-center">
                                    <span className="px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded font-bold">{s.months}mo</span>
                                </td>
                                <td className="p-1.5 text-right font-bold text-slate-700">${s.amount.toFixed(2)}</td>
                                <td className="p-1.5 text-right font-black text-emerald-600">${s.totalYear.toFixed(0)}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div className="pt-2 border-t border-slate-100 mt-2 flex justify-between items-center">
                <div className="text-[10px] text-slate-400">üì∫ {subscriptions.length} subscriptions</div>
                <div className="text-right">
                    <div className="text-[10px] font-bold text-slate-600">${totalMonthly.toFixed(2)}/mo</div>
                    <div className="text-[11px] font-black text-emerald-600">${totalYearly.toLocaleString(undefined,{maximumFractionDigits:0})} YTD</div>
                </div>
            </div>
        </div>
    );
};

const SmallPurchaseMerchants = ({ expenses, merchantRules }) => {
    const { data, grandTotal } = useMemo(() => {
        const sp2025 = expenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        if (!sp2025.length) return { data: [], grandTotal: 0 };
        const byMerchant = {};
        sp2025.forEach(e => { const name = cleanMerchant(e.description); if (!byMerchant[name]) byMerchant[name] = { total: 0, count: 0 }; byMerchant[name].total += safe(e.amount); byMerchant[name].count += 1; });
        const filtered = Object.entries(byMerchant).map(([name, d]) => ({ name, total: d.total, count: d.count, avg: d.total / d.count })).filter(m => m.avg < 20).sort((a, b) => b.total - a.total).slice(0, 10);
        const grandTotal = filtered.reduce((s, m) => s + m.total, 0);
        return { data: filtered, grandTotal };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="No purchases under $20 avg" />;
    const mx = data[0]?.total || 1;
    return (<div className="h-full flex flex-col"><div className="flex-1 space-y-1.5 overflow-auto">
        {data.map((m, i) => (<div key={m.name} className="flex items-center gap-2"><div className="w-5 text-[10px] font-black text-red-400">{i + 1}</div><div className="w-24 text-[10px] font-semibold text-slate-600 truncate" title={m.name}>{m.name}</div><div className="flex-1 h-5 bg-red-50 rounded overflow-hidden"><div className="h-full rounded bg-gradient-to-r from-red-400 to-orange-400" style={{width:`${m.total/mx*100}%`}}/></div><div className="w-10 text-[9px] text-slate-400 text-center">{m.count}x</div><div className="w-12 text-[9px] text-slate-500 text-right">~${m.avg.toFixed(0)}</div><div className="w-14 text-[10px] font-bold text-red-600 text-right">${m.total.toFixed(0)}</div></div>))}
    </div><div className="pt-2 border-t border-slate-100 mt-2 flex justify-between items-center"><div className="text-[10px] text-slate-400">‚òï Avg &lt;$20/txn</div><div className="text-[11px] font-black text-red-600">${grandTotal.toLocaleString(undefined,{maximumFractionDigits:0})} total</div></div></div>);
};

const Scatter = ({ expenses, merchantRules }) => {
    const { pts, minD, maxD, maxA } = useMemo(() => {
        const sp = expenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        if (!sp.length) return { pts:[], minD:0, maxD:1, maxA:100 };
        const pts = sp.map(e => ({ d:pDate(e.date).getTime(), a:safe(e.amount), desc:e.description }));
        const ds = pts.map(p => p.d), as = pts.map(p => p.a);
        return { pts, minD:Math.min(...ds), maxD:Math.max(...ds), maxA:Math.max(...as) };
    }, [expenses, merchantRules]);
    if (!pts.length) return <Empty msg="No 2025 data" />;
    const range = maxD - minD || 1;
    const small = pts.filter(p => p.a < 20).length;
    const pct = (small/pts.length*100).toFixed(0);
    return (<div className="h-full flex flex-col"><div className="flex-1 relative bg-slate-50 rounded-lg overflow-hidden">
        <div className="absolute left-0 right-0 border-t border-dashed border-red-300" style={{bottom:`${20/maxA*100}%`}}><span className="absolute -top-2 left-1 text-[8px] font-bold text-red-400">$20</span></div>
        {pts.map((p,i) => <div key={i} className={`absolute w-2 h-2 rounded-full ${p.a<20?'bg-red-400':'bg-indigo-400'}`} style={{left:`${(p.d-minD)/range*100}%`,bottom:`${p.a/maxA*100}%`,opacity:.7}} title={`$${p.a.toFixed(2)}`}/>)}
    </div><div className="text-[10px] text-slate-400 text-center pt-2 border-t border-slate-100 mt-2">üî¥ {pct}% under $20</div></div>);
};

// ============== CATEGORY MANAGEMENT PAGE ==============
const CategoryEditModal = ({ expense, merchantRules, allAccounts, onSave, onClose }) => {
    const merchant = cleanMerchant(expense.description);
    const account = expense.account || 'Unknown';
    const currentEffective = getEffectiveCategory(expense, merchantRules);
    const [selectedCategory, setSelectedCategory] = useState(currentEffective.category);
    const [applyToAll, setApplyToAll] = useState(true);
    const [scope, setScope] = useState('global'); // 'global' or 'accounts'
    const [selectedAccounts, setSelectedAccounts] = useState([account]); // Default to current account

    const toggleAccount = (acc) => {
        if (selectedAccounts.includes(acc)) {
            // Don't allow deselecting all - must have at least one
            if (selectedAccounts.length > 1) {
                setSelectedAccounts(selectedAccounts.filter(a => a !== acc));
            }
        } else {
            setSelectedAccounts([...selectedAccounts, acc]);
        }
    };

    const selectAllAccounts = () => setSelectedAccounts([...allAccounts]);
    const clearAccountSelection = () => setSelectedAccounts([account]); // Reset to current

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={onClose}/>
            <div className="relative bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
                <div className="p-6 border-b border-slate-100">
                    <h2 className="text-lg font-black text-slate-800">Edit Category</h2>
                    <p className="text-sm text-slate-500 mt-1 truncate" title={expense.description}>{expense.description}</p>
                </div>
                <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Merchant</label>
                            <div className="p-3 bg-slate-50 rounded-xl text-sm font-semibold text-slate-700 truncate" title={merchant}>{merchant}</div>
                        </div>
                        <div>
                            <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Account</label>
                            <div className="p-3 bg-blue-50 rounded-xl text-sm font-semibold text-blue-700 truncate" title={account}>{account}</div>
                        </div>
                    </div>
                    <div>
                        <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Original CSV Category</label>
                        <div className="p-3 bg-amber-50 rounded-xl text-sm font-semibold text-amber-700">{expense.csvCategory || 'None'}</div>
                    </div>
                    <div>
                        <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">New Category</label>
                        <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)}
                            className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none border-2 border-transparent focus:border-indigo-500">
                            <option value="Uncategorized">Uncategorized</option>
                            {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    
                    {/* Apply to all toggle */}
                    <div className="p-4 bg-slate-50 rounded-xl">
                        <label className="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" checked={applyToAll} onChange={e => setApplyToAll(e.target.checked)}
                                className="w-5 h-5 rounded border-slate-300 text-indigo-600 mt-0.5"/>
                            <div>
                                <div className="font-bold text-slate-800 text-sm">Create rule for "{merchant}"</div>
                                <div className="text-xs text-slate-500 mt-1">Apply to all past and future transactions from this merchant</div>
                            </div>
                        </label>
                    </div>

                    {/* Scope selection - only show when creating a rule */}
                    {applyToAll && (
                        <div className="p-4 bg-indigo-50 rounded-xl space-y-3">
                            <label className="text-[10px] font-black uppercase text-indigo-600 block">Rule Scope</label>
                            <div className="space-y-2">
                                <label className="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-indigo-100 transition-colors">
                                    <input type="radio" name="scope" value="global" checked={scope === 'global'} onChange={() => setScope('global')}
                                        className="w-4 h-4 text-indigo-600"/>
                                    <div>
                                        <div className="font-bold text-slate-800 text-sm">üåç Global</div>
                                        <div className="text-xs text-slate-500">Apply to this merchant across ALL accounts</div>
                                    </div>
                                </label>
                                <label className="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-indigo-100 transition-colors">
                                    <input type="radio" name="scope" value="accounts" checked={scope === 'accounts'} onChange={() => setScope('accounts')}
                                        className="w-4 h-4 text-indigo-600"/>
                                    <div>
                                        <div className="font-bold text-slate-800 text-sm">üí≥ Specific Accounts</div>
                                        <div className="text-xs text-slate-500">Apply only for selected accounts</div>
                                    </div>
                                </label>
                            </div>
                            
                            {/* Multi-select accounts - only show when accounts scope selected */}
                            {scope === 'accounts' && (
                                <div className="mt-3 p-3 bg-white rounded-xl border border-indigo-200">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-[10px] font-black uppercase text-slate-500">Select Accounts ({selectedAccounts.length})</span>
                                        <div className="flex gap-2">
                                            <button onClick={selectAllAccounts} className="text-[10px] text-indigo-600 font-bold hover:underline">All</button>
                                            <button onClick={clearAccountSelection} className="text-[10px] text-slate-500 font-bold hover:underline">Reset</button>
                                        </div>
                                    </div>
                                    <div className="space-y-1 max-h-32 overflow-y-auto">
                                        {allAccounts.map(acc => (
                                            <label key={acc} className="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={selectedAccounts.includes(acc)} 
                                                    onChange={() => toggleAccount(acc)}
                                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"
                                                />
                                                <span className={`text-sm ${acc === account ? 'font-bold text-indigo-700' : 'text-slate-700'}`}>
                                                    {acc} {acc === account && '(current)'}
                                                </span>
                                            </label>
                                        ))}
                                    </div>
                                    {selectedAccounts.length > 0 && (
                                        <div className="mt-2 pt-2 border-t border-slate-100">
                                            <div className="text-[10px] text-slate-500">
                                                Selected: {selectedAccounts.join(', ')}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
                <div className="p-6 bg-slate-50 flex gap-4">
                    <button onClick={onClose} className="flex-1 py-3 font-bold text-slate-500 rounded-xl hover:bg-slate-200">Cancel</button>
                    <button onClick={() => onSave(selectedCategory, applyToAll, merchant, scope, selectedAccounts)} className="flex-1 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700">Save</button>
                </div>
            </div>
        </div>
    );
};

// High Impact Mode - Merchant-centric view
const HighImpactView = ({ expenses, merchantRules, onUpdateRule }) => {
    const [sortBy, setSortBy] = useState('total'); // total, count, uncategorized
    const [showCategorized, setShowCategorized] = useState(true);
    
    const merchantData = useMemo(() => {
        const byMerchant = {};
        
        // Only process 2024+ expenses
        expenses.filter(e => isValidYear(e.date)).forEach(e => {
            const merchant = cleanMerchant(e.description);
            const effective = getEffectiveCategory(e, merchantRules);
            
            // Skip excluded for total calculation but track them
            const isExcluded = EXCLUDED_CATEGORIES.includes(effective.category);
            
            if (!byMerchant[merchant]) {
                byMerchant[merchant] = {
                    merchant,
                    total: 0,
                    count: 0,
                    excludedTotal: 0,
                    excludedCount: 0,
                    category: effective.category,
                    source: effective.source,
                    hasRule: !!(merchantRules[merchant]?.scope === 'global'),
                    hasAccountRules: false,
                    csvCategories: new Set(),
                    accounts: new Set()
                };
            }
            
            // Track accounts for this merchant
            if (e.account) byMerchant[merchant].accounts.add(e.account);
            
            // Check for account-specific rules (new multi-account format or legacy)
            const accountsKey = getAccountsRuleKey(merchant);
            const legacyAccountKey = `${merchant}|||${e.account}`;
            if (merchantRules[accountsKey] || merchantRules[legacyAccountKey]) {
                byMerchant[merchant].hasAccountRules = true;
            }
            
            if (isExcluded) {
                byMerchant[merchant].excludedTotal += safe(e.amount);
                byMerchant[merchant].excludedCount += 1;
            } else {
                byMerchant[merchant].total += safe(e.amount);
                byMerchant[merchant].count += 1;
            }
            
            if (e.csvCategory) byMerchant[merchant].csvCategories.add(e.csvCategory);
            
            // Update category info (use first non-excluded transaction's effective category)
            if (!isExcluded) {
                byMerchant[merchant].category = effective.category;
                byMerchant[merchant].source = effective.source;
            }
        });
        
        let data = Object.values(byMerchant);
        
        // Filter out categorized if needed
        if (!showCategorized) {
            data = data.filter(m => m.category === 'Uncategorized' || !m.hasRule);
        }
        
        // Sort
        if (sortBy === 'total') {
            data.sort((a, b) => b.total - a.total);
        } else if (sortBy === 'count') {
            data.sort((a, b) => b.count - a.count);
        } else if (sortBy === 'uncategorized') {
            // Uncategorized first, then by total
            data.sort((a, b) => {
                if (a.category === 'Uncategorized' && b.category !== 'Uncategorized') return -1;
                if (a.category !== 'Uncategorized' && b.category === 'Uncategorized') return 1;
                return b.total - a.total;
            });
        }
        
        return data;
    }, [expenses, merchantRules, sortBy, showCategorized]);

    const stats = useMemo(() => {
        const total = merchantData.length;
        const uncategorized = merchantData.filter(m => m.category === 'Uncategorized').length;
        const withRules = merchantData.filter(m => m.hasRule).length;
        const totalSpend = merchantData.reduce((s, m) => s + m.total, 0);
        const uncategorizedSpend = merchantData.filter(m => m.category === 'Uncategorized').reduce((s, m) => s + m.total, 0);
        return { total, uncategorized, withRules, totalSpend, uncategorizedSpend };
    }, [merchantData]);

    const handleCategoryChange = (merchant, category) => {
        // From High Impact mode, always create global rules
        onUpdateRule(merchant, category, 'global', null);
    };

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-amber-500 to-orange-500 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black flex items-center gap-2">üéØ High Impact Mode</h2>
                <p className="text-amber-100 text-sm mt-1">Categorize merchants by total spend ‚Äî tackle the big fish first!</p>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Unique Merchants</h3>
                    <p className="text-2xl font-black text-slate-900">{stats.total}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-amber-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-amber-500 uppercase">Need Categorizing</h3>
                    <p className="text-2xl font-black text-amber-600">{stats.uncategorized}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-500 uppercase">With Rules</h3>
                    <p className="text-2xl font-black text-green-600">{stats.withRules}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Spend</h3>
                    <p className="text-2xl font-black text-slate-900">${(stats.totalSpend/1000).toFixed(1)}k</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-red-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-red-500 uppercase">Uncategorized $</h3>
                    <p className="text-2xl font-black text-red-600">${(stats.uncategorizedSpend/1000).toFixed(1)}k</p>
                </div>
            </div>

            {/* Controls */}
            <div className="flex flex-wrap gap-4 items-center justify-between">
                <div className="flex gap-2 items-center">
                    <span className="text-xs font-bold text-slate-500">Sort by:</span>
                    <div className="flex gap-1 bg-slate-100 p-1 rounded-xl">
                        {[['total','üí∞ Total $'],['count','üî¢ Count'],['uncategorized','‚ö†Ô∏è Uncategorized First']].map(([key, label]) => (
                            <button key={key} onClick={() => setSortBy(key)}
                                className={`px-3 py-1.5 rounded-lg text-xs font-bold ${sortBy === key ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                                {label}
                            </button>
                        ))}
                    </div>
                </div>
                <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked={showCategorized} onChange={e => setShowCategorized(e.target.checked)}
                        className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                    <span className="text-xs font-bold text-slate-500">Show already categorized</span>
                </label>
            </div>

            {/* Merchant List */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="overflow-x-auto max-h-[60vh]">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-4 w-8">#</th>
                                <th className="p-4">Merchant</th>
                                <th className="p-4 text-center">Transactions</th>
                                <th className="p-4 text-right">Total Spend</th>
                                <th className="p-4 text-center">Category</th>
                                <th className="p-4 w-20">Status</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {merchantData.length === 0 ? (
                                <tr><td colSpan={6} className="p-12 text-center text-slate-400">No merchants to categorize</td></tr>
                            ) : merchantData.map((m, i) => {
                                const isUncategorized = m.category === 'Uncategorized';
                                const isDone = m.hasRule && !isUncategorized;
                                
                                return (
                                    <tr key={m.merchant} className={`group transition-all ${isDone ? 'bg-green-50/50' : isUncategorized ? 'bg-amber-50/30' : 'hover:bg-slate-50'}`}>
                                        <td className="p-4 text-slate-400 font-bold">{i + 1}</td>
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800">{m.merchant}</div>
                                            {m.csvCategories.size > 0 && (
                                                <div className="text-[10px] text-slate-400 mt-0.5">
                                                    CSV: {[...m.csvCategories].slice(0, 2).join(', ')}
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-4 text-center">
                                            <span className="px-2 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-600">
                                                {m.count} txn{m.count !== 1 ? 's' : ''}
                                            </span>
                                        </td>
                                        <td className="p-4 text-right">
                                            <span className={`text-lg font-black ${isUncategorized ? 'text-amber-600' : 'text-slate-900'}`}>
                                                ${m.total.toLocaleString(undefined, {maximumFractionDigits: 0})}
                                            </span>
                                        </td>
                                        <td className="p-4">
                                            <select 
                                                value={m.hasRule ? merchantRules[m.merchant] : m.category}
                                                onChange={e => handleCategoryChange(m.merchant, e.target.value)}
                                                className={`w-full p-2 rounded-lg text-xs font-bold border-2 cursor-pointer transition-all ${
                                                    isUncategorized 
                                                        ? 'bg-amber-100 border-amber-300 text-amber-700 hover:border-amber-400' 
                                                        : isDone 
                                                            ? 'bg-green-100 border-green-300 text-green-700'
                                                            : 'bg-slate-100 border-slate-200 text-slate-700 hover:border-indigo-400'
                                                }`}>
                                                <option value="Uncategorized">‚ö†Ô∏è Uncategorized</option>
                                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </td>
                                        <td className="p-4">
                                            {isDone ? (
                                                <span className="px-2 py-1 bg-green-100 text-green-600 rounded-full text-[10px] font-bold">‚úì DONE</span>
                                            ) : m.hasRule ? (
                                                <span className="px-2 py-1 bg-purple-100 text-purple-600 rounded-full text-[10px] font-bold">RULE</span>
                                            ) : isUncategorized ? (
                                                <span className="px-2 py-1 bg-amber-100 text-amber-600 rounded-full text-[10px] font-bold animate-pulse">TODO</span>
                                            ) : (
                                                <span className="px-2 py-1 bg-slate-100 text-slate-500 rounded-full text-[10px] font-bold">AUTO</span>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Progress */}
            {stats.total > 0 && (
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-sm font-bold text-slate-600">Categorization Progress</span>
                        <span className="text-sm font-black text-indigo-600">{Math.round(((stats.total - stats.uncategorized) / stats.total) * 100)}%</span>
                    </div>
                    <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                        <div 
                            className="h-full bg-gradient-to-r from-green-400 to-emerald-500 rounded-full transition-all duration-500"
                            style={{ width: `${((stats.total - stats.uncategorized) / stats.total) * 100}%` }}
                        />
                    </div>
                    <div className="flex justify-between mt-2 text-[10px] text-slate-400">
                        <span>{stats.total - stats.uncategorized} categorized</span>
                        <span>{stats.uncategorized} remaining</span>
                    </div>
                </div>
            )}
        </div>
    );
};

const CategoryManagement = ({ expenses, merchantRules, onUpdateExpense, onUpdateRule, onDeleteRule }) => {
    const [viewMode, setViewMode] = useState('highimpact'); // 'highimpact' or 'transactions'
    const [filter, setFilter] = useState('all');
    const [searchTerm, setSearchTerm] = useState('');
    const [editingExpense, setEditingExpense] = useState(null);
    
    // Get all unique account names from expenses
    const allAccounts = useMemo(() => {
        const accounts = new Set();
        expenses.forEach(e => {
            if (e.account) accounts.add(e.account);
        });
        return [...accounts].sort();
    }, [expenses]);
    
    const filteredExpenses = useMemo(() => {
        // Start with 2024+ expenses only
        let filtered = expenses.filter(e => isValidYear(e.date));
        if (filter === 'uncategorized') {
            filtered = filtered.filter(e => getEffectiveCategory(e, merchantRules).category === 'Uncategorized');
        } else if (filter === 'rules') {
            filtered = filtered.filter(e => {
                const src = getEffectiveCategory(e, merchantRules).source;
                return src === 'rule-global' || src === 'rule-account' || src === 'rule-accounts';
            });
        } else if (filter === 'excluded') {
            filtered = filtered.filter(e => EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category));
        }
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(e => e.description?.toLowerCase().includes(term) || cleanMerchant(e.description).toLowerCase().includes(term));
        }
        return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    }, [expenses, merchantRules, filter, searchTerm]);

    const handleSaveCategory = (category, applyToAll, merchant, scope, accounts) => {
        if (applyToAll) {
            onUpdateRule(merchant, category, scope, accounts);
        } else {
            onUpdateExpense(editingExpense.id, category);
        }
        setEditingExpense(null);
    };

    const stats = useMemo(() => {
        const validExpenses = expenses.filter(e => isValidYear(e.date));
        const uncategorized = validExpenses.filter(e => getEffectiveCategory(e, merchantRules).category === 'Uncategorized').length;
        const withRules = validExpenses.filter(e => {
            const src = getEffectiveCategory(e, merchantRules).source;
            return src === 'rule-global' || src === 'rule-account' || src === 'rule-accounts';
        }).length;
        const excluded = validExpenses.filter(e => EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category)).length;
        return { uncategorized, withRules, excluded, total: validExpenses.length, rulesCount: Object.keys(merchantRules).length };
    }, [expenses, merchantRules]);

    const getCategoryBadge = (source) => {
        switch(source) {
            case 'rule-global': return <span className="ml-1 px-1.5 py-0.5 bg-purple-100 text-purple-600 text-[8px] font-bold rounded">üåç GLOBAL</span>;
            case 'rule-account': return <span className="ml-1 px-1.5 py-0.5 bg-cyan-100 text-cyan-600 text-[8px] font-bold rounded">üí≥ ACCOUNT</span>;
            case 'rule-accounts': return <span className="ml-1 px-1.5 py-0.5 bg-cyan-100 text-cyan-600 text-[8px] font-bold rounded">üí≥ ACCOUNTS</span>;
            case 'rule': return <span className="ml-1 px-1.5 py-0.5 bg-purple-100 text-purple-600 text-[8px] font-bold rounded">RULE</span>;
            case 'manual': return <span className="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-600 text-[8px] font-bold rounded">EDITED</span>;
            case 'auto': return <span className="ml-1 px-1.5 py-0.5 bg-green-100 text-green-600 text-[8px] font-bold rounded">AUTO</span>;
            case 'csv': return <span className="ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-600 text-[8px] font-bold rounded">CSV</span>;
            default: return null;
        }
    };

    // High Impact Mode
    if (viewMode === 'highimpact') {
        return (
            <div className="space-y-6">
                {/* Mode Toggle */}
                <div className="flex gap-2 bg-slate-100 p-1 rounded-xl w-fit">
                    <button onClick={() => setViewMode('highimpact')}
                        className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'highimpact' ? 'bg-white text-amber-600 shadow' : 'text-slate-500'}`}>
                        üéØ High Impact
                    </button>
                    <button onClick={() => setViewMode('transactions')}
                        className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'transactions' ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                        üìã All Transactions
                    </button>
                </div>
                
                <HighImpactView expenses={expenses} merchantRules={merchantRules} onUpdateRule={onUpdateRule} />
            </div>
        );
    }

    // Transaction View
    return (
        <div className="space-y-6">
            {/* Mode Toggle */}
            <div className="flex gap-2 bg-slate-100 p-1 rounded-xl w-fit">
                <button onClick={() => setViewMode('highimpact')}
                    className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'highimpact' ? 'bg-white text-amber-600 shadow' : 'text-slate-500'}`}>
                    üéØ High Impact
                </button>
                <button onClick={() => setViewMode('transactions')}
                    className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'transactions' ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                    üìã All Transactions
                </button>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total</h3>
                    <p className="text-2xl font-black text-slate-900">{stats.total}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-amber-200 shadow-lg cursor-pointer hover:bg-amber-50" onClick={() => setFilter('uncategorized')}>
                    <h3 className="text-[10px] font-bold text-amber-500 uppercase">Uncategorized</h3>
                    <p className="text-2xl font-black text-amber-600">{stats.uncategorized}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-purple-200 shadow-lg cursor-pointer hover:bg-purple-50" onClick={() => setFilter('rules')}>
                    <h3 className="text-[10px] font-bold text-purple-500 uppercase">With Rules</h3>
                    <p className="text-2xl font-black text-purple-600">{stats.withRules}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-lg cursor-pointer hover:bg-slate-100" onClick={() => setFilter('excluded')}>
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Excluded</h3>
                    <p className="text-2xl font-black text-slate-500">{stats.excluded}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-indigo-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-indigo-500 uppercase">Merchant Rules</h3>
                    <p className="text-2xl font-black text-indigo-600">{stats.rulesCount}</p>
                </div>
            </div>

            {/* Merchant Rules Summary */}
            {Object.keys(merchantRules).length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 className="font-black text-slate-800">üè∑Ô∏è Active Merchant Rules</h3>
                        <button onClick={() => { if(confirm("Delete all merchant rules?")) Object.keys(merchantRules).forEach(m => onDeleteRule(m)); }}
                            className="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg hover:bg-red-100">Clear All Rules</button>
                    </div>
                    <div className="p-4 flex flex-wrap gap-2 max-h-40 overflow-auto">
                        {Object.entries(merchantRules).map(([ruleKey, ruleData]) => {
                            const isAccountRule = ruleKey.includes('|||');
                            const isMultiAccountRule = ruleData?.scope === 'accounts';
                            const displayName = isAccountRule ? ruleKey.split('|||')[0] : ruleKey;
                            const accountName = isAccountRule && !isMultiAccountRule ? ruleKey.split('|||')[1] : null;
                            const accountsList = isMultiAccountRule && ruleData?.accounts ? ruleData.accounts : null;
                            const category = ruleData?.category || ruleData;
                            const scope = ruleData?.scope || 'global';
                            
                            // Format accounts display
                            const accountsDisplay = accountsList 
                                ? (accountsList.length > 2 
                                    ? `${accountsList.slice(0, 2).join(', ')} +${accountsList.length - 2}` 
                                    : accountsList.join(', '))
                                : accountName;
                            
                            return (
                                <div key={ruleKey} className={`flex items-center gap-2 rounded-lg px-3 py-2 group ${isAccountRule ? 'bg-cyan-50' : 'bg-purple-50'}`}>
                                    <span className={`text-[8px] font-bold px-1.5 py-0.5 rounded ${isAccountRule ? 'bg-cyan-200 text-cyan-700' : 'bg-purple-200 text-purple-700'}`}>
                                        {isAccountRule ? 'üí≥' : 'üåç'}
                                    </span>
                                    <span className="text-xs font-semibold text-slate-600 max-w-[120px] truncate" title={displayName}>{displayName}</span>
                                    {isAccountRule && accountsDisplay && (
                                        <span className="text-[9px] text-slate-400 max-w-[100px] truncate" title={accountsList ? accountsList.join(', ') : accountName}>
                                            ({accountsDisplay})
                                        </span>
                                    )}
                                    <span className="text-[10px] font-bold text-white px-2 py-0.5 rounded" style={{backgroundColor: CAT_COLORS[category] || '#6366f1'}}>{category}</span>
                                    <button onClick={() => onDeleteRule(ruleKey)} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 text-xs">‚úï</button>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* Filters & Search */}
            <div className="flex flex-wrap gap-4 items-center">
                <div className="flex gap-1 bg-slate-100 p-1 rounded-xl">
                    {[['all','All'],['uncategorized','‚ö†Ô∏è Uncategorized'],['rules','üè∑Ô∏è With Rules'],['excluded','üö´ Excluded']].map(([key, label]) => (
                        <button key={key} onClick={() => setFilter(key)}
                            className={`px-3 py-1.5 rounded-lg text-xs font-bold ${filter === key ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                            {label}
                        </button>
                    ))}
                </div>
                <div className="flex-1 min-w-[200px]">
                    <input type="text" placeholder="Search merchant or description..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                        className="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-indigo-500"/>
                </div>
                <div className="text-sm text-slate-500">{filteredExpenses.length} transactions</div>
            </div>

            {/* Transactions Table */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="overflow-x-auto max-h-[60vh]">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-3">Date</th>
                                <th className="p-3">Merchant</th>
                                <th className="p-3">Amount</th>
                                <th className="p-3">Category</th>
                                <th className="p-3 w-20">Action</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {filteredExpenses.length === 0 ? (
                                <tr><td colSpan={5} className="p-12 text-center text-slate-400">No transactions found</td></tr>
                            ) : filteredExpenses.map(e => {
                                const effective = getEffectiveCategory(e, merchantRules);
                                const isExcluded = EXCLUDED_CATEGORIES.includes(effective.category);
                                const isVenmo = effective.category === 'Venmo';
                                const isNegative = e.amount < 0;
                                return (
                                    <tr key={e.id} className={`group ${isExcluded ? 'bg-slate-50 opacity-60' : isVenmo ? 'bg-blue-50/30' : 'hover:bg-slate-50'}`}>
                                        <td className="p-3 text-slate-500 text-xs">{e.date}</td>
                                        <td className="p-3">
                                            <div className={`font-semibold text-xs ${isExcluded ? 'text-slate-400 line-through' : 'text-slate-700'}`} title={e.description}>
                                                {isVenmo && <span className="text-blue-500 mr-1">üí∏</span>}
                                                {cleanMerchant(e.description)}
                                            </div>
                                            <div className="text-[10px] text-slate-400 truncate max-w-[200px]">{e.description}</div>
                                        </td>
                                        <td className={`p-3 font-bold ${isExcluded ? 'text-slate-400' : isNegative ? 'text-green-600' : isVenmo ? 'text-blue-700' : 'text-slate-900'}`}>
                                            {isNegative ? `-$${Math.abs(e.amount).toFixed(2)}` : `$${e.amount.toFixed(2)}`}
                                        </td>
                                        <td className="p-3">
                                            <div className="flex items-center" title={`Original CSV: ${e.csvCategory || 'None'}`}>
                                                <span className={`px-2 py-1 rounded-full text-[10px] font-bold ${
                                                    isExcluded ? 'bg-slate-200 text-slate-500' :
                                                    isVenmo ? 'bg-blue-100 text-blue-700' :
                                                    effective.category === 'Uncategorized' ? 'bg-amber-100 text-amber-700' : 'bg-indigo-100 text-indigo-700'
                                                }`}>
                                                    {effective.category}
                                                </span>
                                                {getCategoryBadge(effective.source)}
                                            </div>
                                        </td>
                                        <td className="p-3">
                                            <button onClick={() => setEditingExpense(e)}
                                                className="px-3 py-1.5 bg-indigo-100 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-200">
                                                Edit
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>

            {editingExpense && (
                <CategoryEditModal
                    expense={editingExpense}
                    merchantRules={merchantRules}
                    allAccounts={allAccounts}
                    onSave={handleSaveCategory}
                    onClose={() => setEditingExpense(null)}
                />
            )}
        </div>
    );
};

// ============== TRANSACTIONS TABLE WITH FILTERS ==============
const FilterDropdown = ({ isOpen, onClose, children, style }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-50" onClick={onClose}>
            <div className="absolute bg-white rounded-xl shadow-2xl border border-slate-200 p-3 min-w-[200px] max-h-[300px] overflow-auto"
                style={style} onClick={e => e.stopPropagation()}>
                {children}
            </div>
        </div>
    );
};

const TransactionsTable = ({ expenses, merchantRules, onDelete, onClearAll }) => {
    // Filter state
    const [dateFilter, setDateFilter] = useState([]); // Array of "Month Year" strings
    const [categoryFilter, setCategoryFilter] = useState([]); // Array of category strings
    const [accountFilter, setAccountFilter] = useState([]); // Array of account strings
    const [amountMin, setAmountMin] = useState('');
    const [amountMax, setAmountMax] = useState('');
    const [descSearch, setDescSearch] = useState('');
    
    // Dropdown open state
    const [openFilter, setOpenFilter] = useState(null); // 'date', 'category', 'account', 'amount', 'desc'
    const [filterPos, setFilterPos] = useState({ top: 0, left: 0 });

    // Get unique filter options
    const filterOptions = useMemo(() => {
        const months = new Set();
        const categories = new Set();
        const accounts = new Set();
        
        expenses.filter(e => isValidYear(e.date)).forEach(e => {
            const d = pDate(e.date);
            const monthYear = `${MONTHS[d.getMonth()]} ${d.getFullYear()}`;
            months.add(monthYear);
            
            const cat = getEffectiveCategory(e, merchantRules).category;
            categories.add(cat);
            
            if (e.account) accounts.add(e.account);
        });
        
        // Sort months chronologically
        const sortedMonths = [...months].sort((a, b) => {
            const [aMonth, aYear] = a.split(' ');
            const [bMonth, bYear] = b.split(' ');
            const aDate = new Date(`${aMonth} 1, ${aYear}`);
            const bDate = new Date(`${bMonth} 1, ${bYear}`);
            return bDate - aDate; // Most recent first
        });
        
        return {
            months: sortedMonths,
            categories: [...categories].sort(),
            accounts: [...accounts].sort()
        };
    }, [expenses, merchantRules]);

    // Apply filters
    const filteredExpenses = useMemo(() => {
        return expenses.filter(e => {
            // Year filter - only 2024+
            if (!isValidYear(e.date)) return false;
            
            // Date filter (Month Year)
            if (dateFilter.length > 0) {
                const d = pDate(e.date);
                const monthYear = `${MONTHS[d.getMonth()]} ${d.getFullYear()}`;
                if (!dateFilter.includes(monthYear)) return false;
            }
            
            // Category filter
            if (categoryFilter.length > 0) {
                const cat = getEffectiveCategory(e, merchantRules).category;
                if (!categoryFilter.includes(cat)) return false;
            }
            
            // Account filter
            if (accountFilter.length > 0) {
                if (!accountFilter.includes(e.account)) return false;
            }
            
            // Amount range filter
            const amt = safe(e.amount);
            if (amountMin !== '' && amt < parseFloat(amountMin)) return false;
            if (amountMax !== '' && amt > parseFloat(amountMax)) return false;
            
            // Description search
            if (descSearch) {
                const term = descSearch.toLowerCase();
                if (!e.description?.toLowerCase().includes(term)) return false;
            }
            
            return true;
        });
    }, [expenses, merchantRules, dateFilter, categoryFilter, accountFilter, amountMin, amountMax, descSearch]);

    // Summary stats for filtered data
    const summary = useMemo(() => {
        const spending = filteredExpenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category));
        const total = spending.reduce((s, e) => s + safe(e.amount), 0);
        return { count: filteredExpenses.length, total, spendingCount: spending.length };
    }, [filteredExpenses, merchantRules]);

    // Check if any filters are active
    const hasActiveFilters = dateFilter.length > 0 || categoryFilter.length > 0 || accountFilter.length > 0 || 
        amountMin !== '' || amountMax !== '' || descSearch !== '';

    const clearAllFilters = () => {
        setDateFilter([]);
        setCategoryFilter([]);
        setAccountFilter([]);
        setAmountMin('');
        setAmountMax('');
        setDescSearch('');
    };

    const openFilterDropdown = (filterType, event) => {
        const rect = event.currentTarget.getBoundingClientRect();
        setFilterPos({ top: rect.bottom + 4, left: Math.min(rect.left, window.innerWidth - 220) });
        setOpenFilter(filterType);
    };

    const toggleFilterItem = (filterType, value) => {
        const setters = { date: setDateFilter, category: setCategoryFilter, account: setAccountFilter };
        const current = { date: dateFilter, category: categoryFilter, account: accountFilter }[filterType];
        const setter = setters[filterType];
        
        if (current.includes(value)) {
            setter(current.filter(v => v !== value));
        } else {
            setter([...current, value]);
        }
    };

    const FilterButton = ({ type, label, activeCount, onClick }) => (
        <button onClick={onClick}
            className={`flex items-center gap-1 px-1 py-0.5 rounded transition-colors ${activeCount > 0 ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-200 text-slate-400'}`}>
            <span className="text-[10px] font-bold uppercase">{label}</span>
            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            {activeCount > 0 && <span className="text-[9px] bg-indigo-600 text-white px-1 rounded-full">{activeCount}</span>}
        </button>
    );

    return (
        <div className="space-y-4">
            {/* Header with summary */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg p-4">
                <div className="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 className="font-black text-slate-800">Transactions</h2>
                        <p className="text-sm text-slate-500">
                            {hasActiveFilters ? (
                                <span>Showing <span className="font-bold text-indigo-600">{summary.count}</span> of {expenses.length} transactions</span>
                            ) : (
                                <span>{expenses.length} total transactions</span>
                            )}
                        </p>
                    </div>
                    <div className="flex items-center gap-4">
                        {hasActiveFilters && (
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-bold text-slate-600">
                                    Filtered Total: <span className="text-indigo-600">${summary.total.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                                </span>
                                <button onClick={clearAllFilters} className="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100">
                                    Clear Filters
                                </button>
                            </div>
                        )}
                        <button onClick={onClearAll} className="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg hover:bg-red-100">
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>

            {/* Table */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="overflow-x-auto max-h-[65vh]">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 sticky top-0 z-10">
                            <tr>
                                <th className="p-3">
                                    <FilterButton type="date" label="Date" activeCount={dateFilter.length} onClick={e => openFilterDropdown('date', e)} />
                                </th>
                                <th className="p-3">
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] font-bold uppercase text-slate-400">Description</span>
                                        <input type="text" placeholder="üîç" value={descSearch} onChange={e => setDescSearch(e.target.value)}
                                            className={`w-20 px-2 py-1 text-xs rounded border outline-none ${descSearch ? 'border-indigo-400 bg-indigo-50' : 'border-slate-200 bg-white'}`}/>
                                    </div>
                                </th>
                                <th className="p-3">
                                    <FilterButton type="account" label="Account" activeCount={accountFilter.length} onClick={e => openFilterDropdown('account', e)} />
                                </th>
                                <th className="p-3">
                                    <FilterButton type="category" label="Category" activeCount={categoryFilter.length} onClick={e => openFilterDropdown('category', e)} />
                                </th>
                                <th className="p-3 text-right">
                                    <FilterButton type="amount" label="Amount" activeCount={(amountMin || amountMax) ? 1 : 0} onClick={e => openFilterDropdown('amount', e)} />
                                </th>
                                <th className="p-3 w-10"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {filteredExpenses.length === 0 ? (
                                <tr><td colSpan={6} className="p-12 text-center text-slate-400">
                                    {expenses.length === 0 ? 'No transactions' : 'No transactions match filters'}
                                </td></tr>
                            ) : [...filteredExpenses].reverse().map(e => {
                                const effective = getEffectiveCategory(e, merchantRules);
                                const isExcluded = EXCLUDED_CATEGORIES.includes(effective.category);
                                const isNegative = e.amount < 0;
                                const isVenmoReimbursement = e.transactionType === 'venmo-reimbursement';
                                const isVenmo = effective.category === 'Venmo';
                                return (
                                    <tr key={e.id} className={`group ${isExcluded ? 'bg-slate-50 opacity-50' : isVenmoReimbursement ? 'bg-green-50/50' : isVenmo ? 'bg-blue-50/30' : 'hover:bg-slate-50'}`}>
                                        <td className="p-3 text-slate-500 text-xs whitespace-nowrap">{e.date}</td>
                                        <td className={`p-3 font-semibold max-w-[250px] ${isExcluded ? 'text-slate-400 line-through' : 'text-slate-700'}`}>
                                            <div className="truncate text-xs" title={e.rawDescription || e.description}>
                                                {isVenmoReimbursement && <span className="text-green-600 mr-1">‚Ü©</span>}
                                                {isVenmo && !isVenmoReimbursement && <span className="text-blue-500 mr-1">üí∏</span>}
                                                {e.description}
                                            </div>
                                            {e.rawDescription && e.rawDescription !== e.description && (
                                                <div className="text-[9px] text-slate-400 truncate" title={e.rawDescription}>
                                                    Raw: {e.rawDescription}
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-3 text-slate-500 text-xs">{e.account}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded-full text-[10px] font-bold ${
                                                isExcluded ? 'bg-slate-200 text-slate-500' : 
                                                isVenmo ? 'bg-blue-100 text-blue-700' :
                                                effective.category === 'Uncategorized' ? 'bg-amber-100 text-amber-700' : 'bg-indigo-100 text-indigo-700'
                                            }`} title={`Source: ${effective.source} | CSV: ${e.csvCategory} | Type: ${e.transactionType || 'expense'}`}>
                                                {effective.category}
                                            </span>
                                        </td>
                                        <td className={`p-3 text-right font-bold ${isExcluded ? 'text-slate-400' : isNegative ? 'text-green-600' : isVenmo ? 'text-blue-700' : 'text-slate-900'}`}>
                                            {isNegative ? `-$${Math.abs(e.amount).toFixed(2)}` : `$${e.amount.toFixed(2)}`}
                                        </td>
                                        <td className="p-3">
                                            <button onClick={() => onDelete(e.id)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>

                {/* Footer Summary */}
                {filteredExpenses.length > 0 && (
                    <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                        <span className="text-sm text-slate-500">
                            {summary.spendingCount} spending transactions (excluding Income/Transfer/Excluded)
                        </span>
                        <div className="text-right">
                            <div className="text-xs text-slate-400 uppercase font-bold">Filtered Total (Spending)</div>
                            <div className="text-2xl font-black text-indigo-600">${summary.total.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                )}
            </div>

            {/* Filter Dropdowns */}
            <FilterDropdown isOpen={openFilter === 'date'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-2">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Month</span>
                        {dateFilter.length > 0 && (
                            <button onClick={() => setDateFilter([])} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-1 max-h-[200px] overflow-auto">
                        {filterOptions.months.map(month => (
                            <label key={month} className="flex items-center gap-2 p-1.5 rounded hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" checked={dateFilter.includes(month)} onChange={() => toggleFilterItem('date', month)}
                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                                <span className="text-sm text-slate-700">{month}</span>
                            </label>
                        ))}
                    </div>
                </div>
            </FilterDropdown>

            <FilterDropdown isOpen={openFilter === 'category'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-2">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Category</span>
                        {categoryFilter.length > 0 && (
                            <button onClick={() => setCategoryFilter([])} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-1 max-h-[200px] overflow-auto">
                        {filterOptions.categories.map(cat => (
                            <label key={cat} className="flex items-center gap-2 p-1.5 rounded hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" checked={categoryFilter.includes(cat)} onChange={() => toggleFilterItem('category', cat)}
                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                                <span className="text-sm text-slate-700">{cat}</span>
                                <span className="w-3 h-3 rounded-full ml-auto" style={{backgroundColor: CAT_COLORS[cat] || '#6366f1'}}/>
                            </label>
                        ))}
                    </div>
                </div>
            </FilterDropdown>

            <FilterDropdown isOpen={openFilter === 'account'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-2">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Account</span>
                        {accountFilter.length > 0 && (
                            <button onClick={() => setAccountFilter([])} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-1 max-h-[200px] overflow-auto">
                        {filterOptions.accounts.map(acc => (
                            <label key={acc} className="flex items-center gap-2 p-1.5 rounded hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" checked={accountFilter.includes(acc)} onChange={() => toggleFilterItem('account', acc)}
                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                                <span className="text-sm text-slate-700">{acc}</span>
                            </label>
                        ))}
                    </div>
                </div>
            </FilterDropdown>

            <FilterDropdown isOpen={openFilter === 'amount'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-3">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Amount</span>
                        {(amountMin || amountMax) && (
                            <button onClick={() => { setAmountMin(''); setAmountMax(''); }} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-2">
                        <div>
                            <label className="text-xs font-bold text-slate-500 block mb-1">Minimum ($)</label>
                            <input type="number" value={amountMin} onChange={e => setAmountMin(e.target.value)} placeholder="0"
                                className="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500"/>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-500 block mb-1">Maximum ($)</label>
                            <input type="number" value={amountMax} onChange={e => setAmountMax(e.target.value)} placeholder="‚àû"
                                className="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500"/>
                        </div>
                    </div>
                </div>
            </FilterDropdown>
        </div>
    );
};

// ============== STYLECOM REIMBURSEMENT DASHBOARD ==============
const StylecomReimbursement = ({ expenses, merchantRules, paidIds, onTogglePaid }) => {
    const [selectedQuarter, setSelectedQuarter] = useState('all');
    
    // Filter to only Stylecom transactions
    const stylecomExpenses = useMemo(() => {
        return expenses.filter(e => {
            const effective = getEffectiveCategory(e, merchantRules);
            return effective.category === 'Stylecom' && isValidYear(e.date);
        }).sort((a, b) => new Date(b.date) - new Date(a.date));
    }, [expenses, merchantRules]);
    
    // Calculate KPIs
    const kpis = useMemo(() => {
        const totalSpend = stylecomExpenses.reduce((sum, e) => sum + safe(e.amount), 0);
        const paidExpenses = stylecomExpenses.filter(e => paidIds.has(e.id));
        const totalPaid = paidExpenses.reduce((sum, e) => sum + safe(e.amount), 0);
        const outstanding = totalSpend - totalPaid;
        return { totalSpend, totalPaid, outstanding, totalCount: stylecomExpenses.length, paidCount: paidExpenses.length };
    }, [stylecomExpenses, paidIds]);
    
    // Group by quarter
    const quarterlyData = useMemo(() => {
        const byQuarter = {};
        
        stylecomExpenses.forEach(e => {
            const date = pDate(e.date);
            const year = date.getFullYear();
            const quarter = Math.floor(date.getMonth() / 3) + 1;
            const key = `Q${quarter} ${year}`;
            
            if (!byQuarter[key]) {
                byQuarter[key] = { 
                    key, 
                    year, 
                    quarter, 
                    total: 0, 
                    paid: 0, 
                    outstanding: 0, 
                    transactions: [] 
                };
            }
            
            const amount = safe(e.amount);
            byQuarter[key].total += amount;
            byQuarter[key].transactions.push(e);
            
            if (paidIds.has(e.id)) {
                byQuarter[key].paid += amount;
            } else {
                byQuarter[key].outstanding += amount;
            }
        });
        
        // Sort by year and quarter descending
        return Object.values(byQuarter).sort((a, b) => {
            if (a.year !== b.year) return b.year - a.year;
            return b.quarter - a.quarter;
        });
    }, [stylecomExpenses, paidIds]);
    
    // Filter transactions by selected quarter
    const filteredTransactions = useMemo(() => {
        if (selectedQuarter === 'all') return stylecomExpenses;
        const q = quarterlyData.find(q => q.key === selectedQuarter);
        return q ? q.transactions : [];
    }, [stylecomExpenses, quarterlyData, selectedQuarter]);
    
    // Mark all in quarter as paid
    const markQuarterPaid = (quarterKey) => {
        const q = quarterlyData.find(q => q.key === quarterKey);
        if (q) {
            q.transactions.forEach(e => {
                if (!paidIds.has(e.id)) {
                    onTogglePaid(e.id);
                }
            });
        }
    };
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black">üëó Stylecom Reimbursement Tracker</h2>
                <p className="text-pink-100 text-sm mt-1">Track business expenses owed by your partner</p>
            </div>
            
            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Lifetime Spend</h3>
                    <p className="text-2xl font-black text-slate-900">${kpis.totalSpend.toLocaleString(undefined, {maximumFractionDigits: 2})}</p>
                    <p className="text-xs text-slate-500 mt-1">{kpis.totalCount} transactions</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-600 uppercase">Total Repaid ‚úì</h3>
                    <p className="text-2xl font-black text-green-600">${kpis.totalPaid.toLocaleString(undefined, {maximumFractionDigits: 2})}</p>
                    <p className="text-xs text-green-500 mt-1">{kpis.paidCount} settled</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-amber-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-amber-600 uppercase">Outstanding Balance</h3>
                    <p className="text-3xl font-black text-amber-600">${kpis.outstanding.toLocaleString(undefined, {maximumFractionDigits: 2})}</p>
                    <p className="text-xs text-amber-500 mt-1">{kpis.totalCount - kpis.paidCount} pending</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Repayment Progress</h3>
                    <p className="text-2xl font-black text-indigo-600">{kpis.totalSpend > 0 ? Math.round((kpis.totalPaid / kpis.totalSpend) * 100) : 0}%</p>
                    <div className="h-2 bg-slate-100 rounded-full mt-2 overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-green-400 to-emerald-500 rounded-full transition-all duration-500"
                            style={{ width: `${kpis.totalSpend > 0 ? (kpis.totalPaid / kpis.totalSpend) * 100 : 0}%` }}/>
                    </div>
                </div>
            </div>
            
            {/* Quarterly Breakdown */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100">
                    <h3 className="text-sm font-black text-slate-800">üìÖ Quarterly Breakdown</h3>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold">
                            <tr>
                                <th className="p-4 text-left">Quarter</th>
                                <th className="p-4 text-right">Total</th>
                                <th className="p-4 text-right">Paid</th>
                                <th className="p-4 text-right">Outstanding</th>
                                <th className="p-4 text-center">Status</th>
                                <th className="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {quarterlyData.length === 0 ? (
                                <tr><td colSpan={6} className="p-12 text-center text-slate-400">No Stylecom expenses found</td></tr>
                            ) : quarterlyData.map(q => {
                                const isFullyPaid = q.outstanding === 0;
                                const progress = q.total > 0 ? (q.paid / q.total) * 100 : 0;
                                return (
                                    <tr key={q.key} className={`hover:bg-slate-50 ${isFullyPaid ? 'bg-green-50/50' : ''}`}>
                                        <td className="p-4 font-bold text-slate-800">{q.key}</td>
                                        <td className="p-4 text-right font-semibold text-slate-600">${q.total.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                                        <td className="p-4 text-right font-semibold text-green-600">${q.paid.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                                        <td className="p-4 text-right font-bold text-amber-600">${q.outstanding.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                                        <td className="p-4 text-center">
                                            <div className="flex items-center gap-2">
                                                <div className="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                                    <div className="h-full bg-green-500 rounded-full" style={{ width: `${progress}%` }}/>
                                                </div>
                                                <span className="text-[10px] font-bold text-slate-500 w-10">{Math.round(progress)}%</span>
                                            </div>
                                        </td>
                                        <td className="p-4 text-center">
                                            <div className="flex gap-2 justify-center">
                                                <button 
                                                    onClick={() => setSelectedQuarter(selectedQuarter === q.key ? 'all' : q.key)}
                                                    className={`px-3 py-1 rounded-lg text-xs font-bold ${selectedQuarter === q.key ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                                    {selectedQuarter === q.key ? 'Hide' : 'View'}
                                                </button>
                                                {!isFullyPaid && (
                                                    <button 
                                                        onClick={() => markQuarterPaid(q.key)}
                                                        className="px-3 py-1 bg-green-100 text-green-600 rounded-lg text-xs font-bold hover:bg-green-200">
                                                        Mark All Paid
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {/* Transaction List */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 className="text-sm font-black text-slate-800">
                        üìù Transactions {selectedQuarter !== 'all' && `- ${selectedQuarter}`}
                    </h3>
                    <div className="flex gap-2">
                        {selectedQuarter !== 'all' && (
                            <button onClick={() => setSelectedQuarter('all')} className="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">
                                Show All
                            </button>
                        )}
                        <span className="text-xs text-slate-500">{filteredTransactions.length} items</span>
                    </div>
                </div>
                <div className="overflow-x-auto max-h-[50vh]">
                    <table className="w-full text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-3 text-center w-16">Paid</th>
                                <th className="p-3 text-left">Date</th>
                                <th className="p-3 text-left">Description</th>
                                <th className="p-3 text-left">Account</th>
                                <th className="p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {filteredTransactions.length === 0 ? (
                                <tr><td colSpan={5} className="p-12 text-center text-slate-400">No transactions found</td></tr>
                            ) : filteredTransactions.map(e => {
                                const isPaid = paidIds.has(e.id);
                                return (
                                    <tr key={e.id} className={`group hover:bg-slate-50 ${isPaid ? 'bg-green-50/50' : ''}`}>
                                        <td className="p-3 text-center">
                                            <button 
                                                onClick={() => onTogglePaid(e.id)}
                                                className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${
                                                    isPaid 
                                                        ? 'bg-green-500 border-green-500 text-white' 
                                                        : 'border-slate-300 hover:border-green-400 text-transparent hover:text-green-400'
                                                }`}>
                                                ‚úì
                                            </button>
                                        </td>
                                        <td className={`p-3 text-slate-500 text-xs whitespace-nowrap ${isPaid ? 'line-through' : ''}`}>{e.date}</td>
                                        <td className={`p-3 ${isPaid ? 'text-slate-400 line-through' : 'text-slate-700'}`}>
                                            <div className="font-semibold text-xs truncate max-w-[250px]" title={e.description}>{e.description}</div>
                                        </td>
                                        <td className="p-3 text-slate-500 text-xs">{e.account}</td>
                                        <td className={`p-3 text-right font-bold ${isPaid ? 'text-green-600' : 'text-slate-900'}`}>
                                            ${safe(e.amount).toFixed(2)}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

// ============== INCOME VS SPEND FLOW (SANKEY) ==============
const IncomeFlowDashboard = ({ expenses, merchantRules }) => {
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const chartRef = React.useRef(null);
    
    // Income categories to look for
    const INCOME_CATEGORIES = ['Income', 'TaxIncome'];
    
    // Income source keywords - checked in ORDER (first match wins)
    // More specific sources should come before generic ones
    const INCOME_KEYWORDS = [
        { name: 'Microsoft', keywords: ['microsoft', 'msft'] },
        { name: 'Salary/Payroll', keywords: ['payroll', 'salary', 'direct deposit', 'paycheck', 'employer', 'wage'] },
        { name: 'Interest & Dividends', keywords: ['interest', 'dividend', 'yield', 'apy', 'capital gain'] },
        { name: 'Tax Refunds', keywords: ['irs', 'treasury', 'tax refund', 'state tax', 'federal tax'] },
        { name: 'Wire/Transfers In', keywords: ['wire in', 'wire deposit', 'incoming wire', 'ach credit', 'external deposit'] },
        { name: 'Reimbursements', keywords: ['reimburse', 'refund', 'rebate', 'cashback', 'cash back'] },
        { name: 'Gifts/Other', keywords: ['gift', 'bonus', 'award'] }
    ];
    
    // Expense categories to exclude
    const EXCLUDED_FROM_EXPENSES = ['Income', 'TaxIncome', 'Transfer', 'Excluded', 'Venmo'];
    
    // Prepare data for Sankey
    const sankeyData = useMemo(() => {
        // Filter by year
        const yearExpenses = expenses.filter(e => getY(e.date) === selectedYear);
        
        // Separate income and expenses
        const incomeBySource = {};
        const expenseByCategory = {};
        
        yearExpenses.forEach(e => {
            const effective = getEffectiveCategory(e, merchantRules);
            const category = effective.category;
            const amount = Math.abs(safe(e.amount));
            const descLower = (e.description || '').toLowerCase();
            
            if (INCOME_CATEGORIES.includes(category)) {
                // Determine income source type - check in order, first match wins
                let sourceType = 'Other Income';
                for (const source of INCOME_KEYWORDS) {
                    if (source.keywords.some(kw => descLower.includes(kw))) {
                        sourceType = source.name;
                        break;
                    }
                }
                incomeBySource[sourceType] = (incomeBySource[sourceType] || 0) + amount;
            } else if (!EXCLUDED_FROM_EXPENSES.includes(category) && category !== 'Uncategorized') {
                expenseByCategory[category] = (expenseByCategory[category] || 0) + amount;
            }
        });
        
        // Calculate totals
        const totalIncome = Object.values(incomeBySource).reduce((a, b) => a + b, 0);
        const totalExpenses = Object.values(expenseByCategory).reduce((a, b) => a + b, 0);
        const savings = totalIncome - totalExpenses;
        
        // Build nodes and links
        const nodes = [];
        const nodeIndices = {};
        let nodeIndex = 0;
        
        // Add income source nodes (left side) - sorted by amount
        const incomeSources = Object.keys(incomeBySource).sort((a, b) => incomeBySource[b] - incomeBySource[a]);
        incomeSources.forEach(source => {
            nodeIndices[source] = nodeIndex++;
            // Use different green shades for different income sources
            const color = source === 'Microsoft' ? '#0078d4' : // Microsoft blue
                         source === 'Salary/Payroll' ? '#22c55e' : // Green
                         source === 'Tax Refunds' ? '#10b981' : // Teal
                         source === 'Interest & Dividends' ? '#059669' : // Emerald
                         '#16a34a'; // Default green
            nodes.push({ name: source, color });
        });
        
        // Add "Budget" middle node
        const budgetIndex = nodeIndex++;
        nodes.push({ name: 'Total Budget', color: '#6366f1' }); // Indigo for budget
        nodeIndices['Budget'] = budgetIndex;
        
        // IMPORTANT: Add Savings FIRST (before expenses) so it appears at top of right column
        if (savings > 0) {
            nodeIndices['Savings'] = nodeIndex++;
            nodes.push({ name: 'üí∞ SAVINGS', color: '#3b82f6' }); // Blue for savings - prominent
        }
        
        // Add expense category nodes (right side) - sorted by amount
        const expenseCategories = Object.keys(expenseByCategory).sort((a, b) => expenseByCategory[b] - expenseByCategory[a]);
        expenseCategories.forEach(cat => {
            nodeIndices[cat] = nodeIndex++;
            nodes.push({ name: cat, color: CAT_COLORS[cat] || '#ef4444' });
        });
        
        // Build links
        const links = [];
        
        // Income sources -> Budget (use source-specific colors)
        incomeSources.forEach(source => {
            const sourceColor = source === 'Microsoft' ? 'rgba(0, 120, 212, 0.5)' : // Microsoft blue
                               'rgba(34, 197, 94, 0.4)'; // Default green
            links.push({
                source: nodeIndices[source],
                target: budgetIndex,
                value: incomeBySource[source],
                color: sourceColor
            });
        });
        
        // Budget -> Savings FIRST (so it renders at top)
        if (savings > 0) {
            links.push({
                source: budgetIndex,
                target: nodeIndices['Savings'],
                value: savings,
                color: 'rgba(59, 130, 246, 0.6)' // Blue with more opacity - more prominent
            });
        }
        
        // Budget -> Expense categories
        expenseCategories.forEach(cat => {
            links.push({
                source: budgetIndex,
                target: nodeIndices[cat],
                value: expenseByCategory[cat],
                color: `${CAT_COLORS[cat] || '#ef4444'}66` // Category color with transparency
            });
        });
        
        return {
            nodes,
            links,
            totalIncome,
            totalExpenses,
            savings,
            incomeBySource,
            expenseByCategory
        };
    }, [expenses, merchantRules, selectedYear]);
    
    // Render Plotly chart
    useEffect(() => {
        if (!chartRef.current || sankeyData.nodes.length === 0) return;
        
        const data = [{
            type: 'sankey',
            orientation: 'h',
            node: {
                pad: 20,
                thickness: 30,
                line: { color: 'white', width: 2 },
                label: sankeyData.nodes.map(n => n.name),
                color: sankeyData.nodes.map(n => n.color),
                hovertemplate: '%{label}<br>$%{value:,.0f}<extra></extra>'
            },
            link: {
                source: sankeyData.links.map(l => l.source),
                target: sankeyData.links.map(l => l.target),
                value: sankeyData.links.map(l => l.value),
                color: sankeyData.links.map(l => l.color),
                hovertemplate: '%{source.label} ‚Üí %{target.label}<br>$%{value:,.0f}<extra></extra>'
            }
        }];
        
        const layout = {
            font: { family: 'Inter, sans-serif', size: 12 },
            margin: { l: 20, r: 20, t: 20, b: 20 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent'
        };
        
        const config = {
            responsive: true,
            displayModeBar: false
        };
        
        Plotly.newPlot(chartRef.current, data, layout, config);
        
        return () => {
            if (chartRef.current) {
                Plotly.purge(chartRef.current);
            }
        };
    }, [sankeyData]);
    
    // Get available years
    const availableYears = useMemo(() => {
        const years = new Set();
        expenses.forEach(e => {
            const year = getY(e.date);
            if (year >= MIN_YEAR) years.add(year);
        });
        return [...years].sort((a, b) => b - a);
    }, [expenses]);
    
    const hasData = sankeyData.totalIncome > 0 || sankeyData.totalExpenses > 0;
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-6 rounded-2xl flex justify-between items-center">
                <div>
                    <h2 className="text-xl font-black">üí∞ Income vs Spend Flow</h2>
                    <p className="text-emerald-100 text-sm mt-1">Visualize how your money flows from income to expenses</p>
                </div>
                <select 
                    value={selectedYear} 
                    onChange={e => setSelectedYear(Number(e.target.value))}
                    className="bg-white/20 text-white border border-white/30 rounded-xl px-4 py-2 font-bold outline-none">
                    {availableYears.map(y => <option key={y} value={y} className="text-slate-800">{y}</option>)}
                </select>
            </div>
            
            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-600 uppercase">Total Income</h3>
                    <p className="text-2xl font-black text-green-600">${sankeyData.totalIncome.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    <p className="text-xs text-green-500 mt-1">{Object.keys(sankeyData.incomeBySource).length} sources</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-red-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-red-600 uppercase">Total Expenses</h3>
                    <p className="text-2xl font-black text-red-600">${sankeyData.totalExpenses.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    <p className="text-xs text-red-500 mt-1">{Object.keys(sankeyData.expenseByCategory).length} categories</p>
                </div>
                <div className={`bg-white p-5 rounded-2xl border shadow-lg ${sankeyData.savings >= 0 ? 'border-blue-200' : 'border-amber-200'}`}>
                    <h3 className={`text-[10px] font-bold uppercase ${sankeyData.savings >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>
                        {sankeyData.savings >= 0 ? 'Savings' : 'Deficit'}
                    </h3>
                    <p className={`text-2xl font-black ${sankeyData.savings >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>
                        ${Math.abs(sankeyData.savings).toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </p>
                    <p className={`text-xs mt-1 ${sankeyData.savings >= 0 ? 'text-blue-500' : 'text-amber-500'}`}>
                        {sankeyData.totalIncome > 0 ? `${Math.abs(sankeyData.savings / sankeyData.totalIncome * 100).toFixed(1)}% of income` : 'N/A'}
                    </p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-500 uppercase">Burn Rate</h3>
                    <p className="text-2xl font-black text-slate-700">
                        {sankeyData.totalIncome > 0 ? `${(sankeyData.totalExpenses / sankeyData.totalIncome * 100).toFixed(0)}%` : 'N/A'}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">of income spent</p>
                </div>
            </div>
            
            {/* Sankey Chart */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100">
                    <h3 className="text-sm font-black text-slate-800">üìä Money Flow Diagram</h3>
                    <p className="text-xs text-slate-500 mt-1">Income sources ‚Üí Budget ‚Üí Expense categories</p>
                </div>
                <div className="p-4">
                    {hasData ? (
                        <div ref={chartRef} style={{ width: '100%', height: '500px' }} />
                    ) : (
                        <div className="h-64 flex items-center justify-center text-slate-400">
                            <div className="text-center">
                                <div className="text-4xl mb-2">üìä</div>
                                <p>No income or expense data for {selectedYear}</p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
            
            {/* Breakdown Tables */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Income Breakdown */}
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100 bg-green-50">
                        <h3 className="text-sm font-black text-green-800">üíµ Income Sources</h3>
                    </div>
                    <div className="p-4">
                        {Object.keys(sankeyData.incomeBySource).length === 0 ? (
                            <p className="text-slate-400 text-center py-8">No income recorded</p>
                        ) : (
                            <div className="space-y-3">
                                {Object.entries(sankeyData.incomeBySource)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([source, amount]) => {
                                        const color = source === 'Microsoft' ? '#0078d4' : 
                                                     source === 'Salary/Payroll' ? '#22c55e' : 
                                                     source === 'Tax Refunds' ? '#10b981' : 
                                                     source === 'Interest & Dividends' ? '#059669' : 
                                                     '#16a34a';
                                        return (
                                            <div key={source} className="flex items-center gap-3">
                                                <div className="w-3 h-3 rounded-full" style={{ backgroundColor: color }} />
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-center">
                                                        <span className="font-semibold text-sm text-slate-700">
                                                            {source === 'Microsoft' && 'üè¢ '}{source}
                                                        </span>
                                                        <span className="font-bold" style={{ color }}>${amount.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                                                    </div>
                                                    <div className="h-1.5 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                                        <div className="h-full rounded-full" style={{ backgroundColor: color, width: `${(amount / sankeyData.totalIncome) * 100}%` }} />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Expense Breakdown */}
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100 bg-red-50">
                        <h3 className="text-sm font-black text-red-800">üí∏ Expense Categories</h3>
                    </div>
                    <div className="p-4 max-h-80 overflow-y-auto">
                        {Object.keys(sankeyData.expenseByCategory).length === 0 ? (
                            <p className="text-slate-400 text-center py-8">No expenses recorded</p>
                        ) : (
                            <div className="space-y-3">
                                {Object.entries(sankeyData.expenseByCategory)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([cat, amount]) => (
                                        <div key={cat} className="flex items-center gap-3">
                                            <div className="w-3 h-3 rounded-full" style={{ backgroundColor: CAT_COLORS[cat] || '#ef4444' }} />
                                            <div className="flex-1">
                                                <div className="flex justify-between items-center">
                                                    <span className="font-semibold text-sm text-slate-700">{cat}</span>
                                                    <span className="font-bold" style={{ color: CAT_COLORS[cat] || '#ef4444' }}>
                                                        ${amount.toLocaleString(undefined, {maximumFractionDigits: 0})}
                                                    </span>
                                                </div>
                                                <div className="h-1.5 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                                    <div className="h-full rounded-full" style={{ 
                                                        backgroundColor: CAT_COLORS[cat] || '#ef4444',
                                                        width: `${(amount / sankeyData.totalExpenses) * 100}%` 
                                                    }} />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// ============== TRANSFER MATCHING ==============
const TransferMatching = ({ expenses, merchantRules }) => {
    const [dateRange, setDateRange] = useState(5); // Days tolerance for matching
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    
    // Categories that represent transfers (Excluded is now empty, all CC payments are Transfer)
    const TRANSFER_CATEGORIES = ['Transfer'];
    
    // Matching algorithm
    const matchingData = useMemo(() => {
        // Filter to selected year and transfer categories
        const transfers = expenses.filter(e => {
            const year = getY(e.date);
            if (year !== selectedYear) return false;
            const cat = getEffectiveCategory(e, merchantRules).category;
            return TRANSFER_CATEGORIES.includes(cat);
        });
        
        // Separate into outflows (negative/sent) and inflows (positive/received)
        // For checking accounts: negative amount = money leaving
        // For credit cards: positive amount = payment received
        const outflows = []; // Money leaving (checking account debits, transfers out)
        const inflows = [];  // Money arriving (credit card payments received)
        
        transfers.forEach(t => {
            const amount = safe(t.amount);
            const rawAmount = t.rawAmount || amount;
            const accountType = t.accountType || 'credit';
            const desc = (t.description || '').toLowerCase();
            
            // Determine if this is an outflow or inflow based on context
            // Checking account: negative raw amount = outflow
            // Credit card: transactions are payments TO the card = inflow
            
            if (accountType === 'checking') {
                // For checking: use raw amount sign
                // Also check description for transfer direction
                if (rawAmount < 0 || desc.includes('transfer to') || desc.includes('payment to') || desc.includes('autopay')) {
                    outflows.push({ ...t, matchAmount: Math.abs(amount) });
                } else if (rawAmount > 0 || desc.includes('transfer from')) {
                    inflows.push({ ...t, matchAmount: Math.abs(amount) });
                } else {
                    // Default: treat as outflow if amount shown is positive (expense)
                    outflows.push({ ...t, matchAmount: Math.abs(amount) });
                }
            } else {
                // Credit card transfers are typically payments received (inflows)
                inflows.push({ ...t, matchAmount: Math.abs(amount) });
            }
        });
        
        // Sort by date
        outflows.sort((a, b) => new Date(a.date) - new Date(b.date));
        inflows.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Matching algorithm
        const matched = [];
        const usedInflowIds = new Set();
        const unmatchedOutflows = [];
        
        outflows.forEach(outflow => {
            const outDate = new Date(outflow.date);
            let bestMatch = null;
            let bestDaysDiff = Infinity;
            
            // Find best matching inflow
            for (const inflow of inflows) {
                if (usedInflowIds.has(inflow.id)) continue;
                
                // Check amount match (exact)
                if (Math.abs(outflow.matchAmount - inflow.matchAmount) > 0.01) continue;
                
                // Check date range (inflow should be same day or after outflow)
                const inDate = new Date(inflow.date);
                const daysDiff = Math.floor((inDate - outDate) / (1000 * 60 * 60 * 24));
                
                // Allow for some flexibility - inflow can be before or after within range
                if (Math.abs(daysDiff) <= dateRange) {
                    if (Math.abs(daysDiff) < Math.abs(bestDaysDiff)) {
                        bestMatch = inflow;
                        bestDaysDiff = daysDiff;
                    }
                }
            }
            
            if (bestMatch) {
                usedInflowIds.add(bestMatch.id);
                matched.push({
                    outflow,
                    inflow: bestMatch,
                    amount: outflow.matchAmount,
                    daysDiff: bestDaysDiff
                });
            } else {
                unmatchedOutflows.push(outflow);
            }
        });
        
        // Find unmatched inflows
        const unmatchedInflows = inflows.filter(i => !usedInflowIds.has(i.id));
        
        // Calculate totals
        const totalMatched = matched.reduce((sum, m) => sum + m.amount, 0);
        const totalUnmatchedOut = unmatchedOutflows.reduce((sum, t) => sum + Math.abs(safe(t.amount)), 0);
        const totalUnmatchedIn = unmatchedInflows.reduce((sum, t) => sum + Math.abs(safe(t.amount)), 0);
        
        return {
            matched,
            unmatchedOutflows,
            unmatchedInflows,
            totalMatched,
            totalUnmatchedOut,
            totalUnmatchedIn,
            outflowCount: outflows.length,
            inflowCount: inflows.length
        };
    }, [expenses, merchantRules, selectedYear, dateRange]);
    
    // Get available years
    const availableYears = useMemo(() => {
        const years = new Set();
        expenses.forEach(e => {
            const year = getY(e.date);
            if (year >= MIN_YEAR) years.add(year);
        });
        return [...years].sort((a, b) => b - a);
    }, [expenses]);
    
    const matchRate = matchingData.outflowCount > 0 
        ? ((matchingData.matched.length / matchingData.outflowCount) * 100).toFixed(0) 
        : 0;
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-violet-500 to-purple-600 text-white p-6 rounded-2xl flex justify-between items-center">
                <div>
                    <h2 className="text-xl font-black">üîÑ Transfer Matching</h2>
                    <p className="text-violet-100 text-sm mt-1">Verify internal transfers between accounts</p>
                </div>
                <div className="flex gap-3">
                    <div>
                        <label className="text-[10px] text-violet-200 block mb-1">Year</label>
                        <select 
                            value={selectedYear} 
                            onChange={e => setSelectedYear(Number(e.target.value))}
                            className="bg-white/20 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm font-bold outline-none">
                            {availableYears.map(y => <option key={y} value={y} className="text-slate-800">{y}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="text-[10px] text-violet-200 block mb-1">Date Tolerance</label>
                        <select 
                            value={dateRange} 
                            onChange={e => setDateRange(Number(e.target.value))}
                            className="bg-white/20 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm font-bold outline-none">
                            {[1,2,3,5,7,10,14,30].map(d => <option key={d} value={d} className="text-slate-800">¬±{d} days</option>)}
                        </select>
                    </div>
                </div>
            </div>
            
            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-600 uppercase">‚úì Matched Volume</h3>
                    <p className="text-2xl font-black text-green-600">${matchingData.totalMatched.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    <p className="text-xs text-green-500 mt-1">{matchingData.matched.length} pairs found</p>
                </div>
                <div className={`bg-white p-5 rounded-2xl border shadow-lg ${matchingData.unmatchedOutflows.length > 0 ? 'border-red-300' : 'border-slate-100'}`}>
                    <h3 className={`text-[10px] font-bold uppercase ${matchingData.unmatchedOutflows.length > 0 ? 'text-red-600' : 'text-slate-400'}`}>
                        ‚ö†Ô∏è Unmatched Outflows
                    </h3>
                    <p className={`text-2xl font-black ${matchingData.unmatchedOutflows.length > 0 ? 'text-red-600' : 'text-slate-400'}`}>
                        ${matchingData.totalUnmatchedOut.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">{matchingData.unmatchedOutflows.length} orphaned</p>
                </div>
                <div className={`bg-white p-5 rounded-2xl border shadow-lg ${matchingData.unmatchedInflows.length > 0 ? 'border-amber-300' : 'border-slate-100'}`}>
                    <h3 className={`text-[10px] font-bold uppercase ${matchingData.unmatchedInflows.length > 0 ? 'text-amber-600' : 'text-slate-400'}`}>
                        ‚ö†Ô∏è Unmatched Inflows
                    </h3>
                    <p className={`text-2xl font-black ${matchingData.unmatchedInflows.length > 0 ? 'text-amber-600' : 'text-slate-400'}`}>
                        ${matchingData.totalUnmatchedIn.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">{matchingData.unmatchedInflows.length} orphaned</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Match Rate</h3>
                    <p className="text-2xl font-black text-indigo-600">{matchRate}%</p>
                    <div className="h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden">
                        <div className="h-full bg-indigo-500 rounded-full" style={{ width: `${matchRate}%` }}/>
                    </div>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Transfers</h3>
                    <p className="text-2xl font-black text-slate-700">{matchingData.outflowCount + matchingData.inflowCount}</p>
                    <p className="text-xs text-slate-500 mt-1">{matchingData.outflowCount} out / {matchingData.inflowCount} in</p>
                </div>
            </div>
            
            {/* Matched Pairs Table */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 bg-green-50">
                    <h3 className="text-sm font-black text-green-800">‚úì Matched Transfer Pairs ({matchingData.matched.length})</h3>
                </div>
                <div className="overflow-x-auto max-h-96">
                    <table className="w-full text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-3 text-left">Date Sent</th>
                                <th className="p-3 text-left">From Account</th>
                                <th className="p-3 text-left">Description</th>
                                <th className="p-3 text-right">Amount</th>
                                <th className="p-3 text-center">‚Üí</th>
                                <th className="p-3 text-left">Date Received</th>
                                <th className="p-3 text-left">To Account</th>
                                <th className="p-3 text-center">Days Œî</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {matchingData.matched.length === 0 ? (
                                <tr><td colSpan={8} className="p-8 text-center text-slate-400">No matched pairs found</td></tr>
                            ) : matchingData.matched.map((pair, i) => (
                                <tr key={i} className="hover:bg-green-50/50">
                                    <td className="p-3 text-slate-600 whitespace-nowrap">{pair.outflow.date}</td>
                                    <td className="p-3 text-slate-700 font-semibold text-xs">{pair.outflow.account}</td>
                                    <td className="p-3 text-slate-500 text-xs truncate max-w-[150px]" title={pair.outflow.description}>{pair.outflow.description}</td>
                                    <td className="p-3 text-right font-bold text-green-600">${pair.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                    <td className="p-3 text-center text-green-500 font-bold">‚Üí</td>
                                    <td className="p-3 text-slate-600 whitespace-nowrap">{pair.inflow.date}</td>
                                    <td className="p-3 text-slate-700 font-semibold text-xs">{pair.inflow.account}</td>
                                    <td className="p-3 text-center">
                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                            pair.daysDiff === 0 ? 'bg-green-100 text-green-700' :
                                            Math.abs(pair.daysDiff) <= 2 ? 'bg-blue-100 text-blue-700' :
                                            'bg-amber-100 text-amber-700'
                                        }`}>
                                            {pair.daysDiff === 0 ? 'Same day' : `${pair.daysDiff > 0 ? '+' : ''}${pair.daysDiff}d`}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {/* Unmatched Outflows */}
            {matchingData.unmatchedOutflows.length > 0 && (
                <div className="bg-white rounded-2xl border border-red-200 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-red-100 bg-red-50">
                        <h3 className="text-sm font-black text-red-800">‚ö†Ô∏è Unmatched Outflows ({matchingData.unmatchedOutflows.length})</h3>
                        <p className="text-xs text-red-600 mt-1">Money left these accounts but no matching inflow found</p>
                    </div>
                    <div className="overflow-x-auto max-h-64">
                        <table className="w-full text-sm">
                            <thead className="bg-red-50/50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                                <tr>
                                    <th className="p-3 text-left">Date</th>
                                    <th className="p-3 text-left">Account</th>
                                    <th className="p-3 text-left">Description</th>
                                    <th className="p-3 text-right">Amount</th>
                                    <th className="p-3 text-left">Possible Issue</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {matchingData.unmatchedOutflows.map(t => (
                                    <tr key={t.id} className="hover:bg-red-50/50">
                                        <td className="p-3 text-slate-600 whitespace-nowrap">{t.date}</td>
                                        <td className="p-3 text-slate-700 font-semibold text-xs">{t.account}</td>
                                        <td className="p-3 text-slate-500 text-xs truncate max-w-[200px]" title={t.description}>{t.description}</td>
                                        <td className="p-3 text-right font-bold text-red-600">${Math.abs(safe(t.amount)).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                        <td className="p-3 text-xs text-slate-500">
                                            {t.description?.toLowerCase().includes('atm') ? 'üèß ATM withdrawal' :
                                             t.description?.toLowerCase().includes('fee') ? 'üí∞ Bank fee' :
                                             '‚ùì No matching inflow found'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {/* Unmatched Inflows */}
            {matchingData.unmatchedInflows.length > 0 && (
                <div className="bg-white rounded-2xl border border-amber-200 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-amber-100 bg-amber-50">
                        <h3 className="text-sm font-black text-amber-800">‚ö†Ô∏è Unmatched Inflows ({matchingData.unmatchedInflows.length})</h3>
                        <p className="text-xs text-amber-600 mt-1">Payments received but no matching outflow found</p>
                    </div>
                    <div className="overflow-x-auto max-h-64">
                        <table className="w-full text-sm">
                            <thead className="bg-amber-50/50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                                <tr>
                                    <th className="p-3 text-left">Date</th>
                                    <th className="p-3 text-left">Account</th>
                                    <th className="p-3 text-left">Description</th>
                                    <th className="p-3 text-right">Amount</th>
                                    <th className="p-3 text-left">Possible Issue</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {matchingData.unmatchedInflows.map(t => (
                                    <tr key={t.id} className="hover:bg-amber-50/50">
                                        <td className="p-3 text-slate-600 whitespace-nowrap">{t.date}</td>
                                        <td className="p-3 text-slate-700 font-semibold text-xs">{t.account}</td>
                                        <td className="p-3 text-slate-500 text-xs truncate max-w-[200px]" title={t.description}>{t.description}</td>
                                        <td className="p-3 text-right font-bold text-amber-600">${Math.abs(safe(t.amount)).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                        <td className="p-3 text-xs text-slate-500">
                                            {t.description?.toLowerCase().includes('refund') ? '‚Ü©Ô∏è Possible refund' :
                                             t.description?.toLowerCase().includes('credit') ? 'üí≥ Statement credit' :
                                             '‚ùì No matching outflow found'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {/* Help Section */}
            <div className="bg-slate-50 border border-slate-200 rounded-2xl p-5">
                <h3 className="font-bold text-slate-700 mb-2">üìñ How Transfer Matching Works</h3>
                <div className="text-sm text-slate-600 space-y-2">
                    <p><strong>Outflows:</strong> Transactions categorized as "Transfer" or "Excluded" where money left a checking account (negative amounts, or descriptions like "transfer to", "payment to")</p>
                    <p><strong>Inflows:</strong> Transactions on credit cards categorized as "Transfer" (payments received)</p>
                    <p><strong>Matching:</strong> Pairs are matched by exact amount and date within ¬±{dateRange} days</p>
                    <p><strong>Red Flags:</strong></p>
                    <ul className="list-disc list-inside ml-4 text-slate-500">
                        <li><span className="text-red-600">Unmatched Outflows</span> - Money left but didn't arrive (wrong category? missing import?)</li>
                        <li><span className="text-amber-600">Unmatched Inflows</span> - Payment arrived but can't find source (external payment? wrong date range?)</li>
                    </ul>
                </div>
            </div>
        </div>
    );
};

// ============== EXPORT RULES (DEVELOPER MODE) ==============
const ExportRules = ({ merchantRules, expenses }) => {
    const [copied, setCopied] = useState(false);
    const [exportType, setExportType] = useState('all'); // 'all', 'global', 'accounts'
    
    // Generate statistics about rules
    const ruleStats = useMemo(() => {
        const globalRules = {};
        const accountRules = {};
        
        Object.entries(merchantRules).forEach(([key, value]) => {
            if (key.includes('|||')) {
                // Account-specific rule
                const merchant = key.split('|||')[0];
                if (value.scope === 'accounts' && value.accounts) {
                    accountRules[key] = { merchant, category: value.category, accounts: value.accounts };
                } else if (value.account) {
                    // Legacy single account
                    accountRules[key] = { merchant, category: value.category, accounts: [value.account] };
                }
            } else if (value.scope === 'global') {
                globalRules[key] = value.category;
            }
        });
        
        return { globalRules, accountRules, totalRules: Object.keys(merchantRules).length };
    }, [merchantRules]);
    
    // Generate the code snippet for AUTO_RULES additions
    const generateAutoRulesCode = () => {
        const lines = [];
        lines.push('// ========== NEW AUTO_RULES KEYWORDS ==========');
        lines.push('// Copy these keywords into the appropriate category in AUTO_RULES');
        lines.push('');
        
        // Group by category
        const byCategory = {};
        Object.entries(ruleStats.globalRules).forEach(([merchant, category]) => {
            if (!byCategory[category]) byCategory[category] = [];
            // Convert merchant name to a keyword (lowercase, simplified)
            const keyword = merchant.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
            if (keyword) byCategory[category].push(keyword);
        });
        
        Object.entries(byCategory).sort((a, b) => a[0].localeCompare(b[0])).forEach(([cat, keywords]) => {
            lines.push(`// ${cat}:`);
            keywords.forEach(kw => {
                lines.push(`'${kw}',`);
            });
            lines.push('');
        });
        
        return lines.join('\n');
    };
    
    // Generate the code snippet for merchantRules (full export)
    const generateMerchantRulesCode = () => {
        const lines = [];
        lines.push('// ========== MERCHANT RULES EXPORT ==========');
        lines.push('// Paste this into localStorage or use to initialize merchantRules');
        lines.push('');
        lines.push('const SAVED_MERCHANT_RULES = {');
        
        // Global rules
        Object.entries(ruleStats.globalRules).sort((a, b) => a[0].localeCompare(b[0])).forEach(([merchant, category]) => {
            const escapedMerchant = merchant.replace(/'/g, "\\'");
            lines.push(`    '${escapedMerchant}': { category: '${category}', scope: 'global' },`);
        });
        
        // Account-specific rules
        Object.entries(ruleStats.accountRules).sort((a, b) => a[0].localeCompare(b[0])).forEach(([key, rule]) => {
            const escapedKey = key.replace(/'/g, "\\'");
            const accountsStr = JSON.stringify(rule.accounts);
            lines.push(`    '${escapedKey}': { category: '${rule.category}', scope: 'accounts', accounts: ${accountsStr} },`);
        });
        
        lines.push('};');
        
        return lines.join('\n');
    };
    
    // Generate PRIORITY_RULES additions
    const generatePriorityRulesCode = () => {
        const lines = [];
        lines.push('// ========== SUGGESTED PRIORITY_RULES ADDITIONS ==========');
        lines.push('// Add these to PRIORITY_RULES if you want them to override CC payoff detection');
        lines.push('');
        lines.push('const NEW_PRIORITY_RULES = {');
        
        Object.entries(ruleStats.globalRules).sort((a, b) => a[0].localeCompare(b[0])).forEach(([merchant, category]) => {
            const keyword = merchant.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
            if (keyword) {
                lines.push(`    // ${category}: ['${keyword}'],`);
            }
        });
        
        lines.push('};');
        
        return lines.join('\n');
    };
    
    // Combined export
    const generateFullExport = () => {
        const sections = [];
        sections.push('// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        sections.push('// EXPENSE TRACKER - RULES EXPORT');
        sections.push(`// Generated: ${new Date().toISOString()}`);
        sections.push(`// Total Rules: ${ruleStats.totalRules}`);
        sections.push(`// Global Rules: ${Object.keys(ruleStats.globalRules).length}`);
        sections.push(`// Account Rules: ${Object.keys(ruleStats.accountRules).length}`);
        sections.push('// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        sections.push('');
        sections.push(generateAutoRulesCode());
        sections.push('');
        sections.push(generateMerchantRulesCode());
        sections.push('');
        sections.push(generatePriorityRulesCode());
        
        return sections.join('\n');
    };
    
    const getExportContent = () => {
        switch (exportType) {
            case 'auto': return generateAutoRulesCode();
            case 'merchant': return generateMerchantRulesCode();
            case 'priority': return generatePriorityRulesCode();
            default: return generateFullExport();
        }
    };
    
    const copyToClipboard = () => {
        navigator.clipboard.writeText(getExportContent());
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };
    
    const downloadAsFile = () => {
        const content = getExportContent();
        const blob = new Blob([content], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `expense-rules-${new Date().toISOString().split('T')[0]}.js`;
        a.click();
        URL.revokeObjectURL(url);
    };
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-slate-700 to-slate-900 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black">üõ†Ô∏è Export Rules (Developer Mode)</h2>
                <p className="text-slate-300 text-sm mt-1">Export your categorization rules to hardcode into the source</p>
            </div>
            
            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Rules</h3>
                    <p className="text-3xl font-black text-slate-900">{ruleStats.totalRules}</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-purple-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-purple-600 uppercase">üåç Global Rules</h3>
                    <p className="text-3xl font-black text-purple-600">{Object.keys(ruleStats.globalRules).length}</p>
                    <p className="text-xs text-slate-500 mt-1">Apply to all accounts</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-cyan-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-cyan-600 uppercase">üí≥ Account Rules</h3>
                    <p className="text-3xl font-black text-cyan-600">{Object.keys(ruleStats.accountRules).length}</p>
                    <p className="text-xs text-slate-500 mt-1">Account-specific overrides</p>
                </div>
            </div>
            
            {/* Export Type Selector */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100">
                    <h3 className="text-sm font-black text-slate-800">üì¶ Export Type</h3>
                </div>
                <div className="p-4">
                    <div className="flex flex-wrap gap-2">
                        {[
                            { key: 'all', label: 'üìã Full Export', desc: 'Everything' },
                            { key: 'auto', label: 'üî§ AUTO_RULES', desc: 'Keywords only' },
                            { key: 'merchant', label: 'üè™ Merchant Rules', desc: 'JSON format' },
                            { key: 'priority', label: '‚ö° PRIORITY_RULES', desc: 'Hard overrides' }
                        ].map(opt => (
                            <button 
                                key={opt.key}
                                onClick={() => setExportType(opt.key)}
                                className={`px-4 py-2 rounded-xl text-sm font-bold transition-all ${
                                    exportType === opt.key 
                                        ? 'bg-indigo-600 text-white' 
                                        : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                }`}>
                                {opt.label}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
            
            {/* Code Output */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 className="text-sm font-black text-slate-800">üìù Generated Code</h3>
                    <div className="flex gap-2">
                        <button 
                            onClick={downloadAsFile}
                            className="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200">
                            üíæ Download
                        </button>
                        <button 
                            onClick={copyToClipboard}
                            className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${
                                copied 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-indigo-600 text-white hover:bg-indigo-700'
                            }`}>
                            {copied ? '‚úì Copied!' : 'üìã Copy to Clipboard'}
                        </button>
                    </div>
                </div>
                <div className="p-4">
                    <pre className="bg-slate-900 text-green-400 p-4 rounded-xl text-xs overflow-auto max-h-96 font-mono whitespace-pre-wrap">
                        {getExportContent()}
                    </pre>
                </div>
            </div>
            
            {/* Instructions */}
            <div className="bg-amber-50 border border-amber-200 rounded-2xl p-5">
                <h3 className="font-bold text-amber-800 mb-2">üìñ How to Use This Export</h3>
                <ol className="text-sm text-amber-700 space-y-2 list-decimal list-inside">
                    <li>Categorize transactions in the <strong>Categories</strong> page</li>
                    <li>Come here and click <strong>"Copy to Clipboard"</strong></li>
                    <li>Paste the code into a chat with Claude and say: <em>"Add these to my expense tracker rules"</em></li>
                    <li>Claude will update your source code with the new rules</li>
                    <li>Push to GitHub and your rules are saved permanently!</li>
                </ol>
            </div>
            
            {/* Rules Preview */}
            {Object.keys(ruleStats.globalRules).length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100">
                        <h3 className="text-sm font-black text-slate-800">üåç Global Rules Preview</h3>
                    </div>
                    <div className="p-4 max-h-64 overflow-y-auto">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            {Object.entries(ruleStats.globalRules).sort((a, b) => a[0].localeCompare(b[0])).map(([merchant, category]) => (
                                <div key={merchant} className="flex items-center gap-2 p-2 bg-slate-50 rounded-lg">
                                    <span className="text-xs font-semibold text-slate-600 truncate flex-1" title={merchant}>{merchant}</span>
                                    <span className="text-[10px] font-bold text-white px-2 py-0.5 rounded" style={{ backgroundColor: CAT_COLORS[category] || '#6366f1' }}>
                                        {category}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
            
            {/* Account Rules Preview */}
            {Object.keys(ruleStats.accountRules).length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100">
                        <h3 className="text-sm font-black text-slate-800">üí≥ Account-Specific Rules Preview</h3>
                    </div>
                    <div className="p-4 max-h-64 overflow-y-auto">
                        <div className="space-y-2">
                            {Object.entries(ruleStats.accountRules).sort((a, b) => a[0].localeCompare(b[0])).map(([key, rule]) => (
                                <div key={key} className="flex items-center gap-2 p-2 bg-cyan-50 rounded-lg">
                                    <span className="text-xs font-semibold text-slate-600 truncate" style={{maxWidth: '150px'}} title={rule.merchant}>{rule.merchant}</span>
                                    <span className="text-[9px] text-slate-400 truncate" style={{maxWidth: '150px'}} title={rule.accounts.join(', ')}>
                                        ({rule.accounts.length > 1 ? `${rule.accounts.length} accounts` : rule.accounts[0]})
                                    </span>
                                    <span className="text-[10px] font-bold text-white px-2 py-0.5 rounded ml-auto" style={{ backgroundColor: CAT_COLORS[rule.category] || '#6366f1' }}>
                                        {rule.category}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

// ============== AI ANALYST EXPORT ==============
const AIAnalystExport = ({ expenses, merchantRules }) => {
    const [report, setReport] = useState('');
    const [copied, setCopied] = useState(false);
    const [generating, setGenerating] = useState(false);
    
    const generateReport = () => {
        setGenerating(true);
        
        // Small delay for UX feedback
        setTimeout(() => {
            const lines = [];
            const now = new Date();
            
            // Helper to format currency
            const fmt = (n) => '$' + n.toLocaleString(undefined, { maximumFractionDigits: 0 });
            const fmtPct = (n) => n.toFixed(1) + '%';
            
            // Filter to 2024 and 2025 only
            const validYears = [2024, 2025];
            
            // Filter valid expenses (exclude transfers, income for spending analysis)
            const allExpenses = expenses.filter(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const year = getY(e.date);
                return !EXCLUDED_CATEGORIES.includes(cat) && validYears.includes(year);
            });
            
            const incomeExpenses = expenses.filter(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const year = getY(e.date);
                return (cat === 'Income' || cat === 'TaxIncome') && validYears.includes(year);
            });
            
            // Separate by year
            const exp2024 = allExpenses.filter(e => getY(e.date) === 2024);
            const exp2025 = allExpenses.filter(e => getY(e.date) === 2025);
            const total2024 = exp2024.reduce((s, e) => s + safe(e.amount), 0);
            const total2025 = exp2025.reduce((s, e) => s + safe(e.amount), 0);
            
            // === HEADER ===
            lines.push('# üìä Personal Finance Report (2024-2025)');
            lines.push('');
            lines.push(`**Generated:** ${now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`);
            lines.push(`**Focus Period:** 2024-2025 (with emphasis on 2025 insights)`);
            lines.push(`**Total Transactions Analyzed:** ${allExpenses.length.toLocaleString()}`);
            lines.push('');
            lines.push('---');
            lines.push('');
            
            // === ANNUAL COMPARISON ===
            lines.push('## üìÖ 2024 vs 2025 Overview');
            lines.push('');
            lines.push('| Metric | 2024 | 2025 | Change |');
            lines.push('|--------|------|------|--------|');
            
            const months2024 = new Set(exp2024.map(e => getM(e.date))).size || 1;
            const months2025 = new Set(exp2025.map(e => getM(e.date))).size || 1;
            const monthlyAvg2024 = total2024 / months2024;
            const monthlyAvg2025 = total2025 / months2025;
            const yoyChange = total2024 > 0 ? ((total2025 - total2024) / total2024) * 100 : 0;
            const monthlyChange = monthlyAvg2024 > 0 ? ((monthlyAvg2025 - monthlyAvg2024) / monthlyAvg2024) * 100 : 0;
            
            lines.push(`| Total Spending | ${fmt(total2024)} | ${fmt(total2025)} | ${yoyChange >= 0 ? '+' : ''}${fmtPct(yoyChange)} |`);
            lines.push(`| Transactions | ${exp2024.length} | ${exp2025.length} | ${exp2025.length - exp2024.length >= 0 ? '+' : ''}${exp2025.length - exp2024.length} |`);
            lines.push(`| Monthly Average | ${fmt(monthlyAvg2024)} | ${fmt(monthlyAvg2025)} | ${monthlyChange >= 0 ? '+' : ''}${fmtPct(monthlyChange)} |`);
            lines.push(`| Avg Transaction | ${fmt(exp2024.length > 0 ? total2024/exp2024.length : 0)} | ${fmt(exp2025.length > 0 ? total2025/exp2025.length : 0)} | |`);
            lines.push('');
            
            // === COST STRUCTURE ANALYSIS (2025 Focus) ===
            lines.push('## üì¶ 2025 Cost Structure Analysis');
            lines.push('');
            lines.push('*Expenses are categorized into three cost types for budgeting analysis:*');
            lines.push('- **Fixed:** Mandatory expenses (Rent, Daycare)');
            lines.push('- **Semi-Fixed:** Necessary but variable (Household, Groceries, Subscriptions)');
            lines.push('- **Variable:** Discretionary spending (all other categories)');
            lines.push('');
            
            // Calculate cost structure for 2025
            const costStructure2025 = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0 };
            exp2025.forEach(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const costType = getCostType(cat);
                costStructure2025[costType] += safe(e.amount);
            });
            
            const costStructure2024 = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0 };
            exp2024.forEach(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const costType = getCostType(cat);
                costStructure2024[costType] += safe(e.amount);
            });
            
            lines.push('| Cost Type | 2024 | 2025 | % of 2025 | YoY Change |');
            lines.push('|-----------|------|------|-----------|------------|');
            ['Fixed', 'Semi-Fixed', 'Variable'].forEach(type => {
                const val2024 = costStructure2024[type];
                const val2025 = costStructure2025[type];
                const pct2025 = total2025 > 0 ? (val2025 / total2025) * 100 : 0;
                const change = val2024 > 0 ? ((val2025 - val2024) / val2024) * 100 : 0;
                lines.push(`| **${type}** | ${fmt(val2024)} | ${fmt(val2025)} | ${fmtPct(pct2025)} | ${change >= 0 ? '+' : ''}${fmtPct(change)} |`);
            });
            lines.push(`| **TOTAL** | ${fmt(total2024)} | ${fmt(total2025)} | 100% | ${yoyChange >= 0 ? '+' : ''}${fmtPct(yoyChange)} |`);
            lines.push('');
            
            // Cost structure insight
            const fixedPct = total2025 > 0 ? (costStructure2025.Fixed / total2025) * 100 : 0;
            const semiFixedPct = total2025 > 0 ? (costStructure2025['Semi-Fixed'] / total2025) * 100 : 0;
            const variablePct = total2025 > 0 ? (costStructure2025.Variable / total2025) * 100 : 0;
            
            lines.push('### üîç Cost Structure Insights');
            lines.push(`- **${fmtPct(fixedPct + semiFixedPct)}** of spending is Fixed or Semi-Fixed (committed costs)`);
            lines.push(`- **${fmtPct(variablePct)}** is Variable (discretionary - potential savings area)`);
            if (variablePct > 50) {
                lines.push(`- ‚ö†Ô∏è Variable spending is over 50% - high discretionary spending`);
            }
            if (fixedPct > 40) {
                lines.push(`- ‚ö†Ô∏è Fixed costs are over 40% - limited budget flexibility`);
            }
            lines.push('');
            
            // === MONTHLY COST STRUCTURE (2025) ===
            lines.push('## üìà 2025 Monthly Cost Structure');
            lines.push('');
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyCostStructure = {};
            
            exp2025.forEach(e => {
                const month = getM(e.date);
                const cat = getEffectiveCategory(e, merchantRules).category;
                const costType = getCostType(cat);
                if (!monthlyCostStructure[month]) {
                    monthlyCostStructure[month] = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 };
                }
                monthlyCostStructure[month][costType] += safe(e.amount);
                monthlyCostStructure[month].total += safe(e.amount);
            });
            
            lines.push('| Month | Fixed | Semi-Fixed | Variable | Total |');
            lines.push('|-------|-------|------------|----------|-------|');
            for (let m = 0; m < 12; m++) {
                if (monthlyCostStructure[m]) {
                    const mc = monthlyCostStructure[m];
                    lines.push(`| ${monthNames[m]} | ${fmt(mc.Fixed)} | ${fmt(mc['Semi-Fixed'])} | ${fmt(mc.Variable)} | ${fmt(mc.total)} |`);
                }
            }
            lines.push('');
            
            // Monthly stats
            const monthlyTotals = Object.values(monthlyCostStructure).map(m => m.total);
            if (monthlyTotals.length > 0) {
                const avgMonthly = monthlyTotals.reduce((a, b) => a + b, 0) / monthlyTotals.length;
                const maxMonthVal = Math.max(...monthlyTotals);
                const minMonthVal = Math.min(...monthlyTotals);
                const maxMonthIdx = Object.entries(monthlyCostStructure).find(([k, v]) => v.total === maxMonthVal)?.[0];
                const minMonthIdx = Object.entries(monthlyCostStructure).find(([k, v]) => v.total === minMonthVal)?.[0];
                
                lines.push(`- **Average Monthly:** ${fmt(avgMonthly)}`);
                lines.push(`- **Highest:** ${monthNames[maxMonthIdx]} (${fmt(maxMonthVal)})`);
                lines.push(`- **Lowest:** ${monthNames[minMonthIdx]} (${fmt(minMonthVal)})`);
                lines.push(`- **Variance:** ${fmt(maxMonthVal - minMonthVal)} spread`);
                lines.push('');
            }
            
            // === 2025 CATEGORY BREAKDOWN ===
            if (exp2025.length > 0) {
                lines.push('## üè∑Ô∏è 2025 Spending by Category');
                lines.push('');
                
                const byCategory = {};
                exp2025.forEach(e => {
                    const cat = getEffectiveCategory(e, merchantRules).category;
                    if (!byCategory[cat]) byCategory[cat] = { total: 0, count: 0 };
                    byCategory[cat].total += safe(e.amount);
                    byCategory[cat].count += 1;
                });
                
                // Also get 2024 for comparison
                const byCategory2024 = {};
                exp2024.forEach(e => {
                    const cat = getEffectiveCategory(e, merchantRules).category;
                    if (!byCategory2024[cat]) byCategory2024[cat] = { total: 0 };
                    byCategory2024[cat].total += safe(e.amount);
                });
                
                const sortedCats = Object.entries(byCategory)
                    .map(([cat, data]) => ({ 
                        cat, 
                        ...data, 
                        pct: (data.total / total2025) * 100,
                        costType: getCostType(cat),
                        prev: byCategory2024[cat]?.total || 0
                    }))
                    .sort((a, b) => b.total - a.total);
                
                lines.push('| Category | Cost Type | 2025 Amount | % of Total | vs 2024 |');
                lines.push('|----------|-----------|-------------|------------|---------|');
                sortedCats.forEach(({ cat, costType, total, pct, prev }) => {
                    const change = prev > 0 ? ((total - prev) / prev) * 100 : 0;
                    const changeStr = prev > 0 ? `${change >= 0 ? '+' : ''}${fmtPct(change)}` : 'New';
                    lines.push(`| ${cat} | ${costType} | ${fmt(total)} | ${fmtPct(pct)} | ${changeStr} |`);
                });
                lines.push(`| **TOTAL** | | **${fmt(total2025)}** | **100%** | |`);
                lines.push('');
            }
            
            // === INCOME VS EXPENSES (2025) ===
            const income2025 = incomeExpenses.filter(e => getY(e.date) === 2025);
            const totalIncome2025 = income2025.reduce((s, e) => s + Math.abs(safe(e.amount)), 0);
            
            if (totalIncome2025 > 0 && total2025 > 0) {
                lines.push('## üí∞ 2025 Income vs Expenses');
                lines.push('');
                lines.push('| Metric | Amount |');
                lines.push('|--------|--------|');
                lines.push(`| Total Income | ${fmt(totalIncome2025)} |`);
                lines.push(`| Total Expenses | ${fmt(total2025)} |`);
                lines.push(`| **Net Savings** | **${fmt(totalIncome2025 - total2025)}** |`);
                lines.push(`| Savings Rate | ${fmtPct(((totalIncome2025 - total2025) / totalIncome2025) * 100)} |`);
                lines.push(`| Fixed Cost Ratio | ${fmtPct((costStructure2025.Fixed / totalIncome2025) * 100)} of income |`);
                lines.push(`| Committed Cost Ratio | ${fmtPct(((costStructure2025.Fixed + costStructure2025['Semi-Fixed']) / totalIncome2025) * 100)} of income |`);
                lines.push('');
            }
            
            // === TOP MERCHANTS (2025) ===
            if (exp2025.length > 0) {
                lines.push('## üè™ 2025 Top 10 Spending Areas');
                lines.push('');
                
                const byMerchant = {};
                exp2025.forEach(e => {
                    const name = cleanMerchant(e.description);
                    const cat = getEffectiveCategory(e, merchantRules).category;
                    if (!byMerchant[name]) byMerchant[name] = { total: 0, count: 0, category: cat };
                    byMerchant[name].total += safe(e.amount);
                    byMerchant[name].count += 1;
                });
                
                const topMerchants = Object.entries(byMerchant)
                    .map(([name, data]) => ({ name, ...data, costType: getCostType(data.category) }))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 10);
                
                lines.push('| Rank | Merchant | Category | Cost Type | Total | Visits |');
                lines.push('|------|----------|----------|-----------|-------|--------|');
                topMerchants.forEach((m, i) => {
                    lines.push(`| ${i + 1} | ${m.name} | ${m.category} | ${m.costType} | ${fmt(m.total)} | ${m.count} |`);
                });
                lines.push('');
            }
            
            // === RECURRING EXPENSES (2025) ===
            const subscriptionLikely = [];
            const merchantMonthly = {};
            exp2025.forEach(e => {
                const name = cleanMerchant(e.description);
                const month = getM(e.date);
                if (!merchantMonthly[name]) merchantMonthly[name] = new Set();
                merchantMonthly[name].add(month);
            });
            
            Object.entries(merchantMonthly).forEach(([name, months]) => {
                if (months.size >= 3) {
                    const total = exp2025.filter(e => cleanMerchant(e.description) === name)
                        .reduce((s, e) => s + safe(e.amount), 0);
                    const monthly = total / months.size;
                    if (monthly > 5 && monthly < 500) {
                        subscriptionLikely.push({ name, months: months.size, monthly, annual: monthly * 12 });
                    }
                }
            });
            
            if (subscriptionLikely.length > 0) {
                subscriptionLikely.sort((a, b) => b.annual - a.annual);
                const topSubs = subscriptionLikely.slice(0, 8);
                const totalSubsAnnual = topSubs.reduce((s, sub) => s + sub.annual, 0);
                
                lines.push('## üîÑ Likely Recurring Expenses (2025)');
                lines.push('');
                lines.push('| Service | Est. Monthly | Est. Annual | Frequency |');
                lines.push('|---------|--------------|-------------|-----------|');
                topSubs.forEach(sub => {
                    lines.push(`| ${sub.name} | ${fmt(sub.monthly)} | ${fmt(sub.annual)} | ${sub.months} months |`);
                });
                lines.push(`| **Subtotal** | **${fmt(totalSubsAnnual / 12)}** | **${fmt(totalSubsAnnual)}** | |`);
                lines.push('');
            }
            
            // === FOOTER / PROMPT ===
            lines.push('---');
            lines.push('');
            lines.push('## ü§ñ Suggested Questions to Ask AI');
            lines.push('');
            lines.push('1. "Based on my cost structure, how can I reduce my fixed costs?"');
            lines.push('2. "My variable spending is X% - is this healthy? Where can I cut?"');
            lines.push('3. "Which categories grew the most from 2024 to 2025 and why?"');
            lines.push('4. "Help me create a budget that reduces my committed costs ratio."');
            lines.push('5. "What\'s a healthy ratio of Fixed/Semi-Fixed/Variable spending?"');
            lines.push('6. "Are there any concerning trends in my monthly spending pattern?"');
            lines.push('');
            lines.push('---');
            lines.push('*This report contains aggregated 2024-2025 data only. No individual transaction details or bank descriptions are included for privacy.*');
            
            setReport(lines.join('\n'));
            setGenerating(false);
        }, 300);
    };
    
    const copyToClipboard = () => {
        navigator.clipboard.writeText(report);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-cyan-500 to-blue-600 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black">ü§ñ AI Analyst Export</h2>
                <p className="text-cyan-100 text-sm mt-1">Generate a privacy-safe report to paste into ChatGPT, Claude, or other AI assistants</p>
            </div>
            
            {/* Generate Button */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg p-6">
                <div className="flex items-center justify-between mb-4">
                    <div>
                        <h3 className="font-bold text-slate-800">Generate Financial Report</h3>
                        <p className="text-sm text-slate-500 mt-1">Creates a Markdown-formatted summary of your finances</p>
                    </div>
                    <button 
                        onClick={generateReport}
                        disabled={generating}
                        className={`px-6 py-3 rounded-xl font-bold text-white transition-all ${
                            generating 
                                ? 'bg-slate-400 cursor-wait' 
                                : 'bg-gradient-to-r from-cyan-500 to-blue-600 hover:shadow-lg hover:scale-105'
                        }`}>
                        {generating ? '‚è≥ Generating...' : '‚ú® Generate AI Report'}
                    </button>
                </div>
                
                <div className="bg-slate-50 rounded-xl p-4 text-sm text-slate-600">
                    <p className="font-semibold mb-2">üìã What's included (2024-2025 focus):</p>
                    <ul className="grid grid-cols-2 gap-1 text-xs">
                        <li>‚úì 2024 vs 2025 comparison</li>
                        <li>‚úì Cost structure (Fixed/Semi-Fixed/Variable)</li>
                        <li>‚úì Monthly cost breakdown</li>
                        <li>‚úì Category analysis with YoY change</li>
                        <li>‚úì Income vs expenses ratios</li>
                        <li>‚úì Top merchants with cost types</li>
                        <li>‚úì Recurring expense detection</li>
                        <li>‚úì Budget-focused AI questions</li>
                    </ul>
                    <p className="mt-3 text-[10px] text-slate-400">üîí <strong>Privacy:</strong> No individual transactions or raw bank descriptions are included.</p>
                </div>
            </div>
            
            {/* Report Output */}
            {report && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                        <h3 className="text-sm font-black text-slate-800">üìù Generated Report</h3>
                        <button 
                            onClick={copyToClipboard}
                            className={`px-4 py-2 rounded-xl text-sm font-bold transition-all ${
                                copied 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-indigo-600 text-white hover:bg-indigo-700'
                            }`}>
                            {copied ? '‚úì Copied!' : 'üìã Copy to Clipboard'}
                        </button>
                    </div>
                    <div className="p-4">
                        <textarea 
                            readOnly
                            value={report}
                            className="w-full h-96 p-4 bg-slate-900 text-green-400 rounded-xl text-xs font-mono resize-none outline-none"
                        />
                    </div>
                    <div className="p-4 bg-amber-50 border-t border-amber-100">
                        <p className="text-sm text-amber-800 font-semibold">üí° How to use:</p>
                        <ol className="text-xs text-amber-700 mt-2 space-y-1 list-decimal list-inside">
                            <li>Click "Copy to Clipboard" above</li>
                            <li>Open ChatGPT, Claude, or your preferred AI assistant</li>
                            <li>Paste the report and ask questions like: <em>"Analyze my spending and suggest a budget"</em></li>
                        </ol>
                    </div>
                </div>
            )}
        </div>
    );
};

// ============== IMPORT DIALOG ==============
const ImportDialog = ({ headers, onClose, onConfirm, defaultAccountName = '' }) => {
    const isHSBC = defaultAccountName.toLowerCase().includes('hsbc');
    const [map, setMap] = useState({ date: headers.find(h=>/date/i.test(h))||headers[0], amount: headers.find(h=>/amount|debit/i.test(h))||headers[1], desc: headers.find(h=>/desc|memo/i.test(h))||headers[2], cat: headers.find(h=>/cat/i.test(h))||'' });
    const [acc, setAcc] = useState(defaultAccountName);
    const [accType, setAccType] = useState(isHSBC ? 'checking' : 'credit'); // Auto-detect HSBC as checking
    
    return (<div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={onClose}/>
        <div className="relative bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
            <div className="p-6 border-b border-slate-100">
                <h2 className="text-xl font-black text-slate-800">Import CSV</h2>
                <p className="text-sm text-slate-500 mt-1">üìÑ {defaultAccountName || 'Unknown file'}</p>
                {isHSBC && (
                    <div className="mt-2 px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-xs font-semibold inline-block">
                        ‚úì HSBC format detected - columns auto-mapped
                    </div>
                )}
            </div>
            <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                {/* Account Type Selection */}
                <div>
                    <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Account Type</label>
                    <div className="grid grid-cols-2 gap-2">
                        <button onClick={() => setAccType('credit')} className={`p-3 rounded-xl text-sm font-bold border-2 transition-colors ${accType === 'credit' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>
                            üí≥ Credit Card
                        </button>
                        <button onClick={() => setAccType('checking')} className={`p-3 rounded-xl text-sm font-bold border-2 transition-colors ${accType === 'checking' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>
                            üè¶ Checking/Debit
                        </button>
                    </div>
                    <p className="text-[10px] text-slate-400 mt-2">
                        {accType === 'credit' ? 'All transactions treated as expenses' : 'Handles income, transfers, and Venmo reimbursements'}
                    </p>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Date</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.date} onChange={e=>setMap({...map,date:e.target.value})}>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                    <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.amount} onChange={e=>setMap({...map,amount:e.target.value})}>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                </div>
                <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Description</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.desc} onChange={e=>setMap({...map,desc:e.target.value})}>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Category Column (optional)</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.cat} onChange={e=>setMap({...map,cat:e.target.value})}><option value="">-- None --</option>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Account Name (from filename)</label><input type="text" placeholder="e.g., Chase Checking, Amex Gold" value={acc} onChange={e=>setAcc(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none border-2 border-transparent focus:border-indigo-500"/></div>
                
                {/* Info box for checking accounts */}
                {accType === 'checking' && (
                    <div className="p-3 bg-blue-50 rounded-xl border border-blue-200">
                        <p className="text-xs text-blue-700 font-semibold">üí° Checking Account Import</p>
                        <ul className="text-[10px] text-blue-600 mt-1 space-y-0.5">
                            <li>‚Ä¢ Negative amounts = expenses (kept positive)</li>
                            <li>‚Ä¢ Positive amounts = income/deposits (auto-categorized)</li>
                            <li>‚Ä¢ Venmo incoming = reimbursement (shown as credit)</li>
                            <li>‚Ä¢ Credit card payments auto-excluded</li>
                        </ul>
                    </div>
                )}
            </div>
            <div className="p-6 bg-slate-50 flex gap-4"><button onClick={onClose} className="flex-1 py-3 font-bold text-slate-500 rounded-xl hover:bg-slate-200">Cancel</button><button onClick={()=>onConfirm({...map, acc, accType})} className="flex-1 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700">Import</button></div>
        </div>
    </div>);
};

// ============== MAIN APP ==============
const App = () => {
    const [expenses, setExpenses] = useState([]);
    const [merchantRules, setMerchantRules] = useState({});
    const [paidStylecomIds, setPaidStylecomIds] = useState(new Set());
    const [importData, setImportData] = useState(null);
    const [importFileName, setImportFileName] = useState('');
    const [msg, setMsg] = useState('');
    const [tab, setTab] = useState('dashboard');

    useEffect(() => { 
        setExpenses(loadExpenses()); 
        setMerchantRules(loadMerchantRules());
        // Load paid Stylecom IDs
        try {
            const saved = localStorage.getItem('stylecom_paid_ids');
            if (saved) setPaidStylecomIds(new Set(JSON.parse(saved)));
        } catch {}
    }, []);
    
    useEffect(() => { localStorage.setItem('expense_v9', JSON.stringify(expenses)); }, [expenses]);
    useEffect(() => { localStorage.setItem('merchant_rules_v2', JSON.stringify(merchantRules)); }, [merchantRules]);
    useEffect(() => { localStorage.setItem('stylecom_paid_ids', JSON.stringify([...paidStylecomIds])); }, [paidStylecomIds]);

    const toggleStylecomPaid = (id) => {
        setPaidStylecomIds(prev => {
            const next = new Set(prev);
            if (next.has(id)) {
                next.delete(id);
            } else {
                next.add(id);
            }
            return next;
        });
    };

    const handleFile = e => { 
        const f = e.target.files[0]; 
        if (!f) return; 
        // Extract filename without extension for default account name
        const fileName = f.name.replace(/\.[^/.]+$/, ''); // Remove extension
        setImportFileName(fileName);
        
        // Check if this is an HSBC file (no headers)
        const isHSBC = fileName.toLowerCase().includes('hsbc');
        
        if (isHSBC) {
            // HSBC files have no headers - parse without header row
            Papa.parse(f, { 
                header: false, 
                skipEmptyLines: true, 
                complete: r => { 
                    if (r.data.length) {
                        // Transform headerless data to have consistent structure
                        // HSBC format: Date, Description, Amount, Balance
                        const headers = ['Date', 'Description', 'Amount', 'Balance'];
                        const transformedData = r.data.map(row => {
                            const obj = {};
                            headers.forEach((h, i) => {
                                let value = row[i] || '';
                                // Clean up the data
                                if (h === 'Description') {
                                    // Strip excessive whitespace and normalize
                                    value = value.replace(/\s+/g, ' ').trim();
                                } else if (h === 'Amount' || h === 'Balance') {
                                    // Remove commas from numbers (they're in quotes like "1,234.56")
                                    value = String(value).replace(/,/g, '');
                                }
                                obj[h] = value;
                            });
                            return obj;
                        });
                        
                        // Create a result object that looks like PapaParse with headers
                        setImportData({
                            data: transformedData,
                            meta: { fields: headers }
                        });
                    }
                } 
            });
        } else {
            // Standard CSV with headers
            Papa.parse(f, { header: true, skipEmptyLines: true, complete: r => { if (r.data.length) setImportData(r); } }); 
        }
        e.target.value = ''; 
    };
    
    const processImport = (map) => {
        const isCheckingAccount = map.accType === 'checking';
        const isHSBC = (map.acc || '').toLowerCase().includes('hsbc');
        
        const newExp = importData.data.map((row, i) => {
            const desc = row[map.desc] || '';
            const descLower = desc.toLowerCase();
            const raw = String(row[map.amount]||'0').replace(/[^\d.-]/g,'');
            const rawAmount = parseFloat(raw) || 0;
            
            // Only skip truly zero amounts (not small ones like 0.01)
            if (raw === '' || raw === '0' || raw === '0.00') return null;
            
            // Determine transaction type and final amount
            let transactionType = 'expense';
            let finalAmount = Math.abs(rawAmount);
            
            // Check if this is a Venmo transaction (by description, not amount sign)
            const isVenmo = descLower.includes('venmo');
            
            // Check for ONLINE TRANSFER (HSBC style) - these are internal transfers
            const isOnlineTransfer = descLower.includes('online transfer to') || 
                                     descLower.includes('online transfer from') ||
                                     descLower.includes('ach payment to');
            
            // CRITICAL: Check if description indicates a WITHDRAWAL (money going OUT)
            // This overrides the raw amount sign for checking accounts
            const isWithdrawal = descLower.includes('withdrawal');
            const isDeposit = descLower.includes('deposit') && !isWithdrawal && !isOnlineTransfer;
            
            if (isVenmo) {
                // Venmo: Use description keywords to determine direction
                // "Withdrawal" = money going OUT = expense (positive)
                // "Deposit" or "Cashout" = money coming IN = reimbursement (negative)
                const isVenmoDeposit = descLower.includes('deposit') || descLower.includes('cashout');
                
                if (isVenmoDeposit) {
                    // Venmo deposit/cashout = reimbursement = NEGATIVE expense
                    transactionType = 'venmo-reimbursement';
                    finalAmount = -Math.abs(rawAmount);
                } else {
                    // Venmo withdrawal/payment or unspecified = expense = POSITIVE
                    transactionType = 'venmo-payment';
                    finalAmount = Math.abs(rawAmount);
                }
            } else if (isOnlineTransfer) {
                // HSBC Online Transfers - categorize as transfer (excluded from expenses)
                transactionType = 'transfer';
                finalAmount = Math.abs(rawAmount);
            } else if (isCheckingAccount) {
                // Checking account: Use DESCRIPTION to determine direction, not amount sign
                // "Withdrawal" = money OUT = expense (regardless of sign in CSV)
                // "Deposit" = money IN = income
                
                if (isWithdrawal) {
                    // ALL withdrawals are EXPENSES (money leaving account)
                    transactionType = 'expense';
                    finalAmount = Math.abs(rawAmount);
                } else if (isDeposit) {
                    // Deposits are income
                    transactionType = 'income';
                    finalAmount = Math.abs(rawAmount);
                } else {
                    // Fallback: use raw amount sign
                    const isIncoming = rawAmount > 0;
                    if (isIncoming) {
                        transactionType = 'income';
                        finalAmount = Math.abs(rawAmount);
                    } else {
                        transactionType = 'expense';
                        finalAmount = Math.abs(rawAmount);
                    }
                }
            } else {
                // Credit card: all transactions are expenses (positive amounts)
                transactionType = 'expense';
                finalAmount = Math.abs(rawAmount);
            }
            
            // Store original CSV category
            const csvCategory = map.cat && row[map.cat] ? fuzzyMatchCSV(row[map.cat]) : 'Uncategorized';
            
            // Clean the description by stripping payment processor prefixes
            const cleanedDesc = cleanDescription(desc);
            
            return { 
                id: `e-${Date.now()}-${i}`, 
                date: row[map.date] || new Date().toISOString().split('T')[0], 
                description: cleanedDesc,  // Use cleaned description for display and categorization
                rawDescription: desc,      // Keep original for auditing
                amount: finalAmount,
                rawAmount: rawAmount,  // Keep original signed amount for reference
                transactionType: transactionType,  // expense, income, venmo-payment, venmo-reimbursement
                accountType: map.accType || 'credit',  // credit or checking
                csvCategory: csvCategory,
                manualCategory: null,
                account: map.acc || 'Imported' 
            };
        }).filter(Boolean);
        
        setExpenses([...expenses, ...newExp]);
        setImportData(null);
        setMsg(`‚úÖ Imported ${newExp.length} transactions`);
        setTimeout(() => setMsg(''), 4000);
    };

    const updateExpenseCategory = (id, category) => {
        setExpenses(expenses.map(e => e.id === id ? {...e, manualCategory: category} : e));
    };

    const updateMerchantRule = (merchant, category, scope = 'global', accounts = []) => {
        const newRules = {...merchantRules};
        
        if (scope === 'accounts' && accounts.length > 0) {
            // Multi-account rule - use special key format
            const accountsKey = getAccountsRuleKey(merchant);
            newRules[accountsKey] = { category, scope: 'accounts', accounts: accounts };
            setMerchantRules(newRules);
            const accountsList = accounts.length > 2 
                ? `${accounts.slice(0, 2).join(', ')} +${accounts.length - 2} more`
                : accounts.join(', ');
            setMsg(`‚úÖ Account rule: "${merchant}" ‚Üí ${category} (for ${accountsList})`);
        } else {
            // Global rule
            newRules[merchant] = { category, scope: 'global' };
            setMerchantRules(newRules);
            setMsg(`‚úÖ Global rule: "${merchant}" ‚Üí ${category}`);
        }
        setTimeout(() => setMsg(''), 4000);
    };

    const deleteMerchantRule = (ruleKey) => {
        const newRules = {...merchantRules};
        delete newRules[ruleKey];
        setMerchantRules(newRules);
    };

    const del = id => setExpenses(expenses.filter(e => e.id !== id));
    
    const exportCSV = () => { 
        const csv = ['date,amount,raw_amount,transaction_type,category,source,account,account_type,description,raw_description,csv_category', 
            ...expenses.map(e => {
                const eff = getEffectiveCategory(e, merchantRules);
                return `${e.date},${e.amount},${e.rawAmount || e.amount},${e.transactionType || 'expense'},${eff.category},${eff.source},${e.account},${e.accountType || 'credit'},"${(e.description||'').replace(/"/g,'""')}","${(e.rawDescription || e.description||'').replace(/"/g,'""')}",${e.csvCategory || ''}`;
            })
        ].join('\n'); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); 
        a.download = 'expenses.csv'; 
        a.click(); 
    };

    return (<div className="min-h-screen pb-20">
        <header className="bg-white/90 backdrop-blur-lg border-b border-slate-100 h-14 flex items-center px-4 justify-between sticky top-0 z-40">
            <div className="flex items-center gap-2"><div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-xl flex items-center justify-center text-white font-black text-sm">S</div><h1 className="text-lg font-black text-slate-800">Smart<span className="text-indigo-600">Expense</span></h1></div>
            <div className="flex gap-2"><button onClick={exportCSV} className="bg-slate-100 text-slate-600 px-3 py-2 rounded-xl font-bold text-xs">üì•</button><label className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-black text-xs cursor-pointer">üì§ Import<input type="file" className="hidden" accept=".csv" onChange={handleFile}/></label></div>
        </header>

        <div className="max-w-7xl mx-auto px-4 mt-4">
            <div className="flex gap-1 bg-slate-100 p-1 rounded-xl w-fit text-xs overflow-x-auto">
                {['dashboard','evolution','flow','categories','stylecom','transfers','transactions','ai','export'].map(t => (
                    <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded-lg font-bold capitalize whitespace-nowrap ${tab===t?'bg-white text-indigo-600 shadow':'text-slate-500'}`}>
                        {t==='dashboard'?'üìä ':t==='evolution'?'üìà ':t==='flow'?'üí∞ ':t==='categories'?'üè∑Ô∏è ':t==='stylecom'?'üëó ':t==='transfers'?'üîÑ ':t==='transactions'?'üìã ':t==='ai'?'ü§ñ ':'üõ†Ô∏è '}{t}
                    </button>
                ))}
            </div>
        </div>

        <main className="max-w-7xl mx-auto px-4 mt-6 space-y-6">
            {msg && <div className="bg-green-50 border border-green-200 rounded-xl p-4 text-green-700 font-medium text-sm">{msg}</div>}

            {tab === 'dashboard' && (<>
                <Stats expenses={expenses} merchantRules={merchantRules}/>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üìä Where Does It All Go? (2025)</h3><div className="h-56"><Pareto expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üè™ Top 20 Merchants (2025)</h3><div className="h-80"><TopMerchants expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üîÑ Recurring Costs (2025)</h3><div className="h-56"><RecurringCosts expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üì¶ Monthly Cost Structure (2025)</h3><div className="h-56"><CostStructureChart expenses={expenses} merchantRules={merchantRules}/></div></div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üì∫ Subscriptions (2025)</h3><div className="h-56"><Subscriptions expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">‚òï Small Purchase Leaks (2025)</h3><div className="h-56"><SmallPurchaseMerchants expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üí∏ Death by 1000 Cuts (2025)</h3><div className="h-56"><Scatter expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
            </>)}

            {tab === 'evolution' && (<>
                <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-2xl"><h2 className="text-xl font-black">üìà Year-over-Year Evolution</h2><p className="text-indigo-100 text-sm mt-1">Compare spending across 2024 and 2025</p></div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üóìÔ∏è Seasonality (Jan-Dec)</h3><div className="h-64"><SeasonalityChart expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üèÉ Pace of Spending</h3><div className="h-64"><PaceChart expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üì¶ Cost Structure Evolution (2024 vs 2025)</h3><div className="h-64"><CostStructureEvolution expenses={expenses} merchantRules={merchantRules}/></div></div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üìä Category Evolution (YoY)</h3><div className="h-80"><CategoryEvolution expenses={expenses} merchantRules={merchantRules}/></div></div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üî• Spending Heatmap</h3><div className="h-64"><Heatmap expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üí≥ Account Totals by Year</h3><div className="h-64"><AccountTotalsChart expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
            </>)}

            {tab === 'flow' && (
                <IncomeFlowDashboard expenses={expenses} merchantRules={merchantRules} />
            )}

            {tab === 'categories' && (
                <CategoryManagement 
                    expenses={expenses} 
                    merchantRules={merchantRules}
                    onUpdateExpense={updateExpenseCategory}
                    onUpdateRule={updateMerchantRule}
                    onDeleteRule={deleteMerchantRule}
                />
            )}

            {tab === 'stylecom' && (
                <StylecomReimbursement 
                    expenses={expenses} 
                    merchantRules={merchantRules}
                    paidIds={paidStylecomIds}
                    onTogglePaid={toggleStylecomPaid}
                />
            )}

            {tab === 'transfers' && (
                <TransferMatching expenses={expenses} merchantRules={merchantRules} />
            )}

            {tab === 'transactions' && (
                <TransactionsTable 
                    expenses={expenses} 
                    merchantRules={merchantRules} 
                    onDelete={del}
                    onClearAll={() => { if(confirm("Delete all data?")) setExpenses([]); }}
                />
            )}

            {tab === 'ai' && (
                <AIAnalystExport expenses={expenses} merchantRules={merchantRules} />
            )}

            {tab === 'export' && (
                <ExportRules merchantRules={merchantRules} expenses={expenses} />
            )}
        </main>
        
        {importData && <ImportDialog headers={importData.meta.fields} onClose={()=>{setImportData(null); setImportFileName('');}} onConfirm={processImport} defaultAccountName={importFileName}/>}
    </div>);
};

ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App/></ErrorBoundary>);
</script>
</body>
</html>
