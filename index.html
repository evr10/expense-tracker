<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: linear-gradient(to bottom right, #f8fafc, #dbeafe); min-height: 100vh; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-purple { background: #8b5cf6; color: white; }
    .btn-green { background: #10b981; color: white; }
    .btn-gray { background: #e5e7eb; color: #1f2937; }
    .btn-red { background: #ef4444; color: white; }
    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    input[type="file"] { display: none; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }
    th { font-weight: 500; color: #64748b; }
    select, input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-box { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    function App() {
      const [expenses, setExpenses] = useState(() => {
        try {
          const saved = localStorage.getItem('expenses');
          if (saved) {
            const parsed = JSON.parse(saved);
            // Clean up any invalid entries on load
            return parsed.filter(e => e && typeof e.amount === 'number' && !isNaN(e.amount));
          }
          return [];
        } catch (e) {
          console.error('Error loading from localStorage:', e);
          return [];
        }
      });
      const [showModal, setShowModal] = useState(false);
      const [csvHeaders, setCsvHeaders] = useState([]);
      const [csvData, setCsvData] = useState([]);
      const [mapping, setMapping] = useState({ date: '', amount: '', description: '', account: '' });
      const [message, setMessage] = useState('');

      useEffect(() => {
        try {
          localStorage.setItem('expenses', JSON.stringify(expenses));
        } catch (e) {
          console.error('Error saving to localStorage:', e);
        }
      }, [expenses]);

      const categories = ['Groceries', 'Rent', 'Utilities', 'Transportation', 'Entertainment', 'Healthcare', 'Shopping', 'Dining', 'Other'];

      function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          const lines = text.split('\n').filter(l => l.trim());
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          const data = lines.slice(1).map(line => {
            const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
            const row = {};
            headers.forEach((h, i) => row[h] = values[i] || '');
            return row;
          });
          
          setCsvHeaders(headers);
          setCsvData(data);
          setShowModal(true);
        };
        reader.readAsText(file);
        e.target.value = '';
      }

      function processImport() {
        if (!mapping.date || !mapping.amount) {
          alert('Please select Date and Amount columns');
          return;
        }

        const newExpenses = csvData.map((row, i) => {
          const dateStr = row[mapping.date];
          const dateObj = new Date(dateStr);
          const date = !isNaN(dateObj) ? dateObj.toISOString().slice(0, 7) : new Date().toISOString().slice(0, 7);
          const rawAmount = parseFloat(String(row[mapping.amount] || '0').replace(/[$,]/g, ''));
          const amount = isNaN(rawAmount) ? 0 : Math.abs(rawAmount);
          
          return {
            id: Date.now() + i,
            date,
            amount,
            category: 'Uncategorized',
            account: mapping.account ? row[mapping.account] : 'Imported',
            description: mapping.description ? row[mapping.description] : ''
          };
        }).filter(e => e.amount > 0);

        setExpenses([...expenses, ...newExpenses]);
        setMessage(`Imported ${newExpenses.length} transactions`);
        setTimeout(() => setMessage(''), 3000);
        setShowModal(false);
        setCsvHeaders([]);
        setCsvData([]);
        setMapping({ date: '', amount: '', description: '', account: '' });
      }

      function updateCategory(id, cat) {
        setExpenses(expenses.map(e => e.id === id ? {...e, category: cat} : e));
      }

      function deleteExpense(id) {
        setExpenses(expenses.filter(e => e.id !== id));
      }

      function clearAllData() {
        if (confirm('Are you sure you want to delete all expenses? This cannot be undone.')) {
          setExpenses([]);
          localStorage.removeItem('expenses');
        }
      }

      function exportCSV() {
        const csv = ['date,amount,category,account,description', ...expenses.map(e => 
          `${e.date},${e.amount},${e.category},${e.account},${e.description}`
        )].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'expenses.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      const categorized = expenses.filter(e => e.category !== 'Uncategorized');
      const total = categorized.reduce((sum, e) => sum + (e.amount || 0), 0);
      const uncategorized = expenses.length - categorized.length;

      return (
        <div className="container">
          <div style={{marginBottom: '30px'}}>
            <h1 style={{fontSize: '32px', fontWeight: 'bold', marginBottom: '8px'}}>Expense Tracker</h1>
            <p style={{color: '#64748b'}}>Import bank CSVs and categorize expenses</p>
          </div>

          <div style={{display: 'flex', gap: '10px', marginBottom: '20px', flexWrap: 'wrap'}}>
            <label className="btn btn-blue">
              üì§ Import CSV
              <input type="file" accept=".csv" onChange={handleFileUpload} />
            </label>
            <button className="btn btn-purple" onClick={exportCSV}>üì• Export</button>
            <button className="btn btn-red" onClick={clearAllData}>üóëÔ∏è Clear All</button>
          </div>

          {message && (
            <div style={{padding: '12px', background: '#dbeafe', color: '#1e40af', borderRadius: '8px', marginBottom: '20px'}}>
              {message}
            </div>
          )}

          {uncategorized > 0 && (
            <div style={{padding: '12px', background: '#fef3c7', color: '#92400e', borderRadius: '8px', marginBottom: '20px'}}>
              ‚ö†Ô∏è {uncategorized} transactions need categorization
            </div>
          )}

          <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '30px'}}>
            <div className="card">
              <div style={{fontSize: '14px', color: '#64748b', marginBottom: '4px'}}>Total</div>
              <div style={{fontSize: '28px', fontWeight: 'bold'}}>${total.toFixed(2)}</div>
            </div>
            <div className="card">
              <div style={{fontSize: '14px', color: '#64748b', marginBottom: '4px'}}>Categorized</div>
              <div style={{fontSize: '28px', fontWeight: 'bold'}}>{categorized.length}</div>
            </div>
            <div className="card">
              <div style={{fontSize: '14px', color: '#64748b', marginBottom: '4px'}}>To Review</div>
              <div style={{fontSize: '28px', fontWeight: 'bold'}}>{uncategorized}</div>
            </div>
          </div>

          <div className="card">
            <h2 style={{fontSize: '20px', fontWeight: '600', marginBottom: '20px'}}>Transactions</h2>
            <div style={{overflowX: 'auto'}}>
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Account</th>
                    <th>Category</th>
                    <th style={{textAlign: 'right'}}>Amount</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.length === 0 ? (
                    <tr>
                      <td colSpan="6" style={{textAlign: 'center', color: '#64748b', padding: '40px'}}>
                        No expenses yet. Import a CSV to get started.
                      </td>
                    </tr>
                  ) : (
                    [...expenses].sort((a, b) => a.category === 'Uncategorized' ? -1 : 1).map(exp => (
                      <tr key={exp.id}>
                        <td>{exp.date}</td>
                        <td>{exp.description}</td>
                        <td>{exp.account}</td>
                        <td>
                          <select 
                            value={exp.category} 
                            onChange={(e) => updateCategory(exp.id, e.target.value)}
                            style={{
                              background: exp.category === 'Uncategorized' ? '#fee2e2' : '#dbeafe',
                              color: exp.category === 'Uncategorized' ? '#991b1b' : '#1e40af',
                              border: 'none',
                              padding: '4px 8px',
                              borderRadius: '12px',
                              cursor: 'pointer'
                            }}
                          >
                            <option value="Uncategorized">Uncategorized</option>
                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                          </select>
                        </td>
                        <td style={{textAlign: 'right', fontWeight: '600'}}>${(exp.amount || 0).toFixed(2)}</td>
                        <td>
                          <button onClick={() => deleteExpense(exp.id)} style={{background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px'}}>
                            üóëÔ∏è
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>

          <div className={`modal ${showModal ? 'show' : ''}`}>
            <div className="modal-box">
              <h2 style={{fontSize: '22px', fontWeight: 'bold', marginBottom: '16px'}}>Map CSV Columns</h2>
              <p style={{color: '#64748b', marginBottom: '20px'}}>Match columns (Date & Amount required)</p>
              
              <div style={{marginBottom: '16px'}}>
                <label style={{display: 'block', marginBottom: '6px', fontWeight: '500'}}>Date *</label>
                <select value={mapping.date} onChange={(e) => setMapping({...mapping, date: e.target.value})} style={{width: '100%'}}>
                  <option value="">Select...</option>
                  {csvHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                </select>
              </div>

              <div style={{marginBottom: '16px'}}>
                <label style={{display: 'block', marginBottom: '6px', fontWeight: '500'}}>Amount *</label>
                <select value={mapping.amount} onChange={(e) => setMapping({...mapping, amount: e.target.value})} style={{width: '100%'}}>
                  <option value="">Select...</option>
                  {csvHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                </select>
              </div>

              <div style={{marginBottom: '16px'}}>
                <label style={{display: 'block', marginBottom: '6px', fontWeight: '500'}}>Description</label>
                <select value={mapping.description} onChange={(e) => setMapping({...mapping, description: e.target.value})} style={{width: '100%'}}>
                  <option value="">Select...</option>
                  {csvHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                </select>
              </div>

              <div style={{marginBottom: '20px'}}>
                <label style={{display: 'block', marginBottom: '6px', fontWeight: '500'}}>Account</label>
                <select value={mapping.account} onChange={(e) => setMapping({...mapping, account: e.target.value})} style={{width: '100%'}}>
                  <option value="">Select...</option>
                  {csvHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                </select>
              </div>

              <div style={{display: 'flex', gap: '10px'}}>
                <button onClick={processImport} className="btn btn-blue" style={{flex: 1}}>
                  Import {csvData.length} Transactions
                </button>
                <button onClick={() => setShowModal(false)} className="btn btn-gray">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
