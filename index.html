<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .line-path { fill: none; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body class="bg-slate-50">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, Component } = React;

class ErrorBoundary extends Component {
    state = { hasError: false };
    static getDerivedStateFromError() { return { hasError: true }; }
    render() {
        if (this.state.hasError) {
            return (<div className="min-h-screen flex items-center justify-center"><div className="bg-white p-8 rounded-2xl shadow-xl text-center">
                <div className="text-4xl mb-4">‚ö†Ô∏è</div><h1 className="text-xl font-bold mb-4">Something went wrong</h1>
                <button onClick={() => { localStorage.removeItem('expense_v9'); localStorage.removeItem('merchant_rules'); window.location.reload(); }} className="px-6 py-3 bg-red-500 text-white rounded-xl font-bold">Clear & Reload</button>
            </div></div>);
        }
        return this.props.children;
    }
}

// ============== CONFIGURATION ==============
const CATEGORIES = ['Groceries','Rent','Daycare','Household','Transportation','Entertainment','Health & Wellness','Shopping','Dining','Travel','Amazon','Coffee','Stylecom','Venmo','Income','TaxIncome','Transfer','Other','Excluded'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const YEAR_COLORS = { 2021:'#94a3b8', 2022:'#f59e0b', 2023:'#3b82f6', 2024:'#ef4444', 2025:'#10b981', 2026:'#8b5cf6' };
const CAT_COLORS = { Groceries:'#22c55e', Rent:'#f59e0b', Daycare:'#a855f7', Household:'#3b82f6', Transportation:'#8b5cf6', Entertainment:'#ec4899', 'Health & Wellness':'#14b8a6', Shopping:'#f43f5e', Dining:'#f97316', Travel:'#06b6d4', Amazon:'#ff9900', Coffee:'#6f4e37', Stylecom:'#db2777', Venmo:'#008CFF', Other:'#94a3b8', Uncategorized:'#fbbf24', Excluded:'#cbd5e1', Income:'#10b981', TaxIncome:'#059669', Transfer:'#64748b' };

// SUBSCRIPTION DETECTION - Keywords that indicate recurring subscriptions
// Maps keyword -> actual category (not "Subscriptions")
const SUBSCRIPTION_RULES = {
    // Entertainment subscriptions
    'netflix': 'Entertainment',
    'hulu': 'Entertainment',
    'disney plus': 'Entertainment',
    'disney+': 'Entertainment',
    'hbo max': 'Entertainment',
    'hbo': 'Entertainment',
    'spotify': 'Entertainment',
    'apple music': 'Entertainment',
    'youtube premium': 'Entertainment',
    'youtube music': 'Entertainment',
    'amazon prime': 'Entertainment',
    'prime video': 'Entertainment',
    'peacock': 'Entertainment',
    'paramount': 'Entertainment',
    'audible': 'Entertainment',
    'kindle unlimited': 'Entertainment',
    'xbox game pass': 'Entertainment',
    'playstation plus': 'Entertainment',
    'nintendo online': 'Entertainment',
    'crunchyroll': 'Entertainment',
    'max.com': 'Entertainment',
    'appletv': 'Entertainment',
    'apple tv': 'Entertainment',
    
    // Health & Wellness subscriptions
    'gym': 'Health & Wellness',
    'equinox': 'Health & Wellness',
    'planet fitness': 'Health & Wellness',
    'orange theory': 'Health & Wellness',
    'crossfit': 'Health & Wellness',
    'peloton': 'Health & Wellness',
    'classpass': 'Health & Wellness',
    'solidstarts': 'Health & Wellness',
    'headspace': 'Health & Wellness',
    'calm': 'Health & Wellness',
    'noom': 'Health & Wellness',
    'weight watchers': 'Health & Wellness',
    'every mother': 'Health & Wellness',
    'fitbit premium': 'Health & Wellness',
    'strava': 'Health & Wellness',
    
    // Household subscriptions
    'comcast': 'Household',
    'xfinity': 'Household',
    'spectrum': 'Household',
    'verizon': 'Household',
    'at&t': 'Household',
    't-mobile': 'Household',
    'internet': 'Household',
    'icloud': 'Household',
    'google one': 'Household',
    'dropbox': 'Household',
    'ring': 'Household',
    'adt': 'Household',
    'simplisafe': 'Household',
    
    // Groceries subscriptions
    'hellofresh': 'Groceries',
    'blue apron': 'Groceries',
    'home chef': 'Groceries',
    'instacart': 'Groceries',
    'freshly': 'Groceries',
    'factor': 'Groceries',
    'daily harvest': 'Groceries',
    
    // Shopping subscriptions
    'amazon prime': 'Shopping',
    'costco membership': 'Shopping',
    'sams club': 'Shopping',
    'walmart+': 'Shopping',
    'ipsy': 'Shopping',
    'birchbox': 'Shopping',
    'stitch fix': 'Shopping',
    
    // Software/Productivity (Stylecom for business, otherwise Other)
    'adobe': 'Other',
    'microsoft 365': 'Other',
    'office 365': 'Other',
    'linkedin premium': 'Other',
    'github': 'Other',
    'notion': 'Other',
    'evernote': 'Other',
    'lastpass': 'Other',
    '1password': 'Other',
    'dashlane': 'Other',
    'nordvpn': 'Other',
    'expressvpn': 'Other',
    
    // News/Education
    'new york times': 'Other',
    'nytimes': 'Other',
    'washington post': 'Other',
    'wall street journal': 'Other',
    'wsj': 'Other',
    'economist': 'Other',
    'masterclass': 'Entertainment',
    'skillshare': 'Entertainment',
    'coursera': 'Other',
    'duolingo': 'Other',
    
    // Generic subscription keywords
    'subscription': 'Other',
    'membership': 'Other',
    'monthly': 'Other',
    'recurring': 'Other',
};

// Helper function to detect if a transaction is a subscription
const detectSubscription = (description) => {
    if (!description) return { isSubscription: false, suggestedCategory: null };
    const descLower = description.toLowerCase();
    
    for (const [keyword, category] of Object.entries(SUBSCRIPTION_RULES)) {
        if (descLower.includes(keyword)) {
            return { isSubscription: true, suggestedCategory: category };
        }
    }
    return { isSubscription: false, suggestedCategory: null };
};

// HIGH PRIORITY specific expense rules (checked FIRST in autoRuleMatch)
const PRIORITY_RULES = {
    Daycare: ['msh'],  // MSH = Daycare provider
    Rent: ['wells fargo card', 'wells fargo']  // Wells Fargo withdrawals = Rent
};

// Credit Card Payoff keywords (these become Transfer, excluded from expense totals)
const CC_PAYOFF_KEYWORDS = ['amex', 'chase card', 'capital one', 'citi card', 'discover card', 'cc payment', 'card ccpymt', 'card autopay', 'credit card auto pay', 'wf credit card'];

const AUTO_RULES = {
    // Excluded - only for truly unmatchable/ignorable transactions
    Excluded:[],
    Groceries:['walmart','kroger','safeway','trader joe','whole foods','aldi','costco','publix','grocery','supermarket','wegmans','heb','albertsons','sprouts',
        'hellofresh','blue apron','home chef','freshly','factor','daily harvest'],
    Dining:['sweetgreen','mcdonald','starbucks','chipotle','subway','restaurant','cafe','coffee','doordash','uber eats','pizza','grubhub','seamless','postmates',
        'cathedrale','alphabet ba','jongro gopchang','phd terrace','rubirosa','laccolade','shinn west','niagara','the garrett','ternesse golf','de vogelenzang','ops','brasserie den artist'],
    Transportation:['uber','lyft','taxi','shell','exxon','chevron','gas','fuel','parking','metro','transit','mobil','bp','sunoco',
        '900 8th ave gar','900 8th avenue gar','motorcycle mall'],
    Shopping:['amazon','ebay','best buy','apple store','ikea','nike','nordstrom','target','macys','tjmaxx','marshalls','kohls','gap','old navy','zara','h&m','uniqlo','sephora','ulta','bath body',
        'ferrier','hoekjes en boekjes','partzilla','dia art foundation','sp dore rose','hdsht'],
    Entertainment:['netflix','hulu','disney','hbo','spotify','movie','cinema','xbox','steam','playstation','nintendo','amc',
        'seatgeek','all borough party','fat black pussycat','fnac direct','ascent lounge','wcs zoos','msg concessions',
        'apple music','youtube premium','amazon prime','prime video','peacock','paramount','audible','kindle','crunchyroll','masterclass','skillshare'],
    // Household - utilities, home services, maintenance, cleaning, home supplies
    Household:['electric','power','water bill','comcast','xfinity','spectrum','internet','verizon','at&t','t-mobile','con ed','pge','national grid','cable','phone bill','trash','waste','sewer','gas bill','heating','cooling','hvac','plumber','plumbing','electrician','handyman','lawn','landscaping','pest control','cleaning','maid','housekeeping','home depot','lowes','ace hardware','menards','bed bath','container store','pottery barn','crate barrel','williams sonoma','wayfair','overstock','furniture','mattress','appliance','repair','maintenance','security','adt','ring','nest','thermostat',
        'taskrabbit','ups store','laundry card','mysalights','hildreths','janovic paint','level frames','swans cleaners',
        'icloud','google one','dropbox','simplisafe'],
    // Health & Wellness - medical, pharmacy, fitness, mental health, personal care
    'Health & Wellness':['pharmacy','cvs','walgreens','doctor','hospital','medical','dentist','optum','cigna','aetna','united health','clinic','urgent care','emergency','lab','blood','xray','mri','therapy','therapist','counseling','psychiatrist','psychologist','mental health','gym','fitness','yoga','pilates','peloton','crossfit','equinox','planet fitness','orange theory','soulcycle','massage','spa','chiropractor','physical therapy','vision','eye','optical','glasses','contacts','lenscrafters','warby parker','vitamins','supplements','gnc','vitamin shoppe',
        'evavercouteren','shair nyc','every mother','solidstarts','headspace','calm','noom','weight watchers','classpass','strava'],
    // Amazon - all Amazon purchases
    Amazon:['amazon','amzn','amz mktplace','prime now','whole foods','amazon fresh','amazon pantry'],
    // Coffee - coffee shops and cafes
    Coffee:['starbucks','dunkin','peets','blue bottle','philz','intelligentsia','counter culture','stumptown','la colombe','coffee','cafe','caffe','espresso','latte'],
    Travel:['airline','delta','united','southwest','flight','airbnb','hotel','marriott','hilton','hyatt','expedia','booking.com',
        'thestrabon','wuzipay'],
    // Other - software, news, education subscriptions
    Other:['adobe','linkedin premium','github','notion','patreon','evernote','lastpass','1password','nordvpn','expressvpn','new york times','nytimes','washington post','wall street journal','wsj','economist','coursera','duolingo'],
    // Stylecom - business expenses for reimbursement
    Stylecom:['softr','yww','airtable','iphone citiz','winred','crowne plaza amsterdam','smartsuite','gsuite','lindy','paddle.net','bambino technologies','hannago','vultr','odoo','dex personal crm','art of mondays','transip','vcn','hostinger','pingen','srd services'],
    // Venmo - special category, NOT excluded (allows netting)
    Venmo:['venmo'],
    // Income categories - will be auto-excluded from expense views
    Income:['payroll','salary','direct deposit','paycheck','dividend','interest income','wire in','employer','bonus','commission','stripe',
        'payyourselfback','returned payment','credit balance refund','travel credit'],
    // Tax refunds/income - auto-excluded
    TaxIncome:['irs','treasury','tax refund','state tax','federal tax','tax credit',
        'budgetnerd'],
    // Transfer category - internal moves between accounts (for transfer matching)
    // Includes CC payments so they can be matched with checking withdrawals
    Transfer:['zelle to','zelle from','internal transfer','external transfer','online transfer to','online transfer from','ach payment to','transfer to sav','transfer from sav','transfer to chk','transfer from chk','autopay','auto pay','thank you','credit card payment','card payment','online payment','bill pay','paying','paid in full','minimum payment','statement balance','balance payment','ach payment','electronic payment','pymt','payment to chase','payment to amex','payment to citi','payment to capital one','payment to discover','amex transfer','chase transfer',
        'payment thank you','ach automatic transfer to credit']
};

// INTERNAL TRANSFER SOURCES - these override income keywords
// If description contains these, it's money moving between your own accounts, NOT real income
const INTERNAL_TRANSFER_SOURCES = [
    'hsbc bank usa',
    'hsbc bank',
    'preauthorized deposit from hsbc',
    'preauthorized deposit from wells',
    'preauthorized deposit from chase',
    'preauthorized deposit from bank of america',
    'preauthorized deposit from citi',
    'from checking',
    'from savings',
    'from sav ',
    'from chk ',
    'internal xfer',
    'account transfer'
];

// Categories to exclude from expense calculations (Venmo is NOT excluded - it nets out)
const EXCLUDED_CATEGORIES = ['Income', 'Transfer', 'Excluded', 'TaxIncome'];

// Extended exclusions for dashboard/evolution/flow pages (Stylecom is reimbursable, tracked separately)
const DASHBOARD_EXCLUDED_CATEGORIES = ['Income', 'Transfer', 'Excluded', 'TaxIncome', 'Stylecom'];

// Cost Type mappings for budget structure analysis
const COST_TYPE_RULES = {
    Fixed: ['Rent', 'Daycare'],
    'Semi-Fixed': ['Household', 'Groceries'],
    Variable: [] // Catch-all for everything else
};
const COST_TYPE_COLORS = {
    Fixed: '#ef4444',      // Red - mandatory expenses
    'Semi-Fixed': '#f59e0b', // Amber - somewhat predictable
    Variable: '#3b82f6'     // Blue - discretionary
};

// Load manual cost type overrides from localStorage
const loadCostTypeOverrides = () => {
    try {
        const s = localStorage.getItem('cost_type_overrides');
        return s ? JSON.parse(s) : {};
    } catch { return {}; }
};

// Helper to get cost type from category (checks manual overrides first)
const getCostType = (category, overrides = null) => {
    // Check manual overrides first
    const manualOverrides = overrides || loadCostTypeOverrides();
    if (manualOverrides[category]) {
        return manualOverrides[category];
    }
    
    // Fall back to rules
    const catLower = (category || '').toLowerCase();
    for (const [costType, categories] of Object.entries(COST_TYPE_RULES)) {
        if (costType === 'Variable') continue; // Skip catch-all
        if (categories.some(c => c.toLowerCase() === catLower)) {
            return costType;
        }
    }
    return 'Variable'; // Default catch-all
};

// ============== HELPERS ==============
const MIN_YEAR = 2024; // Only show data from 2024 onwards
const safe = v => (v == null || isNaN(v)) ? 0 : Number(v);
const pDate = d => { const x = new Date(d); return isNaN(x) ? new Date() : x; };
const getY = d => pDate(d).getFullYear();
const getM = d => pDate(d).getMonth();
const getDoY = d => { const x = pDate(d), s = new Date(x.getFullYear(),0,0); return Math.floor((x-s)/864e5); };
const isValidYear = d => getY(d) >= MIN_YEAR;

// Payment processor prefixes to strip from descriptions
// These prefixes obscure the actual merchant name
const PROCESSOR_PREFIXES = [
    // Apple Pay variations
    /^APLPAY\s*\*?\s*/i,
    /^APL\s*\*?\s*/i,
    /^APPLE PAY\s*\*?\s*/i,
    // Toast POS variations
    /^TST\s*\*?\s*/i,
    /^TOAST\s*\*?\s*/i,
    // Square variations
    /^SQ\s*\*?\s*/i,
    /^SQU\s*\*?\s*/i,
    /^SQUARE\s*\*?\s*/i,
    /^GOSQ\s*\*?\s*/i,
    // PayPal variations
    /^PAYPAL\s*\*?\s*/i,
    /^PP\s*\*?\s*/i,
    // Google Pay
    /^GOOGLEPAY\s*\*?\s*/i,
    /^GOOGLE\s*\*?\s*/i,
    // Stripe
    /^STRIPE\s*\*?\s*/i,
    // Clover
    /^CLOVER\s*\*?\s*/i,
    /^CLV\s*\*?\s*/i,
    // Generic POS prefixes
    /^POS\s*(PURCHASE\s*)?\*?\s*/i,
    /^DEBIT\s*(CARD\s*)?(PURCHASE\s*)?\*?\s*/i,
    /^CHECK\s*CARD\s*\*?\s*/i,
    // Recurring/subscription prefixes
    /^RECURRING\s*\*?\s*/i,
    /^RECUR\s*\*?\s*/i
];

// Clean description by stripping payment processor prefixes
// Returns the cleaned description for categorization
const cleanDescription = (rawDesc) => {
    if (!rawDesc) return '';
    let cleaned = rawDesc.trim();
    
    // Apply each prefix pattern
    for (const pattern of PROCESSOR_PREFIXES) {
        cleaned = cleaned.replace(pattern, '');
    }
    
    // Also strip any leading asterisks or spaces left over
    cleaned = cleaned.replace(/^\*+\s*/, '').trim();
    
    return cleaned;
};

// Clean merchant name for matching (uses cleanDescription internally)
const cleanMerchant = (desc) => {
    if (!desc) return 'Unknown';
    // First clean any processor prefixes
    let name = cleanDescription(desc);
    // Then apply merchant name extraction
    name = name.split(/\s{2,}|\t|\*|#|\d{10,}/)[0].trim();
    name = name.substring(0, 40).toUpperCase();
    return name || 'Unknown';
};

// Fuzzy match CSV category to our categories
const fuzzyMatchCSV = v => {
    if (!v) return 'Uncategorized';
    const l = v.toLowerCase();
    const e = CATEGORIES.find(c => c.toLowerCase() === l);
    if (e) return e;
    for (const p of l.split(/[-&,]/)) {
        const part = p.trim();
        if (!part) continue;
        const m = CATEGORIES.find(c => part.includes(c.toLowerCase()) || c.toLowerCase().includes(part));
        if (m) return m;
        if (part.includes('restaurant') || part.includes('food') || part.includes('dining')) return 'Dining';
        if (part.includes('taxi') || part.includes('transport') || part.includes('uber') || part.includes('lyft') || part.includes('parking')) return 'Transportation';
        if (part.includes('airline') || part.includes('travel') || part.includes('hotel') || part.includes('lodging') || part.includes('flight')) return 'Travel';
        if (part.includes('pharmac') || part.includes('medical') || part.includes('health') || part.includes('doctor') || part.includes('hospital') || part.includes('healthcare')) return 'Health & Wellness';
        if (part.includes('grocer') || part.includes('supermarket') || part.includes('food store')) return 'Groceries';
        if (part.includes('gas') || part.includes('fuel') || part.includes('petrol')) return 'Transportation';
        if (part.includes('entertain') || part.includes('movie') || part.includes('theatre') || part.includes('theater')) return 'Entertainment';
        if (part.includes('merchan') || part.includes('retail') || part.includes('store') || part.includes('shop')) return 'Shopping';
        if (part.includes('util') || part.includes('electric') || part.includes('water') || part.includes('internet') || part.includes('phone')) return 'Household';
        if (part.includes('subscription') || part.includes('member')) return 'Other';
    }
    return 'Uncategorized';
};

// Auto-categorize by description keywords
const autoRuleMatch = (desc, transactionType = 'expense') => {
    if (!desc) return null;
    
    // Clean description first to strip payment processor prefixes
    const cleaned = cleanDescription(desc);
    const d = cleaned.toLowerCase();
    const rawLower = desc.toLowerCase(); // Keep raw for checking prefixes like withdrawal/deposit
    
    // ============ PRIORITY HIERARCHY ============
    
    // PRIORITY 0: Venmo transactions always go to Venmo category
    // This prevents Venmo from being caught by other rules
    if (rawLower.includes('venmo') || d.includes('venmo')) {
        return 'Venmo';
    }
    
    // PRIORITY 1: HARD EXCEPTIONS - Specific Expense Overrides (HIGHEST PRIORITY)
    // These rules run BEFORE CC payoff detection to prevent false positives
    // Example: "WELLS FARGO CARD CCPYMT" should be Rent, NOT Transfer
    for (const [cat, kws] of Object.entries(PRIORITY_RULES)) {
        if (kws.some(k => d.includes(k) || rawLower.includes(k))) {
            // Hard exception - return immediately, do NOT check CC payoff keywords
            return cat;
        }
    }
    
    // PRIORITY 2: Credit Card Payoffs ‚Üí Transfer (EXCLUDED)
    // Only runs if PRIORITY 1 didn't match
    // Check for CC payoff patterns - these are transfers, not expenses
    if (CC_PAYOFF_KEYWORDS.some(k => d.includes(k) || rawLower.includes(k))) {
        return 'Transfer';
    }
    
    // PRIORITY 2.5: Generic Withdrawals ‚Üí Transfer (EXCLUDED)
    // Catches ATM withdrawals, transfers to savings, unrecognized bill payments
    // This runs AFTER specific overrides (Venmo, Wells Fargo, CC payoffs)
    if (rawLower.includes('withdrawal') || d.includes('withdrawal')) {
        return 'Transfer';
    }
    
    // PRIORITY 2.75: If transaction type is transfer (set during import for HSBC etc)
    if (transactionType === 'transfer') {
        return 'Transfer';
    }
    
    // PRIORITY 3: If it's an income transaction type AND doesn't match above
    if (transactionType === 'income') {
        // PRIORITY 3a: Check for INTERNAL TRANSFERS first (overrides income keywords)
        // If money is coming from your own bank accounts, it's NOT real income
        if (INTERNAL_TRANSFER_SOURCES.some(src => rawLower.includes(src) || d.includes(src))) {
            return 'Transfer';
        }
        
        // PRIORITY 3b: Check for explicit transfer keywords in income transactions
        if (AUTO_RULES.Transfer.some(k => d.includes(k) || rawLower.includes(k))) {
            return 'Transfer';
        }
        
        // PRIORITY 3c: Now safe to check for real income
        // Check TaxIncome first (more specific)
        if (AUTO_RULES.TaxIncome.some(k => d.includes(k))) return 'TaxIncome';
        // Then general Income
        if (AUTO_RULES.Income.some(k => d.includes(k))) return 'Income';
        
        // Default income to Income category (positive amounts that aren't transfers)
        return 'Income';
    }
    
    // PRIORITY 4: Regular AUTO_RULES for expenses (use cleaned description)
    for (const [cat, kws] of Object.entries(AUTO_RULES)) {
        if (kws.some(k => d.includes(k))) return cat;
    }
    
    // PRIORITY 5: Default - return null (will become Uncategorized)
    return null;
};

// ============== DATA STORAGE ==============
const loadExpenses = () => {
    try {
        const s = localStorage.getItem('expense_v9');
        return s ? JSON.parse(s).filter(e => e && typeof e.amount === 'number') : [];
    } catch { return []; }
};

// Default merchant rules from categorization export
const DEFAULT_MERCHANT_RULES = {
    '900 8TH AVE GAR WEB': { category: 'Transportation', scope: 'global' },
    '900 8TH AVENUE GAR': { category: 'Transportation', scope: 'global' },
    '99231 LAUNDRY CARD': { category: 'Household', scope: 'global' },
    'ACH AUTOMATIC TRANSFER TO CREDIT ACCOUNT': { category: 'Transfer', scope: 'global' },
    'AIRTABLE.COM/BILL': { category: 'Stylecom', scope: 'global' },
    'ALL BOROUGH PARTY RENTAL': { category: 'Entertainment', scope: 'global' },
    'AMAZON MKTPL': { category: 'Amazon', scope: 'global' },
    'AMAZON PRIME': { category: 'Amazon', scope: 'global' },
    'AMAZONPRIMEBE': { category: 'Amazon', scope: 'global' },
    'APPLE.COM/BILL': { category: 'Stylecom', scope: 'global' },
    'APPLE.COM/US': { category: 'Stylecom', scope: 'global' },
    'ART OF MONDAYS': { category: 'Stylecom', scope: 'global' },
    'ASCENT LOUNGE': { category: 'Entertainment', scope: 'global' },
    'BAMBINO TECHNOLOGIES': { category: 'Stylecom', scope: 'global' },
    'BLVD': { category: 'Health & Wellness', scope: 'global' },
    'BRASSERIE DEN ARTIST': { category: 'Dining', scope: 'global' },
    'CANADIAN RIVERS WILDCANMORE': { category: 'Transfer', scope: 'global' },
    'CASH WITHDRAWAL AT BRANCH': { category: 'Other', scope: 'global' },
    'CATHEDRALE/ALPHABET BA': { category: 'Dining', scope: 'global' },
    'CREDIT BALANCE REFUND': { category: 'Income', scope: 'global' },
    'CROWNE PLAZA AMSTERDAM': { category: 'Stylecom', scope: 'global' },
    'DE VOGELENZANG': { category: 'Dining', scope: 'global' },
    'DEPOSIT FROM 360 CHECKING XXXXXXX1275': { category: 'Transfer', scope: 'global' },
    'DEPOSIT FROM CONTINENTAL EXC P2P 174001 ': { category: 'Stylecom', scope: 'global' },
    'DEPOSIT FROM DAYCARE XXXXXXX1048': { category: 'Transfer', scope: 'global' },
    'DEPOSIT FROM JPMORGAN CHASE EXT TRNSFR': { category: 'Transfer', scope: 'global' },
    'DEPOSIT FROM NY STATE NYSTTAXRFD': { category: 'TaxIncome', scope: 'global' },
    'DEPOSIT FROM RENT XXXXXXX0906': { category: 'Transfer', scope: 'global' },
    'DEX PERSONAL CRM': { category: 'Stylecom', scope: 'global' },
    'DIA ART FOUNDATION': { category: 'Shopping', scope: 'global' },
    'DISNEY PLUS': { category: 'Entertainment', scope: 'global' },
    'DUANE READE': { category: 'Household', scope: 'global' },
    'EVAVERCOUTEREN.COM': { category: 'Health & Wellness', scope: 'global' },
    'EVERY MOTHER': { category: 'Health & Wellness', scope: 'global' },
    'FAT BLACK PUSSYCAT': { category: 'Entertainment', scope: 'global' },
    'FERRIER-30': { category: 'Shopping', scope: 'global' },
    'FNAC DIRECT BELGIUM': { category: 'Entertainment', scope: 'global' },
    'GSUITE MRTNS.IO': { category: 'Stylecom', scope: 'global' },
    'GSUITE_NICOLASMERT': { category: 'Stylecom', scope: 'global' },
    'HANNAGO': { category: 'Stylecom', scope: 'global' },
    'HDSHT.PRO': { category: 'Shopping', scope: 'global' },
    'HILDRETHS DEPT. STORE': { category: 'Household', scope: 'global' },
    'HOEKJES EN BOEKJES': { category: 'Shopping', scope: 'global' },
    'HOSTINGER': { category: 'Stylecom', scope: 'global' },
    'IN': { category: 'Stylecom', scope: 'global' },
    'INSTANT FUNDS RECEIVED FROM NICOLAS MERT': { category: 'Income', scope: 'global' },
    'IPHONE CITIZ': { category: 'Stylecom', scope: 'global' },
    'JANOVIC PAINT AND DECORA': { category: 'Household', scope: 'global' },
    'JETTY INSURANCE': { category: 'Transportation', scope: 'global' },
    'JONGRO GOPCHANG (5TH F': { category: 'Dining', scope: 'global' },
    "L'ACCOLADE": { category: 'Dining', scope: 'global' },
    'LEMONADE INSURANCE': { category: 'Household', scope: 'global' },
    'LEVEL FRAMES ORDER': { category: 'Household', scope: 'global' },
    'LINDY': { category: 'Stylecom', scope: 'global' },
    'MOTORCYCLE MALL INC.': { category: 'Transportation', scope: 'global' },
    'MSG CONCESSIONS': { category: 'Entertainment', scope: 'global' },
    'NIAGARA / LOVERS': { category: 'Dining', scope: 'global' },
    'ODOO': { category: 'Stylecom', scope: 'global' },
    'OPS': { category: 'Dining', scope: 'global' },
    'PADDLE.NET': { category: 'Stylecom', scope: 'global' },
    'PARTZILLA.COM': { category: 'Shopping', scope: 'global' },
    'PAYMENT THANK YOU-MOBILE': { category: 'Transfer', scope: 'global' },
    'PAYYOURSELFBACK CREDIT': { category: 'Income', scope: 'global' },
    'PHD TERRACE AT DREAM H': { category: 'Dining', scope: 'global' },
    'PURCHASE INTEREST CHARGE': { category: 'Other', scope: 'global' },
    'PURCHASE ON 0208 AT SPOT IFY': { category: 'Entertainment', scope: 'global' },
    'RETURNED PAYMENT': { category: 'Income', scope: 'global' },
    'RITUAL (RITUAL.COM)': { category: 'Health & Wellness', scope: 'global' },
    'RUBIROSA - MULBERRY': { category: 'Dining', scope: 'global' },
    'SEATGEEK TICKETS': { category: 'Entertainment', scope: 'global' },
    'SHAIR NYC 000NEW YORK': { category: 'Health & Wellness', scope: 'global' },
    'SHINN WEST': { category: 'Dining', scope: 'global' },
    'SMARTSUITE': { category: 'Stylecom', scope: 'global' },
    'SOFTR.IO': { category: 'Stylecom', scope: 'global' },
    'SOLIDSTARTS': { category: 'Health & Wellness', scope: 'global' },
    'SP BUDGETNERD': { category: 'TaxIncome', scope: 'global' },
    'SP DORE ROSE': { category: 'Shopping', scope: 'global' },
    'SP MYSALIGHTS': { category: 'Household', scope: 'global' },
    'SP NUUN HYDRATION': { category: 'Health & Wellness', scope: 'global' },
    'SRD SERVICES': { category: 'Stylecom', scope: 'global' },
    "SWAN'S CLEANERS": { category: 'Household', scope: 'global' },
    'TASKER ON TASKRABBITSAN FRANCISCO': { category: 'Household', scope: 'global' },
    'TERNESSE GOLF &AMP; COUNTR': { category: 'Dining', scope: 'global' },
    'THE GARRETT - WEST': { category: 'Dining', scope: 'global' },
    'THE UPS STORE 6387': { category: 'Household', scope: 'global' },
    'TRANSIP B.V.': { category: 'Stylecom', scope: 'global' },
    'TRAVEL CREDIT $300/YEAR': { category: 'Income', scope: 'global' },
    'US MOBILE': { category: 'Household', scope: 'global' },
    'VCN': { category: 'Stylecom', scope: 'global' },
    'VOI BE': { category: 'Transportation', scope: 'global' },
    'VULTR BY CONSTANT': { category: 'Stylecom', scope: 'global' },
    'WCS ZOOS AND AQUARIUM': { category: 'Entertainment', scope: 'global' },
    'WILLIAMS-SONOMA.COM': { category: 'Household', scope: 'global' },
    'WINRED': { category: 'Stylecom', scope: 'global' },
    'WIRE WITHDRAWAL': { category: 'Stylecom', scope: 'global' },
    'WITHDRAWAL FROM APPLECARD GSBANK PAYMENT': { category: 'Stylecom', scope: 'global' },
    'WITHDRAWAL FROM CON ED OF NY CECONY': { category: 'Household', scope: 'global' },
    'WITHDRAWAL FROM IRS USATAXPYMT': { category: 'TaxIncome', scope: 'global' },
    'WUZIPAY': { category: 'Travel', scope: 'global' },
    'WWW.PINGEN.COM': { category: 'Stylecom', scope: 'global' },
    'WWW.THESTRABON.COM': { category: 'Travel', scope: 'global' },
    'YSI': { category: 'Household', scope: 'global' },
    'YWW': { category: 'Stylecom', scope: 'global' },
    'AIR EUROPA|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 0700 - 4","Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 3","Chase 2251","Chase 5448"] },
    'AIR FRANCE|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 5448","Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 3","Chase 0700 - 4","Chase 2251"] },
    'BANGKOK AIRWAYS-5G7NK3|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 0700 - 3","Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 4","Chase 2251"] },
    'DELTA AIR|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 5448","Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 3","Chase 0700 - 4","Chase 2251"] },
    'ETIHAD AIRW|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 0700 - 3"] },
    'JETBLUE|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 0700 - 4"] },
    'KLM AIRLINE|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 3","Chase 0700 - 4","Chase 2251","Chase 5448"] },
    'KLM ROYAL DUYIAONX|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 3","Chase 0700 - 4","Chase 2251"] },
    'QATAR AIR|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 0700 - 3","Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 4","Chase 2251","Chase 5448"] },
    'SWISS AIR|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 5448","Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 3","Chase 0700 - 4","Chase 2251"] },
    'UNITED|||accounts': { category: 'Stylecom', scope: 'accounts', accounts: ["Chase 5448","Chase 0700 - 1","Chase 0700 - 2","Chase 0700 - 3","Chase 0700 - 4","Chase 2251"] },
};

const loadMerchantRules = () => {
    try {
        const s = localStorage.getItem('merchant_rules_v2');
        if (s) {
            const saved = JSON.parse(s);
            // Merge with defaults (saved rules take precedence)
            return { ...DEFAULT_MERCHANT_RULES, ...saved };
        }
        
        // Migrate from old format (merchant_rules)
        const oldRules = localStorage.getItem('merchant_rules');
        if (oldRules) {
            const parsed = JSON.parse(oldRules);
            // Convert old format {merchant: category} to new {merchant: {category, scope: 'global'}}
            const migrated = {};
            Object.entries(parsed).forEach(([merchant, value]) => {
                if (typeof value === 'string') {
                    migrated[merchant] = { category: value, scope: 'global' };
                } else {
                    migrated[merchant] = value; // Already in new format
                }
            });
            return { ...DEFAULT_MERCHANT_RULES, ...migrated };
        }
        return { ...DEFAULT_MERCHANT_RULES };
    } catch { return { ...DEFAULT_MERCHANT_RULES }; }
};

// Get the rule key for account-specific rules (now uses merchant only, accounts stored in rule)
const getAccountsRuleKey = (merchant) => `${merchant}|||accounts`;

// Get effective category for a transaction
const getEffectiveCategory = (expense, merchantRules) => {
    const merchant = cleanMerchant(expense.description);
    const account = expense.account || '';
    const transactionType = expense.transactionType || 'expense';
    
    // Priority 0: Manual Override (one-off single transaction) - HIGHEST PRIORITY
    // This allows exceptions to any merchant rule
    if (expense.manualCategory) {
        return { category: expense.manualCategory, source: 'manual' };
    }
    
    // Priority 1: Multi-Account Rule (check if this account is in the rule's accounts list)
    const accountsKey = getAccountsRuleKey(merchant);
    if (merchantRules[accountsKey]) {
        const rule = merchantRules[accountsKey];
        // Check if transaction's account is in the rule's accounts array
        if (rule.accounts && Array.isArray(rule.accounts) && rule.accounts.includes(account)) {
            return { category: rule.category, source: 'rule-accounts', accounts: rule.accounts };
        }
    }
    
    // Priority 1b: Legacy single-account rule (for backward compatibility)
    const legacyAccountKey = `${merchant}|||${account}`;
    if (merchantRules[legacyAccountKey]) {
        const rule = merchantRules[legacyAccountKey];
        return { category: rule.category, source: 'rule-account', account: account };
    }
    
    // Priority 2: Global Merchant Rule
    if (merchantRules[merchant] && merchantRules[merchant].scope === 'global') {
        return { category: merchantRules[merchant].category, source: 'rule-global' };
    }
    
    // Priority 3: Auto-detected rule (with transaction type awareness)
    const autoCategory = autoRuleMatch(expense.description, transactionType);
    if (autoCategory) {
        return { category: autoCategory, source: 'auto' };
    }
    
    // Priority 4: CSV Category (fuzzy matched)
    if (expense.csvCategory && expense.csvCategory !== 'Uncategorized') {
        return { category: expense.csvCategory, source: 'csv' };
    }
    
    return { category: 'Uncategorized', source: 'none' };
};

const Empty = ({ msg }) => <div className="h-full flex items-center justify-center text-slate-400"><div className="text-center"><div className="text-3xl mb-2">üìä</div><p className="text-sm font-medium">{msg}</p></div></div>;

// ============== CHART COMPONENTS ==============
const SVGLine = ({ data, xLabels, h = 200, dots = true }) => {
    if (!data?.length) return <Empty msg="No data" />;
    const pad = { t:20, r:20, b:30, l:50 }, w = 400, cW = w - pad.l - pad.r, cH = h - pad.t - pad.b;
    const vals = data.flatMap(d => d.values.filter(v => v > 0));
    if (!vals.length) return <Empty msg="No data to display" />;
    const yMax = Math.max(...vals) * 1.1, xN = data[0].values.length;
    return (<svg viewBox={`0 0 ${w} ${h}`} className="w-full h-full">
        {[0,.25,.5,.75,1].map(r => <g key={r}><line x1={pad.l} x2={w-pad.r} y1={pad.t+cH*(1-r)} y2={pad.t+cH*(1-r)} stroke="#e2e8f0" strokeDasharray="4"/><text x={pad.l-8} y={pad.t+cH*(1-r)+4} fontSize="9" fill="#94a3b8" textAnchor="end">${(yMax*r/1000).toFixed(1)}k</text></g>)}
        {xLabels?.map((l,i) => <text key={i} x={pad.l+(i/(xN-1||1))*cW} y={h-8} fontSize="9" fill="#94a3b8" textAnchor="middle">{l}</text>)}
        {data.map((s,si) => {
            const pts = s.values.map((v,i) => v > 0 ? { x:pad.l+(i/(xN-1||1))*cW, y:pad.t+cH-(v/yMax)*cH, v } : null).filter(Boolean);
            if (pts.length < 2) return null;
            return (<g key={si}><path d={pts.map((p,i) => `${i?'L':'M'} ${p.x} ${p.y}`).join(' ')} className="line-path" stroke={s.color}/>{dots && pts.map((p,i) => <circle key={i} cx={p.x} cy={p.y} r="4" fill={s.color}><title>{s.label}: ${p.v.toLocaleString()}</title></circle>)}</g>);
        })}
    </svg>);
};

const Legend = ({ years }) => <div className="flex flex-wrap gap-3 justify-center pt-2 border-t border-slate-100">{years.map(y => <div key={y} className="flex items-center gap-1"><div className="w-3 h-3 rounded" style={{backgroundColor:YEAR_COLORS[y]||'#6366f1'}}/><span className="text-[10px] font-bold text-slate-500">{y}</span></div>)}</div>;

const SeasonalityChart = ({ expenses, merchantRules }) => {
    const { data, years } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const data = yrs.map(y => {
            const mt = Array(12).fill(0);
            sp.filter(e => getY(e.date) === y).forEach(e => mt[getM(e.date)] += safe(e.amount));
            return { label: String(y), color: YEAR_COLORS[y] || '#6366f1', values: mt };
        });
        return { data, years: yrs };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="Import data to see seasonality" />;
    return (<div className="h-full flex flex-col">
        <div className="flex-1 min-h-0 overflow-hidden"><SVGLine data={data} xLabels={MONTHS} h={220}/></div>
        <div className="flex-shrink-0"><Legend years={years}/></div>
    </div>);
};

const PaceChart = ({ expenses, merchantRules }) => {
    const { data, years } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const data = yrs.map(y => {
            const ye = sp.filter(e => getY(e.date) === y).sort((a,b) => pDate(a.date) - pDate(b.date));
            const dt = Array(366).fill(null);
            let cum = 0;
            ye.forEach(e => { cum += safe(e.amount); dt[getDoY(e.date)] = cum; });
            let last = 0;
            for (let i = 0; i < 366; i++) { if (dt[i] !== null) last = dt[i]; else if (last > 0) dt[i] = last; }
            const sam = []; for (let i = 0; i < 365; i += 30) sam.push(dt[i] || 0);
            return { label: String(y), color: YEAR_COLORS[y] || '#6366f1', values: sam };
        });
        return { data, years: yrs };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="Import data to see pace" />;
    return (<div className="h-full flex flex-col">
        <div className="flex-1 min-h-0 overflow-hidden"><SVGLine data={data} xLabels={MONTHS} h={220} dots={false}/></div>
        <div className="flex-shrink-0"><Legend years={years}/></div>
    </div>);
};

// Category Evolution - vertical year layout, two columns
const CategoryEvolution = ({ expenses, merchantRules }) => {
    const { data, years } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const year = getY(e.date);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(cat) && cat !== 'Uncategorized' && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const cyt = {};
        sp.forEach(e => { 
            const y = getY(e.date); 
            if (!yrs.includes(y)) return; 
            const cat = getEffectiveCategory(e, merchantRules).category;
            if (!cyt[cat]) cyt[cat] = {}; 
            cyt[cat][y] = (cyt[cat][y]||0) + safe(e.amount); 
        });
        const cy = yrs[yrs.length-1];
        const data = Object.entries(cyt).map(([c,yt]) => ({ 
            category: c, 
            yearData: yrs.map(y => ({ year: y, value: yt[y] || 0 })),
            cur: yt[cy] || 0 
        })).sort((a,b) => b.cur - a.cur).slice(0, 10);
        return { data, years: yrs };
    }, [expenses, merchantRules]);
    
    if (!data.length) return <Empty msg="Import data to compare" />;
    const mx = Math.max(...data.flatMap(d => d.yearData.map(y => y.value)));
    
    // Split into two columns
    const midpoint = Math.ceil(data.length / 2);
    const leftColumn = data.slice(0, midpoint);
    const rightColumn = data.slice(midpoint);
    
    const CategoryBlock = ({ item }) => (
        <div className="bg-slate-50 rounded-lg p-2">
            <div className="text-[11px] font-bold text-slate-700 mb-2 truncate" title={item.category}>
                {item.category}
            </div>
            <div className="space-y-1.5">
                {item.yearData.map(({ year, value }) => (
                    <div key={year} className="flex items-center gap-2">
                        <div className="w-10 text-[9px] font-bold text-slate-400">{year}</div>
                        <div className="flex-1 h-5 bg-slate-200 rounded overflow-hidden relative">
                            <div 
                                className="h-full rounded transition-all" 
                                style={{
                                    width: `${mx > 0 ? Math.max((value / mx) * 100, 0) : 0}%`,
                                    backgroundColor: YEAR_COLORS[year] || '#6366f1'
                                }}
                            />
                        </div>
                        <div className="w-16 text-[10px] font-bold text-slate-600 text-right">
                            {value > 0 ? `$${(value / 1000).toFixed(1)}k` : '$0'}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 min-h-0 overflow-auto">
                <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-3">
                        {leftColumn.map(item => <CategoryBlock key={item.category} item={item} />)}
                    </div>
                    <div className="space-y-3">
                        {rightColumn.map(item => <CategoryBlock key={item.category} item={item} />)}
                    </div>
                </div>
            </div>
            <div className="flex-shrink-0"><Legend years={years}/></div>
        </div>
    );
};

const Heatmap = ({ expenses, merchantRules }) => {
    const { data, years, min, max } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const yrs = [...new Set(sp.map(e => getY(e.date)))].sort();
        const data = {};
        sp.forEach(e => { const y = getY(e.date), m = getM(e.date); if (!data[y]) data[y] = Array(12).fill(0); data[y][m] += safe(e.amount); });
        const all = Object.values(data).flatMap(a => a.filter(v => v > 0));
        return { data, years: yrs, min: all.length ? Math.min(...all) : 0, max: all.length ? Math.max(...all) : 1 };
    }, [expenses, merchantRules]);
    if (!years.length) return <Empty msg="Import data for heatmap" />;
    const getCol = v => { if (!v) return '#f8fafc'; const r = (v-min)/(max-min||1); return r<.5 ? `rgb(${34+r*2*216},${197+r*2*7},${94-r*2*94})` : `rgb(${250-(r-.5)*2*11},${204-(r-.5)*2*136},${(r-.5)*2*68})`; };
    return (<div className="h-full flex flex-col"><div className="flex-1 min-h-0 overflow-auto"><table className="w-full text-[10px]"><thead><tr><th className="p-1 text-slate-400 text-left">Year</th>{MONTHS.map(m=><th key={m} className="p-1 text-slate-400 text-center">{m}</th>)}<th className="p-1 text-slate-400 text-right">Total</th></tr></thead><tbody>
        {years.map(y => { const yd = data[y]||Array(12).fill(0), tot = yd.reduce((a,b)=>a+b,0); return (<tr key={y}><td className="p-1 font-bold text-slate-700">{y}</td>{yd.map((v,i)=><td key={i} className="p-0.5"><div className="rounded p-1 text-center font-bold" style={{backgroundColor:getCol(v),color:v>max*.6?'white':'#334155'}}>{v>0?`${(v/1000).toFixed(1)}k`:'-'}</div></td>)}<td className="p-1 font-black text-slate-900 text-right">${tot.toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>); })}
    </tbody></table></div><div className="flex-shrink-0 flex items-center justify-center gap-2 pt-2 border-t border-slate-100 mt-2"><span className="text-[10px] text-slate-400">Low</span><div className="flex h-3 rounded overflow-hidden">{[0,.25,.5,.75,1].map(r=><div key={r} className="w-6 h-full" style={{backgroundColor:getCol(min+r*(max-min))}}/>)}</div><span className="text-[10px] text-slate-400">High</span></div></div>);
};

const AccountTotalsChart = ({ expenses, merchantRules }) => {
    const { data, years, maxVal } = useMemo(() => {
        const sp = expenses.filter(e => {
            const year = getY(e.date);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && (year === 2024 || year === 2025);
        });
        const byAccount = {};
        sp.forEach(e => { const acc = e.account || 'Unknown', year = getY(e.date); if (!byAccount[acc]) byAccount[acc] = {}; byAccount[acc][year] = (byAccount[acc][year] || 0) + safe(e.amount); });
        const yearsSet = new Set(sp.map(e => getY(e.date)));
        const years = [...yearsSet].sort();
        const data = Object.entries(byAccount).map(([account, yearTotals]) => ({ account, years: years.map(y => yearTotals[y] || 0), total: Object.values(yearTotals).reduce((s, v) => s + v, 0) })).sort((a, b) => b.total - a.total);
        const maxVal = Math.max(...data.flatMap(d => d.years));
        return { data, years, maxVal };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="Import data to see account totals" />;
    return (<div className="h-full flex flex-col">
        <div className="flex-1 min-h-0 overflow-auto space-y-2">
            {data.map(item => (<div key={item.account} className="space-y-1"><div className="text-[10px] font-bold text-slate-700 truncate">{item.account}</div><div className="flex gap-1">{item.years.map((val, yi) => (<div key={yi} className="flex-1 flex items-center gap-1"><div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden"><div className="h-full rounded" style={{width: `${maxVal > 0 ? (val / maxVal) * 100 : 0}%`, backgroundColor: YEAR_COLORS[years[yi]] || '#6366f1'}}/></div><span className="text-[9px] font-semibold text-slate-500 w-14 text-right">{val > 0 ? `$${(val/1000).toFixed(1)}k` : '-'}</span></div>))}</div></div>))}
        </div>
        <div className="flex-shrink-0"><Legend years={years}/></div>
    </div>);
};

// Cost Structure Chart - Dashboard version (2025 only) with CUMULATIVE avg lines
const CostStructureChart = ({ expenses, merchantRules, costTypeOverrides = {} }) => {
    const { data, maxTotal, avgFixed, avgSemiFixed, avgVariable, avgTotal } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(cat) && getY(e.date) === 2025;
        });
        
        // Group by month and cost type
        const byMonth = {};
        sp.forEach(e => {
            const month = getM(e.date);
            const cat = getEffectiveCategory(e, merchantRules).category;
            const costType = getCostType(cat, costTypeOverrides);
            
            if (!byMonth[month]) byMonth[month] = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 };
            byMonth[month][costType] += safe(e.amount);
            byMonth[month].total += safe(e.amount);
        });
        
        // Convert to array format
        const data = MONTHS.map((name, i) => ({
            month: name,
            monthIndex: i,
            ...byMonth[i] || { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 }
        }));
        
        // Calculate averages (only months with data)
        const monthsWithData = data.filter(d => d.total > 0);
        const monthCount = monthsWithData.length || 1;
        const avgFixed = monthsWithData.reduce((s, d) => s + d.Fixed, 0) / monthCount;
        const avgSemiFixed = monthsWithData.reduce((s, d) => s + d['Semi-Fixed'], 0) / monthCount;
        const avgVariable = monthsWithData.reduce((s, d) => s + d.Variable, 0) / monthCount;
        const avgTotal = avgFixed + avgSemiFixed + avgVariable;
        
        const maxTotal = Math.max(...data.map(d => d.total), 1);
        
        return { data, maxTotal, avgFixed, avgSemiFixed, avgVariable, avgTotal };
    }, [expenses, merchantRules, costTypeOverrides]);
    
    const hasData = data.some(d => d.total > 0);
    const chartHeight = 140; // Reduced to leave room for labels
    
    if (!hasData) return <Empty msg="No 2025 data for cost structure" />;
    
    // CUMULATIVE average line positions (measured from BOTTOM of chart)
    // Line 1: Top of Fixed segment = avgFixed
    // Line 2: Top of Semi-Fixed segment = avgFixed + avgSemiFixed  
    // Line 3: Top of Variable (Total) = avgFixed + avgSemiFixed + avgVariable
    const line1Y = chartHeight - (avgFixed / maxTotal) * chartHeight;
    const line2Y = chartHeight - ((avgFixed + avgSemiFixed) / maxTotal) * chartHeight;
    const line3Y = chartHeight - (avgTotal / maxTotal) * chartHeight;
    
    return (
        <div className="h-full flex flex-col">
            {/* Chart area with fixed height */}
            <div className="relative" style={{ height: chartHeight }}>
                {/* Average reference lines - CUMULATIVE */}
                <div className="absolute inset-0 pointer-events-none z-10">
                    {/* Line 1: Avg Fixed (top of red segment) */}
                    {avgFixed > 0 && (
                        <div 
                            className="absolute left-0 right-0 border-t-2 border-dashed"
                            style={{ top: line1Y, borderColor: COST_TYPE_COLORS.Fixed }}
                            title={`Avg Fixed: $${avgFixed.toLocaleString(undefined, {maximumFractionDigits: 0})}`}
                        />
                    )}
                    {/* Line 2: Avg Fixed + Semi-Fixed (top of orange segment) */}
                    {avgSemiFixed > 0 && (
                        <div 
                            className="absolute left-0 right-0 border-t-2 border-dashed"
                            style={{ top: line2Y, borderColor: COST_TYPE_COLORS['Semi-Fixed'] }}
                            title={`Avg Fixed+Semi: $${(avgFixed + avgSemiFixed).toLocaleString(undefined, {maximumFractionDigits: 0})}`}
                        />
                    )}
                    {/* Line 3: Avg Total (top of blue segment) */}
                    {avgVariable > 0 && (
                        <div 
                            className="absolute left-0 right-0 border-t-2 border-dashed"
                            style={{ top: line3Y, borderColor: COST_TYPE_COLORS.Variable }}
                            title={`Avg Total: $${avgTotal.toLocaleString(undefined, {maximumFractionDigits: 0})}`}
                        />
                    )}
                </div>
                
                {/* Bars */}
                <div className="flex items-end gap-1 h-full">
                    {data.map((d, i) => {
                        const barHeight = d.total > 0 ? (d.total / maxTotal) * chartHeight : 0;
                        const fixedH = d.total > 0 ? (d.Fixed / d.total) * barHeight : 0;
                        const semiH = d.total > 0 ? (d['Semi-Fixed'] / d.total) * barHeight : 0;
                        const varH = d.total > 0 ? (d.Variable / d.total) * barHeight : 0;
                        const minHeightForText = 18;
                        
                        return (
                            <div key={i} className="flex-1 flex flex-col justify-end h-full">
                                <div 
                                    className="w-full cursor-pointer"
                                    title={`${d.month}: $${d.total.toLocaleString()}\nFixed: $${d.Fixed.toLocaleString()}\nSemi-Fixed: $${d['Semi-Fixed'].toLocaleString()}\nVariable: $${d.Variable.toLocaleString()}`}
                                >
                                    {varH > 0 && (
                                        <div style={{ height: varH, backgroundColor: COST_TYPE_COLORS.Variable }} className="w-full rounded-t flex items-center justify-center overflow-hidden">
                                            {varH >= minHeightForText && <span className="text-[8px] font-bold text-white">${(d.Variable/1000).toFixed(1)}k</span>}
                                        </div>
                                    )}
                                    {semiH > 0 && (
                                        <div style={{ height: semiH, backgroundColor: COST_TYPE_COLORS['Semi-Fixed'] }} className="w-full flex items-center justify-center overflow-hidden">
                                            {semiH >= minHeightForText && <span className="text-[8px] font-bold text-white">${(d['Semi-Fixed']/1000).toFixed(1)}k</span>}
                                        </div>
                                    )}
                                    {fixedH > 0 && (
                                        <div style={{ height: fixedH, backgroundColor: COST_TYPE_COLORS.Fixed }} className="w-full rounded-b flex items-center justify-center overflow-hidden">
                                            {fixedH >= minHeightForText && <span className="text-[8px] font-bold text-white">${(d.Fixed/1000).toFixed(1)}k</span>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
            
            {/* X-axis labels - OUTSIDE chart area */}
            <div className="flex gap-1 mt-1">
                {data.map((d, i) => (
                    <div key={i} className="flex-1 text-center">
                        <span className="text-[9px] text-slate-400 font-semibold">{d.month}</span>
                    </div>
                ))}
            </div>
            
            {/* Legend with avg values */}
            <div className="flex-shrink-0 flex justify-center gap-3 pt-2 border-t border-slate-100 mt-2">
                <div className="flex items-center gap-1">
                    <div className="w-3 h-0.5 border-t-2 border-dashed" style={{ borderColor: COST_TYPE_COLORS.Fixed }} />
                    <span className="text-[9px] text-slate-500">F: ${(avgFixed/1000).toFixed(1)}k</span>
                </div>
                <div className="flex items-center gap-1">
                    <div className="w-3 h-0.5 border-t-2 border-dashed" style={{ borderColor: COST_TYPE_COLORS['Semi-Fixed'] }} />
                    <span className="text-[9px] text-slate-500">+SF: ${((avgFixed+avgSemiFixed)/1000).toFixed(1)}k</span>
                </div>
                <div className="flex items-center gap-1">
                    <div className="w-3 h-0.5 border-t-2 border-dashed" style={{ borderColor: COST_TYPE_COLORS.Variable }} />
                    <span className="text-[9px] text-slate-500">Total: ${(avgTotal/1000).toFixed(1)}k</span>
                </div>
            </div>
        </div>
    );
};

// Cost Structure Evolution - Chronological 2024‚Üí2025 with CUMULATIVE avg lines
const CostStructureEvolution = ({ expenses, merchantRules, costTypeOverrides = {} }) => {
    const { data, maxTotal, avgFixed, avgSemiFixed, avgVariable, avgTotal } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const year = getY(e.date);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(cat) && (year === 2024 || year === 2025);
        });
        
        // Group by year-month
        const byYearMonth = {};
        sp.forEach(e => {
            const year = getY(e.date);
            const month = getM(e.date);
            const key = `${year}-${month}`;
            const cat = getEffectiveCategory(e, merchantRules).category;
            const costType = getCostType(cat, costTypeOverrides);
            
            if (!byYearMonth[key]) {
                byYearMonth[key] = { year, month, Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 };
            }
            byYearMonth[key][costType] += safe(e.amount);
            byYearMonth[key].total += safe(e.amount);
        });
        
        // Build STRICTLY chronological array: Jan'24 ‚Üí Dec'24 ‚Üí Jan'25 ‚Üí Dec'25
        const data = [];
        [2024, 2025].forEach(year => {
            for (let m = 0; m < 12; m++) {
                const key = `${year}-${m}`;
                const monthData = byYearMonth[key] || { year, month: m, Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 };
                data.push({
                    ...monthData,
                    shortLabel: `${MONTHS[m].substring(0, 3)}'${String(year).slice(-2)}`, // "Jan'24"
                    fullLabel: `${MONTHS[m]} ${year}`,
                    isYearStart: m === 0,
                    isQuarterStart: m % 3 === 0
                });
            }
        });
        
        // Calculate GLOBAL averages (all months with data across both years)
        const monthsWithData = data.filter(d => d.total > 0);
        const monthCount = monthsWithData.length || 1;
        const avgFixed = monthsWithData.reduce((s, d) => s + d.Fixed, 0) / monthCount;
        const avgSemiFixed = monthsWithData.reduce((s, d) => s + d['Semi-Fixed'], 0) / monthCount;
        const avgVariable = monthsWithData.reduce((s, d) => s + d.Variable, 0) / monthCount;
        const avgTotal = avgFixed + avgSemiFixed + avgVariable;
        
        const maxTotal = Math.max(...data.map(d => d.total), 1);
        
        return { data, maxTotal, avgFixed, avgSemiFixed, avgVariable, avgTotal };
    }, [expenses, merchantRules, costTypeOverrides]);
    
    const hasData = data.some(d => d.total > 0);
    const chartHeight = 140;
    
    if (!hasData) return <Empty msg="No data for cost structure comparison" />;
    
    // CUMULATIVE average line positions
    const line1Y = chartHeight - (avgFixed / maxTotal) * chartHeight;
    const line2Y = chartHeight - ((avgFixed + avgSemiFixed) / maxTotal) * chartHeight;
    const line3Y = chartHeight - (avgTotal / maxTotal) * chartHeight;
    
    return (
        <div className="h-full flex flex-col">
            {/* Chart area */}
            <div className="relative" style={{ height: chartHeight }}>
                {/* Average reference lines - CUMULATIVE */}
                <div className="absolute inset-0 pointer-events-none z-10">
                    {avgFixed > 0 && (
                        <div className="absolute left-0 right-0 border-t-2 border-dashed" style={{ top: line1Y, borderColor: COST_TYPE_COLORS.Fixed }} />
                    )}
                    {avgSemiFixed > 0 && (
                        <div className="absolute left-0 right-0 border-t-2 border-dashed" style={{ top: line2Y, borderColor: COST_TYPE_COLORS['Semi-Fixed'] }} />
                    )}
                    {avgVariable > 0 && (
                        <div className="absolute left-0 right-0 border-t-2 border-dashed" style={{ top: line3Y, borderColor: COST_TYPE_COLORS.Variable }} />
                    )}
                </div>
                
                {/* Bars */}
                <div className="flex items-end h-full">
                    {data.map((d, i) => {
                        const barHeight = d.total > 0 ? (d.total / maxTotal) * chartHeight : 0;
                        const fixedH = d.total > 0 ? (d.Fixed / d.total) * barHeight : 0;
                        const semiH = d.total > 0 ? (d['Semi-Fixed'] / d.total) * barHeight : 0;
                        const varH = d.total > 0 ? (d.Variable / d.total) * barHeight : 0;
                        const minHeightForText = 16;
                        const is2024 = d.year === 2024;
                        
                        return (
                            <div 
                                key={i} 
                                className={`flex-1 flex flex-col justify-end h-full ${d.isYearStart && i > 0 ? 'ml-1 border-l border-slate-200' : ''}`}
                                style={{ marginLeft: d.isYearStart && i > 0 ? 4 : 0 }}
                            >
                                <div 
                                    className="w-full cursor-pointer mx-px"
                                    style={{ opacity: is2024 ? 0.7 : 1 }}
                                    title={`${d.fullLabel}: $${d.total.toLocaleString()}\nFixed: $${d.Fixed.toLocaleString()}\nSemi-Fixed: $${d['Semi-Fixed'].toLocaleString()}\nVariable: $${d.Variable.toLocaleString()}`}
                                >
                                    {varH > 0 && (
                                        <div style={{ height: varH, backgroundColor: COST_TYPE_COLORS.Variable }} className="w-full rounded-t flex items-center justify-center overflow-hidden">
                                            {varH >= minHeightForText && <span className="text-[6px] font-bold text-white">{(d.Variable/1000).toFixed(1)}</span>}
                                        </div>
                                    )}
                                    {semiH > 0 && (
                                        <div style={{ height: semiH, backgroundColor: COST_TYPE_COLORS['Semi-Fixed'] }} className="w-full flex items-center justify-center overflow-hidden">
                                            {semiH >= minHeightForText && <span className="text-[6px] font-bold text-white">{(d['Semi-Fixed']/1000).toFixed(1)}</span>}
                                        </div>
                                    )}
                                    {fixedH > 0 && (
                                        <div style={{ height: fixedH, backgroundColor: COST_TYPE_COLORS.Fixed }} className="w-full rounded-b flex items-center justify-center overflow-hidden">
                                            {fixedH >= minHeightForText && <span className="text-[6px] font-bold text-white">{(d.Fixed/1000).toFixed(1)}</span>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
            
            {/* X-axis labels - Clean "Jan '24" format, only show every 3rd */}
            <div className="flex mt-1">
                {data.map((d, i) => (
                    <div 
                        key={i} 
                        className={`flex-1 text-center ${d.isYearStart && i > 0 ? 'ml-1' : ''}`}
                        style={{ marginLeft: d.isYearStart && i > 0 ? 4 : 0 }}
                    >
                        {d.isQuarterStart && (
                            <span className="text-[7px] text-slate-400 font-medium">{d.shortLabel}</span>
                        )}
                    </div>
                ))}
            </div>
            
            {/* Legend with cumulative avg values */}
            <div className="flex-shrink-0 border-t border-slate-100 pt-2 mt-1">
                <div className="flex justify-center gap-3 flex-wrap">
                    <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded" style={{ backgroundColor: COST_TYPE_COLORS.Fixed }} />
                        <span className="text-[8px] text-slate-500">Fixed</span>
                    </div>
                    <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded" style={{ backgroundColor: COST_TYPE_COLORS['Semi-Fixed'] }} />
                        <span className="text-[8px] text-slate-500">Semi-Fixed</span>
                    </div>
                    <div className="flex items-center gap-1">
                        <div className="w-2 h-2 rounded" style={{ backgroundColor: COST_TYPE_COLORS.Variable }} />
                        <span className="text-[8px] text-slate-500">Variable</span>
                    </div>
                    <span className="text-[8px] text-slate-300">|</span>
                    <span className="text-[8px] text-slate-400">Avg Total: ${(avgTotal/1000).toFixed(1)}k/mo</span>
                    <span className="text-[8px] text-slate-300">|</span>
                    <span className="text-[8px] text-slate-400 opacity-70">2024 (faded)</span>
                </div>
            </div>
        </div>
    );
};

// Dashboard Charts (2025 filtered)
const Stats = ({ expenses, merchantRules }) => {
    const { tot, cnt, avg } = useMemo(() => {
        const sp = expenses.filter(e => !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const tot = sp.reduce((s,e) => s + safe(e.amount), 0);
        return { tot, cnt: sp.length, avg: sp.length ? tot/sp.length : 0 };
    }, [expenses, merchantRules]);
    return (<div className="grid grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Spent (2025)</h3><p className="text-2xl font-black text-slate-900 mt-1">${tot.toLocaleString(undefined,{maximumFractionDigits:0})}</p></div>
        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-[10px] font-bold text-slate-400 uppercase">Transactions (2025)</h3><p className="text-2xl font-black text-slate-900 mt-1">{cnt}</p></div>
        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-[10px] font-bold text-slate-400 uppercase">Avg Transaction</h3><p className="text-2xl font-black text-slate-900 mt-1">${avg.toFixed(0)}</p></div>
    </div>);
};

const Pareto = ({ expenses, merchantRules }) => {
    const { data, total } = useMemo(() => {
        const sp = expenses.filter(e => !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const bc = {}; sp.forEach(e => { const cat = getEffectiveCategory(e, merchantRules).category; bc[cat] = (bc[cat]||0) + safe(e.amount); });
        const sorted = Object.entries(bc).map(([n,v]) => ({name:n,value:v})).sort((a,b) => b.value - a.value);
        const tot = sorted.reduce((s,i) => s + i.value, 0);
        return { data: sorted.map(i => ({...i, pct: tot > 0 ? (i.value / tot) * 100 : 0 })), total: tot };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="No 2025 data" />;
    const mx = Math.max(...data.map(d => d.value));
    return (<div className="h-full flex flex-col">
        <div className="flex-1 overflow-auto space-y-1.5">
            {data.map(i => <div key={i.name} className="flex items-center gap-2">
                <div className="w-24 text-[10px] font-semibold text-slate-600 truncate text-right" title={i.name}>{i.name}</div>
                <div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden">
                    <div className="h-full rounded" style={{width:`${i.value/mx*100}%`,backgroundColor:CAT_COLORS[i.name]||'#6366f1'}}/>
                </div>
                <div className="w-16 text-[10px] font-bold text-slate-700 text-right">${(i.value/1000).toFixed(1)}k</div>
                <div className="w-10 text-[10px] font-bold text-slate-500 text-right">{i.pct.toFixed(0)}%</div>
            </div>)}
        </div>
        <div className="text-[10px] text-slate-400 text-center pt-2 border-t border-slate-100 mt-2">
            Total: <span className="font-bold text-slate-600">${total.toLocaleString(undefined,{maximumFractionDigits:0})}</span>
        </div>
    </div>);
};

const TopMerchants = ({ expenses, merchantRules }) => {
    const { data, total } = useMemo(() => {
        const sp = expenses.filter(e => !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        const total = sp.reduce((s, e) => s + safe(e.amount), 0);
        const byMerchant = {};
        sp.forEach(e => { const name = cleanMerchant(e.description); byMerchant[name] = (byMerchant[name] || 0) + safe(e.amount); });
        const sorted = Object.entries(byMerchant).map(([name, value]) => ({ name, value, pct: total > 0 ? (value / total) * 100 : 0 })).sort((a, b) => b.value - a.value).slice(0, 20);
        return { data: sorted, total };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="No 2025 data" />;
    const mx = data[0]?.value || 1;
    return (<div className="h-full flex flex-col"><div className="flex-1 space-y-1 overflow-auto">
        {data.map((m, i) => (<div key={m.name} className="flex items-center gap-2"><div className="w-5 text-[10px] font-black text-slate-400">{i + 1}</div><div className="w-28 text-[10px] font-semibold text-slate-600 truncate" title={m.name}>{m.name}</div><div className="flex-1 h-4 bg-slate-100 rounded overflow-hidden"><div className="h-full rounded bg-gradient-to-r from-indigo-500 to-purple-500" style={{width:`${m.value/mx*100}%`}}/></div><div className="w-14 text-[9px] font-bold text-slate-700 text-right">${m.value.toLocaleString(undefined,{maximumFractionDigits:0})}</div><div className="w-10 text-[9px] font-semibold text-slate-400 text-right">{m.pct.toFixed(1)}%</div></div>))}
    </div><div className="text-[10px] text-slate-400 text-center pt-2 border-t border-slate-100 mt-2">Top 20 = ${data.reduce((s,m)=>s+m.value,0).toLocaleString(undefined,{maximumFractionDigits:0})}</div></div>);
};

const RecurringCosts = ({ expenses, merchantRules }) => {
    const { recurring, totalMonthly, totalYearly, totalCount } = useMemo(() => {
        // Exclude subscription-flagged items - those are shown in Subscriptions widget
        const sp2025 = expenses.filter(e => 
            !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && 
            getY(e.date) === 2025 &&
            e.isSubscription !== true // Exclude items flagged as subscriptions
        );
        const byMerchant = {};
        sp2025.forEach(e => { 
            const name = cleanMerchant(e.description); 
            if (!byMerchant[name]) byMerchant[name] = { amounts: [], months: new Set(), total: 0 }; 
            byMerchant[name].amounts.push(safe(e.amount)); 
            byMerchant[name].months.add(getM(e.date)); 
            byMerchant[name].total += safe(e.amount); 
        });
        const recurring = [];
        Object.entries(byMerchant).forEach(([name, data]) => {
            // Require at least 2 months of data
            if (data.months.size >= 2) {
                const amounts = data.amounts.sort((a,b) => a - b);
                const median = amounts[Math.floor(amounts.length / 2)];
                const consistent = amounts.filter(a => Math.abs(a - median) / median < 0.3).length;
                // Require 50% consistency
                if (consistent >= data.months.size * 0.5) {
                    recurring.push({ 
                        name, 
                        monthlyAvg: data.total / data.months.size, 
                        totalYear: data.total, 
                        months: data.months.size 
                    });
                }
            }
        });
        recurring.sort((a, b) => b.totalYear - a.totalYear);
        const totalYearly = recurring.reduce((s, r) => s + r.totalYear, 0);
        const totalMonthly = recurring.reduce((s, r) => s + r.monthlyAvg, 0);
        // Return all recurring items (no limit)
        return { recurring, totalMonthly, totalYearly, totalCount: recurring.length };
    }, [expenses, merchantRules]);
    
    if (!recurring.length) return <Empty msg="No recurring costs detected" />;
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 overflow-auto">
                <table className="w-full text-[10px]">
                    <thead className="sticky top-0 bg-white">
                        <tr className="text-slate-400 uppercase font-bold">
                            <th className="text-left p-1.5">Merchant</th>
                            <th className="text-center p-1.5">Freq</th>
                            <th className="text-right p-1.5">Monthly</th>
                            <th className="text-right p-1.5">2025</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                        {recurring.map((r, i) => (
                            <tr key={r.name} className="hover:bg-slate-50">
                                <td className="p-1.5 font-semibold text-slate-700 truncate max-w-[150px]" title={r.name}>
                                    <span className="inline-flex items-center gap-1">
                                        <span className="w-4 h-4 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center text-[8px] font-black flex-shrink-0">{i+1}</span>
                                        <span className="truncate">{r.name}</span>
                                    </span>
                                </td>
                                <td className="p-1.5 text-center text-slate-500">{r.months}mo</td>
                                <td className="p-1.5 text-right font-bold text-slate-700">${r.monthlyAvg.toFixed(0)}</td>
                                <td className="p-1.5 text-right font-black text-indigo-600">${r.totalYear.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div className="pt-2 border-t border-slate-100 mt-2 flex justify-between items-center">
                <div className="text-[10px] text-slate-400">üîÑ {totalCount} recurring</div>
                <div className="text-right">
                    <div className="text-[10px] font-bold text-slate-600">~${totalMonthly.toLocaleString(undefined,{maximumFractionDigits:0})}/mo</div>
                    <div className="text-[11px] font-black text-indigo-600">${totalYearly.toLocaleString(undefined,{maximumFractionDigits:0})} YTD</div>
                </div>
            </div>
        </div>
    );
};

// Subscriptions - ONLY expenses with isSubscription flag (manually tagged)
const Subscriptions = ({ expenses, merchantRules }) => {
    const { subscriptions, totalMonthly, totalYearly } = useMemo(() => {
        // Only include expenses with isSubscription flag set to true
        const sp2025 = expenses.filter(e => 
            e.isSubscription === true && 
            !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && 
            getY(e.date) === 2025
        );
        
        const byMerchant = {};
        
        // Group by merchant
        sp2025.forEach(e => {
            const name = cleanMerchant(e.description);
            const month = getM(e.date);
            const amount = safe(e.amount);
            const cat = getEffectiveCategory(e, merchantRules).category;
            
            if (!byMerchant[name]) byMerchant[name] = { 
                monthlyAmounts: {}, 
                total: 0, 
                category: cat
            };
            
            // Store the amount for each month
            if (!byMerchant[name].monthlyAmounts[month]) {
                byMerchant[name].monthlyAmounts[month] = amount;
            }
            byMerchant[name].total += amount;
        });
        
        const subscriptions = Object.entries(byMerchant).map(([name, data]) => {
            const months = Object.keys(data.monthlyAmounts).length;
            const avgAmount = months > 0 ? data.total / months : 0;
            return {
                name,
                amount: avgAmount,
                months: months,
                totalYear: data.total,
                category: data.category
            };
        });
        
        subscriptions.sort((a, b) => b.totalYear - a.totalYear);
        const totalYearly = subscriptions.reduce((s, r) => s + r.totalYear, 0);
        const totalMonthly = subscriptions.reduce((s, r) => s + r.amount, 0);
        
        return { subscriptions: subscriptions.slice(0, 15), totalMonthly, totalYearly };
    }, [expenses, merchantRules]);
    
    if (!subscriptions.length) return <Empty msg="No subscriptions tagged. Use Categories page to mark expenses as subscriptions." />;
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 overflow-auto">
                <table className="w-full text-[10px]">
                    <thead className="sticky top-0 bg-white">
                        <tr className="text-slate-400 uppercase font-bold">
                            <th className="text-left p-1.5">Service</th>
                            <th className="text-left p-1.5">Category</th>
                            <th className="text-right p-1.5">$/mo</th>
                            <th className="text-right p-1.5">2025</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                        {subscriptions.map((s, i) => (
                            <tr key={s.name} className="hover:bg-emerald-50">
                                <td className="p-1.5 font-semibold text-slate-700 truncate max-w-[100px]" title={s.name}>
                                    {s.name}
                                </td>
                                <td className="p-1.5">
                                    <span className="px-1.5 py-0.5 text-[8px] rounded font-bold text-white" style={{ backgroundColor: CAT_COLORS[s.category] || '#94a3b8' }}>
                                        {s.category}
                                    </span>
                                </td>
                                <td className="p-1.5 text-right font-bold text-slate-700">${s.amount.toFixed(0)}</td>
                                <td className="p-1.5 text-right font-black text-emerald-600">${s.totalYear.toFixed(0)}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <div className="pt-2 border-t border-slate-100 mt-2 flex justify-between items-center">
                <div className="text-[10px] text-slate-400">üì∫ {subscriptions.length} subscriptions</div>
                <div className="text-right">
                    <div className="text-[10px] font-bold text-slate-600">${totalMonthly.toFixed(0)}/mo</div>
                    <div className="text-[11px] font-black text-emerald-600">${totalYearly.toLocaleString(undefined,{maximumFractionDigits:0})} YTD</div>
                </div>
            </div>
        </div>
    );
};

const SmallPurchaseMerchants = ({ expenses, merchantRules }) => {
    const { data, grandTotal } = useMemo(() => {
        const sp2025 = expenses.filter(e => !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        if (!sp2025.length) return { data: [], grandTotal: 0 };
        const byMerchant = {};
        sp2025.forEach(e => { const name = cleanMerchant(e.description); if (!byMerchant[name]) byMerchant[name] = { total: 0, count: 0 }; byMerchant[name].total += safe(e.amount); byMerchant[name].count += 1; });
        const filtered = Object.entries(byMerchant).map(([name, d]) => ({ name, total: d.total, count: d.count, avg: d.total / d.count })).filter(m => m.avg < 20).sort((a, b) => b.total - a.total).slice(0, 10);
        const grandTotal = filtered.reduce((s, m) => s + m.total, 0);
        return { data: filtered, grandTotal };
    }, [expenses, merchantRules]);
    if (!data.length) return <Empty msg="No purchases under $20 avg" />;
    const mx = data[0]?.total || 1;
    return (<div className="h-full flex flex-col"><div className="flex-1 space-y-1.5 overflow-auto">
        {data.map((m, i) => (<div key={m.name} className="flex items-center gap-2"><div className="w-5 text-[10px] font-black text-red-400">{i + 1}</div><div className="w-24 text-[10px] font-semibold text-slate-600 truncate" title={m.name}>{m.name}</div><div className="flex-1 h-5 bg-red-50 rounded overflow-hidden"><div className="h-full rounded bg-gradient-to-r from-red-400 to-orange-400" style={{width:`${m.total/mx*100}%`}}/></div><div className="w-10 text-[9px] text-slate-400 text-center">{m.count}x</div><div className="w-12 text-[9px] text-slate-500 text-right">~${m.avg.toFixed(0)}</div><div className="w-14 text-[10px] font-bold text-red-600 text-right">${m.total.toFixed(0)}</div></div>))}
    </div><div className="pt-2 border-t border-slate-100 mt-2 flex justify-between items-center"><div className="text-[10px] text-slate-400">‚òï Avg &lt;$20/txn</div><div className="text-[11px] font-black text-red-600">${grandTotal.toLocaleString(undefined,{maximumFractionDigits:0})} total</div></div></div>);
};

const Scatter = ({ expenses, merchantRules }) => {
    const { pts, minD, maxD, maxA } = useMemo(() => {
        const sp = expenses.filter(e => !DASHBOARD_EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category) && getY(e.date) === 2025);
        if (!sp.length) return { pts:[], minD:0, maxD:1, maxA:100 };
        const pts = sp.map(e => ({ d:pDate(e.date).getTime(), a:safe(e.amount), desc:e.description }));
        const ds = pts.map(p => p.d), as = pts.map(p => p.a);
        return { pts, minD:Math.min(...ds), maxD:Math.max(...ds), maxA:Math.max(...as) };
    }, [expenses, merchantRules]);
    if (!pts.length) return <Empty msg="No 2025 data" />;
    const range = maxD - minD || 1;
    const small = pts.filter(p => p.a < 20).length;
    const pct = (small/pts.length*100).toFixed(0);
    return (<div className="h-full flex flex-col"><div className="flex-1 relative bg-slate-50 rounded-lg overflow-hidden">
        <div className="absolute left-0 right-0 border-t border-dashed border-red-300" style={{bottom:`${20/maxA*100}%`}}><span className="absolute -top-2 left-1 text-[8px] font-bold text-red-400">$20</span></div>
        {pts.map((p,i) => <div key={i} className={`absolute w-2 h-2 rounded-full ${p.a<20?'bg-red-400':'bg-indigo-400'}`} style={{left:`${(p.d-minD)/range*100}%`,bottom:`${p.a/maxA*100}%`,opacity:.7}} title={`$${p.a.toFixed(2)}`}/>)}
    </div><div className="text-[10px] text-slate-400 text-center pt-2 border-t border-slate-100 mt-2">üî¥ {pct}% under $20</div></div>);
};

// ============== SPENDING MAGNITUDE DISTRIBUTION (Whale vs Minnow) ==============
const SpendingMagnitude = ({ expenses, merchantRules }) => {
    const BUCKETS = [
        { name: 'Under $20', min: 0, max: 20, color: '#ef4444', emoji: 'üêü' },
        { name: '$20 ‚Äì $50', min: 20, max: 50, color: '#f97316', emoji: 'üê†' },
        { name: '$50 ‚Äì $100', min: 50, max: 100, color: '#eab308', emoji: 'ü¶à' },
        { name: '$100 ‚Äì $500', min: 100, max: 500, color: '#22c55e', emoji: 'üêã' },
        { name: '$500 ‚Äì $1k', min: 500, max: 1000, color: '#3b82f6', emoji: 'üê≥' },
        { name: 'Over $1k', min: 1000, max: Infinity, color: '#8b5cf6', emoji: 'üèîÔ∏è' }
    ];
    
    const { bucketData, totalSpend, maxSum } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(cat) && getY(e.date) === 2025 && safe(e.amount) > 0;
        });
        
        const totalSpend = sp.reduce((sum, e) => sum + safe(e.amount), 0);
        
        const bucketData = BUCKETS.map(bucket => {
            const txns = sp.filter(e => {
                const amt = safe(e.amount);
                return amt >= bucket.min && amt < bucket.max;
            });
            const sum = txns.reduce((s, e) => s + safe(e.amount), 0);
            return {
                ...bucket,
                count: txns.length,
                sum,
                pct: totalSpend > 0 ? (sum / totalSpend * 100) : 0
            };
        });
        
        const maxSum = Math.max(...bucketData.map(b => b.sum));
        return { bucketData, totalSpend, maxSum };
    }, [expenses, merchantRules]);
    
    if (totalSpend === 0) return <Empty msg="No 2025 spending data" />;
    
    const totalTxns = bucketData.reduce((sum, b) => sum + b.count, 0);
    
    return (
        <div className="h-full flex flex-col">
            {/* Column Headers */}
            <div className="flex items-center gap-2 pb-2 border-b border-slate-100 mb-2">
                <div className="w-5"></div>
                <div className="w-20 text-[9px] font-bold text-slate-400 uppercase">Bucket</div>
                <div className="flex-1 text-[9px] font-bold text-slate-400 uppercase text-center">Distribution</div>
                <div className="w-14 text-[9px] font-bold text-slate-400 uppercase text-right">Amount</div>
                <div className="w-10 text-[9px] font-bold text-slate-400 uppercase text-right">#</div>
                <div className="w-10 text-[9px] font-bold text-slate-400 uppercase text-right">%</div>
            </div>
            {/* Data Rows */}
            <div className="flex-1 overflow-auto space-y-1.5">
                {bucketData.map((b, i) => (
                    <div key={b.name} className="flex items-center gap-2">
                        <div className="w-5 text-[10px] font-black text-slate-400">{i + 1}</div>
                        <div className="w-20 text-[10px] font-semibold text-slate-600 truncate" title={b.name}>{b.emoji} {b.name}</div>
                        <div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden">
                            <div 
                                className="h-full rounded"
                                style={{ width: `${maxSum > 0 ? (b.sum / maxSum * 100) : 0}%`, backgroundColor: b.color }}
                            />
                        </div>
                        <div className="w-14 text-[9px] font-bold text-slate-700 text-right">${(b.sum/1000).toFixed(1)}k</div>
                        <div className="w-10 text-[9px] font-semibold text-slate-400 text-right">{b.count.toLocaleString()}</div>
                        <div className="w-10 text-[9px] font-bold text-right" style={{ color: b.color }}>{b.pct.toFixed(0)}%</div>
                    </div>
                ))}
            </div>
            <div className="pt-2 border-t border-slate-100 mt-2">
                <div className="flex justify-between items-center">
                    <div className="text-[10px] text-slate-400">
                        üêü Minnows: {bucketData[0].count + bucketData[1].count} txns = ${((bucketData[0].sum + bucketData[1].sum)/1000).toFixed(1)}k
                    </div>
                    <div className="text-[10px] font-bold text-slate-600">
                        Total: ${totalSpend.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </div>
                </div>
                <div className="text-[9px] text-slate-400 mt-1">
                    üê≥ Whales: {bucketData[4].count + bucketData[5].count} txns = ${((bucketData[4].sum + bucketData[5].sum)/1000).toFixed(1)}k
                </div>
            </div>
        </div>
    );
};

// ============== SMALL SPEND CATEGORY ANALYSIS (Long Tail) ==============
const SmallSpendCategories = ({ expenses, merchantRules }) => {
    const THRESHOLD = 50; // Transactions under $50
    
    const { categoryData, totalSmallSpend, txnCount } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const amt = safe(e.amount);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(cat) && 
                   getY(e.date) === 2025 && 
                   amt > 0 && 
                   amt < THRESHOLD;
        });
        
        const totalSmallSpend = sp.reduce((sum, e) => sum + safe(e.amount), 0);
        const txnCount = sp.length;
        
        // Group by category
        const byCategory = {};
        sp.forEach(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            if (!byCategory[cat]) byCategory[cat] = { sum: 0, count: 0 };
            byCategory[cat].sum += safe(e.amount);
            byCategory[cat].count += 1;
        });
        
        const categoryData = Object.entries(byCategory)
            .map(([name, data]) => ({
                name,
                sum: data.sum,
                count: data.count,
                pct: totalSmallSpend > 0 ? (data.sum / totalSmallSpend * 100) : 0,
                color: CAT_COLORS[name] || '#94a3b8'
            }))
            .sort((a, b) => b.sum - a.sum)
            .slice(0, 10);
        
        return { categoryData, totalSmallSpend, txnCount };
    }, [expenses, merchantRules]);
    
    if (categoryData.length === 0) return <Empty msg="No small transactions found" />;
    
    const maxSum = categoryData[0]?.sum || 1;
    
    return (
        <div className="h-full flex flex-col">
            {/* Column Headers */}
            <div className="flex items-center gap-2 pb-2 border-b border-slate-100 mb-2">
                <div className="w-5 text-[9px] font-bold text-slate-400 uppercase">#</div>
                <div className="w-24 text-[9px] font-bold text-slate-400 uppercase">Category</div>
                <div className="flex-1 text-[9px] font-bold text-slate-400 uppercase text-center">Distribution</div>
                <div className="w-14 text-[9px] font-bold text-slate-400 uppercase text-right">Amount</div>
                <div className="w-10 text-[9px] font-bold text-slate-400 uppercase text-right">Txns</div>
                <div className="w-10 text-[9px] font-bold text-slate-400 uppercase text-right">%</div>
            </div>
            {/* Data Rows */}
            <div className="flex-1 overflow-auto space-y-1.5">
                {categoryData.map((cat, i) => (
                    <div key={cat.name} className="flex items-center gap-2">
                        <div className="w-5 text-[10px] font-black text-slate-400">{i + 1}</div>
                        <div className="w-24 text-[10px] font-semibold text-slate-600 truncate" title={cat.name}>{cat.name}</div>
                        <div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden">
                            <div 
                                className="h-full rounded"
                                style={{ width: `${cat.sum / maxSum * 100}%`, backgroundColor: cat.color }}
                            />
                        </div>
                        <div className="w-14 text-[9px] font-bold text-slate-700 text-right">${(cat.sum/1000).toFixed(1)}k</div>
                        <div className="w-10 text-[9px] font-semibold text-slate-400 text-right">{cat.count}</div>
                        <div className="w-10 text-[9px] font-bold text-right" style={{ color: cat.color }}>{cat.pct.toFixed(0)}%</div>
                    </div>
                ))}
            </div>
            <div className="pt-2 border-t border-slate-100 mt-2">
                <div className="flex justify-between items-center">
                    <div className="text-[10px] text-slate-400">
                        üí∞ {txnCount.toLocaleString()} transactions under ${THRESHOLD}
                    </div>
                    <div className="text-[10px] font-bold text-slate-600">
                        Total: ${totalSmallSpend.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </div>
                </div>
                <div className="text-[9px] text-slate-400 mt-1">
                    Top 3 leaks: {categoryData.slice(0, 3).map(c => c.name).join(', ')}
                </div>
            </div>
        </div>
    );
};

// ============== $100-$500 BUCKET DEEP DIVE ==============
// Part A: Category breakdown with top merchants (redesigned from treemap)
const MidRangeTreemap = ({ expenses, merchantRules }) => {
    const MIN_AMT = 100;
    const MAX_AMT = 500;
    
    const { categoryData, totalSpend, txnCount } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const amt = safe(e.amount);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(cat) && 
                   getY(e.date) === 2025 && 
                   amt >= MIN_AMT && 
                   amt < MAX_AMT;
        });
        
        const totalSpend = sp.reduce((sum, e) => sum + safe(e.amount), 0);
        const txnCount = sp.length;
        
        // Group by category, then by merchant within each category
        const byCategory = {};
        sp.forEach(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const merchant = cleanMerchant(e.description);
            if (!byCategory[cat]) byCategory[cat] = { sum: 0, count: 0, merchants: {} };
            byCategory[cat].sum += safe(e.amount);
            byCategory[cat].count += 1;
            if (!byCategory[cat].merchants[merchant]) {
                byCategory[cat].merchants[merchant] = { sum: 0, count: 0 };
            }
            byCategory[cat].merchants[merchant].sum += safe(e.amount);
            byCategory[cat].merchants[merchant].count += 1;
        });
        
        // Convert to array and sort
        const categoryData = Object.entries(byCategory)
            .map(([name, data]) => ({
                name,
                sum: data.sum,
                count: data.count,
                pct: totalSpend > 0 ? (data.sum / totalSpend * 100) : 0,
                color: CAT_COLORS[name] || '#94a3b8',
                merchants: Object.entries(data.merchants)
                    .map(([mName, mData]) => ({ name: mName, sum: mData.sum, count: mData.count }))
                    .sort((a, b) => b.sum - a.sum)
                    .slice(0, 3) // Top 3 merchants per category
            }))
            .sort((a, b) => b.sum - a.sum)
            .slice(0, 8); // Top 8 categories
        
        return { categoryData, totalSpend, txnCount };
    }, [expenses, merchantRules]);
    
    if (categoryData.length === 0) return <Empty msg="No $100-$500 transactions found" />;
    
    const maxSum = categoryData[0]?.sum || 1;
    
    return (
        <div className="h-full flex flex-col">
            {/* Column Headers */}
            <div className="flex items-center gap-2 pb-2 border-b border-slate-100 mb-2">
                <div className="w-5 text-[9px] font-bold text-slate-400 uppercase">#</div>
                <div className="w-24 text-[9px] font-bold text-slate-400 uppercase">Category</div>
                <div className="flex-1 text-[9px] font-bold text-slate-400 uppercase text-center">Distribution</div>
                <div className="w-14 text-[9px] font-bold text-slate-400 uppercase text-right">Amount</div>
                <div className="w-10 text-[9px] font-bold text-slate-400 uppercase text-right">Txns</div>
                <div className="w-10 text-[9px] font-bold text-slate-400 uppercase text-right">%</div>
            </div>
            {/* Data Rows */}
            <div className="flex-1 overflow-auto space-y-2">
                {categoryData.map((cat, i) => (
                    <div key={cat.name}>
                        {/* Category Row */}
                        <div className="flex items-center gap-2">
                            <div className="w-5 text-[10px] font-black text-slate-400">{i + 1}</div>
                            <div className="w-24 text-[10px] font-bold text-slate-700 truncate" title={cat.name}>{cat.name}</div>
                            <div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden">
                                <div 
                                    className="h-full rounded"
                                    style={{ width: `${cat.sum / maxSum * 100}%`, backgroundColor: cat.color }}
                                />
                            </div>
                            <div className="w-14 text-[9px] font-bold text-slate-700 text-right">${(cat.sum/1000).toFixed(1)}k</div>
                            <div className="w-10 text-[9px] font-semibold text-slate-400 text-right">{cat.count}</div>
                            <div className="w-10 text-[9px] font-bold text-right" style={{ color: cat.color }}>{cat.pct.toFixed(0)}%</div>
                        </div>
                        {/* Top Merchants under this category */}
                        <div className="ml-7 mt-1 space-y-0.5">
                            {cat.merchants.map(m => (
                                <div key={m.name} className="flex items-center gap-2 text-[8px]">
                                    <div className="w-2 h-2 rounded-full" style={{ backgroundColor: cat.color + '60' }}></div>
                                    <div className="flex-1 text-slate-500 truncate" title={m.name}>{m.name}</div>
                                    <div className="text-slate-600 font-semibold">${m.sum.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                    <div className="text-slate-400 w-8 text-right">{m.count}√ó</div>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
            {/* Summary */}
            <div className="pt-2 border-t border-slate-100 mt-2 flex justify-between items-center">
                <div className="text-[10px] text-slate-400">
                    üì¶ {categoryData.length} categories ¬∑ {txnCount} transactions
                </div>
                <div className="text-[10px] font-bold text-green-600">
                    Total: ${totalSpend.toLocaleString(undefined, {maximumFractionDigits: 0})}
                </div>
            </div>
        </div>
    );
};

// Part B: Top 15 Merchants bar chart with frequency
const MidRangeMerchants = ({ expenses, merchantRules }) => {
    const MIN_AMT = 100;
    const MAX_AMT = 500;
    
    const { merchantData, totalSpend, avgTxn } = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            const amt = safe(e.amount);
            return !DASHBOARD_EXCLUDED_CATEGORIES.includes(cat) && 
                   getY(e.date) === 2025 && 
                   amt >= MIN_AMT && 
                   amt < MAX_AMT;
        });
        
        const totalSpend = sp.reduce((sum, e) => sum + safe(e.amount), 0);
        const avgTxn = sp.length > 0 ? totalSpend / sp.length : 0;
        
        // Group by merchant
        const byMerchant = {};
        sp.forEach(e => {
            const merchant = cleanMerchant(e.description);
            const cat = getEffectiveCategory(e, merchantRules).category;
            if (!byMerchant[merchant]) {
                byMerchant[merchant] = { sum: 0, count: 0, category: cat };
            }
            byMerchant[merchant].sum += safe(e.amount);
            byMerchant[merchant].count += 1;
        });
        
        const merchantData = Object.entries(byMerchant)
            .map(([name, data]) => ({
                name,
                sum: data.sum,
                count: data.count,
                avg: data.sum / data.count,
                category: data.category,
                color: CAT_COLORS[data.category] || '#94a3b8'
            }))
            .sort((a, b) => b.sum - a.sum)
            .slice(0, 15);
        
        return { merchantData, totalSpend, avgTxn };
    }, [expenses, merchantRules]);
    
    if (merchantData.length === 0) return <Empty msg="No $100-$500 transactions found" />;
    
    const maxSum = merchantData[0]?.sum || 1;
    const maxCount = Math.max(...merchantData.map(m => m.count));
    
    return (
        <div className="h-full flex flex-col">
            <div className="flex-1 overflow-auto space-y-1">
                {merchantData.map((m, i) => (
                    <div key={m.name} className="flex items-center gap-2">
                        <div className="w-4 text-[9px] font-black text-slate-400">{i + 1}</div>
                        <div className="w-28 text-[9px] font-semibold text-slate-600 truncate" title={`${m.name} (${m.category})`}>
                            {m.name}
                        </div>
                        {/* Amount bar */}
                        <div className="flex-1 h-5 bg-slate-100 rounded overflow-hidden relative">
                            <div 
                                className="h-full rounded"
                                style={{ width: `${m.sum / maxSum * 100}%`, backgroundColor: m.color }}
                            />
                            {/* Count indicator overlay */}
                            <div 
                                className="absolute top-0 h-full border-r-2 border-slate-800"
                                style={{ left: `${m.count / maxCount * 100}%` }}
                                title={`${m.count} transactions`}
                            />
                        </div>
                        <div className="w-12 text-[9px] font-bold text-slate-700 text-right">${(m.sum/1000).toFixed(1)}k</div>
                        {/* Transaction count bubble */}
                        <div 
                            className="w-8 h-5 rounded-full flex items-center justify-center text-[9px] font-black text-white"
                            style={{ backgroundColor: m.color }}
                            title={`${m.count} transactions, avg $${m.avg.toFixed(0)}`}
                        >
                            {m.count}√ó
                        </div>
                    </div>
                ))}
            </div>
            {/* Legend & Summary */}
            <div className="pt-2 border-t border-slate-100 mt-2">
                <div className="flex justify-between items-center">
                    <div className="text-[9px] text-slate-400">
                        <span className="inline-block w-3 h-3 bg-slate-100 rounded mr-1 align-middle"></span>$ spent
                        <span className="inline-block w-0.5 h-3 bg-slate-800 mx-2 align-middle"></span>frequency
                    </div>
                    <div className="text-[10px] font-bold text-slate-600">
                        Avg txn: ${avgTxn.toFixed(0)}
                    </div>
                </div>
                <div className="text-[9px] text-slate-400 mt-1">
                    üéØ {merchantData.filter(m => m.count >= 3).length} repeat merchants ({'>'}2√ó visits)
                </div>
            </div>
        </div>
    );
};

// ============== CATEGORY MANAGEMENT PAGE ==============
const CategoryEditModal = ({ expense, merchantRules, allAccounts, onSave, onClose }) => {
    const merchant = cleanMerchant(expense.description);
    const account = expense.account || 'Unknown';
    const currentEffective = getEffectiveCategory(expense, merchantRules);
    const [selectedCategory, setSelectedCategory] = useState(currentEffective.category);
    const [applyMode, setApplyMode] = useState('rule'); // 'rule' (merchant rule) or 'oneoff' (single transaction)
    const [scope, setScope] = useState('global'); // 'global' or 'accounts'
    const [selectedAccounts, setSelectedAccounts] = useState([account]); // Default to current account

    const toggleAccount = (acc) => {
        if (selectedAccounts.includes(acc)) {
            // Don't allow deselecting all - must have at least one
            if (selectedAccounts.length > 1) {
                setSelectedAccounts(selectedAccounts.filter(a => a !== acc));
            }
        } else {
            setSelectedAccounts([...selectedAccounts, acc]);
        }
    };

    const selectAllAccounts = () => setSelectedAccounts([...allAccounts]);
    const clearAccountSelection = () => setSelectedAccounts([account]); // Reset to current

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={onClose}/>
            <div className="relative bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
                <div className="p-6 border-b border-slate-100">
                    <h2 className="text-lg font-black text-slate-800">Edit Category</h2>
                    <p className="text-sm text-slate-500 mt-1 truncate" title={expense.description}>{expense.description}</p>
                </div>
                <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Merchant</label>
                            <div className="p-3 bg-slate-50 rounded-xl text-sm font-semibold text-slate-700 truncate" title={merchant}>{merchant}</div>
                        </div>
                        <div>
                            <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Account</label>
                            <div className="p-3 bg-blue-50 rounded-xl text-sm font-semibold text-blue-700 truncate" title={account}>{account}</div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Date</label>
                            <div className="p-3 bg-slate-50 rounded-xl text-sm font-semibold text-slate-700">{expense.date}</div>
                        </div>
                        <div>
                            <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount</label>
                            <div className="p-3 bg-slate-50 rounded-xl text-sm font-semibold text-slate-700">${Math.abs(safe(expense.amount)).toFixed(2)}</div>
                        </div>
                    </div>
                    <div>
                        <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Original CSV Category</label>
                        <div className="p-3 bg-amber-50 rounded-xl text-sm font-semibold text-amber-700">{expense.csvCategory || 'None'}</div>
                    </div>
                    <div>
                        <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">New Category</label>
                        <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)}
                            className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none border-2 border-transparent focus:border-indigo-500">
                            <option value="Uncategorized">Uncategorized</option>
                            {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    
                    {/* Apply Mode Selection */}
                    <div className="p-4 bg-slate-50 rounded-xl space-y-3">
                        <label className="text-[10px] font-black uppercase text-slate-500 block">How to Apply</label>
                        
                        {/* Create Rule (default) */}
                        <label className="flex items-start gap-3 cursor-pointer p-3 rounded-xl hover:bg-white border-2 transition-all ${applyMode === 'rule' ? 'border-indigo-500 bg-white' : 'border-transparent'}">
                            <input type="radio" name="applyMode" value="rule" checked={applyMode === 'rule'} onChange={() => setApplyMode('rule')}
                                className="w-5 h-5 text-indigo-600 mt-0.5"/>
                            <div className="flex-1">
                                <div className="font-bold text-slate-800 text-sm">üè∑Ô∏è Create Rule for "{merchant}"</div>
                                <div className="text-xs text-slate-500 mt-1">Apply to all past and future transactions from this merchant</div>
                            </div>
                        </label>
                        
                        {/* One-off (single transaction) */}
                        <label className="flex items-start gap-3 cursor-pointer p-3 rounded-xl hover:bg-white border-2 transition-all ${applyMode === 'oneoff' ? 'border-amber-500 bg-white' : 'border-transparent'}">
                            <input type="radio" name="applyMode" value="oneoff" checked={applyMode === 'oneoff'} onChange={() => setApplyMode('oneoff')}
                                className="w-5 h-5 text-amber-600 mt-0.5"/>
                            <div className="flex-1">
                                <div className="font-bold text-slate-800 text-sm">‚ö° One-Off Exception</div>
                                <div className="text-xs text-slate-500 mt-1">Apply ONLY to this specific transaction (overrides any merchant rule)</div>
                                <div className="text-[10px] text-amber-600 font-semibold mt-1">Transaction ID: {expense.id?.slice(-8) || 'N/A'}</div>
                            </div>
                        </label>
                    </div>

                    {/* Scope selection - only show when creating a rule */}
                    {applyMode === 'rule' && (
                        <div className="p-4 bg-indigo-50 rounded-xl space-y-3">
                            <label className="text-[10px] font-black uppercase text-indigo-600 block">Rule Scope</label>
                            <div className="space-y-2">
                                <label className="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-indigo-100 transition-colors">
                                    <input type="radio" name="scope" value="global" checked={scope === 'global'} onChange={() => setScope('global')}
                                        className="w-4 h-4 text-indigo-600"/>
                                    <div>
                                        <div className="font-bold text-slate-800 text-sm">üåç Global</div>
                                        <div className="text-xs text-slate-500">Apply to this merchant across ALL accounts</div>
                                    </div>
                                </label>
                                <label className="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-indigo-100 transition-colors">
                                    <input type="radio" name="scope" value="accounts" checked={scope === 'accounts'} onChange={() => setScope('accounts')}
                                        className="w-4 h-4 text-indigo-600"/>
                                    <div>
                                        <div className="font-bold text-slate-800 text-sm">üí≥ Specific Accounts</div>
                                        <div className="text-xs text-slate-500">Apply only for selected accounts</div>
                                    </div>
                                </label>
                            </div>
                            
                            {/* Multi-select accounts - only show when accounts scope selected */}
                            {scope === 'accounts' && (
                                <div className="mt-3 p-3 bg-white rounded-xl border border-indigo-200">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-[10px] font-black uppercase text-slate-500">Select Accounts ({selectedAccounts.length})</span>
                                        <div className="flex gap-2">
                                            <button onClick={selectAllAccounts} className="text-[10px] text-indigo-600 font-bold hover:underline">All</button>
                                            <button onClick={clearAccountSelection} className="text-[10px] text-slate-500 font-bold hover:underline">Reset</button>
                                        </div>
                                    </div>
                                    <div className="space-y-1 max-h-32 overflow-y-auto">
                                        {allAccounts.map(acc => (
                                            <label key={acc} className="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-50 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={selectedAccounts.includes(acc)} 
                                                    onChange={() => toggleAccount(acc)}
                                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"
                                                />
                                                <span className={`text-sm ${acc === account ? 'font-bold text-indigo-700' : 'text-slate-700'}`}>
                                                    {acc} {acc === account && '(current)'}
                                                </span>
                                            </label>
                                        ))}
                                    </div>
                                    {selectedAccounts.length > 0 && (
                                        <div className="mt-2 pt-2 border-t border-slate-100">
                                            <div className="text-[10px] text-slate-500">
                                                Selected: {selectedAccounts.join(', ')}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* One-off warning */}
                    {applyMode === 'oneoff' && (
                        <div className="p-3 bg-amber-50 rounded-xl border border-amber-200">
                            <div className="flex items-start gap-2">
                                <span className="text-amber-600">‚ö†Ô∏è</span>
                                <div className="text-xs text-amber-700">
                                    <strong>One-off categorization:</strong> This will only affect this specific transaction. 
                                    Other transactions from "{merchant}" will keep their existing categorization (rule or auto-detected).
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                <div className="p-6 bg-slate-50 flex gap-4">
                    <button onClick={onClose} className="flex-1 py-3 font-bold text-slate-500 rounded-xl hover:bg-slate-200">Cancel</button>
                    <button 
                        onClick={() => onSave(selectedCategory, applyMode === 'rule', merchant, scope, selectedAccounts)} 
                        className={`flex-1 py-3 text-white font-black rounded-xl ${applyMode === 'oneoff' ? 'bg-amber-500 hover:bg-amber-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                    >
                        {applyMode === 'oneoff' ? 'Save One-Off' : 'Save Rule'}
                    </button>
                </div>
            </div>
        </div>
    );
};

// High Impact Mode - Merchant-centric view
const HighImpactView = ({ expenses, merchantRules, onUpdateRule }) => {
    const [sortBy, setSortBy] = useState('total'); // total, count, uncategorized
    const [showCategorized, setShowCategorized] = useState(true);
    
    const merchantData = useMemo(() => {
        const byMerchant = {};
        
        // Only process 2024+ expenses
        expenses.filter(e => isValidYear(e.date)).forEach(e => {
            const merchant = cleanMerchant(e.description);
            const effective = getEffectiveCategory(e, merchantRules);
            
            // Skip excluded for total calculation but track them
            const isExcluded = EXCLUDED_CATEGORIES.includes(effective.category);
            
            if (!byMerchant[merchant]) {
                byMerchant[merchant] = {
                    merchant,
                    total: 0,
                    count: 0,
                    excludedTotal: 0,
                    excludedCount: 0,
                    category: effective.category,
                    source: effective.source,
                    hasRule: !!(merchantRules[merchant]?.scope === 'global'),
                    hasAccountRules: false,
                    csvCategories: new Set(),
                    accounts: new Set()
                };
            }
            
            // Track accounts for this merchant
            if (e.account) byMerchant[merchant].accounts.add(e.account);
            
            // Check for account-specific rules (new multi-account format or legacy)
            const accountsKey = getAccountsRuleKey(merchant);
            const legacyAccountKey = `${merchant}|||${e.account}`;
            if (merchantRules[accountsKey] || merchantRules[legacyAccountKey]) {
                byMerchant[merchant].hasAccountRules = true;
            }
            
            if (isExcluded) {
                byMerchant[merchant].excludedTotal += safe(e.amount);
                byMerchant[merchant].excludedCount += 1;
            } else {
                byMerchant[merchant].total += safe(e.amount);
                byMerchant[merchant].count += 1;
            }
            
            if (e.csvCategory) byMerchant[merchant].csvCategories.add(e.csvCategory);
            
            // Update category info (use first non-excluded transaction's effective category)
            if (!isExcluded) {
                byMerchant[merchant].category = effective.category;
                byMerchant[merchant].source = effective.source;
            }
        });
        
        let data = Object.values(byMerchant);
        
        // Filter out categorized if needed
        if (!showCategorized) {
            data = data.filter(m => m.category === 'Uncategorized' || !m.hasRule);
        }
        
        // Sort
        if (sortBy === 'total') {
            data.sort((a, b) => b.total - a.total);
        } else if (sortBy === 'count') {
            data.sort((a, b) => b.count - a.count);
        } else if (sortBy === 'uncategorized') {
            // Uncategorized first, then by total
            data.sort((a, b) => {
                if (a.category === 'Uncategorized' && b.category !== 'Uncategorized') return -1;
                if (a.category !== 'Uncategorized' && b.category === 'Uncategorized') return 1;
                return b.total - a.total;
            });
        }
        
        return data;
    }, [expenses, merchantRules, sortBy, showCategorized]);

    const stats = useMemo(() => {
        const total = merchantData.length;
        const uncategorized = merchantData.filter(m => m.category === 'Uncategorized').length;
        const withRules = merchantData.filter(m => m.hasRule).length;
        const totalSpend = merchantData.reduce((s, m) => s + m.total, 0);
        const uncategorizedSpend = merchantData.filter(m => m.category === 'Uncategorized').reduce((s, m) => s + m.total, 0);
        return { total, uncategorized, withRules, totalSpend, uncategorizedSpend };
    }, [merchantData]);

    const handleCategoryChange = (merchant, category) => {
        // From High Impact mode, always create global rules
        onUpdateRule(merchant, category, 'global', null);
    };

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-amber-500 to-orange-500 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black flex items-center gap-2">üéØ High Impact Mode</h2>
                <p className="text-amber-100 text-sm mt-1">Categorize merchants by total spend ‚Äî tackle the big fish first!</p>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Unique Merchants</h3>
                    <p className="text-2xl font-black text-slate-900">{stats.total}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-amber-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-amber-500 uppercase">Need Categorizing</h3>
                    <p className="text-2xl font-black text-amber-600">{stats.uncategorized}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-500 uppercase">With Rules</h3>
                    <p className="text-2xl font-black text-green-600">{stats.withRules}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Spend</h3>
                    <p className="text-2xl font-black text-slate-900">${(stats.totalSpend/1000).toFixed(1)}k</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-red-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-red-500 uppercase">Uncategorized $</h3>
                    <p className="text-2xl font-black text-red-600">${(stats.uncategorizedSpend/1000).toFixed(1)}k</p>
                </div>
            </div>

            {/* Controls */}
            <div className="flex flex-wrap gap-4 items-center justify-between">
                <div className="flex gap-2 items-center">
                    <span className="text-xs font-bold text-slate-500">Sort by:</span>
                    <div className="flex gap-1 bg-slate-100 p-1 rounded-xl">
                        {[['total','üí∞ Total $'],['count','üî¢ Count'],['uncategorized','‚ö†Ô∏è Uncategorized First']].map(([key, label]) => (
                            <button key={key} onClick={() => setSortBy(key)}
                                className={`px-3 py-1.5 rounded-lg text-xs font-bold ${sortBy === key ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                                {label}
                            </button>
                        ))}
                    </div>
                </div>
                <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked={showCategorized} onChange={e => setShowCategorized(e.target.checked)}
                        className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                    <span className="text-xs font-bold text-slate-500">Show already categorized</span>
                </label>
            </div>

            {/* Merchant List */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="overflow-x-auto max-h-[60vh]">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-4 w-8">#</th>
                                <th className="p-4">Merchant</th>
                                <th className="p-4 text-center">Transactions</th>
                                <th className="p-4 text-right">Total Spend</th>
                                <th className="p-4 text-center">Category</th>
                                <th className="p-4 w-20">Status</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {merchantData.length === 0 ? (
                                <tr><td colSpan={6} className="p-12 text-center text-slate-400">No merchants to categorize</td></tr>
                            ) : merchantData.map((m, i) => {
                                const isUncategorized = m.category === 'Uncategorized';
                                const isDone = m.hasRule && !isUncategorized;
                                
                                return (
                                    <tr key={m.merchant} className={`group transition-all ${isDone ? 'bg-green-50/50' : isUncategorized ? 'bg-amber-50/30' : 'hover:bg-slate-50'}`}>
                                        <td className="p-4 text-slate-400 font-bold">{i + 1}</td>
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800">{m.merchant}</div>
                                            {m.csvCategories.size > 0 && (
                                                <div className="text-[10px] text-slate-400 mt-0.5">
                                                    CSV: {[...m.csvCategories].slice(0, 2).join(', ')}
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-4 text-center">
                                            <span className="px-2 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-600">
                                                {m.count} txn{m.count !== 1 ? 's' : ''}
                                            </span>
                                        </td>
                                        <td className="p-4 text-right">
                                            <span className={`text-lg font-black ${isUncategorized ? 'text-amber-600' : 'text-slate-900'}`}>
                                                ${m.total.toLocaleString(undefined, {maximumFractionDigits: 0})}
                                            </span>
                                        </td>
                                        <td className="p-4">
                                            <select 
                                                value={m.hasRule ? merchantRules[m.merchant] : m.category}
                                                onChange={e => handleCategoryChange(m.merchant, e.target.value)}
                                                className={`w-full p-2 rounded-lg text-xs font-bold border-2 cursor-pointer transition-all ${
                                                    isUncategorized 
                                                        ? 'bg-amber-100 border-amber-300 text-amber-700 hover:border-amber-400' 
                                                        : isDone 
                                                            ? 'bg-green-100 border-green-300 text-green-700'
                                                            : 'bg-slate-100 border-slate-200 text-slate-700 hover:border-indigo-400'
                                                }`}>
                                                <option value="Uncategorized">‚ö†Ô∏è Uncategorized</option>
                                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </td>
                                        <td className="p-4">
                                            {isDone ? (
                                                <span className="px-2 py-1 bg-green-100 text-green-600 rounded-full text-[10px] font-bold">‚úì DONE</span>
                                            ) : m.hasRule ? (
                                                <span className="px-2 py-1 bg-purple-100 text-purple-600 rounded-full text-[10px] font-bold">RULE</span>
                                            ) : isUncategorized ? (
                                                <span className="px-2 py-1 bg-amber-100 text-amber-600 rounded-full text-[10px] font-bold animate-pulse">TODO</span>
                                            ) : (
                                                <span className="px-2 py-1 bg-slate-100 text-slate-500 rounded-full text-[10px] font-bold">AUTO</span>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Progress */}
            {stats.total > 0 && (
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-sm font-bold text-slate-600">Categorization Progress</span>
                        <span className="text-sm font-black text-indigo-600">{Math.round(((stats.total - stats.uncategorized) / stats.total) * 100)}%</span>
                    </div>
                    <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                        <div 
                            className="h-full bg-gradient-to-r from-green-400 to-emerald-500 rounded-full transition-all duration-500"
                            style={{ width: `${((stats.total - stats.uncategorized) / stats.total) * 100}%` }}
                        />
                    </div>
                    <div className="flex justify-between mt-2 text-[10px] text-slate-400">
                        <span>{stats.total - stats.uncategorized} categorized</span>
                        <span>{stats.uncategorized} remaining</span>
                    </div>
                </div>
            )}
        </div>
    );
};

const CategoryManagement = ({ expenses, merchantRules, onUpdateExpense, onUpdateRule, onDeleteRule, onUpdateSubscription }) => {
    const [viewMode, setViewMode] = useState('highimpact'); // 'highimpact' or 'transactions'
    const [filter, setFilter] = useState('all');
    const [categoryFilter, setCategoryFilter] = useState('all'); // NEW: category filter
    const [searchTerm, setSearchTerm] = useState('');
    const [editingExpense, setEditingExpense] = useState(null);
    
    // Get all unique account names from expenses
    const allAccounts = useMemo(() => {
        const accounts = new Set();
        expenses.forEach(e => {
            if (e.account) accounts.add(e.account);
        });
        return [...accounts].sort();
    }, [expenses]);
    
    // Get all categories present in data
    const categoriesInData = useMemo(() => {
        const cats = new Set();
        expenses.filter(e => isValidYear(e.date)).forEach(e => {
            cats.add(getEffectiveCategory(e, merchantRules).category);
        });
        return ['all', ...CATEGORIES.filter(c => cats.has(c)), 'Uncategorized'].filter((v, i, a) => a.indexOf(v) === i);
    }, [expenses, merchantRules]);
    
    const filteredExpenses = useMemo(() => {
        // Start with 2024+ expenses only
        let filtered = expenses.filter(e => isValidYear(e.date));
        if (filter === 'uncategorized') {
            filtered = filtered.filter(e => getEffectiveCategory(e, merchantRules).category === 'Uncategorized');
        } else if (filter === 'rules') {
            filtered = filtered.filter(e => {
                const src = getEffectiveCategory(e, merchantRules).source;
                return src === 'rule-global' || src === 'rule-account' || src === 'rule-accounts';
            });
        } else if (filter === 'oneoff') {
            filtered = filtered.filter(e => getEffectiveCategory(e, merchantRules).source === 'manual');
        } else if (filter === 'excluded') {
            filtered = filtered.filter(e => EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category));
        }
        // NEW: Apply category filter
        if (categoryFilter !== 'all') {
            filtered = filtered.filter(e => getEffectiveCategory(e, merchantRules).category === categoryFilter);
        }
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(e => e.description?.toLowerCase().includes(term) || cleanMerchant(e.description).toLowerCase().includes(term));
        }
        return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    }, [expenses, merchantRules, filter, categoryFilter, searchTerm]);

    const handleSaveCategory = (category, applyToAll, merchant, scope, accounts) => {
        if (applyToAll) {
            onUpdateRule(merchant, category, scope, accounts);
        } else {
            onUpdateExpense(editingExpense.id, category);
        }
        setEditingExpense(null);
    };

    const stats = useMemo(() => {
        const validExpenses = expenses.filter(e => isValidYear(e.date));
        const uncategorized = validExpenses.filter(e => getEffectiveCategory(e, merchantRules).category === 'Uncategorized').length;
        const withRules = validExpenses.filter(e => {
            const src = getEffectiveCategory(e, merchantRules).source;
            return src === 'rule-global' || src === 'rule-account' || src === 'rule-accounts';
        }).length;
        const oneoff = validExpenses.filter(e => getEffectiveCategory(e, merchantRules).source === 'manual').length;
        const excluded = validExpenses.filter(e => EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category)).length;
        return { uncategorized, withRules, oneoff, excluded, total: validExpenses.length, rulesCount: Object.keys(merchantRules).length };
    }, [expenses, merchantRules]);

    const getCategoryBadge = (source) => {
        switch(source) {
            case 'rule-global': return <span className="ml-1 px-1.5 py-0.5 bg-purple-100 text-purple-600 text-[8px] font-bold rounded">üåç GLOBAL</span>;
            case 'rule-account': return <span className="ml-1 px-1.5 py-0.5 bg-cyan-100 text-cyan-600 text-[8px] font-bold rounded">üí≥ ACCOUNT</span>;
            case 'rule-accounts': return <span className="ml-1 px-1.5 py-0.5 bg-cyan-100 text-cyan-600 text-[8px] font-bold rounded">üí≥ ACCOUNTS</span>;
            case 'rule': return <span className="ml-1 px-1.5 py-0.5 bg-purple-100 text-purple-600 text-[8px] font-bold rounded">RULE</span>;
            case 'manual': return <span className="ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-600 text-[8px] font-bold rounded">‚ö° ONE-OFF</span>;
            case 'auto': return <span className="ml-1 px-1.5 py-0.5 bg-green-100 text-green-600 text-[8px] font-bold rounded">AUTO</span>;
            case 'csv': return <span className="ml-1 px-1.5 py-0.5 bg-amber-100 text-amber-600 text-[8px] font-bold rounded">CSV</span>;
            default: return null;
        }
    };

    // High Impact Mode
    if (viewMode === 'highimpact') {
        return (
            <div className="space-y-6">
                {/* Mode Toggle */}
                <div className="flex gap-2 bg-slate-100 p-1 rounded-xl w-fit">
                    <button onClick={() => setViewMode('highimpact')}
                        className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'highimpact' ? 'bg-white text-amber-600 shadow' : 'text-slate-500'}`}>
                        üéØ High Impact
                    </button>
                    <button onClick={() => setViewMode('transactions')}
                        className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'transactions' ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                        üìã All Transactions
                    </button>
                </div>
                
                <HighImpactView expenses={expenses} merchantRules={merchantRules} onUpdateRule={onUpdateRule} />
            </div>
        );
    }

    // Transaction View
    return (
        <div className="space-y-6">
            {/* Mode Toggle */}
            <div className="flex gap-2 bg-slate-100 p-1 rounded-xl w-fit">
                <button onClick={() => setViewMode('highimpact')}
                    className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'highimpact' ? 'bg-white text-amber-600 shadow' : 'text-slate-500'}`}>
                    üéØ High Impact
                </button>
                <button onClick={() => setViewMode('transactions')}
                    className={`px-4 py-2 rounded-lg text-sm font-bold ${viewMode === 'transactions' ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                    üìã All Transactions
                </button>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-2 lg:grid-cols-6 gap-4">
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg cursor-pointer hover:bg-slate-50" onClick={() => setFilter('all')}>
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total</h3>
                    <p className="text-2xl font-black text-slate-900">{stats.total}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-amber-200 shadow-lg cursor-pointer hover:bg-amber-50" onClick={() => setFilter('uncategorized')}>
                    <h3 className="text-[10px] font-bold text-amber-500 uppercase">Uncategorized</h3>
                    <p className="text-2xl font-black text-amber-600">{stats.uncategorized}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-purple-200 shadow-lg cursor-pointer hover:bg-purple-50" onClick={() => setFilter('rules')}>
                    <h3 className="text-[10px] font-bold text-purple-500 uppercase">With Rules</h3>
                    <p className="text-2xl font-black text-purple-600">{stats.withRules}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-orange-200 shadow-lg cursor-pointer hover:bg-orange-50" onClick={() => setFilter('oneoff')}>
                    <h3 className="text-[10px] font-bold text-orange-500 uppercase">‚ö° One-Off</h3>
                    <p className="text-2xl font-black text-orange-600">{stats.oneoff}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-lg cursor-pointer hover:bg-slate-100" onClick={() => setFilter('excluded')}>
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Excluded</h3>
                    <p className="text-2xl font-black text-slate-500">{stats.excluded}</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border border-indigo-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-indigo-500 uppercase">Merchant Rules</h3>
                    <p className="text-2xl font-black text-indigo-600">{stats.rulesCount}</p>
                </div>
            </div>

            {/* Merchant Rules Summary */}
            {Object.keys(merchantRules).length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 className="font-black text-slate-800">üè∑Ô∏è Active Merchant Rules</h3>
                        <button onClick={() => { if(confirm("Delete all merchant rules?")) Object.keys(merchantRules).forEach(m => onDeleteRule(m)); }}
                            className="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg hover:bg-red-100">Clear All Rules</button>
                    </div>
                    <div className="p-4 flex flex-wrap gap-2 max-h-40 overflow-auto">
                        {Object.entries(merchantRules).map(([ruleKey, ruleData]) => {
                            const isAccountRule = ruleKey.includes('|||');
                            const isMultiAccountRule = ruleData?.scope === 'accounts';
                            const displayName = isAccountRule ? ruleKey.split('|||')[0] : ruleKey;
                            const accountName = isAccountRule && !isMultiAccountRule ? ruleKey.split('|||')[1] : null;
                            const accountsList = isMultiAccountRule && ruleData?.accounts ? ruleData.accounts : null;
                            const category = ruleData?.category || ruleData;
                            const scope = ruleData?.scope || 'global';
                            
                            // Format accounts display
                            const accountsDisplay = accountsList 
                                ? (accountsList.length > 2 
                                    ? `${accountsList.slice(0, 2).join(', ')} +${accountsList.length - 2}` 
                                    : accountsList.join(', '))
                                : accountName;
                            
                            return (
                                <div key={ruleKey} className={`flex items-center gap-2 rounded-lg px-3 py-2 group ${isAccountRule ? 'bg-cyan-50' : 'bg-purple-50'}`}>
                                    <span className={`text-[8px] font-bold px-1.5 py-0.5 rounded ${isAccountRule ? 'bg-cyan-200 text-cyan-700' : 'bg-purple-200 text-purple-700'}`}>
                                        {isAccountRule ? 'üí≥' : 'üåç'}
                                    </span>
                                    <span className="text-xs font-semibold text-slate-600 max-w-[120px] truncate" title={displayName}>{displayName}</span>
                                    {isAccountRule && accountsDisplay && (
                                        <span className="text-[9px] text-slate-400 max-w-[100px] truncate" title={accountsList ? accountsList.join(', ') : accountName}>
                                            ({accountsDisplay})
                                        </span>
                                    )}
                                    <span className="text-[10px] font-bold text-white px-2 py-0.5 rounded" style={{backgroundColor: CAT_COLORS[category] || '#6366f1'}}>{category}</span>
                                    <button onClick={() => onDeleteRule(ruleKey)} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 text-xs">‚úï</button>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* Filters & Search */}
            <div className="flex flex-wrap gap-4 items-center">
                <div className="flex gap-1 bg-slate-100 p-1 rounded-xl">
                    {[['all','All'],['uncategorized','‚ö†Ô∏è Uncategorized'],['rules','üè∑Ô∏è With Rules'],['excluded','üö´ Excluded']].map(([key, label]) => (
                        <button key={key} onClick={() => setFilter(key)}
                            className={`px-3 py-1.5 rounded-lg text-xs font-bold ${filter === key ? 'bg-white text-indigo-600 shadow' : 'text-slate-500'}`}>
                            {label}
                        </button>
                    ))}
                </div>
                {/* Category Filter Dropdown */}
                <select 
                    value={categoryFilter} 
                    onChange={e => setCategoryFilter(e.target.value)}
                    className="px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-indigo-500"
                >
                    <option value="all">üìÅ All Categories</option>
                    {categoriesInData.filter(c => c !== 'all').map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                    ))}
                </select>
                <div className="flex-1 min-w-[200px]">
                    <input type="text" placeholder="Search merchant or description..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                        className="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-indigo-500"/>
                </div>
                <div className="text-sm text-slate-500">{filteredExpenses.length} transactions</div>
            </div>

            {/* Transactions Table */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="overflow-x-auto max-h-[60vh]">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-3">Date</th>
                                <th className="p-3">Merchant</th>
                                <th className="p-3">Amount</th>
                                <th className="p-3">Category</th>
                                <th className="p-3">Recurring</th>
                                <th className="p-3 w-20">Action</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {filteredExpenses.length === 0 ? (
                                <tr><td colSpan={6} className="p-12 text-center text-slate-400">No transactions found</td></tr>
                            ) : filteredExpenses.map(e => {
                                const effective = getEffectiveCategory(e, merchantRules);
                                const isExcluded = EXCLUDED_CATEGORIES.includes(effective.category);
                                const isVenmo = effective.category === 'Venmo';
                                const isNegative = e.amount < 0;
                                const isSubscription = e.isSubscription || false;
                                return (
                                    <tr key={e.id} className={`group ${isExcluded ? 'bg-slate-50 opacity-60' : isVenmo ? 'bg-blue-50/30' : 'hover:bg-slate-50'}`}>
                                        <td className="p-3 text-slate-500 text-xs">{e.date}</td>
                                        <td className="p-3">
                                            <div className={`font-semibold text-xs ${isExcluded ? 'text-slate-400 line-through' : 'text-slate-700'}`} title={e.description}>
                                                {isVenmo && <span className="text-blue-500 mr-1">üí∏</span>}
                                                {cleanMerchant(e.description)}
                                            </div>
                                            <div className="text-[10px] text-slate-400 truncate max-w-[200px]">{e.description}</div>
                                        </td>
                                        <td className={`p-3 font-bold ${isExcluded ? 'text-slate-400' : isNegative ? 'text-green-600' : isVenmo ? 'text-blue-700' : 'text-slate-900'}`}>
                                            {isNegative ? `-$${Math.abs(e.amount).toFixed(2)}` : `$${e.amount.toFixed(2)}`}
                                        </td>
                                        <td className="p-3">
                                            <div className="flex items-center" title={`Original CSV: ${e.csvCategory || 'None'}`}>
                                                <span className={`px-2 py-1 rounded-full text-[10px] font-bold ${
                                                    isExcluded ? 'bg-slate-200 text-slate-500' :
                                                    isVenmo ? 'bg-blue-100 text-blue-700' :
                                                    effective.category === 'Uncategorized' ? 'bg-amber-100 text-amber-700' : 'bg-indigo-100 text-indigo-700'
                                                }`}>
                                                    {effective.category}
                                                </span>
                                                {getCategoryBadge(effective.source)}
                                            </div>
                                        </td>
                                        <td className="p-3">
                                            <button
                                                onClick={() => onUpdateSubscription && onUpdateSubscription(e.id, !isSubscription)}
                                                className={`px-2 py-1 rounded text-[10px] font-bold transition-all ${
                                                    isSubscription 
                                                        ? 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200' 
                                                        : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                                }`}
                                                title={isSubscription ? 'Click to remove recurring flag' : 'Click to mark as recurring'}
                                            >
                                                {isSubscription ? 'üîÑ Yes' : '‚Äî'}
                                            </button>
                                        </td>
                                        <td className="p-3">
                                            <button onClick={() => setEditingExpense(e)}
                                                className="px-3 py-1.5 bg-indigo-100 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-200">
                                                Edit
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>

            {editingExpense && (
                <CategoryEditModal
                    expense={editingExpense}
                    merchantRules={merchantRules}
                    allAccounts={allAccounts}
                    onSave={handleSaveCategory}
                    onClose={() => setEditingExpense(null)}
                />
            )}
        </div>
    );
};

// ============== COST TYPE MANAGEMENT ==============
const CostTypeManagement = ({ expenses, merchantRules, costTypeOverrides, onUpdateCostType }) => {
    const [showExport, setShowExport] = useState(false);
    const [copied, setCopied] = useState(false);
    
    // Get all categories with their current cost types and totals
    const categoryData = useMemo(() => {
        const sp = expenses.filter(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            return !EXCLUDED_CATEGORIES.includes(cat) && (getY(e.date) === 2024 || getY(e.date) === 2025);
        });
        
        const byCategory = {};
        sp.forEach(e => {
            const cat = getEffectiveCategory(e, merchantRules).category;
            if (!byCategory[cat]) byCategory[cat] = { total: 0, count: 0 };
            byCategory[cat].total += safe(e.amount);
            byCategory[cat].count += 1;
        });
        
        return Object.entries(byCategory)
            .map(([category, data]) => ({
                category,
                ...data,
                costType: getCostType(category, costTypeOverrides),
                isOverridden: !!costTypeOverrides[category],
                defaultCostType: getCostType(category, {}) // Get default without overrides
            }))
            .sort((a, b) => b.total - a.total);
    }, [expenses, merchantRules, costTypeOverrides]);
    
    // Generate export code
    const exportCode = useMemo(() => {
        const lines = ['// Cost Type Overrides - Copy this into COST_TYPE_RULES'];
        lines.push('const COST_TYPE_RULES = {');
        
        const byType = { Fixed: [], 'Semi-Fixed': [], Variable: [] };
        categoryData.forEach(({ category, costType }) => {
            byType[costType].push(category);
        });
        
        ['Fixed', 'Semi-Fixed', 'Variable'].forEach(type => {
            if (byType[type].length > 0) {
                const cats = byType[type].map(c => `'${c}'`).join(', ');
                lines.push(`    ${type === 'Semi-Fixed' ? "'Semi-Fixed'" : type}: [${cats}],`);
            } else {
                lines.push(`    ${type === 'Semi-Fixed' ? "'Semi-Fixed'" : type}: [],`);
            }
        });
        
        lines.push('};');
        lines.push('');
        lines.push('// Manual overrides only (for localStorage):');
        lines.push('const COST_TYPE_OVERRIDES = ' + JSON.stringify(costTypeOverrides, null, 2) + ';');
        
        return lines.join('\n');
    }, [categoryData, costTypeOverrides]);
    
    const handleCopy = () => {
        navigator.clipboard.writeText(exportCode);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };
    
    // Summary stats
    const totals = useMemo(() => {
        const result = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0 };
        categoryData.forEach(({ total, costType }) => {
            result[costType] += total;
        });
        const grandTotal = result.Fixed + result['Semi-Fixed'] + result.Variable;
        return { ...result, grandTotal };
    }, [categoryData]);
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-amber-500 to-orange-600 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black">üì¶ Cost Type Management</h2>
                <p className="text-amber-100 text-sm mt-1">Assign categories to Fixed, Semi-Fixed, or Variable cost types</p>
            </div>
            
            {/* Summary Cards */}
            <div className="grid grid-cols-3 gap-4">
                {['Fixed', 'Semi-Fixed', 'Variable'].map(type => {
                    const pct = totals.grandTotal > 0 ? (totals[type] / totals.grandTotal) * 100 : 0;
                    return (
                        <div key={type} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-lg">
                            <div className="flex items-center gap-2 mb-2">
                                <div className="w-4 h-4 rounded" style={{ backgroundColor: COST_TYPE_COLORS[type] }} />
                                <h3 className="text-sm font-black text-slate-700">{type}</h3>
                            </div>
                            <p className="text-2xl font-black" style={{ color: COST_TYPE_COLORS[type] }}>
                                ${(totals[type]/1000).toFixed(1)}k
                            </p>
                            <p className="text-xs text-slate-400 mt-1">{pct.toFixed(1)}% of total</p>
                        </div>
                    );
                })}
            </div>
            
            {/* Category Assignment Table */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 className="text-sm font-black text-slate-800">üè∑Ô∏è Category Assignments</h3>
                    <button 
                        onClick={() => setShowExport(!showExport)}
                        className="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-bold text-slate-600 transition-all"
                    >
                        {showExport ? 'üìã Hide Export' : 'üì§ Export Rules'}
                    </button>
                </div>
                
                {/* Export Panel */}
                {showExport && (
                    <div className="p-4 bg-slate-50 border-b border-slate-100">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-slate-500">Copy this code into your source:</span>
                            <button 
                                onClick={handleCopy}
                                className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                    copied ? 'bg-green-500 text-white' : 'bg-indigo-500 text-white hover:bg-indigo-600'
                                }`}
                            >
                                {copied ? '‚úì Copied!' : 'üìã Copy Code'}
                            </button>
                        </div>
                        <pre className="bg-slate-800 text-green-400 p-4 rounded-lg text-[10px] overflow-auto max-h-48 font-mono">
                            {exportCode}
                        </pre>
                    </div>
                )}
                
                <div className="overflow-x-auto max-h-[50vh]">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-3">Category</th>
                                <th className="p-3">2024-25 Total</th>
                                <th className="p-3">Transactions</th>
                                <th className="p-3">Cost Type</th>
                                <th className="p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {categoryData.map(({ category, total, count, costType, isOverridden, defaultCostType }) => (
                                <tr key={category} className={`hover:bg-slate-50 ${isOverridden ? 'bg-amber-50/50' : ''}`}>
                                    <td className="p-3">
                                        <div className="flex items-center gap-2">
                                            <div className="w-3 h-3 rounded" style={{ backgroundColor: CAT_COLORS[category] || '#94a3b8' }} />
                                            <span className="font-semibold text-slate-700">{category}</span>
                                        </div>
                                    </td>
                                    <td className="p-3 font-bold text-slate-900">${total.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                                    <td className="p-3 text-slate-500">{count}</td>
                                    <td className="p-3">
                                        <div className="flex gap-1">
                                            {['Fixed', 'Semi-Fixed', 'Variable'].map(type => (
                                                <button
                                                    key={type}
                                                    onClick={() => onUpdateCostType(category, type)}
                                                    className={`px-2 py-1 rounded text-[10px] font-bold transition-all ${
                                                        costType === type 
                                                            ? 'text-white shadow-sm' 
                                                            : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                                    }`}
                                                    style={costType === type ? { backgroundColor: COST_TYPE_COLORS[type] } : {}}
                                                >
                                                    {type === 'Semi-Fixed' ? 'Semi' : type.substring(0, 3)}
                                                </button>
                                            ))}
                                        </div>
                                    </td>
                                    <td className="p-3">
                                        {isOverridden ? (
                                            <span className="px-2 py-1 bg-amber-100 text-amber-700 rounded text-[10px] font-bold">
                                                ‚úèÔ∏è Override
                                            </span>
                                        ) : (
                                            <span className="px-2 py-1 bg-slate-100 text-slate-400 rounded text-[10px] font-bold">
                                                Auto
                                            </span>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {/* Info Panel */}
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <h4 className="font-bold text-blue-800 text-sm mb-2">üí° How Cost Types Work</h4>
                <ul className="text-xs text-blue-700 space-y-1">
                    <li><strong>Fixed:</strong> Mandatory expenses that don't change (Rent, Insurance, Daycare)</li>
                    <li><strong>Semi-Fixed:</strong> Necessary but variable amounts (Groceries, Household)</li>
                    <li><strong>Variable:</strong> Discretionary spending (Dining, Entertainment, Shopping)</li>
                </ul>
                <p className="text-[10px] text-blue-600 mt-3">
                    üîÑ Changes are saved automatically. Use "Export Rules" to get code for permanent hardcoding.
                </p>
            </div>
        </div>
    );
};

// ============== TRANSACTIONS TABLE WITH FILTERS ==============
const FilterDropdown = ({ isOpen, onClose, children, style }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-50" onClick={onClose}>
            <div className="absolute bg-white rounded-xl shadow-2xl border border-slate-200 p-3 min-w-[200px] max-h-[300px] overflow-auto"
                style={style} onClick={e => e.stopPropagation()}>
                {children}
            </div>
        </div>
    );
};

const TransactionsTable = ({ expenses, merchantRules, onDelete, onClearAll }) => {
    // Filter state
    const [dateFilter, setDateFilter] = useState([]); // Array of "Month Year" strings
    const [categoryFilter, setCategoryFilter] = useState([]); // Array of category strings
    const [accountFilter, setAccountFilter] = useState([]); // Array of account strings
    const [amountMin, setAmountMin] = useState('');
    const [amountMax, setAmountMax] = useState('');
    const [descSearch, setDescSearch] = useState('');
    
    // Dropdown open state
    const [openFilter, setOpenFilter] = useState(null); // 'date', 'category', 'account', 'amount', 'desc'
    const [filterPos, setFilterPos] = useState({ top: 0, left: 0 });

    // Get unique filter options
    const filterOptions = useMemo(() => {
        const months = new Set();
        const categories = new Set();
        const accounts = new Set();
        
        expenses.filter(e => isValidYear(e.date)).forEach(e => {
            const d = pDate(e.date);
            const monthYear = `${MONTHS[d.getMonth()]} ${d.getFullYear()}`;
            months.add(monthYear);
            
            const cat = getEffectiveCategory(e, merchantRules).category;
            categories.add(cat);
            
            if (e.account) accounts.add(e.account);
        });
        
        // Sort months chronologically
        const sortedMonths = [...months].sort((a, b) => {
            const [aMonth, aYear] = a.split(' ');
            const [bMonth, bYear] = b.split(' ');
            const aDate = new Date(`${aMonth} 1, ${aYear}`);
            const bDate = new Date(`${bMonth} 1, ${bYear}`);
            return bDate - aDate; // Most recent first
        });
        
        return {
            months: sortedMonths,
            categories: [...categories].sort(),
            accounts: [...accounts].sort()
        };
    }, [expenses, merchantRules]);

    // Apply filters
    const filteredExpenses = useMemo(() => {
        return expenses.filter(e => {
            // Year filter - only 2024+
            if (!isValidYear(e.date)) return false;
            
            // Date filter (Month Year)
            if (dateFilter.length > 0) {
                const d = pDate(e.date);
                const monthYear = `${MONTHS[d.getMonth()]} ${d.getFullYear()}`;
                if (!dateFilter.includes(monthYear)) return false;
            }
            
            // Category filter
            if (categoryFilter.length > 0) {
                const cat = getEffectiveCategory(e, merchantRules).category;
                if (!categoryFilter.includes(cat)) return false;
            }
            
            // Account filter
            if (accountFilter.length > 0) {
                if (!accountFilter.includes(e.account)) return false;
            }
            
            // Amount range filter
            const amt = safe(e.amount);
            if (amountMin !== '' && amt < parseFloat(amountMin)) return false;
            if (amountMax !== '' && amt > parseFloat(amountMax)) return false;
            
            // Description search
            if (descSearch) {
                const term = descSearch.toLowerCase();
                if (!e.description?.toLowerCase().includes(term)) return false;
            }
            
            return true;
        });
    }, [expenses, merchantRules, dateFilter, categoryFilter, accountFilter, amountMin, amountMax, descSearch]);

    // Summary stats for filtered data
    const summary = useMemo(() => {
        const spending = filteredExpenses.filter(e => !EXCLUDED_CATEGORIES.includes(getEffectiveCategory(e, merchantRules).category));
        const total = spending.reduce((s, e) => s + safe(e.amount), 0);
        return { count: filteredExpenses.length, total, spendingCount: spending.length };
    }, [filteredExpenses, merchantRules]);

    // Check if any filters are active
    const hasActiveFilters = dateFilter.length > 0 || categoryFilter.length > 0 || accountFilter.length > 0 || 
        amountMin !== '' || amountMax !== '' || descSearch !== '';

    const clearAllFilters = () => {
        setDateFilter([]);
        setCategoryFilter([]);
        setAccountFilter([]);
        setAmountMin('');
        setAmountMax('');
        setDescSearch('');
    };

    const openFilterDropdown = (filterType, event) => {
        const rect = event.currentTarget.getBoundingClientRect();
        setFilterPos({ top: rect.bottom + 4, left: Math.min(rect.left, window.innerWidth - 220) });
        setOpenFilter(filterType);
    };

    const toggleFilterItem = (filterType, value) => {
        const setters = { date: setDateFilter, category: setCategoryFilter, account: setAccountFilter };
        const current = { date: dateFilter, category: categoryFilter, account: accountFilter }[filterType];
        const setter = setters[filterType];
        
        if (current.includes(value)) {
            setter(current.filter(v => v !== value));
        } else {
            setter([...current, value]);
        }
    };

    const FilterButton = ({ type, label, activeCount, onClick }) => (
        <button onClick={onClick}
            className={`flex items-center gap-1 px-1 py-0.5 rounded transition-colors ${activeCount > 0 ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-200 text-slate-400'}`}>
            <span className="text-[10px] font-bold uppercase">{label}</span>
            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            {activeCount > 0 && <span className="text-[9px] bg-indigo-600 text-white px-1 rounded-full">{activeCount}</span>}
        </button>
    );

    return (
        <div className="space-y-4">
            {/* Header with summary */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg p-4">
                <div className="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 className="font-black text-slate-800">Transactions</h2>
                        <p className="text-sm text-slate-500">
                            {hasActiveFilters ? (
                                <span>Showing <span className="font-bold text-indigo-600">{summary.count}</span> of {expenses.length} transactions</span>
                            ) : (
                                <span>{expenses.length} total transactions</span>
                            )}
                        </p>
                    </div>
                    <div className="flex items-center gap-4">
                        {hasActiveFilters && (
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-bold text-slate-600">
                                    Filtered Total: <span className="text-indigo-600">${summary.total.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                                </span>
                                <button onClick={clearAllFilters} className="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100">
                                    Clear Filters
                                </button>
                            </div>
                        )}
                        <button onClick={onClearAll} className="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg hover:bg-red-100">
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>

            {/* Table */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="overflow-x-auto max-h-[65vh]">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 sticky top-0 z-10">
                            <tr>
                                <th className="p-3">
                                    <FilterButton type="date" label="Date" activeCount={dateFilter.length} onClick={e => openFilterDropdown('date', e)} />
                                </th>
                                <th className="p-3">
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] font-bold uppercase text-slate-400">Description</span>
                                        <input type="text" placeholder="üîç" value={descSearch} onChange={e => setDescSearch(e.target.value)}
                                            className={`w-20 px-2 py-1 text-xs rounded border outline-none ${descSearch ? 'border-indigo-400 bg-indigo-50' : 'border-slate-200 bg-white'}`}/>
                                    </div>
                                </th>
                                <th className="p-3">
                                    <FilterButton type="account" label="Account" activeCount={accountFilter.length} onClick={e => openFilterDropdown('account', e)} />
                                </th>
                                <th className="p-3">
                                    <FilterButton type="category" label="Category" activeCount={categoryFilter.length} onClick={e => openFilterDropdown('category', e)} />
                                </th>
                                <th className="p-3 text-right">
                                    <FilterButton type="amount" label="Amount" activeCount={(amountMin || amountMax) ? 1 : 0} onClick={e => openFilterDropdown('amount', e)} />
                                </th>
                                <th className="p-3 w-10"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {filteredExpenses.length === 0 ? (
                                <tr><td colSpan={6} className="p-12 text-center text-slate-400">
                                    {expenses.length === 0 ? 'No transactions' : 'No transactions match filters'}
                                </td></tr>
                            ) : [...filteredExpenses].reverse().map(e => {
                                const effective = getEffectiveCategory(e, merchantRules);
                                const isExcluded = EXCLUDED_CATEGORIES.includes(effective.category);
                                const isNegative = e.amount < 0;
                                const isVenmoReimbursement = e.transactionType === 'venmo-reimbursement';
                                const isVenmo = effective.category === 'Venmo';
                                return (
                                    <tr key={e.id} className={`group ${isExcluded ? 'bg-slate-50 opacity-50' : isVenmoReimbursement ? 'bg-green-50/50' : isVenmo ? 'bg-blue-50/30' : 'hover:bg-slate-50'}`}>
                                        <td className="p-3 text-slate-500 text-xs whitespace-nowrap">{e.date}</td>
                                        <td className={`p-3 font-semibold max-w-[250px] ${isExcluded ? 'text-slate-400 line-through' : 'text-slate-700'}`}>
                                            <div className="truncate text-xs" title={e.rawDescription || e.description}>
                                                {isVenmoReimbursement && <span className="text-green-600 mr-1">‚Ü©</span>}
                                                {isVenmo && !isVenmoReimbursement && <span className="text-blue-500 mr-1">üí∏</span>}
                                                {e.description}
                                            </div>
                                            {e.rawDescription && e.rawDescription !== e.description && (
                                                <div className="text-[9px] text-slate-400 truncate" title={e.rawDescription}>
                                                    Raw: {e.rawDescription}
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-3 text-slate-500 text-xs">{e.account}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded-full text-[10px] font-bold ${
                                                isExcluded ? 'bg-slate-200 text-slate-500' : 
                                                isVenmo ? 'bg-blue-100 text-blue-700' :
                                                effective.category === 'Uncategorized' ? 'bg-amber-100 text-amber-700' : 'bg-indigo-100 text-indigo-700'
                                            }`} title={`Source: ${effective.source} | CSV: ${e.csvCategory} | Type: ${e.transactionType || 'expense'}`}>
                                                {effective.category}
                                            </span>
                                        </td>
                                        <td className={`p-3 text-right font-bold ${isExcluded ? 'text-slate-400' : isNegative ? 'text-green-600' : isVenmo ? 'text-blue-700' : 'text-slate-900'}`}>
                                            {isNegative ? `-$${Math.abs(e.amount).toFixed(2)}` : `$${e.amount.toFixed(2)}`}
                                        </td>
                                        <td className="p-3">
                                            <button onClick={() => onDelete(e.id)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>

                {/* Footer Summary */}
                {filteredExpenses.length > 0 && (
                    <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                        <span className="text-sm text-slate-500">
                            {summary.spendingCount} spending transactions (excluding Income/Transfer/Excluded)
                        </span>
                        <div className="text-right">
                            <div className="text-xs text-slate-400 uppercase font-bold">Filtered Total (Spending)</div>
                            <div className="text-2xl font-black text-indigo-600">${summary.total.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                )}
            </div>

            {/* Filter Dropdowns */}
            <FilterDropdown isOpen={openFilter === 'date'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-2">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Month</span>
                        {dateFilter.length > 0 && (
                            <button onClick={() => setDateFilter([])} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-1 max-h-[200px] overflow-auto">
                        {filterOptions.months.map(month => (
                            <label key={month} className="flex items-center gap-2 p-1.5 rounded hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" checked={dateFilter.includes(month)} onChange={() => toggleFilterItem('date', month)}
                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                                <span className="text-sm text-slate-700">{month}</span>
                            </label>
                        ))}
                    </div>
                </div>
            </FilterDropdown>

            <FilterDropdown isOpen={openFilter === 'category'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-2">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Category</span>
                        {categoryFilter.length > 0 && (
                            <button onClick={() => setCategoryFilter([])} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-1 max-h-[200px] overflow-auto">
                        {filterOptions.categories.map(cat => (
                            <label key={cat} className="flex items-center gap-2 p-1.5 rounded hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" checked={categoryFilter.includes(cat)} onChange={() => toggleFilterItem('category', cat)}
                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                                <span className="text-sm text-slate-700">{cat}</span>
                                <span className="w-3 h-3 rounded-full ml-auto" style={{backgroundColor: CAT_COLORS[cat] || '#6366f1'}}/>
                            </label>
                        ))}
                    </div>
                </div>
            </FilterDropdown>

            <FilterDropdown isOpen={openFilter === 'account'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-2">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Account</span>
                        {accountFilter.length > 0 && (
                            <button onClick={() => setAccountFilter([])} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-1 max-h-[200px] overflow-auto">
                        {filterOptions.accounts.map(acc => (
                            <label key={acc} className="flex items-center gap-2 p-1.5 rounded hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" checked={accountFilter.includes(acc)} onChange={() => toggleFilterItem('account', acc)}
                                    className="w-4 h-4 rounded border-slate-300 text-indigo-600"/>
                                <span className="text-sm text-slate-700">{acc}</span>
                            </label>
                        ))}
                    </div>
                </div>
            </FilterDropdown>

            <FilterDropdown isOpen={openFilter === 'amount'} onClose={() => setOpenFilter(null)} style={filterPos}>
                <div className="space-y-3">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-bold text-sm text-slate-700">Filter by Amount</span>
                        {(amountMin || amountMax) && (
                            <button onClick={() => { setAmountMin(''); setAmountMax(''); }} className="text-xs text-indigo-600 hover:underline">Clear</button>
                        )}
                    </div>
                    <div className="space-y-2">
                        <div>
                            <label className="text-xs font-bold text-slate-500 block mb-1">Minimum ($)</label>
                            <input type="number" value={amountMin} onChange={e => setAmountMin(e.target.value)} placeholder="0"
                                className="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500"/>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-500 block mb-1">Maximum ($)</label>
                            <input type="number" value={amountMax} onChange={e => setAmountMax(e.target.value)} placeholder="‚àû"
                                className="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-500"/>
                        </div>
                    </div>
                </div>
            </FilterDropdown>
        </div>
    );
};

// ============== STYLECOM REIMBURSEMENT DASHBOARD ==============
const StylecomReimbursement = ({ expenses, merchantRules, paidIds, onTogglePaid }) => {
    const [selectedQuarter, setSelectedQuarter] = useState('all');
    const [viewMode, setViewMode] = useState('expenses'); // 'expenses' or 'repayments'
    
    // Separate Stylecom into EXPENSES (positive) and REPAYMENTS (negative)
    const { stylecomExpenses, stylecomRepayments } = useMemo(() => {
        const allStylecom = expenses.filter(e => {
            const effective = getEffectiveCategory(e, merchantRules);
            return effective.category === 'Stylecom' && isValidYear(e.date);
        });
        
        // Expenses = positive amounts (money you put out)
        const stylecomExpenses = allStylecom
            .filter(e => safe(e.amount) > 0)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Repayments = negative amounts (money coming back)
        const stylecomRepayments = allStylecom
            .filter(e => safe(e.amount) < 0)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        return { stylecomExpenses, stylecomRepayments };
    }, [expenses, merchantRules]);
    
    // Calculate KPIs using GROSS amounts (expenses only, no netting)
    const kpis = useMemo(() => {
        // GROSS lifetime spend (only positive expenses)
        const grossSpend = stylecomExpenses.reduce((sum, e) => sum + safe(e.amount), 0);
        
        // Total actually repaid (sum of negative amounts, shown as positive)
        const totalRepaid = Math.abs(stylecomRepayments.reduce((sum, e) => sum + safe(e.amount), 0));
        
        // Claims marked as paid (user checkbox)
        const markedAsPaid = stylecomExpenses.filter(e => paidIds.has(e.id));
        const totalMarkedPaid = markedAsPaid.reduce((sum, e) => sum + safe(e.amount), 0);
        
        // Outstanding balance = Gross Spend - Actual Repayments
        const netOwed = grossSpend - totalRepaid;
        
        // Reconciliation delta = What's marked as paid - What's actually received
        const reconciliationDelta = totalMarkedPaid - totalRepaid;
        
        return { 
            grossSpend, 
            totalRepaid, 
            totalMarkedPaid,
            netOwed,
            reconciliationDelta,
            expenseCount: stylecomExpenses.length,
            repaymentCount: stylecomRepayments.length,
            markedPaidCount: markedAsPaid.length
        };
    }, [stylecomExpenses, stylecomRepayments, paidIds]);
    
    // Group EXPENSES by quarter (GROSS only, no repayments mixed in)
    const quarterlyData = useMemo(() => {
        const byQuarter = {};
        
        // Process expenses
        stylecomExpenses.forEach(e => {
            const date = pDate(e.date);
            const year = date.getFullYear();
            const quarter = Math.floor(date.getMonth() / 3) + 1;
            const key = `Q${quarter} ${year}`;
            
            if (!byQuarter[key]) {
                byQuarter[key] = { 
                    key, year, quarter, 
                    grossTotal: 0, markedPaid: 0, notMarked: 0, 
                    transactions: [],
                    repayments: 0, repaymentTxns: []
                };
            }
            
            const amount = safe(e.amount);
            byQuarter[key].grossTotal += amount;
            byQuarter[key].transactions.push(e);
            
            if (paidIds.has(e.id)) {
                byQuarter[key].markedPaid += amount;
            } else {
                byQuarter[key].notMarked += amount;
            }
        });
        
        // Process repayments separately
        stylecomRepayments.forEach(e => {
            const date = pDate(e.date);
            const year = date.getFullYear();
            const quarter = Math.floor(date.getMonth() / 3) + 1;
            const key = `Q${quarter} ${year}`;
            
            if (!byQuarter[key]) {
                byQuarter[key] = { 
                    key, year, quarter, 
                    grossTotal: 0, markedPaid: 0, notMarked: 0, 
                    transactions: [],
                    repayments: 0, repaymentTxns: []
                };
            }
            byQuarter[key].repayments += Math.abs(safe(e.amount));
            byQuarter[key].repaymentTxns.push(e);
        });
        
        return Object.values(byQuarter).sort((a, b) => {
            if (a.year !== b.year) return b.year - a.year;
            return b.quarter - a.quarter;
        });
    }, [stylecomExpenses, stylecomRepayments, paidIds]);
    
    // Filter transactions by selected quarter and view mode
    const filteredTransactions = useMemo(() => {
        const txns = viewMode === 'expenses' ? stylecomExpenses : stylecomRepayments;
        if (selectedQuarter === 'all') return txns;
        
        const q = quarterlyData.find(q => q.key === selectedQuarter);
        if (!q) return [];
        return viewMode === 'expenses' ? q.transactions : (q.repaymentTxns || []);
    }, [stylecomExpenses, stylecomRepayments, quarterlyData, selectedQuarter, viewMode]);
    
    // Mark all in quarter as paid
    const markQuarterPaid = (quarterKey) => {
        const q = quarterlyData.find(q => q.key === quarterKey);
        if (q) {
            q.transactions.forEach(e => {
                if (!paidIds.has(e.id)) {
                    onTogglePaid(e.id);
                }
            });
        }
    };
    
    // Get max for bar chart scaling
    const maxQuarterlyGross = Math.max(...quarterlyData.map(q => q.grossTotal), 1);
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black">üëó Stylecom Reimbursement Tracker</h2>
                <p className="text-pink-100 text-sm mt-1">Track business expenses and reimbursements separately</p>
            </div>
            
            {/* KPI Cards - Row 1: Gross Metrics */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">üí∏ Gross Lifetime Spend</h3>
                    <p className="text-2xl font-black text-slate-900">${kpis.grossSpend.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    <p className="text-xs text-slate-500 mt-1">{kpis.expenseCount} expense transactions</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-600 uppercase">üí∞ Total Repaid</h3>
                    <p className="text-2xl font-black text-green-600">${kpis.totalRepaid.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    <p className="text-xs text-green-500 mt-1">{kpis.repaymentCount} repayment wires</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-amber-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-amber-600 uppercase">‚ö° Net Owed to Family</h3>
                    <p className={`text-3xl font-black ${kpis.netOwed > 0 ? 'text-amber-600' : 'text-green-600'}`}>
                        ${Math.abs(kpis.netOwed).toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </p>
                    <p className="text-xs text-amber-500 mt-1">Gross Spend - Repaid</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-indigo-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-indigo-500 uppercase">üìä Repayment Rate</h3>
                    <p className="text-2xl font-black text-indigo-600">
                        {kpis.grossSpend > 0 ? Math.round((kpis.totalRepaid / kpis.grossSpend) * 100) : 0}%
                    </p>
                    <div className="h-2 bg-slate-100 rounded-full mt-2 overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-indigo-400 to-indigo-600 rounded-full"
                            style={{ width: `${kpis.grossSpend > 0 ? (kpis.totalRepaid / kpis.grossSpend) * 100 : 0}%` }}/>
                    </div>
                </div>
            </div>
            
            {/* NEW: Reimbursement Reconciliation Section */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-slate-100">
                    <h3 className="text-sm font-black text-slate-800">üîç Reimbursement Reconciliation</h3>
                    <p className="text-[10px] text-slate-500 mt-1">Compare what you've marked as paid vs what you've actually received</p>
                </div>
                <div className="p-6">
                    <div className="flex items-center gap-4">
                        {/* Claims (Left) */}
                        <div className="flex-1 text-center">
                            <div className="text-[10px] font-bold text-slate-400 uppercase mb-2">üìã Marked as Paid</div>
                            <div className="text-3xl font-black text-blue-600">${kpis.totalMarkedPaid.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div className="text-xs text-slate-500 mt-1">{kpis.markedPaidCount} expenses checked off</div>
                        </div>
                        
                        {/* Progress Bar */}
                        <div className="flex-1">
                            <div className="relative h-8 bg-slate-100 rounded-full overflow-hidden">
                                {/* Marked as Paid (full bar) */}
                                <div className="absolute inset-0 bg-blue-200 rounded-full" style={{ width: '100%' }}/>
                                {/* Actually Received (overlay) */}
                                <div 
                                    className="absolute inset-y-0 left-0 bg-green-500 rounded-full transition-all"
                                    style={{ width: `${kpis.totalMarkedPaid > 0 ? Math.min((kpis.totalRepaid / kpis.totalMarkedPaid) * 100, 100) : 0}%` }}
                                />
                                {/* Center line marker */}
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <span className="text-[10px] font-black text-white drop-shadow-md">
                                        {kpis.totalMarkedPaid > 0 ? Math.round((kpis.totalRepaid / kpis.totalMarkedPaid) * 100) : 0}% received
                                    </span>
                                </div>
                            </div>
                            <div className="flex justify-between mt-1 text-[9px] text-slate-400">
                                <span>üü¶ Claimed</span>
                                <span>üü© Received</span>
                            </div>
                        </div>
                        
                        {/* Received (Right) */}
                        <div className="flex-1 text-center">
                            <div className="text-[10px] font-bold text-slate-400 uppercase mb-2">üí∞ Actually Received</div>
                            <div className="text-3xl font-black text-green-600">${kpis.totalRepaid.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            <div className="text-xs text-slate-500 mt-1">{kpis.repaymentCount} wire transfers</div>
                        </div>
                    </div>
                    
                    {/* Delta */}
                    <div className={`mt-4 p-4 rounded-xl ${kpis.reconciliationDelta > 0 ? 'bg-red-50 border border-red-200' : kpis.reconciliationDelta < 0 ? 'bg-green-50 border border-green-200' : 'bg-slate-50 border border-slate-200'}`}>
                        <div className="flex justify-between items-center">
                            <div>
                                <span className="text-xs font-bold text-slate-600">Reconciliation Delta:</span>
                                {kpis.reconciliationDelta > 0 && (
                                    <span className="ml-2 text-xs text-red-600">‚ö†Ô∏è You're owed more than received</span>
                                )}
                                {kpis.reconciliationDelta < 0 && (
                                    <span className="ml-2 text-xs text-green-600">‚úì Received more than marked</span>
                                )}
                                {kpis.reconciliationDelta === 0 && (
                                    <span className="ml-2 text-xs text-slate-500">‚úì Perfectly balanced</span>
                                )}
                            </div>
                            <div className={`text-xl font-black ${kpis.reconciliationDelta > 0 ? 'text-red-600' : kpis.reconciliationDelta < 0 ? 'text-green-600' : 'text-slate-600'}`}>
                                {kpis.reconciliationDelta > 0 ? '-' : kpis.reconciliationDelta < 0 ? '+' : ''}${Math.abs(kpis.reconciliationDelta).toLocaleString(undefined, {maximumFractionDigits: 0})}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Quarterly Breakdown - GROSS SPENDING ONLY (no negative bars) */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100">
                    <h3 className="text-sm font-black text-slate-800">üìÖ Quarterly Gross Spending</h3>
                    <p className="text-[10px] text-slate-500 mt-1">Showing what you advanced (not netted with repayments)</p>
                </div>
                
                {/* Table */}
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold">
                            <tr>
                                <th className="p-4 text-left">Quarter</th>
                                <th className="p-4 text-right">Gross Spend</th>
                                <th className="p-4 text-right">Marked Paid</th>
                                <th className="p-4 text-right">Repaid</th>
                                <th className="p-4 text-center">Claim Status</th>
                                <th className="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {quarterlyData.length === 0 ? (
                                <tr><td colSpan={6} className="p-12 text-center text-slate-400">No Stylecom expenses found</td></tr>
                            ) : quarterlyData.map(q => {
                                const allMarked = q.notMarked === 0 && q.grossTotal > 0;
                                const progress = q.grossTotal > 0 ? (q.markedPaid / q.grossTotal) * 100 : 0;
                                return (
                                    <tr key={q.key} className={`hover:bg-slate-50 ${allMarked ? 'bg-green-50/50' : ''}`}>
                                        <td className="p-4 font-bold text-slate-800">{q.key}</td>
                                        <td className="p-4 text-right font-semibold text-pink-600">${q.grossTotal.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                                        <td className="p-4 text-right font-semibold text-blue-600">${q.markedPaid.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                                        <td className="p-4 text-right font-semibold text-green-600">${(q.repayments || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                                        <td className="p-4 text-center">
                                            <div className="flex items-center gap-2">
                                                <div className="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                                    <div className="h-full bg-blue-500 rounded-full" style={{ width: `${progress}%` }}/>
                                                </div>
                                                <span className="text-[10px] font-bold text-slate-500 w-10">{Math.round(progress)}%</span>
                                            </div>
                                        </td>
                                        <td className="p-4 text-center">
                                            <div className="flex gap-2 justify-center">
                                                <button 
                                                    onClick={() => { setSelectedQuarter(selectedQuarter === q.key ? 'all' : q.key); setViewMode('expenses'); }}
                                                    className={`px-3 py-1 rounded-lg text-xs font-bold ${selectedQuarter === q.key && viewMode === 'expenses' ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                                    View
                                                </button>
                                                {!allMarked && (
                                                    <button 
                                                        onClick={() => markQuarterPaid(q.key)}
                                                        className="px-3 py-1 bg-green-100 text-green-600 rounded-lg text-xs font-bold hover:bg-green-200">
                                                        Mark All
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {/* Transaction List with Toggle */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 className="text-sm font-black text-slate-800">
                        üìù {viewMode === 'expenses' ? 'Expenses' : 'Repayments'} {selectedQuarter !== 'all' && `- ${selectedQuarter}`}
                    </h3>
                    <div className="flex gap-2 items-center">
                        {/* Export Button */}
                        <button 
                            onClick={() => {
                                // Export current view to Excel/CSV
                                const dataToExport = filteredTransactions.map(e => ({
                                    Date: e.date,
                                    Description: e.description,
                                    Account: e.account,
                                    Amount: Math.abs(safe(e.amount)).toFixed(2),
                                    Type: safe(e.amount) < 0 ? 'Repayment' : 'Expense',
                                    'Marked Paid': viewMode === 'expenses' ? (paidIds.has(e.id) ? 'Yes' : 'No') : 'N/A'
                                }));
                                
                                // Create CSV content
                                const headers = ['Date', 'Description', 'Account', 'Amount', 'Type', 'Marked Paid'];
                                const csvContent = [
                                    headers.join(','),
                                    ...dataToExport.map(row => 
                                        headers.map(h => `"${String(row[h] || '').replace(/"/g, '""')}"`).join(',')
                                    )
                                ].join('\n');
                                
                                // Download
                                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `stylecom_${viewMode}_${selectedQuarter === 'all' ? 'all' : selectedQuarter.replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                                a.click();
                                URL.revokeObjectURL(url);
                            }}
                            className="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold hover:bg-green-200 flex items-center gap-1"
                            title="Export to Excel/CSV"
                        >
                            üì• Export
                        </button>
                        {/* View Mode Toggle */}
                        <div className="flex gap-1 bg-slate-100 p-1 rounded-lg">
                            <button 
                                onClick={() => setViewMode('expenses')}
                                className={`px-3 py-1 rounded text-xs font-bold ${viewMode === 'expenses' ? 'bg-white text-pink-600 shadow' : 'text-slate-500'}`}>
                                üí∏ Expenses ({stylecomExpenses.length})
                            </button>
                            <button 
                                onClick={() => setViewMode('repayments')}
                                className={`px-3 py-1 rounded text-xs font-bold ${viewMode === 'repayments' ? 'bg-white text-green-600 shadow' : 'text-slate-500'}`}>
                                üí∞ Repayments ({stylecomRepayments.length})
                            </button>
                        </div>
                        {selectedQuarter !== 'all' && (
                            <button onClick={() => setSelectedQuarter('all')} className="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200">
                                Show All
                            </button>
                        )}
                    </div>
                </div>
                <div className="overflow-x-auto max-h-[50vh]">
                    <table className="w-full text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                {viewMode === 'expenses' && <th className="p-3 text-center w-16">Paid</th>}
                                <th className="p-3 text-left">Date</th>
                                <th className="p-3 text-left">Description</th>
                                <th className="p-3 text-left">Account</th>
                                <th className="p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {filteredTransactions.length === 0 ? (
                                <tr><td colSpan={viewMode === 'expenses' ? 5 : 4} className="p-12 text-center text-slate-400">No {viewMode} found</td></tr>
                            ) : filteredTransactions.map(e => {
                                const isPaid = paidIds.has(e.id);
                                const amount = safe(e.amount);
                                const isRepayment = amount < 0;
                                return (
                                    <tr key={e.id} className={`group hover:bg-slate-50 ${isPaid ? 'bg-green-50/50' : ''} ${isRepayment ? 'bg-emerald-50/50' : ''}`}>
                                        {viewMode === 'expenses' && (
                                            <td className="p-3 text-center">
                                                <button 
                                                    onClick={() => onTogglePaid(e.id)}
                                                    className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${
                                                        isPaid 
                                                            ? 'bg-green-500 border-green-500 text-white' 
                                                            : 'border-slate-300 hover:border-green-400 text-transparent hover:text-green-400'
                                                    }`}>
                                                    ‚úì
                                                </button>
                                            </td>
                                        )}
                                        <td className={`p-3 text-slate-500 text-xs whitespace-nowrap ${isPaid ? 'line-through' : ''}`}>{e.date}</td>
                                        <td className={`p-3 ${isPaid ? 'text-slate-400 line-through' : isRepayment ? 'text-emerald-700' : 'text-slate-700'}`}>
                                            <div className="font-semibold text-xs truncate max-w-[250px]" title={e.description}>
                                                {isRepayment && '‚Ü©Ô∏è '}{e.description}
                                            </div>
                                        </td>
                                        <td className="p-3 text-slate-500 text-xs">{e.account}</td>
                                        <td className={`p-3 text-right font-bold ${isRepayment ? 'text-green-600' : isPaid ? 'text-blue-600' : 'text-slate-900'}`}>
                                            {isRepayment ? '+' : ''}${Math.abs(amount).toFixed(2)}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

// ============== INCOME VS SPEND FLOW (SANKEY) ==============
const IncomeFlowDashboard = ({ expenses, merchantRules, costTypeOverrides = {} }) => {
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const chartRef = React.useRef(null);
    
    // Income categories to look for
    const INCOME_CATEGORIES = ['Income', 'TaxIncome'];
    
    // Income source keywords - checked in ORDER (first match wins)
    const INCOME_KEYWORDS = [
        { name: 'Microsoft', keywords: ['microsoft', 'msft'], color: '#0078d4' },
        { name: 'Salary/Payroll', keywords: ['payroll', 'salary', 'direct deposit', 'paycheck', 'employer', 'wage'], color: '#22c55e' },
        { name: 'Interest & Dividends', keywords: ['interest', 'dividend', 'yield', 'apy', 'capital gain'], color: '#059669' },
        { name: 'Tax Refunds', keywords: ['irs', 'treasury', 'tax refund', 'state tax', 'federal tax'], color: '#10b981' },
        { name: 'Wire/Transfers In', keywords: ['wire in', 'wire deposit', 'incoming wire', 'ach credit', 'external deposit'], color: '#16a34a' },
        { name: 'Reimbursements', keywords: ['reimburse', 'refund', 'rebate', 'cashback', 'cash back', 'credit balance'], color: '#84cc16' },
        { name: 'Gifts/Other', keywords: ['gift', 'bonus', 'award'], color: '#a3e635' }
    ];
    
    // Expense categories to exclude (including Stylecom for flow page)
    const EXCLUDED_FROM_EXPENSES = ['Income', 'TaxIncome', 'Transfer', 'Excluded', 'Venmo', 'Stylecom'];
    
    // Prepare data for 4-STAGE Sankey:
    // Column 1: Income Sources
    // Column 2: Total Budget (aggregator)
    // Column 3: Cost Structure (Fixed, Semi-Fixed, Variable, Savings)
    // Column 4: Expense Categories
    const sankeyData = useMemo(() => {
        const yearExpenses = expenses.filter(e => getY(e.date) === selectedYear);
        
        // Separate income and expenses
        const incomeBySource = {};
        const incomeColors = {};
        const expenseByCategory = {};
        const otherIncomeDetails = [];
        
        yearExpenses.forEach(e => {
            const effective = getEffectiveCategory(e, merchantRules);
            const category = effective.category;
            const amount = Math.abs(safe(e.amount));
            const descLower = (e.description || '').toLowerCase();
            
            if (INCOME_CATEGORIES.includes(category)) {
                // Determine income source type and color
                let sourceType = 'Other Income';
                let sourceColor = '#65a30d'; // Default green for Other
                for (const source of INCOME_KEYWORDS) {
                    if (source.keywords.some(kw => descLower.includes(kw))) {
                        sourceType = source.name;
                        sourceColor = source.color;
                        break;
                    }
                }
                incomeBySource[sourceType] = (incomeBySource[sourceType] || 0) + amount;
                incomeColors[sourceType] = sourceColor;
                
                // Track "Other Income" details
                if (sourceType === 'Other Income') {
                    otherIncomeDetails.push({ date: e.date, description: e.description, amount: amount });
                }
            } else if (!EXCLUDED_FROM_EXPENSES.includes(category) && category !== 'Uncategorized') {
                expenseByCategory[category] = (expenseByCategory[category] || 0) + amount;
            }
        });
        
        // Calculate totals
        const totalIncome = Object.values(incomeBySource).reduce((a, b) => a + b, 0);
        const totalExpenses = Object.values(expenseByCategory).reduce((a, b) => a + b, 0);
        const savings = totalIncome - totalExpenses;
        
        // Group expenses by cost type
        const byCostType = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0 };
        const categoryToCostType = {};
        Object.entries(expenseByCategory).forEach(([cat, amount]) => {
            const costType = getCostType(cat, costTypeOverrides);
            byCostType[costType] += amount;
            categoryToCostType[cat] = costType;
        });
        
        // ========== BUILD 4-STAGE SANKEY ==========
        const nodes = [];
        const nodeIndices = {};
        let nodeIndex = 0;
        
        // COLUMN 1: Income Sources (sorted by amount) - with totals
        const incomeSources = Object.keys(incomeBySource).sort((a, b) => incomeBySource[b] - incomeBySource[a]);
        incomeSources.forEach(source => {
            nodeIndices[`income_${source}`] = nodeIndex++;
            const amt = incomeBySource[source];
            nodes.push({ name: `${source} ($${(amt/1000).toFixed(1)}k)`, color: incomeColors[source] || '#22c55e' });
        });
        
        // COLUMN 2: Total Budget (single aggregator node) - with total
        const budgetIndex = nodeIndex++;
        nodeIndices['budget'] = budgetIndex;
        nodes.push({ name: `Total Budget ($${(totalIncome/1000).toFixed(1)}k)`, color: '#6366f1' }); // Indigo
        
        // COLUMN 3: Cost Structure + Savings (in order: Fixed, Semi-Fixed, Variable, Savings) - ALL with totals
        // Savings is in this column as requested
        if (byCostType.Fixed > 0) {
            nodeIndices['cost_Fixed'] = nodeIndex++;
            nodes.push({ name: `Fixed ($${(byCostType.Fixed/1000).toFixed(1)}k)`, color: COST_TYPE_COLORS.Fixed });
        }
        if (byCostType['Semi-Fixed'] > 0) {
            nodeIndices['cost_Semi-Fixed'] = nodeIndex++;
            nodes.push({ name: `Semi-Fixed ($${(byCostType['Semi-Fixed']/1000).toFixed(1)}k)`, color: COST_TYPE_COLORS['Semi-Fixed'] });
        }
        if (byCostType.Variable > 0) {
            nodeIndices['cost_Variable'] = nodeIndex++;
            nodes.push({ name: `Variable ($${(byCostType.Variable/1000).toFixed(1)}k)`, color: COST_TYPE_COLORS.Variable });
        }
        // Savings is in Column 3 (same level as cost types)
        if (savings > 0) {
            nodeIndices['savings'] = nodeIndex++;
            nodes.push({ name: `üí∞ Savings ($${(savings/1000).toFixed(1)}k)`, color: '#3b82f6' });
        }
        
        // COLUMN 4: Expense Categories (sorted by cost type, then by amount) - with totals
        const sortedCategories = Object.keys(expenseByCategory).sort((a, b) => {
            const typeOrder = { Fixed: 0, 'Semi-Fixed': 1, Variable: 2 };
            const aType = categoryToCostType[a];
            const bType = categoryToCostType[b];
            if (typeOrder[aType] !== typeOrder[bType]) {
                return typeOrder[aType] - typeOrder[bType];
            }
            return expenseByCategory[b] - expenseByCategory[a];
        });
        
        sortedCategories.forEach(cat => {
            nodeIndices[`cat_${cat}`] = nodeIndex++;
            const amt = expenseByCategory[cat];
            nodes.push({ name: `${cat} ($${(amt/1000).toFixed(1)}k)`, color: CAT_COLORS[cat] || '#94a3b8' });
        });
        
        // ========== BUILD LINKS ==========
        const links = [];
        
        // STAGE 1‚Üí2: Income Sources ‚Üí Total Budget
        // Each income source flows to budget with ITS OWN COLOR
        incomeSources.forEach(source => {
            const amount = incomeBySource[source];
            const color = incomeColors[source] || '#22c55e';
            links.push({
                source: nodeIndices[`income_${source}`],
                target: budgetIndex,
                value: amount,
                color: color + '70' // Add transparency
            });
        });
        
        // STAGE 2‚Üí3: Total Budget ‚Üí Cost Structure + Savings
        // Links colored by DESTINATION (cost type color)
        if (byCostType.Fixed > 0) {
            links.push({
                source: budgetIndex,
                target: nodeIndices['cost_Fixed'],
                value: byCostType.Fixed,
                color: COST_TYPE_COLORS.Fixed + '60'
            });
        }
        if (byCostType['Semi-Fixed'] > 0) {
            links.push({
                source: budgetIndex,
                target: nodeIndices['cost_Semi-Fixed'],
                value: byCostType['Semi-Fixed'],
                color: COST_TYPE_COLORS['Semi-Fixed'] + '60'
            });
        }
        if (byCostType.Variable > 0) {
            links.push({
                source: budgetIndex,
                target: nodeIndices['cost_Variable'],
                value: byCostType.Variable,
                color: COST_TYPE_COLORS.Variable + '60'
            });
        }
        if (savings > 0) {
            links.push({
                source: budgetIndex,
                target: nodeIndices['savings'],
                value: savings,
                color: 'rgba(59, 130, 246, 0.5)' // Blue for savings
            });
        }
        
        // STAGE 3‚Üí4: Cost Structure ‚Üí Categories
        sortedCategories.forEach(cat => {
            const costType = categoryToCostType[cat];
            const costTypeKey = `cost_${costType}`;
            if (nodeIndices[costTypeKey] !== undefined) {
                links.push({
                    source: nodeIndices[costTypeKey],
                    target: nodeIndices[`cat_${cat}`],
                    value: expenseByCategory[cat],
                    color: (CAT_COLORS[cat] || '#94a3b8') + '50'
                });
            }
        });
        
        return {
            nodes,
            links,
            totalIncome,
            totalExpenses,
            savings,
            incomeBySource,
            incomeColors,
            expenseByCategory,
            byCostType,
            categoryToCostType,
            otherIncomeDetails: otherIncomeDetails.sort((a, b) => b.amount - a.amount)
        };
    }, [expenses, merchantRules, selectedYear, costTypeOverrides]);
    
    // Render Plotly chart
    useEffect(() => {
        if (!chartRef.current || sankeyData.nodes.length === 0) return;
        
        const data = [{
            type: 'sankey',
            orientation: 'h',
            arrangement: 'snap',
            node: {
                pad: 20,
                thickness: 30,
                line: { color: 'white', width: 2 },
                label: sankeyData.nodes.map(n => n.name),
                color: sankeyData.nodes.map(n => n.color),
                hovertemplate: '%{label}<br>$%{value:,.0f}<extra></extra>'
            },
            link: {
                source: sankeyData.links.map(l => l.source),
                target: sankeyData.links.map(l => l.target),
                value: sankeyData.links.map(l => l.value),
                color: sankeyData.links.map(l => l.color),
                hovertemplate: '%{source.label} ‚Üí %{target.label}<br>$%{value:,.0f}<extra></extra>'
            }
        }];
        
        const layout = {
            font: { family: 'Inter, sans-serif', size: 11 },
            margin: { l: 10, r: 10, t: 40, b: 10 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            annotations: [
                { x: 0, y: 1.06, xref: 'paper', yref: 'paper', text: '<b>Income</b>', showarrow: false, font: { size: 11, color: '#22c55e' } },
                { x: 0.33, y: 1.06, xref: 'paper', yref: 'paper', text: '<b>Budget</b>', showarrow: false, font: { size: 11, color: '#6366f1' } },
                { x: 0.66, y: 1.06, xref: 'paper', yref: 'paper', text: '<b>Cost Type</b>', showarrow: false, font: { size: 11, color: '#64748b' } },
                { x: 1, y: 1.06, xref: 'paper', yref: 'paper', text: '<b>Categories</b>', showarrow: false, font: { size: 11, color: '#64748b' } }
            ]
        };
        
        const config = {
            responsive: true,
            displayModeBar: false
        };
        
        Plotly.newPlot(chartRef.current, data, layout, config);
        
        return () => {
            if (chartRef.current) {
                Plotly.purge(chartRef.current);
            }
        };
    }, [sankeyData]);
    
    // Get available years
    const availableYears = useMemo(() => {
        const years = new Set();
        expenses.forEach(e => {
            const year = getY(e.date);
            if (year >= MIN_YEAR) years.add(year);
        });
        return [...years].sort((a, b) => b - a);
    }, [expenses]);
    
    const hasData = sankeyData.totalIncome > 0 || sankeyData.totalExpenses > 0;
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-6 rounded-2xl flex justify-between items-center">
                <div>
                    <h2 className="text-xl font-black">üí∞ 4-Stage Money Flow</h2>
                    <p className="text-emerald-100 text-sm mt-1">Income ‚Üí Budget ‚Üí Cost Structure ‚Üí Categories</p>
                </div>
                <select 
                    value={selectedYear} 
                    onChange={e => setSelectedYear(Number(e.target.value))}
                    className="bg-white/20 text-white border border-white/30 rounded-xl px-4 py-2 font-bold outline-none">
                    {availableYears.map(y => <option key={y} value={y} className="text-slate-800">{y}</option>)}
                </select>
            </div>
            
            {/* KPI Cards */}
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div className="bg-white p-4 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-600 uppercase">Total Income</h3>
                    <p className="text-xl font-black text-green-600">${(sankeyData.totalIncome/1000).toFixed(1)}k</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border shadow-lg" style={{ borderColor: COST_TYPE_COLORS.Fixed }}>
                    <h3 className="text-[10px] font-bold uppercase" style={{ color: COST_TYPE_COLORS.Fixed }}>Fixed</h3>
                    <p className="text-xl font-black" style={{ color: COST_TYPE_COLORS.Fixed }}>${(sankeyData.byCostType.Fixed/1000).toFixed(1)}k</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border shadow-lg" style={{ borderColor: COST_TYPE_COLORS['Semi-Fixed'] }}>
                    <h3 className="text-[10px] font-bold uppercase" style={{ color: COST_TYPE_COLORS['Semi-Fixed'] }}>Semi-Fixed</h3>
                    <p className="text-xl font-black" style={{ color: COST_TYPE_COLORS['Semi-Fixed'] }}>${(sankeyData.byCostType['Semi-Fixed']/1000).toFixed(1)}k</p>
                </div>
                <div className="bg-white p-4 rounded-2xl border shadow-lg" style={{ borderColor: COST_TYPE_COLORS.Variable }}>
                    <h3 className="text-[10px] font-bold uppercase" style={{ color: COST_TYPE_COLORS.Variable }}>Variable</h3>
                    <p className="text-xl font-black" style={{ color: COST_TYPE_COLORS.Variable }}>${(sankeyData.byCostType.Variable/1000).toFixed(1)}k</p>
                </div>
                <div className={`bg-white p-4 rounded-2xl border shadow-lg ${sankeyData.savings >= 0 ? 'border-blue-300' : 'border-amber-300'}`}>
                    <h3 className={`text-[10px] font-bold uppercase ${sankeyData.savings >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>
                        {sankeyData.savings >= 0 ? 'üí∞ Savings' : 'Deficit'}
                    </h3>
                    <p className={`text-xl font-black ${sankeyData.savings >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>
                        ${(Math.abs(sankeyData.savings)/1000).toFixed(1)}k
                    </p>
                </div>
            </div>
            
            {/* Sankey Chart */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                    <div>
                        <h3 className="text-sm font-black text-slate-800">üìä 4-Stage Money Flow</h3>
                        <p className="text-xs text-slate-500 mt-1">
                            ${(sankeyData.totalIncome/1000).toFixed(1)}k income ‚Üí 
                            ${(sankeyData.totalExpenses/1000).toFixed(1)}k expenses ‚Üí 
                            ${(Math.abs(sankeyData.savings)/1000).toFixed(1)}k {sankeyData.savings >= 0 ? 'saved' : 'deficit'}
                        </p>
                    </div>
                    <div className="text-right text-xs text-slate-400">
                        <div>Savings Rate: <span className={`font-bold ${sankeyData.savings >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>
                            {sankeyData.totalIncome > 0 ? `${(sankeyData.savings / sankeyData.totalIncome * 100).toFixed(1)}%` : 'N/A'}
                        </span></div>
                    </div>
                </div>
                <div className="p-4">
                    {hasData ? (
                        <div ref={chartRef} style={{ width: '100%', height: '550px' }} />
                    ) : (
                        <div className="h-64 flex items-center justify-center text-slate-400">
                            <div className="text-center">
                                <div className="text-4xl mb-2">üìä</div>
                                <p>No income or expense data for {selectedYear}</p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
            
            {/* Breakdown Tables - 3 columns */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Income Sources */}
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-4 border-b border-slate-100 bg-green-50">
                        <h3 className="text-sm font-black text-green-800">üíµ Income Sources</h3>
                        <p className="text-xs text-green-600 mt-0.5">Total: ${sankeyData.totalIncome.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    </div>
                    <div className="p-4 max-h-64 overflow-y-auto">
                        {Object.keys(sankeyData.incomeBySource).length === 0 ? (
                            <p className="text-slate-400 text-center py-4 text-sm">No income recorded</p>
                        ) : (
                            <div className="space-y-2">
                                {Object.entries(sankeyData.incomeBySource)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([source, amount]) => (
                                        <div key={source} className="flex justify-between items-center text-sm">
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 rounded" style={{ backgroundColor: sankeyData.incomeColors[source] || '#22c55e' }} />
                                                <span className="text-slate-700">{source}</span>
                                            </div>
                                            <span className="font-bold" style={{ color: sankeyData.incomeColors[source] || '#22c55e' }}>${(amount/1000).toFixed(1)}k</span>
                                        </div>
                                    ))}
                            </div>
                        )}
                    </div>
                </div>
                
                {/* Cost Structure */}
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-4 border-b border-slate-100 bg-indigo-50">
                        <h3 className="text-sm font-black text-indigo-800">üì¶ Cost Structure</h3>
                        <p className="text-xs text-indigo-600 mt-0.5">Total Expenses: ${sankeyData.totalExpenses.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    </div>
                    <div className="p-4">
                        <div className="space-y-3">
                            {['Fixed', 'Semi-Fixed', 'Variable'].map(type => {
                                const amount = sankeyData.byCostType[type];
                                const pct = sankeyData.totalExpenses > 0 ? (amount / sankeyData.totalExpenses * 100) : 0;
                                return (
                                    <div key={type}>
                                        <div className="flex justify-between items-center text-sm mb-1">
                                            <span className="font-semibold" style={{ color: COST_TYPE_COLORS[type] }}>{type}</span>
                                            <span className="font-bold" style={{ color: COST_TYPE_COLORS[type] }}>${(amount/1000).toFixed(1)}k ({pct.toFixed(0)}%)</span>
                                        </div>
                                        <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div className="h-full rounded-full" style={{ backgroundColor: COST_TYPE_COLORS[type], width: `${pct}%` }} />
                                        </div>
                                    </div>
                                );
                            })}
                            {sankeyData.savings > 0 && (
                                <div className="pt-2 border-t border-slate-100">
                                    <div className="flex justify-between items-center text-sm mb-1">
                                        <span className="font-semibold text-blue-600">üí∞ Savings</span>
                                        <span className="font-bold text-blue-600">${(sankeyData.savings/1000).toFixed(1)}k ({(sankeyData.savings/sankeyData.totalIncome*100).toFixed(0)}%)</span>
                                    </div>
                                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div className="h-full rounded-full bg-blue-500" style={{ width: `${sankeyData.savings/sankeyData.totalIncome*100}%` }} />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                
                {/* Top Categories */}
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-4 border-b border-slate-100 bg-slate-50">
                        <h3 className="text-sm font-black text-slate-800">üè∑Ô∏è Top Categories</h3>
                        <p className="text-xs text-slate-500 mt-0.5">{Object.keys(sankeyData.expenseByCategory).length} categories</p>
                    </div>
                    <div className="p-4 max-h-64 overflow-y-auto">
                        <div className="space-y-2">
                            {Object.entries(sankeyData.expenseByCategory)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 10)
                                .map(([cat, amount]) => (
                                    <div key={cat} className="flex justify-between items-center text-sm">
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full" style={{ backgroundColor: CAT_COLORS[cat] || '#94a3b8' }} />
                                            <span className="text-slate-700">{cat}</span>
                                        </div>
                                        <span className="font-bold" style={{ color: CAT_COLORS[cat] || '#94a3b8' }}>${(amount/1000).toFixed(1)}k</span>
                                    </div>
                                ))}
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Other Income Breakdown Table */}
            {sankeyData.otherIncomeDetails.length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-4 border-b border-slate-100 bg-amber-50">
                        <h3 className="text-sm font-black text-amber-800">‚ùì "Other Income" Breakdown</h3>
                        <p className="text-xs text-amber-600 mt-0.5">
                            {sankeyData.otherIncomeDetails.length} transactions totaling ${(sankeyData.incomeBySource['Other Income'] || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}
                        </p>
                    </div>
                    <div className="overflow-x-auto max-h-64">
                        <table className="w-full text-sm">
                            <thead className="bg-slate-50 sticky top-0">
                                <tr className="text-slate-400 uppercase text-[10px] font-bold">
                                    <th className="p-3 text-left">Date</th>
                                    <th className="p-3 text-left">Description</th>
                                    <th className="p-3 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {sankeyData.otherIncomeDetails.map((item, i) => (
                                    <tr key={i} className="hover:bg-amber-50/50">
                                        <td className="p-3 text-slate-500 text-xs">{item.date}</td>
                                        <td className="p-3 text-slate-700 truncate max-w-[300px]" title={item.description}>{item.description}</td>
                                        <td className="p-3 text-right font-bold text-green-600">${item.amount.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
        </div>
    );
};

// ============== TRANSFER MATCHING ==============
const TransferMatching = ({ expenses, merchantRules }) => {
    const [dateRange, setDateRange] = useState(5); // Days tolerance for matching
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    
    // Categories that represent transfers (Excluded is now empty, all CC payments are Transfer)
    const TRANSFER_CATEGORIES = ['Transfer'];
    
    // Matching algorithm
    const matchingData = useMemo(() => {
        // Filter to selected year and transfer categories
        const transfers = expenses.filter(e => {
            const year = getY(e.date);
            if (year !== selectedYear) return false;
            const cat = getEffectiveCategory(e, merchantRules).category;
            return TRANSFER_CATEGORIES.includes(cat);
        });
        
        // Separate into outflows (negative/sent) and inflows (positive/received)
        // For checking accounts: negative amount = money leaving
        // For credit cards: positive amount = payment received
        const outflows = []; // Money leaving (checking account debits, transfers out)
        const inflows = [];  // Money arriving (credit card payments received)
        
        transfers.forEach(t => {
            const amount = safe(t.amount);
            const rawAmount = t.rawAmount || amount;
            const accountType = t.accountType || 'credit';
            const desc = (t.description || '').toLowerCase();
            
            // Determine if this is an outflow or inflow based on context
            
            // Key insight: "Withdrawal from CHASE CREDIT CRD EPAY" on a debit account
            // means money LEFT the debit account TO PAY the credit card = OUTFLOW
            // The "from" refers to the SOURCE of the payment instruction, not where money came from
            
            if (accountType === 'checking' || accountType === 'debit') {
                // For checking/debit accounts:
                // - "Withdrawal" = money leaving = OUTFLOW (regardless of "from" in description)
                // - "transfer to" / "payment to" = OUTFLOW
                // - "autopay" = OUTFLOW
                // - "Deposit" or "transfer from" (without withdrawal) = money arriving = INFLOW
                
                const isWithdrawal = desc.includes('withdrawal');
                const isDeposit = desc.includes('deposit') && !isWithdrawal;
                const isTransferTo = desc.includes('transfer to') || desc.includes('payment to');
                const isTransferFrom = desc.includes('transfer from') && !isWithdrawal;
                const isAutopay = desc.includes('autopay') || desc.includes('auto pay');
                
                if (isWithdrawal || isTransferTo || isAutopay || rawAmount < 0) {
                    // Money leaving the account
                    outflows.push({ ...t, matchAmount: Math.abs(amount) });
                } else if (isDeposit || isTransferFrom || rawAmount > 0) {
                    // Money arriving to the account
                    inflows.push({ ...t, matchAmount: Math.abs(amount) });
                } else {
                    // Default: treat as outflow (most transfers from checking are payments out)
                    outflows.push({ ...t, matchAmount: Math.abs(amount) });
                }
            } else {
                // Credit card accounts: transfers are typically payments received (inflows)
                // These are the "AUTOPAY PAYMENT - THANK YOU" type transactions
                inflows.push({ ...t, matchAmount: Math.abs(amount) });
            }
        });
        
        // Sort by date
        outflows.sort((a, b) => new Date(a.date) - new Date(b.date));
        inflows.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Matching algorithm
        const matched = [];
        const usedInflowIds = new Set();
        const unmatchedOutflows = [];
        
        outflows.forEach(outflow => {
            const outDate = new Date(outflow.date);
            let bestMatch = null;
            let bestDaysDiff = Infinity;
            
            // Find best matching inflow
            for (const inflow of inflows) {
                if (usedInflowIds.has(inflow.id)) continue;
                
                // Check amount match (exact)
                if (Math.abs(outflow.matchAmount - inflow.matchAmount) > 0.01) continue;
                
                // Check date range (inflow should be same day or after outflow)
                const inDate = new Date(inflow.date);
                const daysDiff = Math.floor((inDate - outDate) / (1000 * 60 * 60 * 24));
                
                // Allow for some flexibility - inflow can be before or after within range
                if (Math.abs(daysDiff) <= dateRange) {
                    if (Math.abs(daysDiff) < Math.abs(bestDaysDiff)) {
                        bestMatch = inflow;
                        bestDaysDiff = daysDiff;
                    }
                }
            }
            
            if (bestMatch) {
                usedInflowIds.add(bestMatch.id);
                matched.push({
                    outflow,
                    inflow: bestMatch,
                    amount: outflow.matchAmount,
                    daysDiff: bestDaysDiff
                });
            } else {
                unmatchedOutflows.push(outflow);
            }
        });
        
        // Find unmatched inflows
        const unmatchedInflows = inflows.filter(i => !usedInflowIds.has(i.id));
        
        // Calculate totals
        const totalMatched = matched.reduce((sum, m) => sum + m.amount, 0);
        const totalUnmatchedOut = unmatchedOutflows.reduce((sum, t) => sum + Math.abs(safe(t.amount)), 0);
        const totalUnmatchedIn = unmatchedInflows.reduce((sum, t) => sum + Math.abs(safe(t.amount)), 0);
        
        return {
            matched,
            unmatchedOutflows,
            unmatchedInflows,
            totalMatched,
            totalUnmatchedOut,
            totalUnmatchedIn,
            outflowCount: outflows.length,
            inflowCount: inflows.length
        };
    }, [expenses, merchantRules, selectedYear, dateRange]);
    
    // Get available years
    const availableYears = useMemo(() => {
        const years = new Set();
        expenses.forEach(e => {
            const year = getY(e.date);
            if (year >= MIN_YEAR) years.add(year);
        });
        return [...years].sort((a, b) => b - a);
    }, [expenses]);
    
    const matchRate = matchingData.outflowCount > 0 
        ? ((matchingData.matched.length / matchingData.outflowCount) * 100).toFixed(0) 
        : 0;
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-violet-500 to-purple-600 text-white p-6 rounded-2xl flex justify-between items-center">
                <div>
                    <h2 className="text-xl font-black">üîÑ Transfer Matching</h2>
                    <p className="text-violet-100 text-sm mt-1">Verify internal transfers between accounts</p>
                </div>
                <div className="flex gap-3">
                    <div>
                        <label className="text-[10px] text-violet-200 block mb-1">Year</label>
                        <select 
                            value={selectedYear} 
                            onChange={e => setSelectedYear(Number(e.target.value))}
                            className="bg-white/20 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm font-bold outline-none">
                            {availableYears.map(y => <option key={y} value={y} className="text-slate-800">{y}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="text-[10px] text-violet-200 block mb-1">Date Tolerance</label>
                        <select 
                            value={dateRange} 
                            onChange={e => setDateRange(Number(e.target.value))}
                            className="bg-white/20 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm font-bold outline-none">
                            {[1,2,3,5,7,10,14,30].map(d => <option key={d} value={d} className="text-slate-800">¬±{d} days</option>)}
                        </select>
                    </div>
                </div>
            </div>
            
            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-green-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-green-600 uppercase">‚úì Matched Volume</h3>
                    <p className="text-2xl font-black text-green-600">${matchingData.totalMatched.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                    <p className="text-xs text-green-500 mt-1">{matchingData.matched.length} pairs found</p>
                </div>
                <div className={`bg-white p-5 rounded-2xl border shadow-lg ${matchingData.unmatchedOutflows.length > 0 ? 'border-red-300' : 'border-slate-100'}`}>
                    <h3 className={`text-[10px] font-bold uppercase ${matchingData.unmatchedOutflows.length > 0 ? 'text-red-600' : 'text-slate-400'}`}>
                        ‚ö†Ô∏è Unmatched Outflows
                    </h3>
                    <p className={`text-2xl font-black ${matchingData.unmatchedOutflows.length > 0 ? 'text-red-600' : 'text-slate-400'}`}>
                        ${matchingData.totalUnmatchedOut.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">{matchingData.unmatchedOutflows.length} orphaned</p>
                </div>
                <div className={`bg-white p-5 rounded-2xl border shadow-lg ${matchingData.unmatchedInflows.length > 0 ? 'border-amber-300' : 'border-slate-100'}`}>
                    <h3 className={`text-[10px] font-bold uppercase ${matchingData.unmatchedInflows.length > 0 ? 'text-amber-600' : 'text-slate-400'}`}>
                        ‚ö†Ô∏è Unmatched Inflows
                    </h3>
                    <p className={`text-2xl font-black ${matchingData.unmatchedInflows.length > 0 ? 'text-amber-600' : 'text-slate-400'}`}>
                        ${matchingData.totalUnmatchedIn.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">{matchingData.unmatchedInflows.length} orphaned</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Match Rate</h3>
                    <p className="text-2xl font-black text-indigo-600">{matchRate}%</p>
                    <div className="h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden">
                        <div className="h-full bg-indigo-500 rounded-full" style={{ width: `${matchRate}%` }}/>
                    </div>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Transfers</h3>
                    <p className="text-2xl font-black text-slate-700">{matchingData.outflowCount + matchingData.inflowCount}</p>
                    <p className="text-xs text-slate-500 mt-1">{matchingData.outflowCount} out / {matchingData.inflowCount} in</p>
                </div>
            </div>
            
            {/* Matched Pairs Table */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 bg-green-50">
                    <h3 className="text-sm font-black text-green-800">‚úì Matched Transfer Pairs ({matchingData.matched.length})</h3>
                </div>
                <div className="overflow-x-auto max-h-96">
                    <table className="w-full text-sm">
                        <thead className="bg-slate-50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                            <tr>
                                <th className="p-3 text-left">Date Sent</th>
                                <th className="p-3 text-left">From Account</th>
                                <th className="p-3 text-left">Description</th>
                                <th className="p-3 text-right">Amount</th>
                                <th className="p-3 text-center">‚Üí</th>
                                <th className="p-3 text-left">Date Received</th>
                                <th className="p-3 text-left">To Account</th>
                                <th className="p-3 text-center">Days Œî</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {matchingData.matched.length === 0 ? (
                                <tr><td colSpan={8} className="p-8 text-center text-slate-400">No matched pairs found</td></tr>
                            ) : matchingData.matched.map((pair, i) => (
                                <tr key={i} className="hover:bg-green-50/50">
                                    <td className="p-3 text-slate-600 whitespace-nowrap">{pair.outflow.date}</td>
                                    <td className="p-3 text-slate-700 font-semibold text-xs">{pair.outflow.account}</td>
                                    <td className="p-3 text-slate-500 text-xs truncate max-w-[150px]" title={pair.outflow.description}>{pair.outflow.description}</td>
                                    <td className="p-3 text-right font-bold text-green-600">${pair.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                    <td className="p-3 text-center text-green-500 font-bold">‚Üí</td>
                                    <td className="p-3 text-slate-600 whitespace-nowrap">{pair.inflow.date}</td>
                                    <td className="p-3 text-slate-700 font-semibold text-xs">{pair.inflow.account}</td>
                                    <td className="p-3 text-center">
                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                            pair.daysDiff === 0 ? 'bg-green-100 text-green-700' :
                                            Math.abs(pair.daysDiff) <= 2 ? 'bg-blue-100 text-blue-700' :
                                            'bg-amber-100 text-amber-700'
                                        }`}>
                                            {pair.daysDiff === 0 ? 'Same day' : `${pair.daysDiff > 0 ? '+' : ''}${pair.daysDiff}d`}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {/* Unmatched Outflows */}
            {matchingData.unmatchedOutflows.length > 0 && (
                <div className="bg-white rounded-2xl border border-red-200 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-red-100 bg-red-50">
                        <h3 className="text-sm font-black text-red-800">‚ö†Ô∏è Unmatched Outflows ({matchingData.unmatchedOutflows.length})</h3>
                        <p className="text-xs text-red-600 mt-1">Money left these accounts but no matching inflow found</p>
                    </div>
                    <div className="overflow-x-auto max-h-64">
                        <table className="w-full text-sm">
                            <thead className="bg-red-50/50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                                <tr>
                                    <th className="p-3 text-left">Date</th>
                                    <th className="p-3 text-left">Account</th>
                                    <th className="p-3 text-left">Description</th>
                                    <th className="p-3 text-right">Amount</th>
                                    <th className="p-3 text-left">Possible Issue</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {matchingData.unmatchedOutflows.map(t => (
                                    <tr key={t.id} className="hover:bg-red-50/50">
                                        <td className="p-3 text-slate-600 whitespace-nowrap">{t.date}</td>
                                        <td className="p-3 text-slate-700 font-semibold text-xs">{t.account}</td>
                                        <td className="p-3 text-slate-500 text-xs truncate max-w-[200px]" title={t.description}>{t.description}</td>
                                        <td className="p-3 text-right font-bold text-red-600">${Math.abs(safe(t.amount)).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                        <td className="p-3 text-xs text-slate-500">
                                            {t.description?.toLowerCase().includes('atm') ? 'üèß ATM withdrawal' :
                                             t.description?.toLowerCase().includes('fee') ? 'üí∞ Bank fee' :
                                             '‚ùì No matching inflow found'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {/* Unmatched Inflows */}
            {matchingData.unmatchedInflows.length > 0 && (
                <div className="bg-white rounded-2xl border border-amber-200 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-amber-100 bg-amber-50">
                        <h3 className="text-sm font-black text-amber-800">‚ö†Ô∏è Unmatched Inflows ({matchingData.unmatchedInflows.length})</h3>
                        <p className="text-xs text-amber-600 mt-1">Payments received but no matching outflow found</p>
                    </div>
                    <div className="overflow-x-auto max-h-64">
                        <table className="w-full text-sm">
                            <thead className="bg-amber-50/50 text-slate-400 uppercase text-[10px] font-bold sticky top-0">
                                <tr>
                                    <th className="p-3 text-left">Date</th>
                                    <th className="p-3 text-left">Account</th>
                                    <th className="p-3 text-left">Description</th>
                                    <th className="p-3 text-right">Amount</th>
                                    <th className="p-3 text-left">Possible Issue</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {matchingData.unmatchedInflows.map(t => (
                                    <tr key={t.id} className="hover:bg-amber-50/50">
                                        <td className="p-3 text-slate-600 whitespace-nowrap">{t.date}</td>
                                        <td className="p-3 text-slate-700 font-semibold text-xs">{t.account}</td>
                                        <td className="p-3 text-slate-500 text-xs truncate max-w-[200px]" title={t.description}>{t.description}</td>
                                        <td className="p-3 text-right font-bold text-amber-600">${Math.abs(safe(t.amount)).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                        <td className="p-3 text-xs text-slate-500">
                                            {t.description?.toLowerCase().includes('refund') ? '‚Ü©Ô∏è Possible refund' :
                                             t.description?.toLowerCase().includes('credit') ? 'üí≥ Statement credit' :
                                             '‚ùì No matching outflow found'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {/* Help Section */}
            <div className="bg-slate-50 border border-slate-200 rounded-2xl p-5">
                <h3 className="font-bold text-slate-700 mb-2">üìñ How Transfer Matching Works</h3>
                <div className="text-sm text-slate-600 space-y-2">
                    <p><strong>Outflows:</strong> Transactions categorized as "Transfer" or "Excluded" where money left a checking account (negative amounts, or descriptions like "transfer to", "payment to")</p>
                    <p><strong>Inflows:</strong> Transactions on credit cards categorized as "Transfer" (payments received)</p>
                    <p><strong>Matching:</strong> Pairs are matched by exact amount and date within ¬±{dateRange} days</p>
                    <p><strong>Red Flags:</strong></p>
                    <ul className="list-disc list-inside ml-4 text-slate-500">
                        <li><span className="text-red-600">Unmatched Outflows</span> - Money left but didn't arrive (wrong category? missing import?)</li>
                        <li><span className="text-amber-600">Unmatched Inflows</span> - Payment arrived but can't find source (external payment? wrong date range?)</li>
                    </ul>
                </div>
            </div>
        </div>
    );
};

// ============== EXPORT RULES (DEVELOPER MODE) ==============
const ExportRules = ({ merchantRules, expenses }) => {
    const [copied, setCopied] = useState(false);
    const [exportType, setExportType] = useState('all'); // 'all', 'global', 'accounts'
    
    // Generate statistics about rules
    const ruleStats = useMemo(() => {
        const globalRules = {};
        const accountRules = {};
        
        Object.entries(merchantRules).forEach(([key, value]) => {
            if (key.includes('|||')) {
                // Account-specific rule
                const merchant = key.split('|||')[0];
                if (value.scope === 'accounts' && value.accounts) {
                    accountRules[key] = { merchant, category: value.category, accounts: value.accounts };
                } else if (value.account) {
                    // Legacy single account
                    accountRules[key] = { merchant, category: value.category, accounts: [value.account] };
                }
            } else if (value.scope === 'global') {
                globalRules[key] = value.category;
            }
        });
        
        return { globalRules, accountRules, totalRules: Object.keys(merchantRules).length };
    }, [merchantRules]);
    
    // Generate the code snippet for AUTO_RULES additions
    const generateAutoRulesCode = () => {
        const lines = [];
        lines.push('// ========== NEW AUTO_RULES KEYWORDS ==========');
        lines.push('// Copy these keywords into the appropriate category in AUTO_RULES');
        lines.push('');
        
        // Group by category
        const byCategory = {};
        Object.entries(ruleStats.globalRules).forEach(([merchant, category]) => {
            if (!byCategory[category]) byCategory[category] = [];
            // Convert merchant name to a keyword (lowercase, simplified)
            const keyword = merchant.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
            if (keyword) byCategory[category].push(keyword);
        });
        
        Object.entries(byCategory).sort((a, b) => a[0].localeCompare(b[0])).forEach(([cat, keywords]) => {
            lines.push(`// ${cat}:`);
            keywords.forEach(kw => {
                lines.push(`'${kw}',`);
            });
            lines.push('');
        });
        
        return lines.join('\n');
    };
    
    // Generate the code snippet for merchantRules (full export)
    const generateMerchantRulesCode = () => {
        const lines = [];
        lines.push('// ========== MERCHANT RULES EXPORT ==========');
        lines.push('// Paste this into localStorage or use to initialize merchantRules');
        lines.push('');
        lines.push('const SAVED_MERCHANT_RULES = {');
        
        // Global rules
        Object.entries(ruleStats.globalRules).sort((a, b) => a[0].localeCompare(b[0])).forEach(([merchant, category]) => {
            const escapedMerchant = merchant.replace(/'/g, "\\'");
            lines.push(`    '${escapedMerchant}': { category: '${category}', scope: 'global' },`);
        });
        
        // Account-specific rules
        Object.entries(ruleStats.accountRules).sort((a, b) => a[0].localeCompare(b[0])).forEach(([key, rule]) => {
            const escapedKey = key.replace(/'/g, "\\'");
            const accountsStr = JSON.stringify(rule.accounts);
            lines.push(`    '${escapedKey}': { category: '${rule.category}', scope: 'accounts', accounts: ${accountsStr} },`);
        });
        
        lines.push('};');
        
        return lines.join('\n');
    };
    
    // Generate PRIORITY_RULES additions
    const generatePriorityRulesCode = () => {
        const lines = [];
        lines.push('// ========== SUGGESTED PRIORITY_RULES ADDITIONS ==========');
        lines.push('// Add these to PRIORITY_RULES if you want them to override CC payoff detection');
        lines.push('');
        lines.push('const NEW_PRIORITY_RULES = {');
        
        Object.entries(ruleStats.globalRules).sort((a, b) => a[0].localeCompare(b[0])).forEach(([merchant, category]) => {
            const keyword = merchant.toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
            if (keyword) {
                lines.push(`    // ${category}: ['${keyword}'],`);
            }
        });
        
        lines.push('};');
        
        return lines.join('\n');
    };
    
    // Combined export
    const generateFullExport = () => {
        const sections = [];
        sections.push('// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        sections.push('// EXPENSE TRACKER - RULES EXPORT');
        sections.push(`// Generated: ${new Date().toISOString()}`);
        sections.push(`// Total Rules: ${ruleStats.totalRules}`);
        sections.push(`// Global Rules: ${Object.keys(ruleStats.globalRules).length}`);
        sections.push(`// Account Rules: ${Object.keys(ruleStats.accountRules).length}`);
        sections.push('// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        sections.push('');
        sections.push(generateAutoRulesCode());
        sections.push('');
        sections.push(generateMerchantRulesCode());
        sections.push('');
        sections.push(generatePriorityRulesCode());
        
        return sections.join('\n');
    };
    
    const getExportContent = () => {
        switch (exportType) {
            case 'auto': return generateAutoRulesCode();
            case 'merchant': return generateMerchantRulesCode();
            case 'priority': return generatePriorityRulesCode();
            default: return generateFullExport();
        }
    };
    
    const copyToClipboard = () => {
        navigator.clipboard.writeText(getExportContent());
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };
    
    const downloadAsFile = () => {
        const content = getExportContent();
        const blob = new Blob([content], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `expense-rules-${new Date().toISOString().split('T')[0]}.js`;
        a.click();
        URL.revokeObjectURL(url);
    };
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-slate-700 to-slate-900 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black">üõ†Ô∏è Export Rules (Developer Mode)</h2>
                <p className="text-slate-300 text-sm mt-1">Export your categorization rules to hardcode into the source</p>
            </div>
            
            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase">Total Rules</h3>
                    <p className="text-3xl font-black text-slate-900">{ruleStats.totalRules}</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-purple-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-purple-600 uppercase">üåç Global Rules</h3>
                    <p className="text-3xl font-black text-purple-600">{Object.keys(ruleStats.globalRules).length}</p>
                    <p className="text-xs text-slate-500 mt-1">Apply to all accounts</p>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-cyan-200 shadow-lg">
                    <h3 className="text-[10px] font-bold text-cyan-600 uppercase">üí≥ Account Rules</h3>
                    <p className="text-3xl font-black text-cyan-600">{Object.keys(ruleStats.accountRules).length}</p>
                    <p className="text-xs text-slate-500 mt-1">Account-specific overrides</p>
                </div>
            </div>
            
            {/* Export Type Selector */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100">
                    <h3 className="text-sm font-black text-slate-800">üì¶ Export Type</h3>
                </div>
                <div className="p-4">
                    <div className="flex flex-wrap gap-2">
                        {[
                            { key: 'all', label: 'üìã Full Export', desc: 'Everything' },
                            { key: 'auto', label: 'üî§ AUTO_RULES', desc: 'Keywords only' },
                            { key: 'merchant', label: 'üè™ Merchant Rules', desc: 'JSON format' },
                            { key: 'priority', label: '‚ö° PRIORITY_RULES', desc: 'Hard overrides' }
                        ].map(opt => (
                            <button 
                                key={opt.key}
                                onClick={() => setExportType(opt.key)}
                                className={`px-4 py-2 rounded-xl text-sm font-bold transition-all ${
                                    exportType === opt.key 
                                        ? 'bg-indigo-600 text-white' 
                                        : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                }`}>
                                {opt.label}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
            
            {/* Code Output */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 className="text-sm font-black text-slate-800">üìù Generated Code</h3>
                    <div className="flex gap-2">
                        <button 
                            onClick={downloadAsFile}
                            className="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200">
                            üíæ Download
                        </button>
                        <button 
                            onClick={copyToClipboard}
                            className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${
                                copied 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-indigo-600 text-white hover:bg-indigo-700'
                            }`}>
                            {copied ? '‚úì Copied!' : 'üìã Copy to Clipboard'}
                        </button>
                    </div>
                </div>
                <div className="p-4">
                    <pre className="bg-slate-900 text-green-400 p-4 rounded-xl text-xs overflow-auto max-h-96 font-mono whitespace-pre-wrap">
                        {getExportContent()}
                    </pre>
                </div>
            </div>
            
            {/* Instructions */}
            <div className="bg-amber-50 border border-amber-200 rounded-2xl p-5">
                <h3 className="font-bold text-amber-800 mb-2">üìñ How to Use This Export</h3>
                <ol className="text-sm text-amber-700 space-y-2 list-decimal list-inside">
                    <li>Categorize transactions in the <strong>Categories</strong> page</li>
                    <li>Come here and click <strong>"Copy to Clipboard"</strong></li>
                    <li>Paste the code into a chat with Claude and say: <em>"Add these to my expense tracker rules"</em></li>
                    <li>Claude will update your source code with the new rules</li>
                    <li>Push to GitHub and your rules are saved permanently!</li>
                </ol>
            </div>
            
            {/* Rules Preview */}
            {Object.keys(ruleStats.globalRules).length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100">
                        <h3 className="text-sm font-black text-slate-800">üåç Global Rules Preview</h3>
                    </div>
                    <div className="p-4 max-h-64 overflow-y-auto">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            {Object.entries(ruleStats.globalRules).sort((a, b) => a[0].localeCompare(b[0])).map(([merchant, category]) => (
                                <div key={merchant} className="flex items-center gap-2 p-2 bg-slate-50 rounded-lg">
                                    <span className="text-xs font-semibold text-slate-600 truncate flex-1" title={merchant}>{merchant}</span>
                                    <span className="text-[10px] font-bold text-white px-2 py-0.5 rounded" style={{ backgroundColor: CAT_COLORS[category] || '#6366f1' }}>
                                        {category}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
            
            {/* Account Rules Preview */}
            {Object.keys(ruleStats.accountRules).length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100">
                        <h3 className="text-sm font-black text-slate-800">üí≥ Account-Specific Rules Preview</h3>
                    </div>
                    <div className="p-4 max-h-64 overflow-y-auto">
                        <div className="space-y-2">
                            {Object.entries(ruleStats.accountRules).sort((a, b) => a[0].localeCompare(b[0])).map(([key, rule]) => (
                                <div key={key} className="flex items-center gap-2 p-2 bg-cyan-50 rounded-lg">
                                    <span className="text-xs font-semibold text-slate-600 truncate" style={{maxWidth: '150px'}} title={rule.merchant}>{rule.merchant}</span>
                                    <span className="text-[9px] text-slate-400 truncate" style={{maxWidth: '150px'}} title={rule.accounts.join(', ')}>
                                        ({rule.accounts.length > 1 ? `${rule.accounts.length} accounts` : rule.accounts[0]})
                                    </span>
                                    <span className="text-[10px] font-bold text-white px-2 py-0.5 rounded ml-auto" style={{ backgroundColor: CAT_COLORS[rule.category] || '#6366f1' }}>
                                        {rule.category}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

// ============== AI ANALYST EXPORT ==============
const AIAnalystExport = ({ expenses, merchantRules }) => {
    const [report, setReport] = useState('');
    const [copied, setCopied] = useState(false);
    const [generating, setGenerating] = useState(false);
    
    const generateReport = () => {
        setGenerating(true);
        
        // Small delay for UX feedback
        setTimeout(() => {
            const lines = [];
            const now = new Date();
            
            // Helper to format currency
            const fmt = (n) => '$' + n.toLocaleString(undefined, { maximumFractionDigits: 0 });
            const fmtPct = (n) => n.toFixed(1) + '%';
            
            // Filter to 2024 and 2025 only
            const validYears = [2024, 2025];
            
            // Filter valid expenses (exclude transfers, income for spending analysis)
            const allExpenses = expenses.filter(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const year = getY(e.date);
                return !EXCLUDED_CATEGORIES.includes(cat) && validYears.includes(year);
            });
            
            const incomeExpenses = expenses.filter(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const year = getY(e.date);
                return (cat === 'Income' || cat === 'TaxIncome') && validYears.includes(year);
            });
            
            // Separate by year
            const exp2024 = allExpenses.filter(e => getY(e.date) === 2024);
            const exp2025 = allExpenses.filter(e => getY(e.date) === 2025);
            const total2024 = exp2024.reduce((s, e) => s + safe(e.amount), 0);
            const total2025 = exp2025.reduce((s, e) => s + safe(e.amount), 0);
            
            // === HEADER ===
            lines.push('# üìä Personal Finance Report (2024-2025)');
            lines.push('');
            lines.push(`**Generated:** ${now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`);
            lines.push(`**Focus Period:** 2024-2025 (with emphasis on 2025 insights)`);
            lines.push(`**Total Transactions Analyzed:** ${allExpenses.length.toLocaleString()}`);
            lines.push('');
            lines.push('---');
            lines.push('');
            
            // === ANNUAL COMPARISON ===
            lines.push('## üìÖ 2024 vs 2025 Overview');
            lines.push('');
            lines.push('| Metric | 2024 | 2025 | Change |');
            lines.push('|--------|------|------|--------|');
            
            const months2024 = new Set(exp2024.map(e => getM(e.date))).size || 1;
            const months2025 = new Set(exp2025.map(e => getM(e.date))).size || 1;
            const monthlyAvg2024 = total2024 / months2024;
            const monthlyAvg2025 = total2025 / months2025;
            const yoyChange = total2024 > 0 ? ((total2025 - total2024) / total2024) * 100 : 0;
            const monthlyChange = monthlyAvg2024 > 0 ? ((monthlyAvg2025 - monthlyAvg2024) / monthlyAvg2024) * 100 : 0;
            
            lines.push(`| Total Spending | ${fmt(total2024)} | ${fmt(total2025)} | ${yoyChange >= 0 ? '+' : ''}${fmtPct(yoyChange)} |`);
            lines.push(`| Transactions | ${exp2024.length} | ${exp2025.length} | ${exp2025.length - exp2024.length >= 0 ? '+' : ''}${exp2025.length - exp2024.length} |`);
            lines.push(`| Monthly Average | ${fmt(monthlyAvg2024)} | ${fmt(monthlyAvg2025)} | ${monthlyChange >= 0 ? '+' : ''}${fmtPct(monthlyChange)} |`);
            lines.push(`| Avg Transaction | ${fmt(exp2024.length > 0 ? total2024/exp2024.length : 0)} | ${fmt(exp2025.length > 0 ? total2025/exp2025.length : 0)} | |`);
            lines.push('');
            
            // === COST STRUCTURE ANALYSIS (2025 Focus) ===
            lines.push('## üì¶ 2025 Cost Structure Analysis');
            lines.push('');
            lines.push('*Expenses are categorized into three cost types for budgeting analysis:*');
            lines.push('- **Fixed:** Mandatory expenses (Rent, Daycare)');
            lines.push('- **Semi-Fixed:** Necessary but variable (Household, Groceries)');
            lines.push('- **Variable:** Discretionary spending (all other categories)');
            lines.push('');
            
            // Calculate cost structure for 2025
            const costStructure2025 = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0 };
            exp2025.forEach(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const costType = getCostType(cat);
                costStructure2025[costType] += safe(e.amount);
            });
            
            const costStructure2024 = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0 };
            exp2024.forEach(e => {
                const cat = getEffectiveCategory(e, merchantRules).category;
                const costType = getCostType(cat);
                costStructure2024[costType] += safe(e.amount);
            });
            
            lines.push('| Cost Type | 2024 | 2025 | % of 2025 | YoY Change |');
            lines.push('|-----------|------|------|-----------|------------|');
            ['Fixed', 'Semi-Fixed', 'Variable'].forEach(type => {
                const val2024 = costStructure2024[type];
                const val2025 = costStructure2025[type];
                const pct2025 = total2025 > 0 ? (val2025 / total2025) * 100 : 0;
                const change = val2024 > 0 ? ((val2025 - val2024) / val2024) * 100 : 0;
                lines.push(`| **${type}** | ${fmt(val2024)} | ${fmt(val2025)} | ${fmtPct(pct2025)} | ${change >= 0 ? '+' : ''}${fmtPct(change)} |`);
            });
            lines.push(`| **TOTAL** | ${fmt(total2024)} | ${fmt(total2025)} | 100% | ${yoyChange >= 0 ? '+' : ''}${fmtPct(yoyChange)} |`);
            lines.push('');
            
            // Cost structure insight
            const fixedPct = total2025 > 0 ? (costStructure2025.Fixed / total2025) * 100 : 0;
            const semiFixedPct = total2025 > 0 ? (costStructure2025['Semi-Fixed'] / total2025) * 100 : 0;
            const variablePct = total2025 > 0 ? (costStructure2025.Variable / total2025) * 100 : 0;
            
            lines.push('### üîç Cost Structure Insights');
            lines.push(`- **${fmtPct(fixedPct + semiFixedPct)}** of spending is Fixed or Semi-Fixed (committed costs)`);
            lines.push(`- **${fmtPct(variablePct)}** is Variable (discretionary - potential savings area)`);
            if (variablePct > 50) {
                lines.push(`- ‚ö†Ô∏è Variable spending is over 50% - high discretionary spending`);
            }
            if (fixedPct > 40) {
                lines.push(`- ‚ö†Ô∏è Fixed costs are over 40% - limited budget flexibility`);
            }
            lines.push('');
            
            // === MONTHLY COST STRUCTURE (2025) ===
            lines.push('## üìà 2025 Monthly Cost Structure');
            lines.push('');
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyCostStructure = {};
            
            exp2025.forEach(e => {
                const month = getM(e.date);
                const cat = getEffectiveCategory(e, merchantRules).category;
                const costType = getCostType(cat);
                if (!monthlyCostStructure[month]) {
                    monthlyCostStructure[month] = { Fixed: 0, 'Semi-Fixed': 0, Variable: 0, total: 0 };
                }
                monthlyCostStructure[month][costType] += safe(e.amount);
                monthlyCostStructure[month].total += safe(e.amount);
            });
            
            lines.push('| Month | Fixed | Semi-Fixed | Variable | Total |');
            lines.push('|-------|-------|------------|----------|-------|');
            for (let m = 0; m < 12; m++) {
                if (monthlyCostStructure[m]) {
                    const mc = monthlyCostStructure[m];
                    lines.push(`| ${monthNames[m]} | ${fmt(mc.Fixed)} | ${fmt(mc['Semi-Fixed'])} | ${fmt(mc.Variable)} | ${fmt(mc.total)} |`);
                }
            }
            lines.push('');
            
            // Monthly stats
            const monthlyTotals = Object.values(monthlyCostStructure).map(m => m.total);
            if (monthlyTotals.length > 0) {
                const avgMonthly = monthlyTotals.reduce((a, b) => a + b, 0) / monthlyTotals.length;
                const maxMonthVal = Math.max(...monthlyTotals);
                const minMonthVal = Math.min(...monthlyTotals);
                const maxMonthIdx = Object.entries(monthlyCostStructure).find(([k, v]) => v.total === maxMonthVal)?.[0];
                const minMonthIdx = Object.entries(monthlyCostStructure).find(([k, v]) => v.total === minMonthVal)?.[0];
                
                lines.push(`- **Average Monthly:** ${fmt(avgMonthly)}`);
                lines.push(`- **Highest:** ${monthNames[maxMonthIdx]} (${fmt(maxMonthVal)})`);
                lines.push(`- **Lowest:** ${monthNames[minMonthIdx]} (${fmt(minMonthVal)})`);
                lines.push(`- **Variance:** ${fmt(maxMonthVal - minMonthVal)} spread`);
                lines.push('');
            }
            
            // === 2025 CATEGORY BREAKDOWN ===
            if (exp2025.length > 0) {
                lines.push('## üè∑Ô∏è 2025 Spending by Category');
                lines.push('');
                
                const byCategory = {};
                exp2025.forEach(e => {
                    const cat = getEffectiveCategory(e, merchantRules).category;
                    if (!byCategory[cat]) byCategory[cat] = { total: 0, count: 0 };
                    byCategory[cat].total += safe(e.amount);
                    byCategory[cat].count += 1;
                });
                
                // Also get 2024 for comparison
                const byCategory2024 = {};
                exp2024.forEach(e => {
                    const cat = getEffectiveCategory(e, merchantRules).category;
                    if (!byCategory2024[cat]) byCategory2024[cat] = { total: 0 };
                    byCategory2024[cat].total += safe(e.amount);
                });
                
                const sortedCats = Object.entries(byCategory)
                    .map(([cat, data]) => ({ 
                        cat, 
                        ...data, 
                        pct: (data.total / total2025) * 100,
                        costType: getCostType(cat),
                        prev: byCategory2024[cat]?.total || 0
                    }))
                    .sort((a, b) => b.total - a.total);
                
                lines.push('| Category | Cost Type | 2025 Amount | % of Total | vs 2024 |');
                lines.push('|----------|-----------|-------------|------------|---------|');
                sortedCats.forEach(({ cat, costType, total, pct, prev }) => {
                    const change = prev > 0 ? ((total - prev) / prev) * 100 : 0;
                    const changeStr = prev > 0 ? `${change >= 0 ? '+' : ''}${fmtPct(change)}` : 'New';
                    lines.push(`| ${cat} | ${costType} | ${fmt(total)} | ${fmtPct(pct)} | ${changeStr} |`);
                });
                lines.push(`| **TOTAL** | | **${fmt(total2025)}** | **100%** | |`);
                lines.push('');
            }
            
            // === INCOME VS EXPENSES (2025) ===
            const income2025 = incomeExpenses.filter(e => getY(e.date) === 2025);
            const totalIncome2025 = income2025.reduce((s, e) => s + Math.abs(safe(e.amount)), 0);
            
            if (totalIncome2025 > 0 && total2025 > 0) {
                lines.push('## üí∞ 2025 Income vs Expenses');
                lines.push('');
                lines.push('| Metric | Amount |');
                lines.push('|--------|--------|');
                lines.push(`| Total Income | ${fmt(totalIncome2025)} |`);
                lines.push(`| Total Expenses | ${fmt(total2025)} |`);
                lines.push(`| **Net Savings** | **${fmt(totalIncome2025 - total2025)}** |`);
                lines.push(`| Savings Rate | ${fmtPct(((totalIncome2025 - total2025) / totalIncome2025) * 100)} |`);
                lines.push(`| Fixed Cost Ratio | ${fmtPct((costStructure2025.Fixed / totalIncome2025) * 100)} of income |`);
                lines.push(`| Committed Cost Ratio | ${fmtPct(((costStructure2025.Fixed + costStructure2025['Semi-Fixed']) / totalIncome2025) * 100)} of income |`);
                lines.push('');
            }
            
            // === TOP MERCHANTS (2025) ===
            if (exp2025.length > 0) {
                lines.push('## üè™ 2025 Top 10 Spending Areas');
                lines.push('');
                
                const byMerchant = {};
                exp2025.forEach(e => {
                    const name = cleanMerchant(e.description);
                    const cat = getEffectiveCategory(e, merchantRules).category;
                    if (!byMerchant[name]) byMerchant[name] = { total: 0, count: 0, category: cat };
                    byMerchant[name].total += safe(e.amount);
                    byMerchant[name].count += 1;
                });
                
                const topMerchants = Object.entries(byMerchant)
                    .map(([name, data]) => ({ name, ...data, costType: getCostType(data.category) }))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 10);
                
                lines.push('| Rank | Merchant | Category | Cost Type | Total | Visits |');
                lines.push('|------|----------|----------|-----------|-------|--------|');
                topMerchants.forEach((m, i) => {
                    lines.push(`| ${i + 1} | ${m.name} | ${m.category} | ${m.costType} | ${fmt(m.total)} | ${m.count} |`);
                });
                lines.push('');
            }
            
            // === RECURRING EXPENSES (2025) ===
            const subscriptionLikely = [];
            const merchantMonthly = {};
            exp2025.forEach(e => {
                const name = cleanMerchant(e.description);
                const month = getM(e.date);
                if (!merchantMonthly[name]) merchantMonthly[name] = new Set();
                merchantMonthly[name].add(month);
            });
            
            Object.entries(merchantMonthly).forEach(([name, months]) => {
                if (months.size >= 3) {
                    const total = exp2025.filter(e => cleanMerchant(e.description) === name)
                        .reduce((s, e) => s + safe(e.amount), 0);
                    const monthly = total / months.size;
                    if (monthly > 5 && monthly < 500) {
                        subscriptionLikely.push({ name, months: months.size, monthly, annual: monthly * 12 });
                    }
                }
            });
            
            if (subscriptionLikely.length > 0) {
                subscriptionLikely.sort((a, b) => b.annual - a.annual);
                const topSubs = subscriptionLikely.slice(0, 8);
                const totalSubsAnnual = topSubs.reduce((s, sub) => s + sub.annual, 0);
                
                lines.push('## üîÑ Likely Recurring Expenses (2025)');
                lines.push('');
                lines.push('| Service | Est. Monthly | Est. Annual | Frequency |');
                lines.push('|---------|--------------|-------------|-----------|');
                topSubs.forEach(sub => {
                    lines.push(`| ${sub.name} | ${fmt(sub.monthly)} | ${fmt(sub.annual)} | ${sub.months} months |`);
                });
                lines.push(`| **Subtotal** | **${fmt(totalSubsAnnual / 12)}** | **${fmt(totalSubsAnnual)}** | |`);
                lines.push('');
            }
            
            // === FOOTER / PROMPT ===
            lines.push('---');
            lines.push('');
            lines.push('## ü§ñ Suggested Questions to Ask AI');
            lines.push('');
            lines.push('1. "Based on my cost structure, how can I reduce my fixed costs?"');
            lines.push('2. "My variable spending is X% - is this healthy? Where can I cut?"');
            lines.push('3. "Which categories grew the most from 2024 to 2025 and why?"');
            lines.push('4. "Help me create a budget that reduces my committed costs ratio."');
            lines.push('5. "What\'s a healthy ratio of Fixed/Semi-Fixed/Variable spending?"');
            lines.push('6. "Are there any concerning trends in my monthly spending pattern?"');
            lines.push('');
            lines.push('---');
            lines.push('*This report contains aggregated 2024-2025 data only. No individual transaction details or bank descriptions are included for privacy.*');
            
            setReport(lines.join('\n'));
            setGenerating(false);
        }, 300);
    };
    
    const copyToClipboard = () => {
        navigator.clipboard.writeText(report);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };
    
    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-cyan-500 to-blue-600 text-white p-6 rounded-2xl">
                <h2 className="text-xl font-black">ü§ñ AI Analyst Export</h2>
                <p className="text-cyan-100 text-sm mt-1">Generate a privacy-safe report to paste into ChatGPT, Claude, or other AI assistants</p>
            </div>
            
            {/* Generate Button */}
            <div className="bg-white rounded-2xl border border-slate-100 shadow-lg p-6">
                <div className="flex items-center justify-between mb-4">
                    <div>
                        <h3 className="font-bold text-slate-800">Generate Financial Report</h3>
                        <p className="text-sm text-slate-500 mt-1">Creates a Markdown-formatted summary of your finances</p>
                    </div>
                    <button 
                        onClick={generateReport}
                        disabled={generating}
                        className={`px-6 py-3 rounded-xl font-bold text-white transition-all ${
                            generating 
                                ? 'bg-slate-400 cursor-wait' 
                                : 'bg-gradient-to-r from-cyan-500 to-blue-600 hover:shadow-lg hover:scale-105'
                        }`}>
                        {generating ? '‚è≥ Generating...' : '‚ú® Generate AI Report'}
                    </button>
                </div>
                
                <div className="bg-slate-50 rounded-xl p-4 text-sm text-slate-600">
                    <p className="font-semibold mb-2">üìã What's included (2024-2025 focus):</p>
                    <ul className="grid grid-cols-2 gap-1 text-xs">
                        <li>‚úì 2024 vs 2025 comparison</li>
                        <li>‚úì Cost structure (Fixed/Semi-Fixed/Variable)</li>
                        <li>‚úì Monthly cost breakdown</li>
                        <li>‚úì Category analysis with YoY change</li>
                        <li>‚úì Income vs expenses ratios</li>
                        <li>‚úì Top merchants with cost types</li>
                        <li>‚úì Recurring expense detection</li>
                        <li>‚úì Budget-focused AI questions</li>
                    </ul>
                    <p className="mt-3 text-[10px] text-slate-400">üîí <strong>Privacy:</strong> No individual transactions or raw bank descriptions are included.</p>
                </div>
            </div>
            
            {/* Report Output */}
            {report && (
                <div className="bg-white rounded-2xl border border-slate-100 shadow-lg overflow-hidden">
                    <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                        <h3 className="text-sm font-black text-slate-800">üìù Generated Report</h3>
                        <button 
                            onClick={copyToClipboard}
                            className={`px-4 py-2 rounded-xl text-sm font-bold transition-all ${
                                copied 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-indigo-600 text-white hover:bg-indigo-700'
                            }`}>
                            {copied ? '‚úì Copied!' : 'üìã Copy to Clipboard'}
                        </button>
                    </div>
                    <div className="p-4">
                        <textarea 
                            readOnly
                            value={report}
                            className="w-full h-96 p-4 bg-slate-900 text-green-400 rounded-xl text-xs font-mono resize-none outline-none"
                        />
                    </div>
                    <div className="p-4 bg-amber-50 border-t border-amber-100">
                        <p className="text-sm text-amber-800 font-semibold">üí° How to use:</p>
                        <ol className="text-xs text-amber-700 mt-2 space-y-1 list-decimal list-inside">
                            <li>Click "Copy to Clipboard" above</li>
                            <li>Open ChatGPT, Claude, or your preferred AI assistant</li>
                            <li>Paste the report and ask questions like: <em>"Analyze my spending and suggest a budget"</em></li>
                        </ol>
                    </div>
                </div>
            )}
        </div>
    );
};

// ============== IMPORT DIALOG ==============
// ============== BULK IMPORT DIALOG ==============
const BulkImportDialog = ({ files, onClose, onConfirm, onRemoveFile }) => {
    // All files share the same settings
    const firstFile = files[0];
    const isHSBC = firstFile?.name.toLowerCase().includes('hsbc');
    const defaultHeaders = firstFile?.headers || [];
    
    const [map, setMap] = useState({ 
        date: defaultHeaders.find(h=>/date/i.test(h))||defaultHeaders[0], 
        amount: defaultHeaders.find(h=>/amount|debit/i.test(h))||defaultHeaders[1], 
        desc: defaultHeaders.find(h=>/desc|memo/i.test(h))||defaultHeaders[2], 
        cat: defaultHeaders.find(h=>/cat/i.test(h))||'' 
    });
    const [accType, setAccType] = useState(isHSBC ? 'checking' : 'credit');
    // Sign convention for credit cards:
    // 'pos_expense' = positive = expense, negative = refund (most common: Chase, Amex)
    // 'neg_expense' = negative = expense, positive = refund (some banks)
    // 'separate_cols' = separate debit/credit columns (Capital One style)
    const [signConvention, setSignConvention] = useState('pos_expense');
    
    const headers = defaultHeaders;
    
    // Auto-detect if there's a credit column
    const hasLikelyCreditCol = defaultHeaders.some(h => /^credit$/i.test(h));
    
    return (<div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={onClose}/>
        <div className="relative bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
            <div className="p-6 border-b border-slate-100">
                <h2 className="text-xl font-black text-slate-800">Import {files.length} CSV File{files.length > 1 ? 's' : ''}</h2>
                <div className="mt-2 space-y-1">
                    {files.map((f, i) => (
                        <div key={i} className="flex items-center justify-between px-3 py-1.5 bg-slate-50 rounded-lg">
                            <div className="flex-1 min-w-0">
                                <span className="text-xs font-semibold text-slate-600 truncate block">üìÑ {f.name}</span>
                                <span className="text-[9px] text-indigo-500">‚Üí Account: {f.name.replace(/\.[^/.]+$/, '')}</span>
                            </div>
                            <span className="text-[10px] text-slate-400 mx-2">{f.data.length} rows</span>
                            {files.length > 1 && (
                                <button onClick={() => onRemoveFile(i)} className="text-red-400 hover:text-red-600 text-xs font-bold">‚úï</button>
                            )}
                        </div>
                    ))}
                </div>
                {isHSBC && (
                    <div className="mt-2 px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-xs font-semibold inline-block">
                        ‚úì HSBC format detected - columns auto-mapped
                    </div>
                )}
            </div>
            <div className="p-6 space-y-4 max-h-[50vh] overflow-y-auto">
                {/* Account Type Selection */}
                <div>
                    <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Account Type</label>
                    <div className="grid grid-cols-2 gap-2">
                        <button onClick={() => setAccType('credit')} className={`p-3 rounded-xl text-sm font-bold border-2 transition-colors ${accType === 'credit' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>
                            üí≥ Credit Card
                        </button>
                        <button onClick={() => setAccType('checking')} className={`p-3 rounded-xl text-sm font-bold border-2 transition-colors ${accType === 'checking' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>
                            üè¶ Checking/Debit
                        </button>
                    </div>
                </div>
                
                {/* Sign Convention - Only for Credit Cards */}
                {accType === 'credit' && (
                    <div>
                        <label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount Format (How does your bank show charges?)</label>
                        <div className="space-y-2">
                            <button 
                                onClick={() => { setSignConvention('pos_expense'); setMap({...map, credit: ''}); }}
                                className={`w-full p-3 rounded-xl text-left border-2 transition-colors ${signConvention === 'pos_expense' ? 'bg-indigo-50 border-indigo-500' : 'bg-slate-50 border-slate-200'}`}
                            >
                                <div className="text-sm font-bold text-slate-700">‚ûï Charges are POSITIVE</div>
                                <div className="text-[10px] text-slate-500 mt-0.5">$50 charge = +50, $20 refund = -20</div>
                                <div className="text-[9px] text-slate-400">(Chase, Amex, most banks)</div>
                            </button>
                            <button 
                                onClick={() => { setSignConvention('neg_expense'); setMap({...map, credit: ''}); }}
                                className={`w-full p-3 rounded-xl text-left border-2 transition-colors ${signConvention === 'neg_expense' ? 'bg-amber-50 border-amber-500' : 'bg-slate-50 border-slate-200'}`}
                            >
                                <div className="text-sm font-bold text-slate-700">‚ûñ Charges are NEGATIVE</div>
                                <div className="text-[10px] text-slate-500 mt-0.5">$50 charge = -50, $20 refund = +20</div>
                                <div className="text-[9px] text-slate-400">(Some European banks, inverted format)</div>
                            </button>
                            <button 
                                onClick={() => setSignConvention('separate_cols')}
                                className={`w-full p-3 rounded-xl text-left border-2 transition-colors ${signConvention === 'separate_cols' ? 'bg-green-50 border-green-500' : 'bg-slate-50 border-slate-200'}`}
                            >
                                <div className="text-sm font-bold text-slate-700">üìä Separate Debit/Credit Columns</div>
                                <div className="text-[10px] text-slate-500 mt-0.5">Charges in one column, refunds in another (all positive)</div>
                                <div className="text-[9px] text-slate-400">(Capital One, some banks)</div>
                            </button>
                        </div>
                    </div>
                )}
                
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Date</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.date} onChange={e=>setMap({...map,date:e.target.value})}>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                    <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">{signConvention === 'separate_cols' ? 'Debit Column (Charges)' : 'Amount'}</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.amount} onChange={e=>setMap({...map,amount:e.target.value})}>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                </div>
                
                {/* Credit Column - Only show for separate columns mode */}
                {signConvention === 'separate_cols' && (
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Credit Column (Refunds/Payments)</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.credit||''} onChange={e=>setMap({...map,credit:e.target.value})}><option value="">-- Select --</option>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                        <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Category (optional)</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.cat} onChange={e=>setMap({...map,cat:e.target.value})}><option value="">-- None --</option>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                    </div>
                )}
                
                {signConvention !== 'separate_cols' && (
                    <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Category (optional)</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.cat} onChange={e=>setMap({...map,cat:e.target.value})}><option value="">-- None --</option>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                )}
                
                <div><label className="text-[10px] font-black uppercase text-slate-400 block mb-2">Description</label><select className="w-full p-3 bg-slate-50 rounded-xl text-sm font-semibold outline-none" value={map.desc} onChange={e=>setMap({...map,desc:e.target.value})}>{headers.map(h=><option key={h}>{h}</option>)}</select></div>
                
                {/* Info about account names */}
                <div className="p-3 bg-blue-50 rounded-xl border border-blue-200">
                    <p className="text-xs text-blue-700 font-semibold">üìÅ Account Names from File Names</p>
                    <p className="text-[10px] text-blue-600 mt-1">Each file's name (without extension) will be used as the account name.</p>
                </div>
            </div>
            <div className="p-6 bg-slate-50 flex gap-4">
                <button onClick={onClose} className="flex-1 py-3 font-bold text-slate-500 rounded-xl hover:bg-slate-200">Cancel</button>
                <button onClick={()=>onConfirm({...map, accType, signConvention})} className="flex-1 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700">
                    Import {files.reduce((sum, f) => sum + f.data.length, 0)} Transactions
                </button>
            </div>
        </div>
    </div>);
};

// ============== IMPORT HISTORY PANEL ==============
const ImportHistoryPanel = ({ importHistory, onDeleteImport, onClose }) => {
    const totalTxns = importHistory.reduce((sum, h) => sum + h.count, 0);
    
    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={onClose}/>
            <div className="relative bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden">
                <div className="p-6 border-b border-slate-100">
                    <h2 className="text-xl font-black text-slate-800">üìö Import History</h2>
                    <p className="text-sm text-slate-500 mt-1">{importHistory.length} imports ¬∑ {totalTxns.toLocaleString()} total transactions</p>
                </div>
                <div className="p-6 max-h-[60vh] overflow-y-auto">
                    {importHistory.length === 0 ? (
                        <div className="text-center py-12 text-slate-400">
                            <div className="text-4xl mb-2">üì≠</div>
                            <p className="font-semibold">No imports yet</p>
                            <p className="text-xs mt-1">Import CSV files to see them here</p>
                        </div>
                    ) : (
                        <div className="space-y-2">
                            {importHistory.map((h, i) => (
                                <div key={h.id} className="flex items-center gap-4 p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors">
                                    <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-black text-sm">
                                        {i + 1}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="font-bold text-slate-800 truncate">{h.fileName}</div>
                                        <div className="text-[10px] text-slate-400 flex gap-3 mt-0.5">
                                            <span>üìÖ {new Date(h.importedAt).toLocaleDateString()}</span>
                                            <span>üí≥ {h.account}</span>
                                            <span>üìä {h.count} txns</span>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-sm font-black text-slate-700">${h.totalAmount.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                                        <div className="text-[10px] text-slate-400">{h.accountType}</div>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            if (confirm(`Delete all ${h.count} transactions from "${h.fileName}"?`)) {
                                                onDeleteImport(h.id);
                                            }
                                        }}
                                        className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                        title="Delete this import"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                <div className="p-6 bg-slate-50 flex justify-between items-center">
                    <button 
                        onClick={() => {
                            if (importHistory.length > 0 && confirm(`Delete ALL ${totalTxns} transactions from ${importHistory.length} imports?`)) {
                                importHistory.forEach(h => onDeleteImport(h.id));
                            }
                        }}
                        className="px-4 py-2 text-red-500 font-bold text-sm hover:bg-red-50 rounded-xl"
                        disabled={importHistory.length === 0}
                    >
                        üóëÔ∏è Delete All
                    </button>
                    <button onClick={onClose} className="px-6 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700">Done</button>
                </div>
            </div>
        </div>
    );
};

// ============== MAIN APP ==============
const App = () => {
    const [expenses, setExpenses] = useState([]);
    const [merchantRules, setMerchantRules] = useState({});
    const [paidStylecomIds, setPaidStylecomIds] = useState(new Set());
    const [costTypeOverrides, setCostTypeOverrides] = useState({});
    const [pendingFiles, setPendingFiles] = useState([]); // Array of {name, data, headers}
    const [importHistory, setImportHistory] = useState([]); // Track imports for deletion
    const [showImportHistory, setShowImportHistory] = useState(false);
    const [msg, setMsg] = useState('');
    const [tab, setTab] = useState('dashboard');

    useEffect(() => { 
        setExpenses(loadExpenses()); 
        setMerchantRules(loadMerchantRules());
        setCostTypeOverrides(loadCostTypeOverrides());
        // Load paid Stylecom IDs
        try {
            const saved = localStorage.getItem('stylecom_paid_ids');
            if (saved) setPaidStylecomIds(new Set(JSON.parse(saved)));
        } catch {}
        // Load import history
        try {
            const savedHistory = localStorage.getItem('import_history');
            if (savedHistory) setImportHistory(JSON.parse(savedHistory));
        } catch {}
    }, []);
    
    useEffect(() => { localStorage.setItem('expense_v9', JSON.stringify(expenses)); }, [expenses]);
    useEffect(() => { localStorage.setItem('merchant_rules_v2', JSON.stringify(merchantRules)); }, [merchantRules]);
    useEffect(() => { localStorage.setItem('cost_type_overrides', JSON.stringify(costTypeOverrides)); }, [costTypeOverrides]);
    useEffect(() => { localStorage.setItem('stylecom_paid_ids', JSON.stringify([...paidStylecomIds])); }, [paidStylecomIds]);
    useEffect(() => { localStorage.setItem('import_history', JSON.stringify(importHistory)); }, [importHistory]);

    const toggleStylecomPaid = (id) => {
        setPaidStylecomIds(prev => {
            const next = new Set(prev);
            if (next.has(id)) {
                next.delete(id);
            } else {
                next.add(id);
            }
            return next;
        });
    };
    
    const updateCostType = (category, costType) => {
        // Check if this matches the default rule (no override needed)
        const defaultType = getCostType(category, {});
        if (defaultType === costType) {
            // Remove override if it exists
            const newOverrides = {...costTypeOverrides};
            delete newOverrides[category];
            setCostTypeOverrides(newOverrides);
            setMsg(`‚úÖ ${category} ‚Üí ${costType} (using default rule)`);
        } else {
            // Add override
            setCostTypeOverrides(prev => ({...prev, [category]: costType}));
            setMsg(`‚úÖ ${category} ‚Üí ${costType} (manual override)`);
        }
        setTimeout(() => setMsg(''), 3000);
    };

    const handleFiles = e => { 
        const fileList = Array.from(e.target.files).slice(0, 5); // Max 5 files
        if (!fileList.length) return;
        
        // Parse all files
        const parsePromises = fileList.map(f => new Promise((resolve) => {
            const fileName = f.name.replace(/\.[^/.]+$/, '');
            const isHSBC = fileName.toLowerCase().includes('hsbc');
            
            if (isHSBC) {
                Papa.parse(f, { 
                    header: false, 
                    skipEmptyLines: true, 
                    complete: r => { 
                        if (r.data.length) {
                            const headers = ['Date', 'Description', 'Amount', 'Balance'];
                            const transformedData = r.data.map(row => {
                                const obj = {};
                                headers.forEach((h, i) => {
                                    let value = row[i] || '';
                                    if (h === 'Description') {
                                        value = value.replace(/\s+/g, ' ').trim();
                                    } else if (h === 'Amount' || h === 'Balance') {
                                        value = String(value).replace(/,/g, '');
                                    }
                                    obj[h] = value;
                                });
                                return obj;
                            });
                            resolve({ name: f.name, data: transformedData, headers });
                        } else {
                            resolve(null);
                        }
                    } 
                });
            } else {
                Papa.parse(f, { 
                    header: true, 
                    skipEmptyLines: true, 
                    complete: r => { 
                        if (r.data.length) {
                            resolve({ name: f.name, data: r.data, headers: r.meta.fields });
                        } else {
                            resolve(null);
                        }
                    } 
                });
            }
        }));
        
        Promise.all(parsePromises).then(results => {
            const validFiles = results.filter(Boolean);
            if (validFiles.length) {
                setPendingFiles(validFiles);
            }
        });
        
        e.target.value = ''; 
    };
    
    const removePendingFile = (index) => {
        setPendingFiles(prev => prev.filter((_, i) => i !== index));
    };
    
    const processBulkImport = (map) => {
        const isCheckingAccount = map.accType === 'checking';
        const signConvention = map.signConvention || 'pos_expense'; // Default to positive = expense
        const hasSeparateCols = signConvention === 'separate_cols' && map.credit && map.credit !== '';
        const importId = `imp-${Date.now()}`;
        const importedAt = new Date().toISOString();
        
        let allNewExp = [];
        const newHistoryEntries = [];
        
        // Process each file
        pendingFiles.forEach((file, fileIdx) => {
            const fileImportId = `${importId}-${fileIdx}`;
            const isHSBC = file.name.toLowerCase().includes('hsbc');
            // Use file name (without extension) as account name for each file
            const fileAccountName = file.name.replace(/\.[^/.]+$/, '') || 'Imported';
            
            const newExp = file.data.map((row, i) => {
                const desc = row[map.desc] || '';
                const descLower = desc.toLowerCase();
                
                let rawAmount = 0;
                let isRefundFromSeparateCol = false;
                
                // CASE 1: Separate Debit/Credit columns (Capital One style)
                if (hasSeparateCols) {
                    const creditRaw = String(row[map.credit]||'').replace(/[^\d.-]/g,'');
                    const debitRaw = String(row[map.amount]||'').replace(/[^\d.-]/g,'');
                    
                    if (creditRaw && creditRaw !== '0' && creditRaw !== '0.00') {
                        // Credit column = refund/payment (make negative)
                        rawAmount = parseFloat(creditRaw) || 0;
                        isRefundFromSeparateCol = true;
                    } else if (debitRaw && debitRaw !== '0' && debitRaw !== '0.00') {
                        // Debit column = expense (keep positive)
                        rawAmount = parseFloat(debitRaw) || 0;
                    } else {
                        return null;
                    }
                } else {
                    // CASE 2: Single amount column
                    const raw = String(row[map.amount]||'0').replace(/[^\d.-]/g,'');
                    rawAmount = parseFloat(raw) || 0;
                    if (raw === '' || raw === '0' || raw === '0.00') return null;
                }
                
                let transactionType = 'expense';
                let finalAmount = Math.abs(rawAmount);
                
                // Handle separate column refunds first
                if (isRefundFromSeparateCol) {
                    transactionType = 'refund';
                    finalAmount = -Math.abs(rawAmount);
                }
                
                const isVenmo = descLower.includes('venmo');
                const isOnlineTransfer = descLower.includes('online transfer to') || 
                                         descLower.includes('online transfer from') ||
                                         descLower.includes('ach payment to');
                const isWithdrawal = descLower.includes('withdrawal');
                const isDeposit = descLower.includes('deposit') && !isWithdrawal && !isOnlineTransfer;
                
                if (!isRefundFromSeparateCol) {
                    if (isVenmo) {
                        const isVenmoDeposit = descLower.includes('deposit') || descLower.includes('cashout');
                        if (isVenmoDeposit) {
                            transactionType = 'venmo-reimbursement';
                            finalAmount = -Math.abs(rawAmount);
                        } else {
                            transactionType = 'venmo-payment';
                            finalAmount = Math.abs(rawAmount);
                        }
                    } else if (isOnlineTransfer) {
                        transactionType = 'transfer';
                        finalAmount = Math.abs(rawAmount);
                    } else if (isCheckingAccount) {
                        if (isWithdrawal) {
                            transactionType = 'expense';
                            finalAmount = Math.abs(rawAmount);
                        } else if (isDeposit) {
                            transactionType = 'income';
                            finalAmount = -Math.abs(rawAmount);
                        } else {
                            const isIncoming = rawAmount > 0;
                            if (isIncoming) {
                                transactionType = 'income';
                                finalAmount = -Math.abs(rawAmount);
                            } else {
                                transactionType = 'expense';
                                finalAmount = Math.abs(rawAmount);
                            }
                        }
                    } else {
                        // CREDIT CARD: Apply sign convention
                        if (signConvention === 'pos_expense') {
                            // Positive = expense, Negative = refund (most common: Chase, Amex)
                            if (rawAmount < 0) {
                                transactionType = 'refund';
                                finalAmount = rawAmount; // Keep negative
                            } else {
                                transactionType = 'expense';
                                finalAmount = Math.abs(rawAmount);
                            }
                        } else if (signConvention === 'neg_expense') {
                            // Negative = expense, Positive = refund (inverted)
                            if (rawAmount > 0) {
                                transactionType = 'refund';
                                finalAmount = -Math.abs(rawAmount); // Make negative for our system
                            } else {
                                transactionType = 'expense';
                                finalAmount = Math.abs(rawAmount); // Make positive for our system
                            }
                        }
                    }
                }
                
                const csvCategory = map.cat && row[map.cat] ? fuzzyMatchCSV(row[map.cat]) : 'Uncategorized';
                const cleanedDesc = cleanDescription(desc);
                const subscriptionDetection = detectSubscription(cleanedDesc);
                
                return { 
                    id: `e-${Date.now()}-${fileIdx}-${i}`, 
                    importId: fileImportId,  // Track which import this came from
                    date: row[map.date] || new Date().toISOString().split('T')[0], 
                    description: cleanedDesc,
                    rawDescription: desc,
                    amount: finalAmount,
                    rawAmount: rawAmount,
                    transactionType: transactionType,
                    accountType: map.accType || 'credit',
                    csvCategory: csvCategory,
                    manualCategory: null,
                    isSubscription: subscriptionDetection.isSubscription,
                    account: fileAccountName  // Use file name as account
                };
            }).filter(Boolean);
            
            allNewExp = [...allNewExp, ...newExp];
            
            // Create history entry for this file
            const totalAmount = newExp.reduce((sum, e) => sum + Math.abs(e.amount), 0);
            newHistoryEntries.push({
                id: fileImportId,
                fileName: file.name,
                account: fileAccountName,  // Use file name as account
                accountType: map.accType || 'credit',
                count: newExp.length,
                totalAmount,
                importedAt
            });
        });
        
        setExpenses([...expenses, ...allNewExp]);
        setImportHistory([...importHistory, ...newHistoryEntries]);
        setPendingFiles([]);
        setMsg(`‚úÖ Imported ${allNewExp.length} transactions from ${pendingFiles.length} file${pendingFiles.length > 1 ? 's' : ''}`);
        setTimeout(() => setMsg(''), 4000);
    };
    
    const deleteImport = (importId) => {
        // Remove all expenses with this importId
        setExpenses(expenses.filter(e => e.importId !== importId));
        // Remove from history
        setImportHistory(importHistory.filter(h => h.id !== importId));
        setMsg(`üóëÔ∏è Deleted import`);
        setTimeout(() => setMsg(''), 3000);
    };

    const updateExpenseCategory = (id, category) => {
        setExpenses(expenses.map(e => e.id === id ? {...e, manualCategory: category} : e));
    };
    
    const updateExpenseSubscription = (id, isSubscription) => {
        // Find the merchant for this expense
        const expense = expenses.find(e => e.id === id);
        if (!expense) return;
        
        const merchant = cleanMerchant(expense.description);
        
        // Update ALL expenses from the same merchant
        setExpenses(expenses.map(e => {
            if (cleanMerchant(e.description) === merchant) {
                return {...e, isSubscription: isSubscription};
            }
            return e;
        }));
        
        // Show feedback
        const count = expenses.filter(e => cleanMerchant(e.description) === merchant).length;
        setMsg(`‚úÖ ${isSubscription ? 'Marked' : 'Unmarked'} ${count} "${merchant}" transactions as ${isSubscription ? 'recurring' : 'one-time'}`);
        setTimeout(() => setMsg(''), 4000);
    };

    const updateMerchantRule = (merchant, category, scope = 'global', accounts = []) => {
        const newRules = {...merchantRules};
        
        if (scope === 'accounts' && accounts.length > 0) {
            // Multi-account rule - use special key format
            const accountsKey = getAccountsRuleKey(merchant);
            newRules[accountsKey] = { category, scope: 'accounts', accounts: accounts };
            setMerchantRules(newRules);
            const accountsList = accounts.length > 2 
                ? `${accounts.slice(0, 2).join(', ')} +${accounts.length - 2} more`
                : accounts.join(', ');
            setMsg(`‚úÖ Account rule: "${merchant}" ‚Üí ${category} (for ${accountsList})`);
        } else {
            // Global rule
            newRules[merchant] = { category, scope: 'global' };
            setMerchantRules(newRules);
            setMsg(`‚úÖ Global rule: "${merchant}" ‚Üí ${category}`);
        }
        setTimeout(() => setMsg(''), 4000);
    };

    const deleteMerchantRule = (ruleKey) => {
        const newRules = {...merchantRules};
        delete newRules[ruleKey];
        setMerchantRules(newRules);
    };

    const del = id => setExpenses(expenses.filter(e => e.id !== id));
    
    const exportCSV = () => { 
        const csv = ['date,amount,raw_amount,transaction_type,category,source,account,account_type,description,raw_description,csv_category', 
            ...expenses.map(e => {
                const eff = getEffectiveCategory(e, merchantRules);
                return `${e.date},${e.amount},${e.rawAmount || e.amount},${e.transactionType || 'expense'},${eff.category},${eff.source},${e.account},${e.accountType || 'credit'},"${(e.description||'').replace(/"/g,'""')}","${(e.rawDescription || e.description||'').replace(/"/g,'""')}",${e.csvCategory || ''}`;
            })
        ].join('\n'); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); 
        a.download = 'expenses.csv'; 
        a.click(); 
    };

    return (<div className="min-h-screen pb-20">
        <header className="bg-white/90 backdrop-blur-lg border-b border-slate-100 h-14 flex items-center px-4 justify-between sticky top-0 z-40">
            <div className="flex items-center gap-2"><div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-xl flex items-center justify-center text-white font-black text-sm">S</div><h1 className="text-lg font-black text-slate-800">Smart<span className="text-indigo-600">Expense</span></h1></div>
            <div className="flex gap-2">
                <button onClick={exportCSV} className="bg-slate-100 text-slate-600 px-3 py-2 rounded-xl font-bold text-xs" title="Export CSV">üì•</button>
                <button onClick={() => setShowImportHistory(true)} className="bg-slate-100 text-slate-600 px-3 py-2 rounded-xl font-bold text-xs relative" title="Import History">
                    üìö
                    {importHistory.length > 0 && (
                        <span className="absolute -top-1 -right-1 w-4 h-4 bg-indigo-500 text-white text-[9px] font-black rounded-full flex items-center justify-center">{importHistory.length}</span>
                    )}
                </button>
                <label className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-black text-xs cursor-pointer hover:bg-indigo-700 transition-colors" title="Import up to 5 CSV files">
                    üì§ Import
                    <input type="file" className="hidden" accept=".csv" multiple onChange={handleFiles}/>
                </label>
            </div>
        </header>

        <div className="max-w-7xl mx-auto px-4 mt-4">
            <div className="flex gap-1 bg-slate-100 p-1 rounded-xl w-fit text-xs overflow-x-auto">
                {['dashboard','evolution','flow','categories','costtype','stylecom','transfers','transactions','ai','export'].map(t => (
                    <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded-lg font-bold capitalize whitespace-nowrap ${tab===t?'bg-white text-indigo-600 shadow':'text-slate-500'}`}>
                        {t==='dashboard'?'üìä ':t==='evolution'?'üìà ':t==='flow'?'üí∞ ':t==='categories'?'üè∑Ô∏è ':t==='costtype'?'üì¶ ':t==='stylecom'?'üëó ':t==='transfers'?'üîÑ ':t==='transactions'?'üìã ':t==='ai'?'ü§ñ ':'üõ†Ô∏è '}{t === 'costtype' ? 'Cost Types' : t}
                    </button>
                ))}
            </div>
        </div>

        <main className="max-w-7xl mx-auto px-4 mt-6 space-y-6">
            {msg && <div className="bg-green-50 border border-green-200 rounded-xl p-4 text-green-700 font-medium text-sm">{msg}</div>}

            {tab === 'dashboard' && (<>
                <Stats expenses={expenses} merchantRules={merchantRules}/>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üìä Where Does It All Go? (2025)</h3><div className="h-80"><Pareto expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üîÑ Recurring Costs (2025)</h3><div className="h-80"><RecurringCosts expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üè™ Top 20 Merchants (2025)</h3><div className="h-80"><TopMerchants expenses={expenses} merchantRules={merchantRules}/></div></div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üì¶ Monthly Cost Structure (2025)</h3><div className="h-56"><CostStructureChart expenses={expenses} merchantRules={merchantRules} costTypeOverrides={costTypeOverrides}/></div></div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üì∫ Subscriptions (2025)</h3><div className="h-56"><Subscriptions expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">‚òï Small Purchase Leaks (2025)</h3><div className="h-56"><SmallPurchaseMerchants expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üí∏ Death by 1000 Cuts (2025)</h3><div className="h-56"><Scatter expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
                {/* NEW: Spending Magnitude & Long Tail Analysis */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                        <h3 className="text-sm font-black text-slate-800 mb-1">üê≥ Spending Magnitude (2025)</h3>
                        <p className="text-[10px] text-slate-400 mb-3">Whale vs. Minnow: How your transactions stack up by size</p>
                        <div className="h-56"><SpendingMagnitude expenses={expenses} merchantRules={merchantRules}/></div>
                    </div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg">
                        <h3 className="text-sm font-black text-slate-800 mb-1">üîç Small Spend Categories (2025)</h3>
                        <p className="text-[10px] text-slate-400 mb-3">The Long Tail: Where do transactions under $50 go?</p>
                        <div className="h-56"><SmallSpendCategories expenses={expenses} merchantRules={merchantRules}/></div>
                    </div>
                </div>
                
                {/* $100-$500 Bucket Deep Dive */}
                <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-2xl">
                    <h2 className="text-lg font-black">üêã $100‚Äì$500 Bucket Deep Dive</h2>
                    <p className="text-green-100 text-xs mt-1">Analyzing the mid-range spending zone: Are these habits or one-offs?</p>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-green-200 shadow-lg">
                        <h3 className="text-sm font-black text-slate-800 mb-1">üóÇÔ∏è Category Breakdown</h3>
                        <p className="text-[10px] text-slate-400 mb-3">Categories with their top merchants (hover for details)</p>
                        <div className="h-72"><MidRangeTreemap expenses={expenses} merchantRules={merchantRules}/></div>
                    </div>
                    <div className="bg-white p-5 rounded-2xl border border-green-200 shadow-lg">
                        <h3 className="text-sm font-black text-slate-800 mb-1">üèÜ Top 15 Merchants</h3>
                        <p className="text-[10px] text-slate-400 mb-3">Frequency vs. Value: Bar = $ spent, Bubble = # transactions</p>
                        <div className="h-72"><MidRangeMerchants expenses={expenses} merchantRules={merchantRules}/></div>
                    </div>
                </div>
            </>)}

            {tab === 'evolution' && (<>
                <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-2xl"><h2 className="text-xl font-black">üìà Year-over-Year Evolution</h2><p className="text-indigo-100 text-sm mt-1">Compare spending across 2024 and 2025</p></div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üóìÔ∏è Seasonality (Jan-Dec)</h3><div className="h-64"><SeasonalityChart expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üèÉ Pace of Spending</h3><div className="h-64"><PaceChart expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üì¶ Cost Structure Evolution (2024 vs 2025)</h3><div className="h-64"><CostStructureEvolution expenses={expenses} merchantRules={merchantRules} costTypeOverrides={costTypeOverrides}/></div></div>
                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üìä Category Evolution (YoY)</h3><div className="h-80"><CategoryEvolution expenses={expenses} merchantRules={merchantRules}/></div></div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üî• Spending Heatmap</h3><div className="h-64"><Heatmap expenses={expenses} merchantRules={merchantRules}/></div></div>
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-lg"><h3 className="text-sm font-black text-slate-800 mb-3">üí≥ Account Totals by Year</h3><div className="h-64"><AccountTotalsChart expenses={expenses} merchantRules={merchantRules}/></div></div>
                </div>
            </>)}

            {tab === 'flow' && (
                <IncomeFlowDashboard expenses={expenses} merchantRules={merchantRules} costTypeOverrides={costTypeOverrides} />
            )}

            {tab === 'categories' && (
                <CategoryManagement 
                    expenses={expenses} 
                    merchantRules={merchantRules}
                    onUpdateExpense={updateExpenseCategory}
                    onUpdateRule={updateMerchantRule}
                    onDeleteRule={deleteMerchantRule}
                    onUpdateSubscription={updateExpenseSubscription}
                />
            )}
            
            {tab === 'costtype' && (
                <CostTypeManagement 
                    expenses={expenses} 
                    merchantRules={merchantRules}
                    costTypeOverrides={costTypeOverrides}
                    onUpdateCostType={updateCostType}
                />
            )}

            {tab === 'stylecom' && (
                <StylecomReimbursement 
                    expenses={expenses} 
                    merchantRules={merchantRules}
                    paidIds={paidStylecomIds}
                    onTogglePaid={toggleStylecomPaid}
                />
            )}

            {tab === 'transfers' && (
                <TransferMatching expenses={expenses} merchantRules={merchantRules} />
            )}

            {tab === 'transactions' && (
                <TransactionsTable 
                    expenses={expenses} 
                    merchantRules={merchantRules} 
                    onDelete={del}
                    onClearAll={() => { if(confirm("Delete all data?")) { setExpenses([]); setImportHistory([]); } }}
                />
            )}

            {tab === 'ai' && (
                <AIAnalystExport expenses={expenses} merchantRules={merchantRules} />
            )}

            {tab === 'export' && (
                <ExportRules merchantRules={merchantRules} expenses={expenses} />
            )}
        </main>
        
        {/* Bulk Import Dialog */}
        {pendingFiles.length > 0 && (
            <BulkImportDialog 
                files={pendingFiles} 
                onClose={() => setPendingFiles([])} 
                onConfirm={processBulkImport}
                onRemoveFile={removePendingFile}
            />
        )}
        
        {/* Import History Panel */}
        {showImportHistory && (
            <ImportHistoryPanel 
                importHistory={importHistory}
                onDeleteImport={deleteImport}
                onClose={() => setShowImportHistory(false)}
            />
        )}
    </div>);
};

ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App/></ErrorBoundary>);
</script>
</body>
</html>
